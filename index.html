<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Youbiiiz</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700;0,9..40,800&display=swap');
*{box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#f0f2f5;color:#1a1a2e;overflow:hidden;-webkit-tap-highlight-color:transparent;touch-action:manipulation}

/* LOGO */
.brand-logo{display:inline-flex;align-items:baseline;font-weight:800;user-select:none;color:#1a1a2e}
.i-wrapper{display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px}
.i-stem{width:12px;height:38px;background:#0ea5e9;border-radius:2px}
.i-dot{width:12px;height:12px;background:#0ea5e9;border-radius:2px;position:absolute;bottom:48px;box-shadow:0 0 16px rgba(14,165,233,.6)}
.i-char{position:relative;display:flex;flex-direction:column;align-items:center}
header .i-stem{width:5px;height:16px}
header .i-dot{width:5px;height:5px;bottom:20px;box-shadow:none}
header .i-wrapper{gap:2px;margin:0 2px}
@keyframes dribble{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(var(--b));animation-timing-function:cubic-bezier(0,0,.2,1)}}
.i-char:nth-child(1) .i-dot{--b:-10px;animation:dribble .9s infinite}
.i-char:nth-child(2) .i-dot{--b:-15px;animation:dribble 1.3s infinite .2s}
.i-char:nth-child(3) .i-dot{--b:-12px;animation:dribble 1.1s infinite .5s}

/* UTILS */
.no-sb{-ms-overflow-style:none;scrollbar-width:none}
.no-sb::-webkit-scrollbar{display:none}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fi .25s ease-out forwards}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.su{animation:su .3s cubic-bezier(.16,1,.3,1) forwards}
@keyframes sr{from{transform:translateX(100%)}to{transform:translateX(0)}}
.sr{animation:sr .28s cubic-bezier(.16,1,.3,1) forwards}
@keyframes ld{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
@keyframes scanmove{0%{top:0;opacity:0}10%{opacity:1}90%{opacity:1}100%{top:100%;opacity:0}}

/* CARDS */
.card{background:#fff;border:none;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .12s,box-shadow .12s;box-shadow:0 2px 12px rgba(0,0,0,.08)}
.card:active{transform:scale(.96)}
.card:hover{box-shadow:0 6px 24px rgba(0,0,0,.12)}
.sq{width:100%;aspect-ratio:1/1;background:#f8fafc;overflow:hidden;position:relative}
.sq img{width:100%;height:100%;object-fit:contain;background:#f8fafc}
.inf{padding:8px 10px 12px}

/* INPUTS */
.inp{width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;padding:11px 13px;color:#1a1a2e;font-size:14px;font-weight:600;outline:none;transition:border-color .15s;font-family:inherit}
.inp:focus{border-color:#0ea5e9;background:#fff}
.inp::placeholder{color:#94a3b8}

/* CHIPS */
.chip{padding:6px 14px;border-radius:99px;font-size:11px;font-weight:700;border:1.5px solid #e2e8f0;color:#64748b;white-space:nowrap;cursor:pointer;transition:all .12s;background:#fff}
.chip.on{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 2px 8px rgba(14,165,233,.3)}

/* SEARCH BAR */
.sbar{background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}

/* MODALS */
.mover{background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
.msheet{background:#fff;border-radius:24px 24px 0 0;border-top:none;box-shadow:0 -4px 32px rgba(0,0,0,.12)}

/* CHAT BUBBLES */
.bme{background:#0ea5e9;color:#fff;border-radius:18px 18px 4px 18px}
.bthem{background:#f1f5f9;border:none;color:#1a1a2e;border-radius:18px 18px 18px 4px}

/* DEBUG */
#dbg{display:none;position:fixed;top:12px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:7px 18px;border-radius:99px;font-size:11px;font-weight:700;z-index:9999;max-width:90%;text-align:center}

/* LOGO UNIVERSEL */
.yb-logo{display:inline-flex;align-items:baseline;font-weight:800;letter-spacing:-1px;line-height:1;user-select:none}
.yb-logo .yb-i-group{display:inline-flex;align-items:flex-end;margin:0 0.08em}
.yb-logo .yb-i{display:flex;flex-direction:column;align-items:center;gap:0}
.yb-logo .yb-i .dot{border-radius:2px;margin-bottom:0.06em;flex-shrink:0}
.yb-logo .yb-i .stem{border-radius:2px;flex-shrink:0}

/* WHATNOT LAYOUT */
#app{display:flex;flex-direction:column}
.app-body{display:flex;flex:1;overflow:hidden}
.sidebar{width:220px;flex-shrink:0;background:#fff;border-right:1px solid #e8ecf0;overflow-y:auto;display:flex;flex-direction:column}
.sidebar-nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border-radius:10px;margin:1px 8px;transition:all .12s}
.sidebar-nav-item:hover{background:#f1f5f9;color:#0f172a}
.sidebar-nav-item.active{background:#eff9ff;color:#0ea5e9;font-weight:700}
/* SIDEBAR ACCORDION */
.sb-group{margin:1px 8px}
.sb-group-header{display:flex;align-items:center;gap:10px;padding:9px 8px;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border-radius:10px;transition:all .12s;user-select:none}
.sb-group-header:hover{background:#f1f5f9;color:#0f172a}
.sb-group-header .sb-group-label{flex:1}
.sb-arrow{font-size:9px;transition:transform .2s;color:#cbd5e1}
.sb-arrow.open{transform:rotate(90deg)}
/* FAVORIS */
.heart-btn{position:absolute;top:7px;right:7px;width:28px;height:28px;background:rgba(255,255,255,.95);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;font-size:13px;transition:transform .15s;box-shadow:0 1px 6px rgba(0,0,0,.14);z-index:2;line-height:1}
.heart-btn:active{transform:scale(.8)}
.heart-btn.fav{background:#fff0f3;color:#f43f5e}
/* TRUST SCORE */
.trust-bar{height:5px;border-radius:99px;background:#f1f5f9;overflow:hidden;margin-top:5px}
.trust-fill{height:100%;border-radius:99px;transition:width .5s cubic-bezier(.16,1,.3,1)}
/* FRAUD WARNING */
.fraud-warn{background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:10px 13px;display:flex;gap:9px;align-items:flex-start;margin-bottom:10px}
/* VIEWS BADGE */
.views-badge{position:absolute;bottom:7px;left:7px;background:rgba(15,23,42,.7);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:99px;display:flex;align-items:center;gap:3px;pointer-events:none}
/* TROC BADGE */
.troc-badge{background:#fef3c7;color:#92400e;font-size:9px;font-weight:800;padding:2px 7px;border-radius:99px;border:1px solid #fde68a;display:inline-flex;align-items:center;gap:3px}
/* NL SEARCH HINT */
.nl-hint{font-size:10px;color:#64748b;padding:3px 8px;background:#f8fafc;border-radius:8px;margin-top:4px;display:none}
/* ALERT CHIP */
.alert-chip{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;margin-bottom:6px}
.alert-chip-label{flex:1;font-size:12px;font-weight:600;color:#1e293b}
.alert-chip-del{background:none;border:none;color:#94a3b8;cursor:pointer;font-size:13px;padding:0}
/* PRICE RANGE */
.price-range-bar{background:#f1f5f9;border-radius:10px;padding:8px 12px;margin-top:6px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.price-range-bar span{font-size:11px;font-weight:700;color:#0ea5e9}
/* SELLER VERIFIED */
.verified-badge{display:inline-flex;align-items:center;gap:3px;background:#eff9ff;color:#0ea5e9;font-size:9px;font-weight:800;padding:2px 7px;border-radius:99px;border:1px solid rgba(14,165,233,.2)}
/* BOOST TOGGLE */
.boost-row{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px 14px;margin-bottom:8px}
.toggle-sw{position:relative;width:38px;height:20px;cursor:pointer}
.toggle-sw input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;background:#cbd5e1;border-radius:99px;transition:.2s}
.toggle-sw input:checked+.toggle-track{background:#0ea5e9}
.toggle-track:before{content:"";position:absolute;width:16px;height:16px;left:2px;top:2px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-sw input:checked+.toggle-track:before{transform:translateX(18px)}
.sb-sublist{padding-left:32px}
.sb-subitem{padding:6px 8px;font-size:12px;font-weight:600;color:#64748b;cursor:pointer;border-radius:8px;transition:all .12s;margin-bottom:1px}
.sb-subitem:hover{background:#f1f5f9;color:#0ea5e9}
.sb-subitem.active{color:#0ea5e9;font-weight:700}
.sidebar-nav-item .icon{width:20px;text-align:center;font-size:13px}
.sidebar-section-title{font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;padding:12px 24px 4px}
.main-content{flex:1;overflow-y:auto;background:#f4f6f8}
@media(max-width:768px){
  .sidebar{display:none}
  .main-content{padding-bottom:72px}
}
@media(min-width:769px){
  nav.bottom-nav{display:none!important}
}

/* HEADER WHATNOT STYLE */
.yb-header{background:#fff;border-bottom:1px solid #e8ecf0;padding:0 20px;height:56px;display:flex;align-items:center;gap:12px;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.yb-search{flex:1;max-width:520px;background:#f4f6f8;border:1.5px solid #e8ecf0;border-radius:10px;display:flex;align-items:center;gap:8px;padding:0 12px;height:38px;transition:border-color .15s}
.yb-search:focus-within{border-color:#0ea5e9;background:#fff}
.yb-search input{flex:1;background:none;border:none;outline:none;font-size:13px;font-weight:500;color:#1a1a2e;font-family:inherit}
.yb-search input::placeholder{color:#94a3b8}
.yb-icon-btn{width:38px;height:38px;border-radius:10px;background:#f4f6f8;border:1.5px solid #e8ecf0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;flex-shrink:0}
.yb-icon-btn:hover{background:#eff9ff;border-color:#0ea5e9;color:#0ea5e9}

/* PILL TABS */
.cat-pills{display:flex;gap:6px;overflow-x:auto;padding:12px 16px 6px;scrollbar-width:none}
.cat-pills::-webkit-scrollbar{display:none}
.cat-pill{padding:7px 16px;border-radius:99px;font-size:11.5px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .18s;background:#fff;color:#475569;border:1.5px solid #e2e8f0;letter-spacing:0.01em}
.cat-pill.on{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 2px 8px rgba(14,165,233,.3)}

/* CARD GRID */
.feed-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:8px 16px 24px}
@media(min-width:900px){.feed-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
@media(min-width:1200px){.feed-grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}}

/* MAP MARKERS */
@keyframes dotBounce{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(-6px);animation-timing-function:cubic-bezier(0,0,.2,1)}}
.yb-marker{display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform .15s}
.yb-marker:hover{transform:scale(1.2)}
.yb-marker:hover .yb-dot{animation:dotBounce .7s infinite}
.yb-stem{width:5px;height:18px;background:#0ea5e9;border-radius:2px;box-shadow:0 0 8px rgba(14,165,233,.5)}
.yb-dot{width:5px;height:5px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;box-shadow:0 0 8px rgba(14,165,233,.5)}
.yb-price{background:#fff;color:#0ea5e9;font-size:10px;font-weight:900;padding:2px 6px;border-radius:6px;border:1.5px solid #0ea5e9;white-space:nowrap;margin-top:3px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.yb-pin{display:flex;flex-direction:column;align-items:center}
/* CARROUSEL PHOTOS */
.photo-dot{width:6px;height:6px;border-radius:50%;background:#cbd5e1;transition:all .2s;cursor:pointer}
.photo-dot.on{background:#0ea5e9;width:18px;border-radius:3px}
/* SOCIAL SHARE */
.share-btn{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;transition:transform .12s}
.share-btn:active{transform:scale(.88)}
.share-btn .sb-icon{width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:20px}
.share-btn span{font-size:10px;font-weight:700;color:#64748b}
/* COINS */
/* OFFER */
.offer-input{font-size:28px;font-weight:900;color:#0ea5e9;text-align:center;background:none;border:none;outline:none;width:100%;font-family:inherit}
/* HISTORY */
.hist-item{display:flex;align-items:center;gap:10px;padding:8px;background:#f8fafc;border-radius:10px;cursor:pointer;margin-bottom:6px;border:1px solid #e8ecf0;transition:background .12s}
.hist-item:hover{background:#eff9ff}
/* SELLER SHEET */
.sp-stat{text-align:center;background:#f8fafc;border-radius:12px;padding:10px;flex:1;border:1px solid #e8ecf0}
/* REPORT */
.report-reason{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f8fafc;border:1px solid #e8ecf0;border-radius:10px;cursor:pointer;margin-bottom:6px;font-size:13px;font-weight:600;transition:all .12s}
.report-reason:hover{background:#fef2f2;border-color:#fecaca;color:#dc2626}
/* PHOTO THUMBS */
.photo-thumb{width:60px;height:60px;border-radius:10px;object-fit:cover;border:2px solid #e2e8f0;cursor:pointer;flex-shrink:0;transition:border-color .12s}
.photo-thumb.active{border-color:#0ea5e9;box-shadow:0 0 0 2px rgba(14,165,233,.3)}
/* PAY 3X */
.pay3x-option{border:1.5px solid #e2e8f0;border-radius:12px;padding:10px 12px;cursor:pointer;transition:all .12s;margin-bottom:6px}
.pay3x-option.selected{border-color:#0ea5e9;background:#eff9ff}
/* SEARCH PHOTO BTN */
.search-photo-btn{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#0ea5e9,#6366f1);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .12s}
.search-photo-btn:hover{opacity:.85}
</style>
</head>
<body>
<div id="dbg"></div>

<!-- SPLASH / LANDING -->
<div id="splash" class="fixed inset-0 z-[999]" style="background:#f0f2f5;display:flex;align-items:stretch">

  <!-- GAUCHE: demo visuelle -->
  <div id="landing-left" style="flex:1;background:linear-gradient(150deg,#0f172a 0%,#1e3a5f 55%,#0369a1 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px 32px;position:relative;overflow:hidden;min-width:0">
    <!-- Blobs deco -->
    <div style="position:absolute;top:-100px;right:-100px;width:350px;height:350px;background:rgba(14,165,233,.18);border-radius:50%;filter:blur(50px);pointer-events:none"></div>
    <div style="position:absolute;bottom:-80px;left:-80px;width:250px;height:250px;background:rgba(99,102,241,.15);border-radius:50%;filter:blur(40px);pointer-events:none"></div>

    <!-- LOGO GRAND BLANC VISIBLE -->
    <div style="margin-bottom:24px">
      <div style="display:inline-flex;align-items:flex-end;font-family:'DM Sans',sans-serif;font-weight:800;font-size:48px;color:#ffffff;letter-spacing:-1px;user-select:none;line-height:1">
        <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:5px;margin:0 5px 6px 5px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble .9s infinite;--b:-12px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble 1.3s infinite .2s;--b:-16px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble 1.1s infinite .5s;--b:-14px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span></span>
        <span>Z</span>
      </div>
      <p style="color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:5px;letter-spacing:.3px">Le marketplace IA nouvelle g√©n√©ration</p>
    </div>

    <h1 style="color:#fff;font-size:32px;font-weight:800;line-height:1.25;margin-bottom:32px">Vends et ach√®te<br><span style="color:#38bdf8">plus intelligemment.</span></h1>

    <!-- Cartes flottantes -->
    <div style="position:relative;height:480px;width:100%;max-width:420px">
      <div style="position:absolute;left:0;top:0;background:#fff;border-radius:22px;padding:14px;width:260px;box-shadow:0 20px 60px rgba(0,0,0,.4);transform:rotate(-5deg);animation:floatA 4s ease-in-out infinite">
        <div style="height:170px;background:#f1f5f9;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:10px"><i class="fa-solid fa-mobile-screen" style="font-size:64px;color:#94a3b8"></i></div>
        <p style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:2px">iPhone 14 Pro</p>
        <p style="font-size:18px;font-weight:900;color:#0ea5e9">750‚Ç¨</p>
        <div style="position:absolute;top:10px;right:10px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:800;padding:2px 5px;border-radius:99px">Neuf</div>
      </div>
      <div style="position:absolute;left:140px;top:24px;background:#fff;border-radius:22px;padding:14px;width:260px;box-shadow:0 20px 60px rgba(0,0,0,.4);transform:rotate(3deg);animation:floatB 5s ease-in-out infinite">
        <div style="height:170px;background:#fef9c3;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:10px"><i class="fa-brands fa-playstation" style="font-size:68px;color:#1e293b"></i></div>
        <p style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:2px">PS5 + manette</p>
        <p style="font-size:18px;font-weight:900;color:#0ea5e9">430‚Ç¨</p>
        <div style="position:absolute;top:10px;right:10px;background:#22c55e;color:#fff;font-size:7px;font-weight:800;padding:2px 5px;border-radius:99px">‚óè Live</div>
      </div>
      <div style="position:absolute;left:8px;top:300px;background:#fff;border-radius:22px;padding:14px;width:220px;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:floatC 6s ease-in-out infinite">
        <div style="height:120px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-radius:14px;margin-bottom:10px;position:relative;display:flex;align-items:center;justify-content:center">
          <i class="fa-solid fa-map" style="font-size:26px;color:#3b82f6;opacity:.3"></i>
          <div style="position:absolute;top:14px;left:28px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">180‚Ç¨</div>
          <div style="position:absolute;top:36px;right:18px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">430‚Ç¨</div>
          <div style="position:absolute;bottom:10px;left:55px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">95‚Ç¨</div>
        </div>
        <p style="font-size:10px;font-weight:700;color:#64748b"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;margin-right:3px"></i>Annonces pr√®s de toi</p>
      </div>
      <div style="position:absolute;right:8px;top:310px;background:linear-gradient(135deg,#0ea5e9,#6366f1);border-radius:16px;padding:14px 18px;box-shadow:0 8px 24px rgba(14,165,233,.5);animation:floatA 3.5s ease-in-out infinite reverse">
        <p style="color:#fff;font-size:13px;font-weight:800;margin-bottom:2px"><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:5px"></i>IA Gemini</p>
        <p style="color:rgba(255,255,255,.6);font-size:11px">Prix estim√© en 3s</p>
      </div>
    </div>
  </div>

  <!-- DROITE: auth -->
  <div id="landing-right" style="width:100%;max-width:400px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 32px;overflow-y:auto">

    <!-- Logo mobile only -->
    <div id="logo-mobile" style="margin-bottom:28px">
      <div style="display:inline-flex;align-items:flex-end;font-family:'DM Sans',sans-serif;font-weight:800;font-size:32px;color:#0f172a;letter-spacing:-1px;line-height:1">
        <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px 4px 4px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble .9s infinite;--b:-9px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble 1.3s infinite .2s;--b:-11px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble 1.1s infinite .5s;--b:-10px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span></span>
        <span>Z</span>
      </div>
    </div>

    <div style="width:100%;max-width:320px">

      <!-- Toggle login/register -->
      <div style="display:flex;background:#f1f5f9;border-radius:12px;padding:4px;margin-bottom:24px">
        <button id="tab-login" onclick="showTab('login')" style="flex:1;padding:8px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;background:#fff;color:#0f172a;box-shadow:0 1px 4px rgba(0,0,0,.1);transition:all .15s">Connexion</button>
        <button id="tab-register" onclick="showTab('register')" style="flex:1;padding:8px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;background:transparent;color:#94a3b8;transition:all .15s">Cr√©er un compte</button>
      </div>

      <!-- CONNEXION -->
      <div id="panel-login">
        <h2 style="font-size:22px;font-weight:800;color:#0f172a;margin-bottom:4px">Bon retour !</h2>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:20px;font-weight:500">Connecte-toi √† ton compte Youbiiiz</p>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Email</label>
          <input id="login-email" type="email" placeholder="ton@email.com" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:20px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Mot de passe</label>
          <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter')doLogin()">
        </div>
        <button onclick="doLogin()" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-size:14px;font-weight:800;padding:13px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,.4);margin-bottom:12px;transition:opacity .15s" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">Se connecter</button>
        <button onclick="doGoogle()" style="width:100%;background:#fff;color:#1e293b;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Continuer avec Google
        </button>
        <div style="text-align:center;margin-top:4px">
          <button onclick="doAnon()" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;color:#475569;display:flex;align-items:center;justify-content:center;gap:6px;margin-top:4px" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'"><i class="fa-solid fa-eye" style="font-size:12px"></i>Parcourir sans compte</button>
        </div>
      </div>

      <!-- INSCRIPTION -->
      <div id="panel-register" style="display:none">
        <h2 style="font-size:22px;font-weight:800;color:#0f172a;margin-bottom:4px">Cr√©er un compte</h2>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:20px;font-weight:500">Rejoins des milliers de vendeurs</p>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Email</label>
          <input id="reg-email" type="email" placeholder="ton@email.com" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Mot de passe</label>
          <input id="reg-password" type="password" placeholder="Min. 6 caract√®res" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:20px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Confirmer</label>
          <input id="reg-confirm" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter')doRegister()">
        </div>
        <button onclick="doRegister()" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-size:14px;font-weight:800;padding:13px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,.4);margin-bottom:12px;transition:opacity .15s" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">Cr√©er mon compte</button>
        <button onclick="doGoogle()" style="width:100%;background:#fff;color:#1e293b;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Continuer avec Google
        </button>
      </div>

      <!-- Message erreur/info -->
      <div id="auth-msg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:10px;font-size:12px;font-weight:700;text-align:center"></div>
    </div>
  </div>
</div>

<style>
@keyframes floatA{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-12px) rotate(-5deg)}}
@keyframes floatB{0%,100%{transform:translateY(0) rotate(3deg)}50%{transform:translateY(-16px) rotate(3deg)}}
@keyframes floatC{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
</style>

<!-- APP -->
<div id="app" class="hidden opacity-0 transition-opacity duration-500 fixed inset-0 flex flex-col" style="background:#f4f6f8">

  <!-- HEADER WHATNOT STYLE -->
  <header class="yb-header shrink-0">
    <!-- Logo -->
    <div style="display:inline-flex;align-items:flex-end;font-family:'DM Sans',sans-serif;font-weight:800;font-size:20px;color:#0f172a;letter-spacing:-.5px;line-height:1;cursor:pointer;user-select:none;flex-shrink:0;margin-right:8px" onclick="switchView('home')">
      <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:2px;margin:0 2px 2px 2px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble .9s infinite;--b:-6px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble 1.3s infinite .2s;--b:-8px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble 1.1s infinite .5s;--b:-7px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span></span>
      <span>Z</span>
    </div>

    <!-- Search -->
    <div class="yb-search" style="flex:1;max-width:520px">
      <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;font-size:12px;flex-shrink:0"></i>
      <input id="header-search" type="text" placeholder='Recherche IA : "iPhone 300‚Ç¨ Lyon bon √©tat"...' oninput="applyFilters()">
      <button class="search-photo-btn" onclick="openSearchByPhoto()" title="Rechercher par photo">
        <i class="fa-solid fa-camera" style="color:#fff;font-size:11px"></i>
      </button>
      <input type="file" id="search-photo-inp" accept="image/*" class="hidden" onchange="onSearchPhoto(this)">
    </div>

    <div style="flex:1"></div>

    <!-- Actions -->
    <button onclick="openScan()" style="background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;flex-shrink:0;box-shadow:0 2px 10px rgba(14,165,233,.35);transition:opacity .12s" onmouseover="this.style.opacity='.88'" onmouseout="this.style.opacity='1'">
      <i class="fa-solid fa-plus" style="font-size:11px"></i><span class="hidden md:inline">Vendre</span>
    </button>
    <button onclick="switchView('notifications')" class="yb-icon-btn relative" style="margin-left:6px">
      <i class="fa-solid fa-bell" style="font-size:14px;color:#475569"></i>
      <span id="nbadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white" style="font-size:9px;font-weight:900;display:none;align-items:center;justify-content:center">0</span>
    </button>
    <button onclick="switchView('profile')" style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#6366f1);display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;flex-shrink:0;margin-left:6px">
      <i class="fa-solid fa-user" style="color:#fff;font-size:12px"></i>
    </button>
  </header>

  <!-- VISITOR BANNER -->
  <div id="visitor-banner" class="hidden" style="background:linear-gradient(90deg,#0ea5e9,#6366f1);padding:6px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
    <p style="font-size:11px;font-weight:700;color:#fff"><i class="fa-solid fa-eye mr-1.5"></i>Mode visiteur ‚Äî Cr√©e un compte pour vendre et acheter</p>
    <button onclick="doLogout()" style="background:rgba(255,255,255,.2);border:none;color:#fff;font-size:10px;font-weight:700;padding:3px 10px;border-radius:99px;cursor:pointer">Connexion</button>
  </div>

  <!-- APP BODY = SIDEBAR + MAIN -->
  <div class="app-body">

    <!-- SIDEBAR -->
    <aside class="sidebar no-sb">
      <!-- Greeting -->
      <div style="padding:16px 16px 8px">
        <p style="font-size:13px;font-weight:800;color:#0f172a;margin-bottom:2px">Bonjour üëã</p>
        <p id="sidebar-uid" style="font-size:11px;color:#94a3b8;font-weight:500"></p>
      </div>

      <p class="sidebar-section-title">Navigation</p>
      <div class="sidebar-nav-item active" id="snav-home" onclick="switchView('home');setSidebarActive('snav-home')">
        <span class="icon"><i class="fa-solid fa-house"></i></span>Pour toi
      </div>
      <div class="sidebar-nav-item" id="snav-map" onclick="switchView('map');setSidebarActive('snav-map')">
        <span class="icon"><i class="fa-solid fa-map-location-dot"></i></span>Carte
      </div>
      <div class="sidebar-nav-item" id="snav-notif" onclick="switchView('notifications');setSidebarActive('snav-notif')">
        <span class="icon"><i class="fa-solid fa-bell"></i></span>Notifications
      </div>
      <div class="sidebar-nav-item" id="snav-profile" onclick="switchView('profile');setSidebarActive('snav-profile')">
        <span class="icon"><i class="fa-solid fa-user"></i></span>Mon profil
      </div>

      <p class="sidebar-section-title">Cat√©gories</p>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('all',this)"><span class="icon">‚ú®</span>Tout voir</div>

      <!-- √âLECTRONIQUE -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-elec')">
          <span class="icon">üì±</span><span class="sb-group-label">√âlectronique</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-elec"></i>
        </div>
        <div class="sb-sublist hidden" id="g-elec">
          <div class="sb-subitem" onclick="filterCatSidebar('T√©l√©phones & objets connect√©s',this)">T√©l√©phones & objets connect√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires t√©l√©phones',this)">Accessoires t√©l√©phones</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Ordinateurs',this)">Ordinateurs</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires informatique',this)">Accessoires informatique</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Tablettes & liseuses',this)">Tablettes & liseuses</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Photo, audio & vid√©o',this)">Photo, audio & vid√©o</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Consoles',this)">Consoles</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jeux vid√©o',this)">Jeux vid√©o</div>
        </div>
      </div>

      <!-- MODE (adulte uniquement) -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-mode')">
          <span class="icon">üëó</span><span class="sb-group-label">Mode</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-mode"></i>
        </div>
        <div class="sb-sublist hidden" id="g-mode">
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements homme',this)">V√™tements homme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements femme',this)">V√™tements femme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chaussures homme',this)">Chaussures homme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chaussures femme',this)">Chaussures femme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires & Bagagerie',this)">Accessoires & Bagagerie</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Montres & Bijoux',this)">Montres & Bijoux</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Lunettes',this)">Lunettes</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Beaut√© & Bien-√™tre',this)">Beaut√© & Bien-√™tre</div>
        </div>
      </div>

      <!-- FAMILLE / ENFANTS -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-famille')">
          <span class="icon">üë∂</span><span class="sb-group-label">Famille</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-famille"></i>
        </div>
        <div class="sb-sublist hidden" id="g-famille">
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements b√©b√©',this)">V√™tements b√©b√© (0‚Äì2 ans)</div>
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements enfant',this)">V√™tements enfant (2‚Äì14 ans)</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chaussures enfant',this)">Chaussures enfant</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement b√©b√©',this)">√âquipement b√©b√©</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Mobilier enfant',this)">Mobilier enfant</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jeux & Jouets',this)">Jeux & Jouets</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Pu√©riculture',this)">Pu√©riculture</div>
        </div>
      </div>

      <!-- MAISON & JARDIN -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-maison')">
          <span class="icon">üè†</span><span class="sb-group-label">Maison & Jardin</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-maison"></i>
        </div>
        <div class="sb-sublist hidden" id="g-maison">
          <div class="sb-subitem" onclick="filterCatSidebar('Ameublement',this)">Ameublement</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âlectrom√©nager',this)">√âlectrom√©nager</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Arts de la table',this)">Arts de la table</div>
          <div class="sb-subitem" onclick="filterCatSidebar('D√©coration',this)">D√©coration</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Linge de maison',this)">Linge de maison</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Bricolage',this)">Bricolage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Outillage',this)">Outillage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jardin & Plantes',this)">Jardin & Plantes</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Papeterie & fournitures',this)">Papeterie & fournitures</div>
        </div>
      </div>

      <!-- LOISIRS -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-loisirs')">
          <span class="icon">üé≠</span><span class="sb-group-label">Loisirs</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-loisirs"></i>
        </div>
        <div class="sb-sublist hidden" id="g-loisirs">
          <div class="sb-subitem" onclick="filterCatSidebar('Livres',this)">Livres</div>
          <div class="sb-subitem" onclick="filterCatSidebar('DVD - Films',this)">DVD - Films</div>
          <div class="sb-subitem" onclick="filterCatSidebar('CD - Musique',this)">CD - Musique</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Instruments de musique',this)">Instruments de musique</div>
          <div class="sb-subitem" onclick="filterCatSidebar('V√©los',this)">V√©los</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipements v√©los',this)">√âquipements v√©los</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Sport & Hobbies',this)">Sport & Hobbies</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chasse & P√™che',this)">Chasse & P√™che</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Collection',this)">Collection</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Vins & Gastronomie',this)">Vins & Gastronomie</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Loisirs cr√©atifs',this)">Loisirs cr√©atifs</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Antiquit√©s',this)">Antiquit√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Mod√©lisme',this)">Mod√©lisme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Camping & Plein air',this)">Camping & Plein air</div>
        </div>
      </div>

      <!-- ANIMAUX -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-animaux')">
          <span class="icon">üêæ</span><span class="sb-group-label">Animaux</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-animaux"></i>
        </div>
        <div class="sb-sublist hidden" id="g-animaux">
          <div class="sb-subitem" onclick="filterCatSidebar('Chiens',this)">Chiens</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chats',this)">Chats</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chevaux & √âquid√©s',this)">Chevaux & √âquid√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Oiseaux',this)">Oiseaux</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Rongeurs & Lapins',this)">Rongeurs & Lapins</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Reptiles & Amphibiens',this)">Reptiles & Amphibiens</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Poissons',this)">Poissons</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires animaux',this)">Accessoires animaux</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Alimentation animaux',this)">Alimentation animaux</div>
        </div>
      </div>

      <!-- V√âHICULES -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-vehicules')">
          <span class="icon">üöó</span><span class="sb-group-label">V√©hicules</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-vehicules"></i>
        </div>
        <div class="sb-sublist hidden" id="g-vehicules">
          <div class="sb-subitem" onclick="filterCatSidebar('Voitures',this)">Voitures</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Motos',this)">Motos</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Scooters & V√©los √©lectriques',this)">Scooters & V√©los √©lec.</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Utilitaires',this)">Utilitaires</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Caravaning',this)">Caravaning</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Nautisme',this)">Nautisme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement auto',this)">√âquipement auto</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement moto',this)">√âquipement moto</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement caravaning',this)">√âquipement caravaning</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Pi√®ces d√©tach√©es auto',this)">Pi√®ces d√©tach√©es auto</div>
        </div>
      </div>

      <!-- IMMOBILIER -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-immo')">
          <span class="icon">üè¢</span><span class="sb-group-label">Immobilier</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-immo"></i>
        </div>
        <div class="sb-sublist hidden" id="g-immo">
          <div class="sb-subitem" onclick="filterCatSidebar('Ventes immobili√®res',this)">Ventes immobili√®res</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Locations',this)">Locations</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Colocations',this)">Colocations</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Bureaux & Commerces',this)">Bureaux & Commerces</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Terrains & Propri√©t√©s',this)">Terrains & Propri√©t√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Locations de vacances',this)">Locations de vacances</div>
        </div>
      </div>

      <!-- SERVICES -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-services')">
          <span class="icon">üõ†Ô∏è</span><span class="sb-group-label">Services</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-services"></i>
        </div>
        <div class="sb-sublist hidden" id="g-services">
          <div class="sb-subitem" onclick="filterCatSidebar('Cours particuliers',this)">Cours particuliers</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Formation professionnelle',this)">Formation professionnelle</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Covoiturage',this)">Covoiturage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Prestations de services',this)">Prestations de services</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Services √©v√©nementiels',this)">Services √©v√©nementiels</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Service √† la personne',this)">Service √† la personne</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Baby-sitting',this)">Baby-sitting</div>
          <div class="sb-subitem" onclick="filterCatSidebar('D√©m√©nagement',this)">D√©m√©nagement</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jardinage',this)">Jardinage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Bricolage & R√©paration',this)">Bricolage & R√©paration</div>
        </div>
      </div>

      <!-- MAT√âRIEL PRO -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-pro')">
          <span class="icon">üè≠</span><span class="sb-group-label">Mat√©riel Pro</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-pro"></i>
        </div>
        <div class="sb-sublist hidden" id="g-pro">
          <div class="sb-subitem" onclick="filterCatSidebar('Mat√©riel agricole',this)">Mat√©riel agricole</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Tracteurs',this)">Tracteurs</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Poids lourds',this)">Poids lourds</div>
          <div class="sb-subitem" onclick="filterCatSidebar('BTP - Chantier',this)">BTP - Chantier</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Manutention - Levage',this)">Manutention - Levage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipements industriels',this)">√âquipements industriels</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Restauration - H√¥tellerie',this)">Restauration - H√¥tellerie</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Fournitures de bureau',this)">Fournitures de bureau</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Mat√©riel m√©dical',this)">Mat√©riel m√©dical</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipements commerces',this)">√âquipements commerces</div>
        </div>
      </div>

      <!-- Ville filter -->
      <p class="sidebar-section-title">Localisation</p>
      <div style="padding:4px 12px 8px">
        <div style="position:relative">
          <i class="fa-solid fa-location-dot" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#0ea5e9;font-size:10px"></i>
          <input id="city-inp" type="text" placeholder="Ville..." oninput="applyFilters()"
            style="width:100%;background:#f4f6f8;border:1.5px solid #e2e8f0;border-radius:9px;padding:8px 10px 8px 28px;font-size:12px;font-weight:600;color:#1a1a2e;outline:none;font-family:inherit;transition:border-color .15s"
            onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
      </div>

      <!-- Live badge -->
      <div style="margin:8px 12px;background:linear-gradient(135deg,rgba(14,165,233,.08),rgba(99,102,241,.08));border:1px solid rgba(14,165,233,.2);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:8px">
        <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;animation:pulse 1.5s infinite;flex-shrink:0"></span>
        <div>
          <p style="font-size:11px;font-weight:800;color:#0f172a">Live</p>
          <p style="font-size:10px;color:#64748b;font-weight:500">Annonces r√©centes</p>
        </div>
      </div>

      <!-- Footer sidebar -->
      <div style="flex:1"></div>
      <div style="padding:12px;border-top:1px solid #f1f5f9;margin-top:12px">
        <button onclick="doLogout()" style="width:100%;background:none;border:1px solid #fecaca;border-radius:9px;padding:8px;font-size:12px;font-weight:700;color:#ef4444;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-family:inherit">
          <i class="fa-solid fa-right-from-bracket" style="font-size:11px"></i>D√©connexion
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content no-sb" id="main-scroll">

    <!-- HOME -->
    <div id="view-home">
      <!-- Mobile only: category pills -->
      <div class="cat-pills md:hidden">
        <button class="cat-pill on" onclick="filterCat('all',this)">Tout</button>
        <button class="cat-pill" onclick="filterCat('T√©l√©phones',this)">üì± T√©l√©phones</button>
        <button class="cat-pill" onclick="filterCat('Ordinateurs',this)">üíª Ordinateurs</button>
        <button class="cat-pill" onclick="filterCat('Consoles',this)">üéÆ Consoles</button>
        <button class="cat-pill" onclick="filterCat('Jeux vid√©o',this)">üïπ Jeux vid√©o</button>
        <button class="cat-pill" onclick="filterCat('V√™tements',this)">üëó V√™tements</button>
        <button class="cat-pill" onclick="filterCat('Chaussures',this)">üëü Chaussures</button>
        <button class="cat-pill" onclick="filterCat('Montres',this)">‚åö Montres & Bijoux</button>
        <button class="cat-pill" onclick="filterCat('Ameublement',this)">üõã Ameublement</button>
        <button class="cat-pill" onclick="filterCat('√âlectrom√©nager',this)">üîå √âlectrom√©nager</button>
        <button class="cat-pill" onclick="filterCat('Bricolage',this)">üîß Bricolage</button>
        <button class="cat-pill" onclick="filterCat('Jardin',this)">üåø Jardin</button>
        <button class="cat-pill" onclick="filterCat('V√©los',this)">üö≤ V√©los</button>
        <button class="cat-pill" onclick="filterCat('Sport',this)">‚öΩ Sport</button>
        <button class="cat-pill" onclick="filterCat('Livres',this)">üìö Livres</button>
        <button class="cat-pill" onclick="filterCat('Chiens',this)">üê∂ Chiens</button>
        <button class="cat-pill" onclick="filterCat('Chats',this)">üê± Chats</button>
        <button class="cat-pill" onclick="filterCat('Voitures',this)">üöó Voitures</button>
        <button class="cat-pill" onclick="filterCat('Motos',this)">üèç Motos</button>
        <button class="cat-pill" onclick="filterCat('Jeux & Jouets',this)">üß∏ Jouets</button>
        <button class="cat-pill" onclick="filterCat('√âquipement b√©b√©',this)">üë∂ B√©b√©</button>
      </div>

      <!-- Section title -->
      <div style="padding:12px 16px 0;display:flex;align-items:center;justify-content:space-between">
        <p id="feed-section-title" style="font-size:16px;font-weight:800;color:#0f172a">Pour toi</p>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="width:7px;height:7px;background:#22c55e;border-radius:50%;display:inline-block;animation:pulse 1.5s infinite"></span>
          <span style="font-size:11px;color:#22c55e;font-weight:700">Live</span>
        </div>
      </div>

      <div id="feed" class="feed-grid">
        <div style="grid-column:1/-1;padding:56px 0;text-align:center">
          <i class="fa-solid fa-circle-notch animate-spin text-2xl" style="color:#94a3b8"></i>
        </div>
      </div>
    </div>

    <!-- CARTE -->
    <div id="view-map" class="hidden" style="position:relative;height:calc(100vh - 56px)">
      <div id="map-el" style="width:100%;height:100%;"></div>

      <!-- Compteur -->
      <div id="map-count" style="position:absolute;top:12px;left:12px;z-index:1000;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:6px 12px;font-size:11px;font-weight:700;color:#64748b;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.08);">
        <i class="fa-solid fa-circle" style="color:#0ea5e9;font-size:7px;margin-right:5px"></i><span id="map-count-txt">0 annonce</span>
      </div>

      <!-- Centrer -->
      <button onclick="centerMap()" style="position:absolute;top:12px;right:12px;z-index:1000;width:40px;height:40px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12)">
        <i class="fa-solid fa-location-crosshairs" style="color:#0ea5e9"></i>
      </button>

      <!-- Filtre rayon -->
      <div style="position:absolute;top:60px;right:12px;z-index:1000;display:flex;flex-direction:column;gap:6px;">
        <button onclick="setRadius(1)" id="r1" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">1km</button>
        <button onclick="setRadius(2)" id="r2" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">2km</button>
        <button onclick="setRadius(5)" id="r5" style="background:#0ea5e9;color:#000;border:none;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer">5km</button>
        <button onclick="setRadius(20)" id="r20" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">20km</button>
        <button onclick="setRadius(50)" id="r50" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">50km</button>
        <button onclick="setRadius(0)" id="r0" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">Tout</button>
      </div>

      <!-- Popup annonce -->
      <div id="map-popup" class="hidden" style="position:absolute;bottom:16px;left:12px;right:12px;background:#fff;border:1px solid #e2e8f0;border-radius:20px;padding:12px;z-index:1000;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,.15)">
        <img id="map-pop-img" style="width:56px;height:56px;border-radius:12px;object-fit:contain;background:#f8f8f8;flex-shrink:0">
        <div style="flex:1;min-width:0">
          <p id="map-pop-name" style="font-size:13px;color:#1e293b;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px"></p>
          <p id="map-pop-price" style="font-size:16px;font-weight:900;color:#0ea5e9;margin-bottom:2px"></p>
          <p style="font-size:10px;color:#94a3b8"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;margin-right:3px;font-size:9px"></i><span id="map-pop-city-txt" style="color:#64748b"></span></p>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <button id="map-pop-btn" style="background:#0ea5e9;color:#000;font-size:12px;font-weight:700;padding:8px 14px;border-radius:12px;border:none;cursor:pointer">Voir</button>
          <button onclick="document.getElementById('map-popup').classList.add('hidden')" style="background:transparent;color:#94a3b8;font-size:10px;border:none;cursor:pointer">Fermer</button>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="view-notifications" class="hidden px-4 pt-5 pb-24">
      <h2 style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:16px">Notifications</h2>
      <div id="notif-list">
        <p style="text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>
      </div>
    </div>

    <!-- PROFIL -->
    <div id="view-profile" class="hidden px-4 pt-5 pb-24">
      <h2 style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:16px">Mon Profil</h2>
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-white"></i>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <p class="font-extrabold text-sm" style="color:#0f172a">Mon Profil</p>
              <span id="profile-verified" class="verified-badge hidden"><i class="fa-solid fa-circle-check"></i> V√©rifi√©</span>
            </div>
            <p id="profile-uid" style="font-size:10px;color:#94a3b8;font-family:monospace;margin-top:2px">...</p>
          </div>
          <p id="user-badge" style="font-size:9px;color:#94a3b8;font-family:monospace"></p>
        </div>
        <div class="grid grid-cols-4 gap-2 mb-3">
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-count" style="font-size:18px;font-weight:900;color:#0ea5e9">0</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Annonces</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-views" style="font-size:18px;font-weight:900;color:#8b5cf6">0</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Vues</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-favs" style="font-size:18px;font-weight:900;color:#f43f5e">0</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Favoris</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-rating" style="font-size:18px;font-weight:900;color:#f59e0b">-</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Note</p>
          </div>
        </div>
        <!-- Valeur totale + boost -->
        <div class="boost-row">
          <div>
            <p style="font-size:12px;font-weight:700;color:#0f172a">Valeur en vente</p>
            <p id="profile-total" style="font-size:16px;font-weight:900;color:#0f172a">0‚Ç¨</p>
          </div>
          <div>
            <p style="font-size:10px;color:#64748b;margin-bottom:4px;text-align:right">Boost auto ‚ú®</p>
            <label class="toggle-sw">
              <input type="checkbox" id="boost-toggle" onchange="toggleBoost(this)">
              <div class="toggle-track"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Mes annonces -->
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <p style="font-size:13px;font-weight:800;color:#0f172a;margin-bottom:12px">Mes annonces</p>
        <div id="my-listings" class="grid grid-cols-2 gap-3"></div>
      </div>


<!-- PARTAGE R√âSEAUX SOCIAUX -->
<div id="share-modal" class="fixed inset-0 z-[900] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeShareModal()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8 bg-white">
    <div class="flex justify-center mb-3"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-5">
      <p class="font-extrabold text-base">Partager l'annonce</p>
      <button onclick="closeShareModal()" class="w-8 h-8 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-slate-500 text-sm"></i></button>
    </div>
    <!-- Preview -->
    <div id="share-preview" class="flex gap-3 bg-slate-50 border border-slate-100 rounded-2xl p-3 mb-5">
      <img id="share-prev-img" class="w-14 h-14 rounded-xl object-contain bg-white border border-slate-100 shrink-0">
      <div class="flex-1 min-w-0">
        <p id="share-prev-title" class="font-bold text-sm leading-tight truncate"></p>
        <p id="share-prev-price" class="text-sky-500 font-black text-base mt-0.5"></p>
        <p class="text-[10px] text-slate-400 mt-0.5">youbiiiz.app</p>
      </div>
    </div>
    <!-- R√©seaux -->
    <div class="grid grid-cols-4 gap-3 mb-5">
      <div class="share-btn" onclick="shareTo('whatsapp')">
        <div class="sb-icon" style="background:#dcfce7"><i class="fa-brands fa-whatsapp" style="color:#25D366;font-size:22px"></i></div>
        <span>WhatsApp</span>
      </div>
      <div class="share-btn" onclick="shareTo('facebook')">
        <div class="sb-icon" style="background:#dbeafe"><i class="fa-brands fa-facebook" style="color:#1877F2;font-size:22px"></i></div>
        <span>Facebook</span>
      </div>
      <div class="share-btn" onclick="shareTo('twitter')">
        <div class="sb-icon" style="background:#f1f5f9"><i class="fa-brands fa-x-twitter" style="color:#000;font-size:20px"></i></div>
        <span>X / Twitter</span>
      </div>
      <div class="share-btn" onclick="shareTo('telegram')">
        <div class="sb-icon" style="background:#e0f2fe"><i class="fa-brands fa-telegram" style="color:#0088CC;font-size:22px"></i></div>
        <span>Telegram</span>
      </div>
      <div class="share-btn" onclick="shareTo('instagram')">
        <div class="sb-icon" style="background:linear-gradient(135deg,#fcebfa,#fce8d5,#fde68a)"><i class="fa-brands fa-instagram" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:22px"></i></div>
        <span>Instagram</span>
      </div>
      <div class="share-btn" onclick="shareTo('tiktok')">
        <div class="sb-icon" style="background:#f1f5f9"><i class="fa-brands fa-tiktok" style="color:#000;font-size:20px"></i></div>
        <span>TikTok</span>
      </div>
      <div class="share-btn" onclick="shareTo('messenger')">
        <div class="sb-icon" style="background:#dbeafe"><i class="fa-brands fa-facebook-messenger" style="color:#0099FF;font-size:22px"></i></div>
        <span>Messenger</span>
      </div>
      <div class="share-btn" onclick="shareTo('sms')">
        <div class="sb-icon" style="background:#dcfce7"><i class="fa-solid fa-message" style="color:#22c55e;font-size:19px"></i></div>
        <span>SMS</span>
      </div>
    </div>
    <!-- Copier lien -->
    <div class="flex gap-2">
      <input id="share-link-val" class="inp flex-1 text-sm text-slate-500 bg-slate-50" readonly style="font-family:monospace">
      <button onclick="copyShareLink()" class="px-4 py-2.5 bg-sky-500 text-black font-bold text-sm rounded-xl active:scale-95 transition-transform whitespace-nowrap">
        <i class="fa-solid fa-copy mr-1"></i>Copier
      </button>
    </div>
  </div>
</div>

<!-- FAIRE UNE OFFRE -->
<div id="offer-modal" class="fixed inset-0 z-[800] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0" onclick="closeOffer()"></div>
  <div class="relative bg-white rounded-3xl p-6 w-full max-w-sm su text-center">
    <button onclick="closeOffer()" class="absolute top-4 right-4 w-8 h-8 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-slate-500 text-sm"></i></button>
    <div class="w-12 h-12 rounded-2xl bg-amber-50 flex items-center justify-center mx-auto mb-3">
      <i class="fa-solid fa-handshake text-amber-400 text-xl"></i>
    </div>
    <h3 class="font-extrabold text-base mb-1">Faire une offre</h3>
    <p id="offer-sub" class="text-slate-400 text-xs mb-5">Prix demand√© : <span id="offer-asked" class="font-bold text-sky-500"></span></p>
    <div class="flex items-center justify-center gap-2 mb-2">
      <span class="text-3xl font-black text-slate-300">‚Ç¨</span>
      <input id="offer-amount" type="number" class="offer-input" placeholder="0" style="width:120px">
    </div>
    <div id="offer-hint" class="text-[10px] text-slate-400 mb-5"></div>
    <!-- Suggestions rapides -->
    <div class="flex justify-center gap-2 mb-5" id="offer-quick"></div>
    <button onclick="sendOffer()" class="w-full bg-amber-400 text-black font-extrabold py-4 rounded-2xl text-[15px] active:scale-95 transition-transform">
      Envoyer l'offre
    </button>
  </div>
</div>

<!-- SIGNALER -->
<div id="report-modal" class="fixed inset-0 z-[800] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeReport()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8 bg-white">
    <div class="flex justify-center mb-3"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <p class="font-extrabold text-base mb-4"><i class="fa-solid fa-flag text-red-500 mr-2"></i>Signaler cette annonce</p>
    <div id="report-reasons">
      <div class="report-reason" onclick="submitReport('Arnaque / phishing')"><i class="fa-solid fa-skull-crossbones text-red-400 w-5 text-center"></i>Arnaque / phishing</div>
      <div class="report-reason" onclick="submitReport('Prix abusif / offre irr√©aliste')"><i class="fa-solid fa-tag text-orange-400 w-5 text-center"></i>Prix abusif ou irr√©aliste</div>
      <div class="report-reason" onclick="submitReport('Contenu interdit ou dangereux')"><i class="fa-solid fa-ban text-red-400 w-5 text-center"></i>Contenu interdit ou dangereux</div>
      <div class="report-reason" onclick="submitReport('Annonce dupliqu√©e / spam')"><i class="fa-solid fa-clone text-slate-400 w-5 text-center"></i>Annonce dupliqu√©e / spam</div>
      <div class="report-reason" onclick="submitReport('Photos vol√©es / trompeuses')"><i class="fa-solid fa-image text-slate-400 w-5 text-center"></i>Photos vol√©es ou trompeuses</div>
      <div class="report-reason" onclick="submitReport('Autre raison')"><i class="fa-solid fa-ellipsis text-slate-400 w-5 text-center"></i>Autre raison</div>
    </div>
  </div>
</div>

<!-- PROFIL VENDEUR -->
<div id="seller-profile-modal" class="fixed inset-0 z-[700] bg-white hidden flex-col sr">
  <div class="flex items-center gap-3 px-4 pt-5 pb-4 border-b border-slate-100 shrink-0">
    <button onclick="closeSellerProfile()" class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left text-slate-600 text-sm"></i>
    </button>
    <p class="font-extrabold text-base text-slate-900 flex-1">Profil vendeur</p>
  </div>
  <div class="flex-1 overflow-y-auto no-sb px-4 pt-5 pb-12">
    <div class="flex items-center gap-4 mb-5">
      <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
        <i class="fa-solid fa-user text-xl text-white"></i>
      </div>
      <div>
        <div class="flex items-center gap-2 flex-wrap">
          <p id="sp-name" class="font-extrabold text-lg text-slate-900"></p>
          <span id="sp-verified" class="verified-badge hidden"><i class="fa-solid fa-circle-check"></i> V√©rifi√©</span>
        </div>
        <p id="sp-since" class="text-xs text-slate-400 mt-0.5"></p>
      </div>
    </div>
    <div class="flex gap-3 mb-5">
      <div class="sp-stat"><p id="sp-count" class="text-xl font-black text-sky-500">0</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Annonces</p></div>
      <div class="sp-stat"><p id="sp-rating-val" class="text-xl font-black text-amber-400">‚Äî</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Note</p></div>
      
    </div>
    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide mb-3">Annonces actives</p>
    <div id="sp-listings" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"></div>
  </div>
</div>

<!-- RECHERCHE PAR PHOTO -->
<div id="search-photo-modal" class="fixed inset-0 z-[900] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0" onclick="closeSearchPhoto()"></div>
  <div class="relative bg-white rounded-3xl p-6 w-full max-w-sm su text-center">
    <button onclick="closeSearchPhoto()" class="absolute top-4 right-4 w-8 h-8 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-slate-500 text-sm"></i></button>
    <div id="sph-idle">
      <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-sky-500 to-indigo-500 flex items-center justify-center mx-auto mb-3">
        <i class="fa-solid fa-camera-retro text-white text-2xl"></i>
      </div>
      <h3 class="font-extrabold text-base mb-1">Recherche par photo</h3>
      <p class="text-slate-400 text-xs mb-5">Prends ou importe une photo d'un objet ‚Äî l'IA trouve les annonces similaires</p>
      <button onclick="document.getElementById('search-photo-inp').click()" class="w-full bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-bold py-3.5 rounded-2xl mb-2 active:scale-95 transition-transform">
        <i class="fa-solid fa-upload mr-2"></i>Importer une photo
      </button>
    </div>
    <div id="sph-loading" class="hidden">
      <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-sky-500 to-indigo-500 flex items-center justify-center mx-auto mb-3">
        <i class="fa-solid fa-circle-notch animate-spin text-white text-2xl"></i>
      </div>
      <p class="font-bold text-sm mb-1">Analyse en cours...</p>
      <p class="text-slate-400 text-xs">L'IA identifie l'objet et cherche des annonces similaires</p>
    </div>
    <div id="sph-results" class="hidden text-left">
      <p class="font-extrabold text-sm mb-1">R√©sultats pour :</p>
      <p id="sph-detected" class="text-sky-500 font-bold text-xs mb-3"></p>
      <div id="sph-list" class="flex flex-col gap-2 max-h-64 overflow-y-auto no-sb"></div>
      <button onclick="closeSearchPhoto()" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl mt-3 text-sm">Fermer</button>
    </div>
  </div>
</div>

<!-- SCAN MODAL -->
<div id="scan-modal" class="fixed inset-0 z-[400] hidden flex-col justify-end">
  <div class="mover absolute inset-0" onclick="closeScan()"></div>
  <div class="relative msheet su w-full max-w-lg mx-auto" style="background:#fff" style="max-height:94vh;display:flex;flex-direction:column;">
    <div class="flex justify-center pt-3 pb-2 shrink-0">
      <div class="w-10 h-1 bg-zinc-700 rounded-full"></div>
    </div>

    <!-- ETAPE 1: photo -->
    <div id="step-photo" class="px-4 pb-5 shrink-0">
      <div class="flex items-center justify-between mb-3">
        <p class="font-extrabold text-[15px]">Nouvelle annonce</p>
        <button onclick="closeScan()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center">
          <i class="fa-solid fa-xmark text-sm"></i>
        </button>
      </div>
      <div id="scan-box" class="relative bg-slate-800 rounded-2xl overflow-hidden mx-auto mb-3" style="width:100%;max-width:340px;aspect-ratio:1/1;">
        <video id="cam-vid" class="hidden absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
        <img id="scan-prev" class="hidden absolute inset-0 w-full h-full object-cover">
        <div id="scan-line" class="hidden absolute w-full left-0 z-20" style="height:2px;background:#0ea5e9;box-shadow:0 0 10px #22d3ee;animation:scanmove 1.8s linear infinite"></div>
        <div id="scan-ph" class="absolute inset-0 flex flex-col items-center justify-center gap-3 pointer-events-none">
          <div class="w-14 h-14 rounded-2xl bg-slate-700 flex items-center justify-center">
            <i class="fa-solid fa-camera text-2xl text-slate-400"></i>
          </div>
          <p class="text-xs text-slate-400 font-semibold">Photo ou galerie</p>
        </div>
        <div id="scan-spin" class="hidden absolute inset-0 bg-black/75 z-30 flex flex-col items-center justify-center gap-3">
          <i class="fa-solid fa-circle-notch animate-spin text-sky-500 text-3xl"></i>
          <p class="text-xs text-sky-500 font-bold tracking-widest uppercase">Analyse IA...</p>
        </div>
      </div>
      <div id="photo-btns" class="flex gap-2">
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="onFile(event)">
        <button onclick="document.getElementById('file-input').click()"
          class="flex-1 bg-slate-700 border border-slate-600/30 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-image text-slate-300"></i> Galerie
        </button>
        <button id="cam-toggle" onclick="toggleCam()"
          class="flex-1 bg-slate-700 border border-slate-600/30 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-camera text-slate-300"></i> Camera
        </button>
        <button id="snap-btn" onclick="snapPhoto()" class="hidden flex-1 bg-sky-500 rounded-xl py-3 text-sm font-bold text-black flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-circle"></i> Capturer
        </button>
      </div>
    </div>

    <!-- ETAPE 2: resultats IA -->
    <div id="step-result" class="hidden flex-col flex-1 overflow-hidden">
      <div class="overflow-y-auto no-sb px-4 pb-6 flex-1">
        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-slate-600/30">
          <img id="res-thumb" class="w-16 h-16 rounded-xl object-cover border border-slate-600/40 shrink-0">
          <div class="flex-1 min-w-0">
            <p class="text-[10px] text-green-400 font-bold uppercase tracking-wide mb-1"><i class="fa-solid fa-check-circle mr-1"></i>IA terminee</p>
            <input id="ai-name" class="w-full bg-transparent text-sm font-extrabold text-slate-800 outline-none border-b border-white/10 pb-1 focus:border-cyan-400 truncate">
          </div>
          <button onclick="resetScan()" class="shrink-0 w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center text-slate-300 active:scale-90 transition-transform">
            <i class="fa-solid fa-rotate-left text-xs"></i>
          </button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Marque</p>
            <p id="ai-brand" class="text-sm font-extrabold text-sky-500">-</p>
          </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Modele</p>
            <p id="ai-model" class="text-sm font-extrabold text-slate-800 truncate">-</p>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Prix</p>
            <p id="ai-price" class="text-sm font-extrabold text-sky-500">-</p>
          </div>
      <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Cat√©gorie</p>
          <select id="ai-cat-select" class="inp" style="cursor:pointer;font-size:12px">
            <optgroup label="üì± √âlectronique">
              <option>T√©l√©phones & objets connect√©s</option>
              <option>Accessoires t√©l√©phones</option>
              <option>Ordinateurs</option>
              <option>Accessoires informatique</option>
              <option>Tablettes & liseuses</option>
              <option>Photo, audio & vid√©o</option>
              <option>Consoles</option>
              <option>Jeux vid√©o</option>
            </optgroup>
            <optgroup label="üëó Mode">
              <option>V√™tements homme</option>
              <option>V√™tements femme</option>
              <option>Chaussures homme</option>
              <option>Chaussures femme</option>
              <option>Accessoires & Bagagerie</option>
              <option>Montres & Bijoux</option>
              <option>Lunettes</option>
              <option>Beaut√© & Bien-√™tre</option>
            </optgroup>
            <optgroup label="üë∂ Famille">
              <option>V√™tements b√©b√©</option>
              <option>V√™tements enfant</option>
              <option>Chaussures enfant</option>
              <option>√âquipement b√©b√©</option>
              <option>Mobilier enfant</option>
              <option>Jeux & Jouets</option>
              <option>Pu√©riculture</option>
            </optgroup>
            <optgroup label="üè† Maison & Jardin">
              <option>Ameublement</option>
              <option>√âlectrom√©nager</option>
              <option>Arts de la table</option>
              <option>D√©coration</option>
              <option>Linge de maison</option>
              <option>Bricolage</option>
              <option>Outillage</option>
              <option>Jardin & Plantes</option>
              <option>Papeterie & fournitures</option>
            </optgroup>
            <optgroup label="üé≠ Loisirs">
              <option>Livres</option>
              <option>DVD - Films</option>
              <option>CD - Musique</option>
              <option>Instruments de musique</option>
              <option>V√©los</option>
              <option>√âquipements v√©los</option>
              <option>Sport & Hobbies</option>
              <option>Chasse & P√™che</option>
              <option>Collection</option>
              <option>Vins & Gastronomie</option>
              <option>Loisirs cr√©atifs</option>
              <option>Antiquit√©s</option>
              <option>Mod√©lisme</option>
              <option>Camping & Plein air</option>
            </optgroup>
            <optgroup label="üêæ Animaux">
              <option>Chiens</option>
              <option>Chats</option>
              <option>Chevaux & √âquid√©s</option>
              <option>Oiseaux</option>
              <option>Rongeurs & Lapins</option>
              <option>Reptiles & Amphibiens</option>
              <option>Poissons</option>
              <option>Accessoires animaux</option>
              <option>Alimentation animaux</option>
            </optgroup>
            <optgroup label="üöó V√©hicules">
              <option>Voitures</option>
              <option>Motos</option>
              <option>Scooters & V√©los √©lectriques</option>
              <option>Utilitaires</option>
              <option>Caravaning</option>
              <option>Nautisme</option>
              <option>√âquipement auto</option>
              <option>√âquipement moto</option>
              <option>√âquipement caravaning</option>
              <option>Pi√®ces d√©tach√©es auto</option>
            </optgroup>
            <optgroup label="üè¢ Immobilier">
              <option>Ventes immobili√®res</option>
              <option>Locations</option>
              <option>Colocations</option>
              <option>Bureaux & Commerces</option>
              <option>Terrains & Propri√©t√©s</option>
              <option>Locations de vacances</option>
            </optgroup>
            <optgroup label="üõ†Ô∏è Services">
              <option>Cours particuliers</option>
              <option>Formation professionnelle</option>
              <option>Covoiturage</option>
              <option>Prestations de services</option>
              <option>Services √©v√©nementiels</option>
              <option>Service √† la personne</option>
              <option>Baby-sitting</option>
              <option>D√©m√©nagement</option>
              <option>Jardinage</option>
              <option>Bricolage & R√©paration</option>
            </optgroup>
            <optgroup label="üè≠ Mat√©riel Pro">
              <option>Mat√©riel agricole</option>
              <option>Tracteurs</option>
              <option>Poids lourds</option>
              <option>BTP - Chantier</option>
              <option>Manutention - Levage</option>
              <option>√âquipements industriels</option>
              <option>Restauration - H√¥tellerie</option>
              <option>Fournitures de bureau</option>
              <option>Mat√©riel m√©dical</option>
              <option>√âquipements commerces</option>
            </optgroup>
          </select>
        </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Etat</p>
            <p id="ai-cond" class="text-xs font-extrabold text-green-400">-</p>
          </div>
        </div>
        <!-- Prix march√© IA -->
        <div id="price-suggestion" class="hidden bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <div class="flex items-center gap-2 mb-1">
            <i class="fa-solid fa-chart-line text-sky-400" style="font-size:10px"></i>
            <p class="text-[9px] text-slate-400 uppercase font-bold">Prix du march√©</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-slate-400">Similaires :</span>
            <span id="price-range-txt" class="text-xs font-bold text-sky-400"></span>
            <span id="price-verdict" class="text-[9px] font-bold px-2 py-0.5 rounded-full"></span>
          </div>
        </div>
        <!-- Photos suppl√©mentaires -->
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[9px] text-slate-400 uppercase font-bold">Photos (max 5)</p>
            <button onclick="document.getElementById('extra-photos-inp').click()" class="text-[10px] text-sky-400 font-bold bg-sky-500/10 px-2 py-1 rounded-lg">
              <i class="fa-solid fa-plus mr-1"></i>Ajouter
            </button>
          </div>
          <input type="file" id="extra-photos-inp" accept="image/*" multiple class="hidden" onchange="addExtraPhotos(this)">
          <div id="extra-photos-list" class="flex gap-2 overflow-x-auto no-sb pb-1 min-h-[40px]">
            <p class="text-[10px] text-slate-500 self-center">Aucune photo suppl√©mentaire</p>
          </div>
        </div>
        <!-- Troc -->
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="scan-troc" class="w-4 h-4 accent-amber-400">
            <span class="text-sm font-semibold flex-1">Proposer un √©change üîÑ</span>
            <span class="text-[10px] text-slate-400">Troc OK</span>
          </label>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Description</p>
          <textarea id="ai-desc" rows="3" class="w-full bg-transparent text-xs text-slate-200 outline-none resize-none leading-relaxed font-medium"></textarea>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Ville</p>
          <div class="relative">
            <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-sky-500" style="font-size:10px"></i>
            <input id="item-city" type="text" placeholder="Ex : Paris, Lyon..." class="inp pl-7 py-2 text-sm" style="background:#f8fafc;border-color:rgba(148,163,184,.10)">
          </div>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-4">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-2.5">Livraison</p>
          <div class="flex flex-col gap-3">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-hand" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Main propre</span>
              <span class="text-xs text-slate-400">Gratuit</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-relay" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Mondial Relay</span>
              <input type="number" id="sh-relay-p" value="5" class="w-14 bg-white border border-slate-600/40 rounded-lg px-2 py-1 text-xs text-center text-slate-800 outline-none">
              <span class="text-xs text-slate-400">euro</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-colis" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Colissimo</span>
              <input type="number" id="sh-colis-p" value="8" class="w-14 bg-white border border-slate-600/40 rounded-lg px-2 py-1 text-xs text-center text-slate-800 outline-none">
              <span class="text-xs text-slate-400">euro</span>
            </label>
          </div>
        </div>
        <button id="pub-btn" class="w-full bg-sky-500 text-black font-extrabold py-4 rounded-2xl text-[15px] active:scale-95 transition-transform shadow-[0_0_18px_rgba(34,211,238,.35)]">
          Publier l'annonce
        </button>
      </div>
    </div>
  </div>
  <canvas id="cap-canvas" class="hidden"></canvas>
</div>

<!-- DETAIL -->
<div id="detail-modal" class="fixed inset-0 z-[500] hidden flex-col" style="background:#f8fafc">

  <!-- Header -->
  <div style="background:#fff;border-bottom:1px solid #e2e8f0;padding:12px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0">
    <button onclick="closeDetail()" style="width:36px;height:36px;background:#f1f5f9;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0">
      <i class="fa-solid fa-arrow-left" style="color:#0f172a;font-size:13px"></i>
    </button>
    <p id="det-title" style="font-weight:800;font-size:14px;color:#0f172a;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></p>
    <button onclick="openShareModal()" style="width:36px;height:36px;background:#f1f5f9;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center">
      <i class="fa-solid fa-share-nodes" style="color:#0ea5e9;font-size:13px"></i>
    </button>
    <button onclick="toggleFavDetail()" id="det-fav-btn" style="width:36px;height:36px;background:#f1f5f9;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center">
      <i id="det-fav-icon" class="fa-regular fa-heart" style="color:#64748b;font-size:13px"></i>
    </button>
    <button onclick="openReport()" style="width:36px;height:36px;background:#f1f5f9;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center">
      <i class="fa-solid fa-flag" style="color:#94a3b8;font-size:13px"></i>
    </button>
  </div>

  <!-- Scroll area -->
  <div class="flex-1 overflow-y-auto no-sb" style="background:#f8fafc">

    <!-- Carrousel photo -->
    <div style="padding:12px 12px 6px">
      <div id="det-carousel-wrap" style="width:100%;height:300px;border-radius:20px;overflow:hidden;background:#e2e8f0;position:relative">
        <div id="det-carousel-track" style="display:flex;height:100%;transition:transform .3s cubic-bezier(.16,1,.3,1)"></div>
        <button id="det-prev" onclick="carNav(-1)" style="display:none;position:absolute;left:10px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:rgba(255,255,255,.9);border:none;border-radius:50%;color:#0f172a;font-size:11px;cursor:pointer;align-items:center;justify-content:center;z-index:2;box-shadow:0 2px 8px rgba(0,0,0,.15)"><i class="fa-solid fa-chevron-left"></i></button>
        <button id="det-next" onclick="carNav(1)"  style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:rgba(255,255,255,.9);border:none;border-radius:50%;color:#0f172a;font-size:11px;cursor:pointer;align-items:center;justify-content:center;z-index:2;box-shadow:0 2px 8px rgba(0,0,0,.15)"><i class="fa-solid fa-chevron-right"></i></button>
        <div id="det-views-badge" class="hidden" style="position:absolute;bottom:10px;left:10px;background:rgba(15,23,42,.65);color:#fff;font-size:9px;font-weight:700;padding:3px 9px;border-radius:99px;display:flex;align-items:center;gap:4px;z-index:2">
          <i class="fa-solid fa-eye" style="font-size:8px"></i><span id="det-views-count">0</span> vues
        </div>
      </div>
      <div id="det-dots" class="flex justify-center gap-1.5 mt-2 min-h-[10px]"></div>
      <div id="det-thumbs" class="flex gap-2 overflow-x-auto no-sb mt-2"></div>
    </div>

    <!-- Infos principales -->
    <div style="padding:0 16px 100px">

      <!-- Titre + prix -->
      <div style="background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;border:1px solid #e2e8f0">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px">
          <h2 id="det-title-big" style="font-weight:800;font-size:20px;color:#0f172a;line-height:1.2;flex:1"></h2>
          <p id="det-price" style="color:#0ea5e9;font-weight:900;font-size:22px;white-space:nowrap"></p>
        </div>
        <div id="det-price-range" class="hidden" style="margin-bottom:8px"></div>
        <!-- Badges -->
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
          <span id="det-cat"  style="font-size:10px;font-weight:700;color:#0ea5e9;background:#e0f2fe;padding:4px 10px;border-radius:99px"></span>
          <span id="det-cond" style="font-size:10px;font-weight:700;color:#0f172a;background:#f1f5f9;padding:4px 10px;border-radius:99px;border:1px solid #e2e8f0"></span>
          <span id="det-city-tag" class="hidden" style="font-size:10px;font-weight:700;color:#475569;background:#f1f5f9;padding:4px 10px;border-radius:99px;border:1px solid #e2e8f0">
            <i class="fa-solid fa-location-dot" style="color:#0ea5e9;font-size:8px;margin-right:3px"></i><span id="det-city-val"></span>
          </span>
          <span id="det-troc-tag" class="hidden troc-badge">üîÑ √âchange OK</span>
        </div>
        <p id="det-brand" style="font-size:11px;color:#94a3b8;font-family:monospace"></p>
        <!-- Alerte fraude -->
        <div id="det-fraud-warn" class="fraud-warn hidden">
          <i class="fa-solid fa-triangle-exclamation" style="color:#ef4444;font-size:13px;flex-shrink:0;margin-top:2px"></i>
          <div><p style="font-size:12px;font-weight:700;color:#dc2626">Prix inhabituel</p><p style="font-size:10px;color:#ef4444;margin-top:2px">Prix tr√®s bas par rapport au march√©. Pr√©f√©rez la remise en main propre.</p></div>
        </div>
      </div>

      <!-- Description -->
      <div style="background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;border:1px solid #e2e8f0">
        <p style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">Description</p>
        <p id="det-desc" style="font-size:13px;color:#334155;line-height:1.6"></p>
      </div>

      <!-- Livraison -->
      <div style="background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;border:1px solid #e2e8f0">
        <p style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px">Livraison</p>
        <div id="det-ship" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      </div>

      <!-- Score de confiance -->
      <div style="background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;border:1px solid #e2e8f0">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <div style="display:flex;align-items:center;gap:6px">
            <p style="font-size:12px;font-weight:800;color:#0f172a">Score de confiance</p>
            <span title="Analyse automatique : photo, description, ville, livraison, marque, √©tat" style="width:16px;height:16px;background:#e0f2fe;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;color:#0ea5e9;cursor:help;flex-shrink:0">?</span>
          </div>
          <span id="det-trust-label" style="font-size:11px;font-weight:700"></span>
        </div>
        <p style="font-size:10px;color:#94a3b8;margin-bottom:8px">Qualit√© de l'annonce analys√©e automatiquement</p>
        <div class="trust-bar"><div id="det-trust-fill" class="trust-fill" style="width:0%"></div></div>
        <div id="det-trust-details" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px"></div>
      </div>

      <!-- Vendeur -->
      <div id="det-seller-card" onclick="openSellerProfile()" style="background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;border:1px solid #e2e8f0;cursor:pointer">
        <p style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px">Vendeur</p>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#0ea5e9,#6366f1);display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <i class="fa-solid fa-user" style="color:#fff;font-size:14px"></i>
          </div>
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
              <p id="det-seller" style="font-weight:700;font-size:14px;color:#0f172a"></p>
              <span id="det-verified" class="verified-badge hidden"><i class="fa-solid fa-circle-check"></i> V√©rifi√©</span>
            </div>
            <p id="det-rating" style="font-size:10px;color:#f59e0b;margin-top:2px">Nouveau vendeur</p>
          </div>
          <i class="fa-solid fa-chevron-right" style="color:#cbd5e1;font-size:11px;flex-shrink:0"></i>
        </div>
      </div>

      <!-- Annonces similaires -->
      <div style="margin-bottom:16px">
        <p style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px">Annonces similaires</p>
        <div id="det-similar" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:4px"></div>
      </div>

      <!-- Boutons action -->
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button id="contact-btn" style="flex:1;background:#fff;border:1.5px solid #e2e8f0;border-radius:16px;padding:14px;font-size:13px;font-weight:700;color:#0f172a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
          <i class="fa-solid fa-message" style="font-size:11px;color:#0ea5e9"></i> Contacter
        </button>
        <button onclick="openOffer()" style="flex:1;background:#fff8f0;border:1.5px solid #fed7aa;border-radius:16px;padding:14px;font-size:13px;font-weight:700;color:#ea580c;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
          <i class="fa-solid fa-handshake" style="font-size:11px"></i> Faire offre
        </button>
      </div>
      <button id="buy-btn" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;border:none;border-radius:16px;padding:16px;font-size:15px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 20px rgba(14,165,233,.35)">
        <i class="fa-brands fa-stripe" style="font-size:18px"></i> Acheter maintenant
      </button>

    </div>
  </div>
</div>
<!-- CHAT -->
<div id="chat-modal" class="fixed inset-0 z-[600] bg-white hidden flex-col sr">
  <div class="flex items-center gap-3 px-3 pt-4 pb-3 bg-white border-b border-slate-600/30 shrink-0">
    <button onclick="closeChat()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
      <i class="fa-solid fa-user text-xs text-slate-800"></i>
    </div>
    <div class="flex-1">
      <p id="chat-seller" class="font-bold text-sm leading-none"></p>
      <p class="text-[10px] text-green-400 font-semibold mt-0.5">En ligne</p>
    </div>
  </div>
  <div class="px-3 py-2 bg-slate-800/50 border-b border-slate-600/30 flex gap-3 items-center shrink-0">
    <img id="chat-img" class="w-9 h-9 rounded-lg object-cover border border-slate-600/40 shrink-0">
    <div class="flex-1 min-w-0">
      <p id="chat-iname" class="text-xs font-bold truncate"></p>
      <p id="chat-iprice" class="text-xs text-sky-500 font-bold"></p>
    </div>
  </div>
  <div id="chat-msgs" class="flex-1 overflow-y-auto no-sb p-4 flex flex-col gap-3"></div>
  <!-- Suggestions IA contextuelles -->
  <div class="px-3 pt-2 bg-white shrink-0">
    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 tracking-wide"><i class="fa-solid fa-wand-magic-sparkles text-sky-400 mr-1"></i>IA sugg√®re</p>
    <div id="chat-suggestions" class="flex gap-2 overflow-x-auto no-sb pb-1"></div>
  </div>
  <div class="px-3 py-3 bg-white border-t border-slate-600/30 shrink-0">
    <div class="flex gap-2">
      <input id="chat-inp" type="text" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()" oninput="updateChatSuggestions()"
        class="flex-1 bg-slate-800 border border-slate-600/40 rounded-xl px-4 py-2.5 text-sm text-slate-800 placeholder-zinc-600 outline-none focus:border-sky-500">
      <button onclick="sendMsg()" class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center active:scale-90 transition-transform">
        <i class="fa-solid fa-paper-plane text-black text-xs"></i>
      </button>
    </div>
  </div>
</div>

<!-- PAIEMENT -->
<div id="pay-modal" class="fixed inset-0 z-[700] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closePay()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8">
    <div class="flex justify-center mb-4"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="w-7 h-7 rounded-lg bg-green-500/15 flex items-center justify-center">
          <i class="fa-solid fa-shield-halved text-green-400 text-xs"></i>
        </div>
        <span class="font-bold text-sm">Paiement securise</span>
      </div>
      <button onclick="closePay()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center">
        <i class="fa-solid fa-xmark text-sm"></i>
      </button>
    </div>
    <div class="flex gap-3 mb-4">
      <div id="pay-img" class="w-14 h-14 rounded-xl bg-slate-700 bg-cover bg-center shrink-0 border border-slate-600/40"></div>
      <div>
        <p id="pay-title" class="font-bold text-sm mb-1 leading-tight"></p>
        <p id="pay-price" class="text-sky-500 font-black text-lg"></p>
      </div>
    </div>
    <div id="pay-ship-wrap" class="hidden mb-3">
      <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">Choisir la livraison</p>
      <div id="pay-ship-list" class="flex flex-col gap-2"></div>
    </div>
    <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30 text-sm">
      <div class="flex justify-between mb-2"><span class="text-slate-300">Article</span><span id="pay-sub" class="font-bold"></span></div>
      <div class="flex justify-between mb-2"><span class="text-slate-300">Livraison</span><span id="pay-shipcost" class="font-bold">-</span></div>
      
      <div class="flex justify-between border-t border-slate-600/30 pt-3"><span class="font-bold">Total</span><span id="pay-total" class="font-extrabold text-sky-500 text-base"></span></div>
    </div>
    <!-- Paiement en plusieurs fois -->
    <div class="mb-4">
      <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">Mode de paiement</p>
      <div id="pay-mode-1x" class="pay3x-option selected" onclick="selectPayMode('1x')">
        <div class="flex items-center justify-between">
          <span class="text-sm font-bold">Paiement comptant</span>
          <span id="pay-1x-amount" class="text-sm font-extrabold text-sky-400"></span>
        </div>
      </div>
      <div id="pay-mode-3x" class="pay3x-option" onclick="selectPayMode('3x')">
        <div class="flex items-center justify-between">
          <div>
            <span class="text-sm font-bold">Paiement en 3√ó</span>
            <span class="text-[10px] text-green-400 font-bold ml-2">Sans frais</span>
          </div>
          <span id="pay-3x-amount" class="text-sm font-extrabold text-sky-400"></span>
        </div>
        <p id="pay-3x-detail" class="text-[10px] text-slate-400 mt-1"></p>
      </div>
    </div>
    <button id="stripe-btn" onclick="doStripe()" class="w-full bg-[#635bff] text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-transform">
      <i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant
    </button>
  </div>
</div>

<!-- NOTATION -->
<div id="rate-modal" class="fixed inset-0 z-[800] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-6 w-full max-w-xs border border-slate-600/40 text-center su">
    <div class="w-14 h-14 rounded-2xl bg-yellow-500/10 flex items-center justify-center mx-auto mb-3">
      <i class="fa-solid fa-star text-yellow-400 text-2xl"></i>
    </div>
    <h3 class="font-extrabold text-base mb-1">Laisser une note</h3>
    <p id="rate-sub" class="text-slate-400 text-xs mb-4">Comment s'est passee la transaction ?</p>
    <div class="flex justify-center gap-2 mb-4">
      <button onclick="setStar(1)" class="star text-3xl text-slate-600 transition-all" data-v="1">&#9733;</button>
      <button onclick="setStar(2)" class="star text-3xl text-slate-600 transition-all" data-v="2">&#9733;</button>
      <button onclick="setStar(3)" class="star text-3xl text-slate-600 transition-all" data-v="3">&#9733;</button>
      <button onclick="setStar(4)" class="star text-3xl text-slate-600 transition-all" data-v="4">&#9733;</button>
      <button onclick="setStar(5)" class="star text-3xl text-slate-600 transition-all" data-v="5">&#9733;</button>
    </div>
    <textarea id="rate-comment" placeholder="Commentaire (optionnel)" rows="2" class="inp text-sm mb-4 resize-none" style="font-size:13px"></textarea>
    <button onclick="submitRate()" class="w-full bg-yellow-400 text-black font-bold py-3.5 rounded-2xl mb-2 active:scale-95 transition-transform">Envoyer</button>
    <button onclick="closeRate()" class="w-full text-slate-400 text-sm py-2">Passer</button>
  </div>
</div>

<!-- EDIT -->
<div id="edit-modal" class="fixed inset-0 z-[600] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeEdit()"></div>
  <div class="relative msheet su w-full max-w-lg">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between px-4 pt-2 pb-3">
      <p class="font-extrabold text-[15px]">Modifier</p>
      <button onclick="closeEdit()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark text-sm"></i></button>
    </div>
    <div class="overflow-y-auto no-sb px-4 pb-8" style="max-height:65vh">
      <div class="mb-3"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Titre</p>
        <input id="edit-title" class="inp"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
        <div><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Prix (euro)</p>
          <input id="edit-price" type="number" class="inp text-sky-500 font-black"></div>
        <div><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Etat</p>
          <select id="edit-cond" class="inp" style="cursor:pointer">
            <option>Neuf</option><option>Tres bon etat</option><option>Bon etat</option><option>Etat correct</option>
          </select></div>
      </div>
      <div class="mb-3"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Cat√©gorie</p>
        <select id="edit-cat" class="inp" style="cursor:pointer;font-size:12px">
          <optgroup label="üì± √âlectronique">
            <option>T√©l√©phones & objets connect√©s</option>
            <option>Accessoires t√©l√©phones</option>
            <option>Ordinateurs</option>
            <option>Accessoires informatique</option>
            <option>Tablettes & liseuses</option>
            <option>Photo, audio & vid√©o</option>
            <option>Consoles</option>
            <option>Jeux vid√©o</option>
          </optgroup>
          <optgroup label="üëó Mode">
            <option>V√™tements homme</option>
            <option>V√™tements femme</option>
            <option>Chaussures homme</option>
            <option>Chaussures femme</option>
            <option>Accessoires & Bagagerie</option>
            <option>Montres & Bijoux</option>
            <option>Lunettes</option>
            <option>Beaut√© & Bien-√™tre</option>
          </optgroup>
          <optgroup label="üë∂ Famille">
            <option>V√™tements b√©b√©</option>
            <option>V√™tements enfant</option>
            <option>Chaussures enfant</option>
            <option>√âquipement b√©b√©</option>
            <option>Mobilier enfant</option>
            <option>Jeux & Jouets</option>
            <option>Pu√©riculture</option>
          </optgroup>
          <optgroup label="üè† Maison & Jardin">
            <option>Ameublement</option>
            <option>√âlectrom√©nager</option>
            <option>Arts de la table</option>
            <option>D√©coration</option>
            <option>Linge de maison</option>
            <option>Bricolage</option>
            <option>Outillage</option>
            <option>Jardin & Plantes</option>
            <option>Papeterie & fournitures</option>
          </optgroup>
          <optgroup label="üé≠ Loisirs">
            <option>Livres</option>
            <option>DVD - Films</option>
            <option>CD - Musique</option>
            <option>Instruments de musique</option>
            <option>V√©los</option>
            <option>√âquipements v√©los</option>
            <option>Sport & Hobbies</option>
            <option>Chasse & P√™che</option>
            <option>Collection</option>
            <option>Vins & Gastronomie</option>
            <option>Loisirs cr√©atifs</option>
            <option>Antiquit√©s</option>
            <option>Mod√©lisme</option>
            <option>Camping & Plein air</option>
          </optgroup>
          <optgroup label="üêæ Animaux">
            <option>Chiens</option>
            <option>Chats</option>
            <option>Chevaux & √âquid√©s</option>
            <option>Oiseaux</option>
            <option>Rongeurs & Lapins</option>
            <option>Reptiles & Amphibiens</option>
            <option>Poissons</option>
            <option>Accessoires animaux</option>
            <option>Alimentation animaux</option>
          </optgroup>
          <optgroup label="üöó V√©hicules">
            <option>Voitures</option>
            <option>Motos</option>
            <option>Scooters & V√©los √©lectriques</option>
            <option>Utilitaires</option>
            <option>Caravaning</option>
            <option>Nautisme</option>
            <option>√âquipement auto</option>
            <option>√âquipement moto</option>
            <option>√âquipement caravaning</option>
            <option>Pi√®ces d√©tach√©es auto</option>
          </optgroup>
          <optgroup label="üè¢ Immobilier">
            <option>Ventes immobili√®res</option>
            <option>Locations</option>
            <option>Colocations</option>
            <option>Bureaux & Commerces</option>
            <option>Terrains & Propri√©t√©s</option>
            <option>Locations de vacances</option>
          </optgroup>
          <optgroup label="üõ†Ô∏è Services">
            <option>Cours particuliers</option>
            <option>Formation professionnelle</option>
            <option>Covoiturage</option>
            <option>Prestations de services</option>
            <option>Services √©v√©nementiels</option>
            <option>Service √† la personne</option>
            <option>Baby-sitting</option>
            <option>D√©m√©nagement</option>
            <option>Jardinage</option>
            <option>Bricolage & R√©paration</option>
          </optgroup>
          <optgroup label="üè≠ Mat√©riel Pro">
            <option>Mat√©riel agricole</option>
            <option>Tracteurs</option>
            <option>Poids lourds</option>
            <option>BTP - Chantier</option>
            <option>Manutention - Levage</option>
            <option>√âquipements industriels</option>
            <option>Restauration - H√¥tellerie</option>
            <option>Fournitures de bureau</option>
            <option>Mat√©riel m√©dical</option>
            <option>√âquipements commerces</option>
          </optgroup>
        </select></div>
      <div class="mb-4"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Description</p>
        <textarea id="edit-desc" rows="3" class="inp resize-none"></textarea></div>
      <button id="edit-save" onclick="saveEdit()" class="w-full bg-sky-500 text-black font-bold py-4 rounded-2xl mb-2 active:scale-95 transition-transform">Sauvegarder</button>
      <button onclick="confirmDel(editingId)" class="w-full bg-red-500/8 border border-red-500/20 text-red-400 font-bold py-3.5 rounded-2xl text-sm active:scale-95 transition-transform">
        <i class="fa-solid fa-trash mr-2"></i>Supprimer
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div id="del-modal" class="fixed inset-0 z-[700] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-5 w-full max-w-xs border border-red-500/20 text-center su">
    <i class="fa-solid fa-trash text-red-400 text-2xl mb-3"></i>
    <p class="font-extrabold text-base mb-1">Supprimer ?</p>
    <p class="text-slate-400 text-xs mb-5">Cette action est definitive.</p>
    <div class="flex gap-2">
      <button onclick="closeDel()" class="flex-1 bg-slate-700 font-bold py-3 rounded-xl text-sm">Annuler</button>
      <button onclick="doDelete()" class="flex-1 bg-red-500 font-bold py-3 rounded-xl text-sm">Supprimer</button>
    </div>
  </div>
</div>

<!-- (search-photo-inp already declared in header) -->


<script>
// ‚îÄ‚îÄ FONCTIONS CRITIQUES UI (ind√©pendantes de Firebase) ‚îÄ‚îÄ
var __me = null; // partag√© avec le module Firebase

function showAuthMsg(msg, ok) {
  var el = document.getElementById("auth-msg");
  if (!el) return;
  el.style.display = "block";
  el.style.background = ok ? "#f0fdf4" : "#fef2f2";
  el.style.color = ok ? "#166534" : "#dc2626";
  el.style.border = ok ? "1px solid #bbf7d0" : "1px solid #fecaca";
  el.innerText = msg;
}
function hideAuthMsg() {
  var el = document.getElementById("auth-msg");
  if (el) el.style.display = "none";
}

function showTab(tab) {
  document.getElementById("panel-login").style.display = tab === "login" ? "block" : "none";
  document.getElementById("panel-register").style.display = tab === "register" ? "block" : "none";
  var tl = document.getElementById("tab-login");
  var tr = document.getElementById("tab-register");
  tl.style.background = tab === "login" ? "#fff" : "transparent";
  tl.style.color = tab === "login" ? "#0f172a" : "#94a3b8";
  tl.style.boxShadow = tab === "login" ? "0 1px 4px rgba(0,0,0,.1)" : "none";
  tr.style.background = tab === "register" ? "#fff" : "transparent";
  tr.style.color = tab === "register" ? "#0f172a" : "#94a3b8";
  tr.style.boxShadow = tab === "register" ? "0 1px 4px rgba(0,0,0,.1)" : "none";
  hideAuthMsg();
}


// Fallback si Firebase pas encore charg√©
function doLogin() {
  if (typeof window.__firebaseLogin === "function") {
    window.__firebaseLogin();
  } else {
    showAuthMsg("Chargement en cours... r√©essaie dans 2 secondes");
  }
}
function doRegister() {
  if (typeof window.__firebaseRegister === "function") {
    window.__firebaseRegister();
  } else {
    showAuthMsg("Chargement en cours... r√©essaie dans 2 secondes");
  }
}
function doGoogle() {
  if (typeof window.__firebaseGoogle === "function") {
    window.__firebaseGoogle();
  } else {
    showAuthMsg("Chargement en cours... r√©essaie dans 2 secondes");
  }
}
function doLogout() {
  if (typeof window.__firebaseLogout === "function") {
    window.__firebaseLogout();
  } else {
    // Visitor logout
    window.__visitorBooted = false;
    window.__me = null;
    document.getElementById("app").classList.add("hidden");
    document.getElementById("app").style.opacity = "0";
    document.getElementById("splash").style.display = "flex";
  }
}

// Mode visiteur : 100% sans Firebase
var __demoItems = [
  {id:"demo1",userId:"demo_seller_1",itemName:"iPhone 14 Pro 256Go Noir",price:699,category:"T√©l√©phones & objets connect√©s",condition:"Tr√®s bon √©tat",description:"iPhone 14 Pro 256Go Noir Spatial. Batterie 91%, aucune rayure. Vendu avec chargeur MagSafe et coque. Fonctionne parfaitement.",brand:"Apple",model:"iPhone 14 Pro",city:"Paris",lat:48.8566,lng:2.3522,imageUrl:"https://picsum.photos/seed/iphone14/400/400",shipping:[{method:"Main propre",price:0},{method:"Colissimo",price:8}],createdAt:{seconds:Math.floor(Date.now()/1000)-3600},views:42},
  {id:"demo2",userId:"demo_seller_2",itemName:"PlayStation 5 + 2 manettes",price:420,category:"Consoles",condition:"Bon √©tat",description:"PS5 √©dition disc avec 2 manettes DualSense. Peu utilis√©e, parfait √©tat. C√¢bles et bo√Æte inclus.",brand:"Sony",model:"PS5",city:"Lyon",lat:45.7640,lng:4.8357,imageUrl:"https://picsum.photos/seed/ps5demo/400/400",shipping:[{method:"Main propre",price:0},{method:"Mondial Relay",price:12}],createdAt:{seconds:Math.floor(Date.now()/1000)-7200},views:89},
  {id:"demo3",userId:"demo_seller_3",itemName:"MacBook Air M2 13 pouces",price:950,category:"Ordinateurs",condition:"Neuf",description:"MacBook Air M2 2022, 8Go RAM, 256Go SSD. Jamais ouvert, offert en cadeau. Facture disponible.",brand:"Apple",model:"MacBook Air M2",city:"Bordeaux",lat:44.8378,lng:-0.5792,imageUrl:"https://picsum.photos/seed/macbookm2/400/400",shipping:[{method:"Colissimo",price:15}],createdAt:{seconds:Math.floor(Date.now()/1000)-10800},views:167},
  {id:"demo4",userId:"demo_seller_4",itemName:"V√©lo √©lectrique Decathlon",price:680,category:"V√©los",condition:"Bon √©tat",description:"V√©lo √©lectrique autonomie 60km, frein √† disque. 2 saisons d'usage, pneus neufs.",brand:"Decathlon",model:"B Twin E-ST500",city:"Marseille",lat:43.2965,lng:5.3698,imageUrl:"https://picsum.photos/seed/veloelec/400/400",shipping:[{method:"Main propre",price:0}],createdAt:{seconds:Math.floor(Date.now()/1000)-14400},views:34},
  {id:"demo5",userId:"demo_seller_5",itemName:"Nike Air Jordan 1 Retro T42",price:185,category:"Chaussures homme",condition:"Tr√®s bon √©tat",description:"Jordan 1 Retro High OG Chicago 2022, T42. Port√©es 3 fois, bo√Æte et lacets originaux.",brand:"Nike",model:"Air Jordan 1",city:"Toulouse",lat:43.6047,lng:1.4442,imageUrl:"https://picsum.photos/seed/jordan1/400/400",shipping:[{method:"Mondial Relay",price:5},{method:"Colissimo",price:8}],createdAt:{seconds:Math.floor(Date.now()/1000)-18000},views:78},
  {id:"demo6",userId:"demo_seller_6",itemName:"Canap√© angle convertible gris",price:350,category:"Ameublement",condition:"Bon √©tat",description:"Canap√© d'angle convertible m√©ridienne droite, tissu gris anthracite avec coffre de rangement.",brand:"IKEA",model:"Friheten",city:"Nantes",lat:47.2184,lng:-1.5536,imageUrl:"https://picsum.photos/seed/canape/400/400",shipping:[{method:"Main propre",price:0}],createdAt:{seconds:Math.floor(Date.now()/1000)-21600},views:55},
  {id:"demo7",userId:"demo_seller_7",itemName:"Guitare acoustique Yamaha F310",price:90,category:"Instruments de musique",condition:"Bon √©tat",description:"Yamaha F310 taille 4/4, id√©ale pour d√©buter. Vendue avec housse et capodastre.",brand:"Yamaha",model:"F310",city:"Strasbourg",lat:48.5734,lng:7.7521,imageUrl:"https://picsum.photos/seed/guitare/400/400",shipping:[{method:"Main propre",price:0},{method:"Colissimo",price:12}],createdAt:{seconds:Math.floor(Date.now()/1000)-25200},views:23},
  {id:"demo8",userId:"demo_seller_8",itemName:"Dyson V11 Aspirateur balai",price:290,category:"√âlectrom√©nager",condition:"Tr√®s bon √©tat",description:"Dyson V11 Absolute Pro, batterie neuve. Livr√© avec toutes les t√™tes et support mural.",brand:"Dyson",model:"V11",city:"Lille",lat:50.6292,lng:3.0573,imageUrl:"https://picsum.photos/seed/dysonv11/400/400",shipping:[{method:"Main propre",price:0},{method:"Colissimo",price:18}],createdAt:{seconds:Math.floor(Date.now()/1000)-28800},views:91},
  {id:"demo9",userId:"demo_seller_9",itemName:"Rolex Datejust 36mm Cadran Vert",price:6800,category:"Montres & Bijoux",condition:"Tr√®s bon √©tat",description:"Rolex Datejust 36mm, lunette flut√©e or jaune, cadran vert. Ann√©e 2019, bo√Æte et papiers.",brand:"Rolex",model:"Datejust 36",city:"Paris",lat:48.8738,lng:2.2950,imageUrl:"https://picsum.photos/seed/rolex/400/400",shipping:[{method:"Main propre",price:0}],createdAt:{seconds:Math.floor(Date.now()/1000)-32400},views:203},
  {id:"demo10",userId:"demo_seller_10",itemName:"Lego Millennium Falcon 75192",price:480,category:"Jeux & Jouets",condition:"Neuf",description:"Lego 75192, 7541 pi√®ces, bo√Æte scell√©e jamais ouverte. Facture disponible.",brand:"Lego",model:"75192",city:"Nice",lat:43.7102,lng:7.2620,imageUrl:"https://picsum.photos/seed/lego75192/400/400",shipping:[{method:"Colissimo",price:20}],createdAt:{seconds:Math.floor(Date.now()/1000)-36000},views:312}
];

function __showView(v) {
  // Minimal switchView that works without the Firebase module
  ["home","map","notifications","profile"].forEach(function(n) {
    var el = document.getElementById("view-" + n);
    if (!el) return;
    if (n === "map") {
      el.style.display = n === v ? "block" : "none";
    } else {
      if (n === v) el.classList.remove("hidden");
      else el.classList.add("hidden");
    }
  });
}

function __renderDemoFeed() {
  var feed = document.getElementById("feed");
  if (!feed) return;
  feed.innerHTML = __demoItems.map(function(item) {
    var id = item.id;
    var isFav = typeof favorites !== "undefined" && favorites.has(id);
    return [
      '<div class="card fi" style="cursor:pointer" onclick="__openDemoItem(\"'+id+'\")">',
      '<div class="sq">',
      '<img src="'+item.imageUrl+'" loading="lazy" style="width:100%;height:100%;object-fit:cover">',
      '<span style="position:absolute;top:6px;left:7px;background:rgba(255,255,255,.93);color:#0ea5e9;font-size:9px;font-weight:800;padding:2px 8px;border-radius:99px">'+item.condition+'</span>',
      '<button onclick="event.stopPropagation();toggleFavCard(this,\"'+id+'\")" style="position:absolute;top:6px;right:7px;width:30px;height:30px;background:rgba(255,255,255,.93);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;font-size:14px;box-shadow:0 1px 6px rgba(0,0,0,.15);line-height:1">'+(isFav?'‚ù§Ô∏è':'ü§ç')+'</button>',
      '</div>',
      '<div class="inf">',
      '<p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px;color:#0f172a">'+item.itemName+'</p>',
      '<p style="font-size:15px;font-weight:900;color:#0ea5e9">'+item.price+'‚Ç¨</p>',
      '<p style="font-size:10px;color:#64748b;margin-top:2px"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;font-size:8px;margin-right:2px"></i>'+item.city+'</p>',
      '</div></div>'
    ].join("");
  }).join("");
}

window.__openDemoItem = function(id) {
  // Injecter les items d√©mo dans le tableau module via l'API expos√©e
  if(window.__demoItems && window.__pushItem){
    var current = window.__getItems ? window.__getItems() : [];
    var ids = new Set(current.map(function(x){return x.id;}));
    window.__demoItems.forEach(function(d){ if(!ids.has(d.id)) window.__pushItem(d); });
  }
  if(typeof window.openDetail === "function"){
    window.openDetail(id);
  }
};

function doAnon() {
  __me = { uid: "visitor_" + Math.random().toString(36).slice(2, 8), email: null, isVisitor: true };
  window.__me = __me;
  window.__visitorBooted = true;
  window.items = __demoItems; // expose to module when it loads

  // Hide splash, show app
  document.getElementById("splash").style.display = "none";
  var app = document.getElementById("app");
  app.classList.remove("hidden");
  app.style.opacity = "1";

  // Show visitor banner
  var vb = document.getElementById("visitor-banner");
  if (vb) vb.style.display = "flex";

  // Force home view visible, hide profile/notif/map
  __showView("home");

  // Hide profile nav items (visitor has no account)
  var navProfile = document.getElementById("nav-profile");
  if (navProfile) navProfile.style.display = "none";
  var snavProfile = document.getElementById("snav-profile");
  if (snavProfile) snavProfile.style.display = "none";
  var snavNotif = document.getElementById("snav-notif");
  if (snavNotif) snavNotif.style.display = "none";
  var navNotif = document.getElementById("nav-notif");
  if (navNotif) navNotif.style.display = "none";

  // Render demo feed now
  __renderDemoFeed();

  // When module loads later, it will also call injectDemoData ‚Äî allow it
  window.__injectDemoAndRender = function() {
    // merge __demoItems into module items array
    if (typeof items !== "undefined") {
      var existingIds = new Set(items.map(function(i){ return i.id; }));
      __demoItems.forEach(function(d) {
        if (!existingIds.has(d.id)) items.push(d);
      });
    }
    __renderDemoFeed(); // re-render with better card function if available
    if (typeof applyFilters === "function") applyFilters();
  };
}
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import{getAuth,signInAnonymously,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,GoogleAuthProvider,signInWithPopup,signOut}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import{getFirestore,collection,addDoc,onSnapshot,serverTimestamp,doc,where,orderBy,query,getDocs,deleteDoc,updateDoc,getDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const FB={apiKey:"AIzaSyDOSIhWwrlkhNfk8Y3-tl9IebJW0YBA7d4",authDomain:"youbiiiz-app.firebaseapp.com",projectId:"youbiiiz-app",storageBucket:"youbiiiz-app.firebasestorage.app",messagingSenderId:"664733497216",appId:"1:664733497216:web:ae19fbadf0fa509f59b365"};
const fb=initializeApp(FB),auth=getAuth(fb),db=getFirestore(fb);

var me=null; // synced with window.__me
let items=[],curItem=null,scanData=null,camStream=null;
window.__getItems=function(){return items;};
window.__pushItem=function(d){items.push(d);};
let editingId=null,deletingId=null,payItem=null,selShip=null,curStar=0,rateCtx=null;
let activeCat="all",map=null,userLat=null,userLng=null,mapMarkers=[];

window.onerror=(m,s,l)=>{toast("JS:"+m+" L"+l);};
function toast(m,ok){
  var e=document.getElementById("dbg");
  e.style.display="block";
  e.style.background=ok?"#22c55e":"#ef4444";
  e.innerText=m;
  setTimeout(function(){e.style.display="none";},3500);
}

onAuthStateChanged(auth,function(u){
  if(u && (!window.__me || !window.__me.isVisitor)){
    me=u; window.__me=u;
    boot();
  }
  // Sinon: landing page reste visible, l'user doit se connecter
});

// AUTH FUNCTIONS
function showAuthMsg(msg,ok){
  var el=document.getElementById("auth-msg");
  el.style.display="block";
  el.style.background=ok?"#f0fdf4":"#fef2f2";
  el.style.color=ok?"#166534":"#dc2626";
  el.style.border=ok?"1px solid #bbf7d0":"1px solid #fecaca";
  el.innerText=msg;
}
function hideAuthMsg(){document.getElementById("auth-msg").style.display="none";}

window.__firebaseLogin=async function(){
  var email=document.getElementById("login-email").value.trim();
  var pass=document.getElementById("login-password").value;
  if(!email||!pass){showAuthMsg("Remplis tous les champs");return;}
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    var msgs={"auth/user-not-found":"Compte introuvable","auth/wrong-password":"Mot de passe incorrect","auth/invalid-email":"Email invalide","auth/invalid-credential":"Email ou mot de passe incorrect"};
    showAuthMsg(msgs[e.code]||"Erreur: "+e.message);
  }
};

window.__firebaseRegister=async function(){
  var email=document.getElementById("reg-email").value.trim();
  var pass=document.getElementById("reg-password").value;
  var conf=document.getElementById("reg-confirm").value;
  if(!email||!pass||!conf){showAuthMsg("Remplis tous les champs");return;}
  if(pass.length<6){showAuthMsg("Mot de passe trop court (min. 6 car.)");return;}
  if(pass!==conf){showAuthMsg("Les mots de passe ne correspondent pas");return;}
  try{
    await createUserWithEmailAndPassword(auth,email,pass);
  }catch(e){
    var msgs={"auth/email-already-in-use":"Email d√©j√† utilis√©","auth/invalid-email":"Email invalide","auth/weak-password":"Mot de passe trop faible"};
    showAuthMsg(msgs[e.code]||"Erreur: "+e.message);
  }
};

window.__firebaseGoogle=async function(){
  try{
    var provider=new GoogleAuthProvider();
    await signInWithPopup(auth,provider);
  }catch(e){
    if(e.code!=="auth/popup-closed-by-user") showAuthMsg("Erreur Google: "+e.message);
  }
};

window.doAnon=function(){
  // Mode visiteur: bypass Firebase enti√®rement
  me={uid:"visitor_"+Math.random().toString(36).slice(2,8),email:null,isVisitor:true};
  document.getElementById("auth-msg") && (document.getElementById("auth-msg").style.display="none");
  boot();
};

window.__firebaseLogout=async function(){
  try{
    if(me && !me.isVisitor) await signOut(auth);
  }catch(e){}
  me=null;
  document.getElementById("app").classList.add("hidden");
  document.getElementById("app").style.opacity="0";
  document.getElementById("splash").style.display="flex";
};

function boot(){
  if(window.__me) me = window.__me; // sync visitor mode
  document.getElementById("splash").style.display="none";
  var app=document.getElementById("app");
  app.classList.remove("hidden");
  setTimeout(function(){app.style.opacity="1";},80);
  // Update UI with user info
  if(me){
    var badge=document.getElementById("user-badge");
    if(badge) badge.innerText=me.isVisitor?"Visiteur":"ID:"+me.uid.slice(0,4);
    var puid=document.getElementById("profile-uid");
    if(puid) puid.innerText=me.isVisitor?"Mode visiteur ‚Äî sans compte":((me.email||"Anonyme")+" ¬∑ "+me.uid.slice(0,8)+"...");
    var suid=document.getElementById("sidebar-uid");
    if(suid) suid.innerText=me.isVisitor?"Mode visiteur":(me.email||"Compte anonyme");
  }
  initFeed();
  if(!me||!me.isVisitor) initNotifs();
  checkPayReturn();
  var vb=document.getElementById("visitor-banner");
  if(vb) vb.style.display=(me&&me.isVisitor)?"flex":"none";
}

async function initPush(){/* messaging d√©sactiv√© */}

function showPushBanner(title,body){
  var el=document.createElement("div");
  el.style.cssText="position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9000;background:#1e293b;border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:12px 16px;max-width:320px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5);display:flex;align-items:center;gap:12px;animation:su .3s cubic-bezier(.16,1,.3,1)";
  el.innerHTML='<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22d3ee,#3b82f6);flex-shrink:0;display:flex;align-items:center;justify-content:center"><i class="fa-solid fa-bell" style="color:#000;font-size:14px"></i></div><div style="flex:1;min-width:0"><p style="font-size:13px;font-weight:700;margin:0 0 2px">'+title+'</p><p style="font-size:11px;color:#94a3b8;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+body+'</p></div><button onclick="this.parentElement.remove()" style="background:none;border:none;color:#94a3b8;cursor:pointer;padding:4px;font-size:14px">x</button>';
  document.body.appendChild(el);
  setTimeout(function(){if(el.parentElement)el.remove();},5000);
}

function initFeed(){
  // Show demo data immediately while Firebase loads
  if(typeof window.__injectDemoAndRender==="function") window.__injectDemoAndRender();
  if(!me||!me.isVisitor){
  onSnapshot(collection(db,"scans"),function(snap){
    var realItems=[];
    snap.forEach(function(d){realItems.push(Object.assign({id:d.id},d.data()));});
    realItems.sort(function(a,b){return(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0);});
    // Keep demo items not replaced by real ones
    var realIds=new Set(realItems.map(function(i){return i.id;}));
    var demoKept=items.filter(function(i){return i.id.indexOf("demo")===0&&!realIds.has(i.id);});
    items=realItems.concat(demoKept);
    applyFilters();
    updateProfile();
  },function(e){toast("Feed:"+e.message);})
  };
}

function card(i){
  var isFav=favorites.has(i.id);
  var cond=i.condition?'<span style="position:absolute;top:6px;left:7px;background:rgba(255,255,255,.93);color:#0ea5e9;font-size:9px;font-weight:800;padding:2px 8px;border-radius:99px">'+i.condition+'</span>':"";
  var hrt='<button onclick="event.stopPropagation();toggleFavCard(this,\''+(i.id)+'\''+')" '
      +'style="position:absolute;top:6px;right:7px;width:30px;height:30px;background:rgba(255,255,255,.93);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;font-size:14px;box-shadow:0 1px 6px rgba(0,0,0,.15);transition:transform .18s;line-height:1">'
      +(isFav?'‚ù§Ô∏è':'ü§ç')+'</button>';
  var city=i.city?'<p style="font-size:10px;color:#64748b;margin-top:3px"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;font-size:8px;margin-right:2px"></i>'+i.city+'</p>':"";
  return '<div class="card fi" onclick="openDetail(\''+(i.id)+'\''+')">'
    +'<div class="sq"><img src="'+(i.imageUrl||"")+'" loading="lazy">'+cond+hrt+'</div>'
    +'<div class="inf">'
    +'<p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px;color:#0f172a">'+(i.itemName||"Objet")+'</p>'
    +'<p style="font-size:15px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p>'
    +city+'</div></div>';
}

function myCard(i){
  var cond=i.condition?'<span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.72);font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px">'+i.condition+'</span>':"";
  return '<div class="card fi">'+
    '<div class="sq"><img src="'+(i.imageUrl||'')+'">'+cond+'</div>'+
    '<div class="inf">'+
    '<p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px">'+(i.itemName||'Objet')+'</p>'+
    '<p style="font-size:14px;font-weight:900;color:#0ea5e9;margin-bottom:6px">'+(i.price||0)+'‚Ç¨</p>'+
    '<div style="display:flex;gap:5px">'+
    '<button onclick="event.stopPropagation();openEdit(\''+(i.id)+'\''+')" style="flex:1;background:#1e293b;border:1px solid rgba(148,163,184,.15);border-radius:9px;padding:5px;font-size:10px;font-weight:700;cursor:pointer">Modif.</button>'+
    '<button onclick="event.stopPropagation();confirmDel(\''+(i.id)+'\''+')" style="flex:1;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.18);border-radius:9px;padding:5px;font-size:10px;font-weight:700;color:#f87171;cursor:pointer">Supp.</button>'+
    '</div></div></div>';
}

function renderFeed(list){
  var el=document.getElementById("feed");
  if(!list.length){el.innerHTML='<div style="grid-column:1/-1;padding:56px 0;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase">Aucune annonce</div>';return;}
  el.innerHTML=list.map(card).join("");
}

window.applyFilters=function(){
  var cat=activeCat;
  var city=(document.getElementById("city-inp").value||"").toLowerCase().trim();
  var q=(document.getElementById("header-search").value||"").toLowerCase().trim();
  var list=items;
  if(cat!=="all") list=list.filter(function(i){return(i.category||"").toLowerCase().indexOf(cat.toLowerCase())>=0;});
  if(city) list=list.filter(function(i){return(i.city||"").toLowerCase().indexOf(city)>=0;});
  if(q) list=list.filter(function(i){return(i.itemName||"").toLowerCase().indexOf(q)>=0||(i.description||"").toLowerCase().indexOf(q)>=0||(i.city||"").toLowerCase().indexOf(q)>=0;});
  renderFeed(list);
};

window.filterCat=function(cat,btn){
  activeCat=cat;
  document.querySelectorAll(".cat-pill").forEach(function(b){b.classList.remove("on");});
  btn.classList.add("on");
  applyFilters();
};

window.switchView=function(v){
  ["home","map","notifications","profile"].forEach(function(n){
    var el=document.getElementById("view-"+n);
    if(el){
      if(n==="map"){
        el.style.display=n===v?"block":"none";
      }else{
        el.classList[n===v?"remove":"add"]("hidden");
      }
    }
  });
  document.getElementById("main-scroll").style.overflow=v==="map"?"hidden":"auto";
  ["home","map","notif","profile"].forEach(function(n){
    var el=document.getElementById("nav-"+n);
    if(el){
      var icon=el.querySelector("i");
      if(icon) icon.style.color=v===n||("notifications"===v&&n==="notif")?"#22d3ee":"#71717a";
    }
  });
  if(v==="map"){
    if(!userLat) askGeo();
    setTimeout(function(){
      initMap();
      renderMapMarkers();
      if(map) map.invalidateSize();
    },250);
  }
  if(v==="notifications"&&me){
    getDocs(query(collection(db,"notifications"),where("userId","==",me.uid),where("read","==",false))).then(function(s){
      s.forEach(function(d){updateDoc(doc(db,"notifications",d.id),{read:true});});
    });
  }
  if(v==="profile") loadMyRating();
};

function updateProfile(){
  if(!me) return;
  var mine=items.filter(function(i){return i.userId===me.uid;});
  document.getElementById("profile-count").innerText=mine.length;
  document.getElementById("profile-total").innerText=mine.reduce(function(s,i){return s+(parseFloat(i.price)||0);},0)+"‚Ç¨";
  var el=document.getElementById("my-listings");
  el.innerHTML=mine.length?mine.map(myCard).join(""):'<p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:32px 0">Aucune annonce</p>';
}

// SCAN
window.openScan=function(){
  var m=document.getElementById("scan-modal");
  m.classList.remove("hidden");
  m.classList.add("flex");
};
window.closeScan=function(){
  stopCam();resetScan();
  var m=document.getElementById("scan-modal");
  m.classList.remove("flex");
  m.classList.add("hidden");
};
window.resetScan=function(){
  stopCam();scanData=null;
  document.getElementById("scan-prev").classList.add("hidden");
  document.getElementById("scan-prev").src="";
  document.getElementById("scan-ph").classList.remove("hidden");
  document.getElementById("scan-spin").classList.add("hidden");
  document.getElementById("scan-line").classList.add("hidden");
  document.getElementById("photo-btns").classList.remove("hidden");
  document.getElementById("snap-btn").classList.add("hidden");
  document.getElementById("cam-toggle").classList.remove("hidden");
  document.getElementById("step-photo").classList.remove("hidden");
  document.getElementById("step-result").classList.add("hidden");
  document.getElementById("step-result").classList.remove("flex");
  document.getElementById("pub-btn").innerText="Publier l'annonce";
  document.getElementById("pub-btn").disabled=false;
  document.getElementById("file-input").value="";
  ["sh-hand","sh-relay","sh-colis"].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.checked=false;
  });
};
window.toggleCam=async function(){
  if(camStream){stopCam();return;}
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1080},height:{ideal:1080}},audio:false});
    var v=document.getElementById("cam-vid");
    v.srcObject=camStream;v.classList.remove("hidden");
    document.getElementById("scan-ph").classList.add("hidden");
    document.getElementById("cam-toggle").classList.add("hidden");
    document.getElementById("snap-btn").classList.remove("hidden");
  }catch(e){
    // Camera unavailable: fallback to file picker
    toast("Cam√©ra non disponible ‚Äî s√©lectionne une photo depuis la galerie");
    document.getElementById("file-input").click();
  }
};
function stopCam(){
  if(camStream){camStream.getTracks().forEach(function(t){t.stop();});camStream=null;}
  var v=document.getElementById("cam-vid");
  v.srcObject=null;v.classList.add("hidden");
}
window.snapPhoto=function(){
  var v=document.getElementById("cam-vid"),c=document.getElementById("cap-canvas");
  c.width=v.videoWidth;c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);
  stopCam();
  document.getElementById("snap-btn").classList.add("hidden");
  processImg(c.toDataURL("image/jpeg",1.0));
};
window.onFile=function(e){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){processImg(ev.target.result);};
  r.readAsDataURL(f);
};
function processImg(raw){
  document.getElementById("scan-ph").classList.add("hidden");
  document.getElementById("photo-btns").classList.add("hidden");
  document.getElementById("scan-spin").classList.remove("hidden");
  cropImage(raw).then(function(opt){
    document.getElementById("scan-prev").src=opt;
    document.getElementById("scan-prev").classList.remove("hidden");
    document.getElementById("scan-line").classList.remove("hidden");
    callGemini(opt);
  });
}
function cropImage(b64){
  return new Promise(function(resolve){
    var img=new Image();
    img.onload=function(){
      var w=img.naturalWidth||img.width;
      var h=img.naturalHeight||img.height;
      if(!w||!h){resolve(b64);return;}
      // Calcul pour tenir l'image entiere dans 400x400 avec padding
      var scale=Math.min(400/w,400/h);
      var dw=Math.round(w*scale);
      var dh=Math.round(h*scale);
      var dx=Math.round((400-dw)/2);
      var dy=Math.round((400-dh)/2);
      var c=document.createElement("canvas");
      c.width=400;c.height=400;
      var ctx=c.getContext("2d");
      ctx.fillStyle="#f5f5f5";
      ctx.fillRect(0,0,400,400);
      ctx.drawImage(img,0,0,w,h,dx,dy,dw,dh);
      resolve(c.toDataURL("image/jpeg",0.82));
    };
    img.onerror=function(){resolve(b64);};
    img.src=b64;
  });
}
async function callGemini(b64){
  try{
    var mime=b64.indexOf("data:image/png")===0?"image/png":"image/jpeg";
    var r=await fetch("https://analyzeimage-xjtnixfrra-uc.a.run.app",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({imageBase64:b64.split(",")[1],mimeType:mime})
    });
    var d=await r.json();
    if(d.error){toast("IA:"+d.error);resetScan();return;}
    showResult(d,b64);
  }catch(e){toast("IA:"+e.message);resetScan();}
}
function showResult(d,img){
  document.getElementById("scan-spin").classList.add("hidden");
  document.getElementById("scan-line").classList.add("hidden");
  document.getElementById("res-thumb").src=img;
  document.getElementById("ai-name").value=d.title||"";
  document.getElementById("ai-price").innerText=(d.price||0)+"‚Ç¨";
  var catSel=document.getElementById("ai-cat-select");
  if(catSel&&d.category){
    // Try exact match first, then partial
    var found=false;
    Array.from(catSel.options).forEach(function(o){if(o.value===d.category){catSel.value=d.category;found=true;}});
    if(!found){Array.from(catSel.options).forEach(function(o){if(!found&&o.value.toLowerCase().indexOf(d.category.toLowerCase())>=0){catSel.value=o.value;found=true;}});}
  }
  document.getElementById("ai-desc").value=d.description||"";
  document.getElementById("ai-cond").innerText=d.condition||"";
  document.getElementById("ai-brand").innerText=d.brand||"-";
  document.getElementById("ai-model").innerText=d.model||"-";
  scanData={itemName:d.title,price:d.price,category:d.category,condition:d.condition||"Bon etat",description:d.description||"",brand:d.brand||"",model:d.model||"",imageUrl:img,shipping:[]};
  document.getElementById("step-photo").classList.add("hidden");
  document.getElementById("step-result").classList.remove("hidden");
  document.getElementById("step-result").classList.add("flex");
}
window.updShip=function(){
  if(!scanData) return;
  var o=[];
  if(document.getElementById("sh-hand").checked) o.push({method:"Main propre",price:0});
  if(document.getElementById("sh-relay").checked) o.push({method:"Mondial Relay",price:parseFloat(document.getElementById("sh-relay-p").value)||5});
  if(document.getElementById("sh-colis").checked) o.push({method:"Colissimo",price:parseFloat(document.getElementById("sh-colis-p").value)||8});
  scanData.shipping=o;
};
document.getElementById("pub-btn").addEventListener("click",async function(){
  if(!scanData||!me) return;
  updShip();
  if(me&&me.isVisitor){toast("Cr√©e un compte pour publier une annonce !");return;}
  var btn=document.getElementById("pub-btn");
  btn.innerText="Publication...";btn.disabled=true;
  try{
    var city=document.getElementById("item-city").value.trim();
    var selectedCat=document.getElementById("ai-cat-select")?document.getElementById("ai-cat-select").value:scanData.category;
    // Geocoder la ville pour la carte
    var coords=city?await geocodeAndSave(city):null;
    await addDoc(collection(db,"scans"),{
      userId:me.uid,
      itemName:document.getElementById("ai-name").value,
      price:scanData.price,
      category:selectedCat,
      condition:scanData.condition,
      description:document.getElementById("ai-desc").value,
      brand:scanData.brand,
      model:scanData.model,
      shipping:scanData.shipping,
      city:city,
      lat:coords?coords.lat:null,
      lng:coords?coords.lng:null,
      imageUrl:scanData.imageUrl,
      createdAt:serverTimestamp()
    });
    closeScan();
    switchView("home");
    toast("Annonce publiee !",true);
  }catch(e){
    toast("Erreur:"+e.message);
    btn.innerText="Publier l'annonce";
    btn.disabled=false;
  }
});

// DETAIL
window.openDetail=function(id){
  var i=items.find(function(x){return x.id===id;});
  if(!i) return;
  curItem=i;
  // det-img is handled by buildCarousel override below
  document.getElementById("det-title").innerText=i.itemName||"";
  var dtb=document.getElementById("det-title-big");if(dtb)dtb.innerText=i.itemName||"";
  document.getElementById("det-price").innerText=(i.price||0)+"‚Ç¨";
  document.getElementById("det-cat").innerText=i.category||"";
  document.getElementById("det-cond").innerText=i.condition||"";
  document.getElementById("det-desc").innerText=i.description||"Aucune description.";
  document.getElementById("det-seller").innerText="Vendeur #"+(i.userId||"").slice(0,6);
  document.getElementById("det-brand").innerText=[i.brand,i.model].filter(Boolean).join(" - ");
  var ct=document.getElementById("det-city-tag");
  if(i.city){document.getElementById("det-city-val").innerText=i.city;ct.classList.remove("hidden");}
  else{ct.classList.add("hidden");}
  var sh=document.getElementById("det-ship");
  if(i.shipping&&i.shipping.length){
    sh.innerHTML=i.shipping.map(function(s){
      return '<span style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:5px 12px;font-size:11px;font-weight:700;color:#0f172a">'+s.method+' <span style="color:#0ea5e9;font-weight:800">'+(s.price===0?"Gratuit":s.price+"‚Ç¨")+"</span></span>";
    }).join("");
  }else{
    sh.innerHTML='<span style="font-size:12px;color:#94a3b8">Non renseigne</span>';
  }
  document.getElementById("contact-btn").onclick=function(){if(me&&me.isVisitor){toast("Cr√©e un compte pour contacter le vendeur !");return;}openChat(i);};
  document.getElementById("buy-btn").onclick=function(){if(me&&me.isVisitor){toast("Cr√©e un compte pour acheter !");return;}openPay(i);};
  loadSellerRating(i.userId);
  var m=document.getElementById("detail-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeDetail=function(){
  var m=document.getElementById("detail-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};

// CHAT
window.openChat=function(i){
  curItem=i;
  document.getElementById("chat-seller").innerText="Vendeur #"+(i.userId||"").slice(0,6);
  document.getElementById("chat-iname").innerText=i.itemName||"";
  document.getElementById("chat-iprice").innerText=(i.price||0)+"‚Ç¨";
  document.getElementById("chat-img").src=i.imageUrl||"";
  document.getElementById("chat-msgs").innerHTML='<div style="text-align:center;padding:16px 0"><span style="font-size:10px;color:#94a3b8;background:#1e3a5f;padding:4px 12px;border-radius:99px;font-weight:700;text-transform:uppercase">Debut de conversation</span></div>';
  var m=document.getElementById("chat-modal");
  m.classList.remove("hidden");m.classList.add("flex");
  closeDetail();
  setTimeout(function(){renderChatSuggestions(i,"start");},100);
};
window.closeChat=function(){
  var m=document.getElementById("chat-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.sendMsg=function(){
  var inp=document.getElementById("chat-inp"),t=inp.value.trim();if(!t)return;
  addBubble(t,true);inp.value="";
  var reps=["Oui disponible !","Je peux baisser un peu.","Envoi Mondial Relay possible.","Article en parfait etat.","Je peux envoyer plus de photos."];
  setTimeout(function(){addBubble(reps[Math.floor(Math.random()*reps.length)],false);},1100);
};
window.qMsg=function(m){document.getElementById("chat-inp").value=m;sendMsg();};
function addBubble(t,mine){
  var el=document.getElementById("chat-msgs");
  var d=document.createElement("div");
  d.className="flex "+(mine?"justify-end":"justify-start");
  d.innerHTML='<div class="max-w-[72%] px-4 py-2 text-sm font-medium '+(mine?"bme":"bthem")+'">'+t+"</div>";
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}

// PAIEMENT
window.openPay=function(i){
  payItem=i;selShip=null;
  document.getElementById("pay-img").style.backgroundImage="url("+i.imageUrl+")";
  document.getElementById("pay-title").innerText=i.itemName;
  document.getElementById("pay-price").innerText=i.price+"‚Ç¨";
  document.getElementById("pay-sub").innerText=i.price+"‚Ç¨";
  document.getElementById("pay-shipcost").innerText="-";
  document.getElementById("pay-total").innerText=i.price+"‚Ç¨";
  var wrap=document.getElementById("pay-ship-wrap"),list=document.getElementById("pay-ship-list");
  if(i.shipping&&i.shipping.length){
    wrap.classList.remove("hidden");
    list.innerHTML=i.shipping.map(function(s,idx){
      return '<label style="display:flex;align-items:center;gap:10px;background:#1e3a5f;border:1px solid rgba(148,163,184,.10);border-radius:12px;padding:10px 12px;cursor:pointer"><input type="radio" name="ship" value="'+idx+'" onchange="selShipping('+idx+')" style="accent-color:#0ea5e9"><span style="font-size:13px;font-weight:600;flex:1">'+s.method+'</span><span style="font-size:13px;font-weight:800;color:#0ea5e9">'+(s.price===0?"Gratuit":s.price+"‚Ç¨")+"</span></label>";
    }).join("");
  }else{wrap.classList.add("hidden");}
  var m=document.getElementById("pay-modal");
  m.classList.remove("hidden");m.classList.add("flex");
  closeDetail();
};
window.selShipping=function(idx){
  selShip=payItem.shipping[idx];
  var tot=(parseFloat(payItem.price)||0)+selShip.price;
  document.getElementById("pay-shipcost").innerText=selShip.price===0?"Gratuit":selShip.price+"‚Ç¨";
  document.getElementById("pay-total").innerText=tot+"‚Ç¨";
};
window.closePay=function(){
  var m=document.getElementById("pay-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.doStripe=async function(){
  if(!payItem||!me) return;
  if(payItem.shipping&&payItem.shipping.length&&!selShip){toast("Choisissez un mode de livraison");return;}
  var btn=document.getElementById("stripe-btn");
  btn.innerHTML='<i class="fa-solid fa-circle-notch animate-spin mr-2"></i>Redirection...';btn.disabled=true;
  try{
    var shipCost=selShip?selShip.price:0;
    var tot=(parseFloat(payItem.price)||0)+shipCost;
    var r=await fetch("https://createpayment-xjtnixfrra-uc.a.run.app",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:tot,itemName:payItem.itemName,itemId:payItem.id,buyerId:me.uid,sellerId:payItem.userId})});
    var d=await r.json();
    if(d.error){toast("Stripe:"+d.error);return;}
    await addDoc(collection(db,"notifications"),{userId:payItem.userId,type:"payment_initiated",message:"Paiement pour "+payItem.itemName,itemId:payItem.id,read:false,createdAt:serverTimestamp()});
    window.location.href=d.url;
  }catch(e){toast("Erreur:"+e.message);}
  btn.innerHTML='<i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant';btn.disabled=false;
};
function checkPayReturn(){
  var p=new URLSearchParams(window.location.search);
  if(p.get("payment")!=="success") return;
  history.replaceState({},"","/");
  var iid=p.get("itemId"),sid=p.get("sellerId");
  setTimeout(async function(){
    if(!me) return;
    try{
      await addDoc(collection(db,"notifications"),{userId:me.uid,type:"payment_success",message:"Paiement valide ! Contactez le vendeur.",itemId:iid||"",read:false,createdAt:serverTimestamp()});
      if(sid) await addDoc(collection(db,"notifications"),{userId:sid,type:"sale",message:"Votre article vient d'etre achete !",itemId:iid||"",read:false,createdAt:serverTimestamp()});
      rateCtx={targetUserId:sid,role:"buyer",itemId:iid||""};
      setTimeout(function(){openRate("vendeur");},2000);
    }catch(e){}
  },1500);
}

// NOTIFS
function initNotifs(){
  if(!me) return;
  var q=query(collection(db,"notifications"),where("userId","==",me.uid));
  onSnapshot(q,function(snap){
    var list=[];
    snap.forEach(function(d){list.push(Object.assign({id:d.id},d.data()));});
    list.sort(function(a,b){return(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0);});
    var unread=list.filter(function(n){return !n.read;}).length;
    var b=document.getElementById("nbadge");
    b.classList.toggle("hidden",unread===0);
    if(unread) b.innerText=unread;
    var icons={payment_success:"ok",payment_initiated:"cb",sale:"vente",rating:"note"};
    var emojis={payment_success:"‚úÖ",payment_initiated:"üí≥",sale:"üéâ",rating:"‚≠ê"};
    document.getElementById("notif-list").innerHTML=list.length?list.map(function(n){
      var date=n.createdAt?new Date(n.createdAt.seconds*1000).toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):"";
      return '<div onclick="markRead(\''+n.id+'\')" style="background:#1e293b;border:1px solid rgba(148,163,184,.10);border-radius:16px;padding:14px;margin-bottom:8px;cursor:pointer;opacity:'+(n.read?".5":"1")+'"><div style="display:flex;gap:10px;align-items:flex-start"><span style="font-size:18px">'+(emojis[n.type]||"bell")+'</span><div style="flex:1"><p style="font-size:13px;font-weight:700;margin-bottom:3px">'+n.message+'</p><p style="font-size:10px;color:#94a3b8">'+date+"</p></div>"+(n.read?"":'<span style="width:7px;height:7px;background:#0ea5e9;border-radius:99px;margin-top:3px;flex-shrink:0;display:block"></span>')+"</div></div>";
    }).join(""):'<p style="text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>';
  });
}
window.markRead=async function(id){await updateDoc(doc(db,"notifications",id),{read:true});};

// NOTATION
window.openRate=function(role){
  curStar=0;
  document.querySelectorAll(".star").forEach(function(s){s.style.color="#3f3f46";s.style.transform="scale(1)";});
  document.getElementById("rate-comment").value="";
  document.getElementById("rate-sub").innerText=role==="buyer"?"Comment s'est comporte l'acheteur ?":"Comment etait le vendeur ?";
  var m=document.getElementById("rate-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeRate=function(){
  var m=document.getElementById("rate-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.setStar=function(v){
  curStar=v;
  document.querySelectorAll(".star").forEach(function(s){
    var sv=parseInt(s.dataset.v);
    s.style.color=sv<=v?"#facc15":"#3f3f46";
    s.style.transform=sv<=v?"scale(1.15)":"scale(1)";
  });
};
window.submitRate=async function(){
  if(!curStar){toast("Choisissez une note");return;}
  if(!rateCtx) return;
  try{
    await addDoc(collection(db,"ratings"),{targetUserId:rateCtx.targetUserId,fromUserId:me.uid,itemId:rateCtx.itemId,rating:curStar,comment:document.getElementById("rate-comment").value,createdAt:serverTimestamp()});
    await updUserRating(rateCtx.targetUserId);
    await addDoc(collection(db,"notifications"),{userId:rateCtx.targetUserId,type:"rating",message:"Vous avez recu une note de "+curStar+"‚òÖ",read:false,createdAt:serverTimestamp()});
    closeRate();toast("Note envoyee !",true);
  }catch(e){toast("Erreur:"+e.message);}
};
async function updUserRating(uid){
  try{
    var s=await getDocs(query(collection(db,"ratings"),where("targetUserId","==",uid)));
    var r=[];s.forEach(function(d){r.push(d.data().rating);});
    if(!r.length) return;
    var avg=(r.reduce(function(a,b){return a+b;},0)/r.length).toFixed(1);
    await updateDoc(doc(db,"users",uid),{rating:parseFloat(avg),ratingCount:r.length});
  }catch(e){}
}
async function loadSellerRating(uid){
  try{
    var d=await getDoc(doc(db,"users",uid));
    var el=document.getElementById("det-rating");
    if(d.exists()&&d.data().rating){
      var r=d.data().rating,n=d.data().ratingCount||0;
      var stars="";
      for(var k=1;k<=5;k++) stars+=k<=Math.round(r)?"‚òÖ":"‚òÜ";
      el.innerText=stars+" "+r+"/5 ("+n+" avis)";
    }else{el.innerText="Nouveau vendeur";}
  }catch(e){}
}
async function loadMyRating(){
  if(!me) return;
  try{
    var d=await getDoc(doc(db,"users",me.uid));
    if(d.exists()&&d.data().rating) document.getElementById("profile-rating").innerText="‚òÖ"+d.data().rating;
  }catch(e){}
}

// EDIT / DELETE
window.openEdit=function(id){
  var i=items.find(function(x){return x.id===id;});if(!i)return;
  editingId=id;
  document.getElementById("edit-title").value=i.itemName||"";
  document.getElementById("edit-price").value=i.price||0;
  document.getElementById("edit-desc").value=i.description||"";
  document.getElementById("edit-cond").value=i.condition||"Bon etat";
  document.getElementById("edit-cat").value=i.category||"Divers";
  var m=document.getElementById("edit-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeEdit=function(){
  var m=document.getElementById("edit-modal");
  m.classList.add("hidden");m.classList.remove("flex");
  editingId=null;
};
window.saveEdit=async function(){
  if(!editingId) return;
  var btn=document.getElementById("edit-save");btn.innerText="Sauvegarde...";btn.disabled=true;
  try{
    await updateDoc(doc(db,"scans",editingId),{
      itemName:document.getElementById("edit-title").value,
      price:parseFloat(document.getElementById("edit-price").value)||0,
      description:document.getElementById("edit-desc").value,
      condition:document.getElementById("edit-cond").value,
      category:document.getElementById("edit-cat").value
    });
    closeEdit();
  }catch(e){toast("Erreur:"+e.message);}
  btn.innerText="Sauvegarder";btn.disabled=false;
};
window.confirmDel=function(id){
  deletingId=id;closeEdit();
  var m=document.getElementById("del-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeDel=function(){
  var m=document.getElementById("del-modal");
  m.classList.add("hidden");m.classList.remove("flex");
  deletingId=null;
};
window.doDelete=async function(){
  if(!deletingId) return;
  try{await deleteDoc(doc(db,"scans",deletingId));closeDel();}
  catch(e){toast("Erreur:"+e.message);}
};

// CARTE
var clusterGroup=null,userMarker=null,activeRadius=5;

function initMap(){
  if(map) return;
  var lat=userLat||46.2276,lng=userLng||2.2137,zoom=userLat?13:6;
  map=L.map("map-el",{zoomControl:false}).setView([lat,lng],zoom);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"CartoDB",maxZoom:19}).addTo(map);
  clusterGroup=L.markerClusterGroup({
    maxClusterRadius:50,
    iconCreateFunction:function(cluster){
      return L.divIcon({
        className:"",
        html:'<div style="background:#0ea5e9;color:#000;font-size:12px;font-weight:900;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5)">'+cluster.getChildCount()+"</div>",
        iconSize:[36,36],iconAnchor:[18,18]
      });
    }
  });
  map.addLayer(clusterGroup);
  if(userLat) addUserMarker();
}

function addUserMarker(){
  if(userMarker) userMarker.remove();
  userMarker=L.circleMarker([userLat,userLng],{radius:10,fillColor:"#22d3ee",color:"#fff",weight:3,fillOpacity:1}).addTo(map);
  // Cercle de rayon
  if(activeRadius>0) drawRadiusCircle();
}

var radiusCircle=null;
function drawRadiusCircle(){
  if(radiusCircle) radiusCircle.remove();
  if(!userLat||activeRadius===0) return;
  radiusCircle=L.circle([userLat,userLng],{
    radius:activeRadius*1000,
    color:"#22d3ee",fillColor:"#22d3ee",fillOpacity:0.04,weight:1.5,dashArray:"6,6"
  }).addTo(map);
}

function getDistanceKm(lat1,lng1,lat2,lng2){
  var R=6371;
  var dLat=(lat2-lat1)*Math.PI/180;
  var dLng=(lng2-lng1)*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function geocodeCity(city){
  try{
    var r=await fetch("https://nominatim.openstreetmap.org/search?q="+encodeURIComponent(city+",France")+"&format=json&limit=1");
    var d=await r.json();
    if(!d.length) return null;
    return{lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};
  }catch(e){return null;}
}

function renderMapMarkers(){
  if(!map||!clusterGroup) return;
  clusterGroup.clearLayers();
  mapMarkers=[];

  var withCoords=items.filter(function(i){return i.lat&&i.lng;});
  var withCityOnly=items.filter(function(i){return i.city&&i.city.trim()&&!i.lat;});

  // Annonces avec coordonnees GPS directes
  withCoords.forEach(function(item){
    addItemMarker(item,item.lat,item.lng);
  });

  // Annonces avec ville seulement - geocoder
  withCityOnly.forEach(async function(item){
    var coords=await geocodeCity(item.city);
    if(!coords) return;
    addItemMarker(item,coords.lat,coords.lng);
  });
}

function addItemMarker(item,lat,lng){
  // Filtre par rayon
  if(activeRadius>0&&userLat){
    var dist=getDistanceKm(userLat,userLng,lat,lng);
    if(dist>activeRadius) return;
  }
  var icon=L.divIcon({
    className:"",
    html:'<div class="yb-marker"><div class="yb-pin"><div class="yb-dot"></div><div class="yb-stem"></div></div><div class="yb-price">'+(item.price||0)+"e</div></div>",
    iconSize:[40,44],
    iconAnchor:[20,26]
  });
  var marker=L.marker([lat,lng],{icon:icon});
  marker.on("click",function(){
    document.getElementById("map-pop-img").src=item.imageUrl||"";
    document.getElementById("map-pop-name").innerText=item.itemName||"";
    document.getElementById("map-pop-price").innerText=(item.price||0)+"‚Ç¨";
    document.getElementById("map-pop-city-txt").innerText=item.city||"";
    document.getElementById("map-pop-btn").onclick=function(){openDetail(item.id);};
    var p=document.getElementById("map-popup");
    p.classList.remove("hidden");p.style.display="flex";
  });
  clusterGroup.addLayer(marker);
  mapMarkers.push(marker);
  // Mettre a jour le compteur
  var count=clusterGroup.getLayers().length;
  document.getElementById("map-count-txt").innerText=count+(count>1?" annonces":" annonce");
}

window.setRadius=function(km){
  activeRadius=km;
  [1,2,5,20,50,0].forEach(function(km){
    var el=document.getElementById("r"+km);
    if(el){el.style.background="#fff";el.style.color="#64748b";el.style.border="1px solid #e2e8f0";}
  });
  var activeBtn=document.getElementById("r"+km);
  if(activeBtn){activeBtn.style.background="#22d3ee";activeBtn.style.color="#000";activeBtn.style.border="none";}
  drawRadiusCircle();
  renderMapMarkers();
  if(map&&userLat&&km>0) map.setView([userLat,userLng],km<=5?13:km<=20?11:10);
};

function askGeo(){
  if(!navigator.geolocation){toast("Geolocalisation non supportee");return;}
  navigator.geolocation.getCurrentPosition(
    function(pos){
      userLat=pos.coords.latitude;userLng=pos.coords.longitude;
      if(map){
        map.setView([userLat,userLng],13);
        addUserMarker();
        renderMapMarkers();
      }
      toast("Position obtenue !",true);
    },
    function(){toast("Position refusee - affichage de toute la France");}
  );
}
window.centerMap=function(){
  if(map&&userLat) map.setView([userLat,userLng],13);
  else askGeo();
};

// Sauvegarder lat/lng lors de la publication
async function geocodeAndSave(city){
  if(!city) return null;
  return await geocodeCity(city);
}


window.filterCatSidebar=function(cat,el){
  activeCat=cat;
  document.querySelectorAll(".sidebar-nav-item,.sb-subitem").forEach(function(b){b.classList.remove("active");});
  if(el) el.classList.add("active");
  applyFilters();
  var t=document.getElementById("feed-section-title");
  if(t) t.innerText=cat==="all"?"Pour toi":cat;
  switchView("home");
};
window.setSidebarActive=function(id){
  ["snav-home","snav-map","snav-notif","snav-profile"].forEach(function(n){
    var el=document.getElementById(n);
    if(el) el.classList.remove("active");
  });
  var el=document.getElementById(id);
  if(el) el.classList.add("active");
};
window.toggleGroup=function(id){
  var list=document.getElementById(id);
  var arrow=document.getElementById("arrow-"+id);
  if(!list) return;
  list.classList.toggle("hidden");
  if(arrow) arrow.classList.toggle("open",!list.classList.contains("hidden"));
};


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAVORIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var favorites=new Set(JSON.parse(localStorage.getItem("yb_favs")||"[]"));
window.toggleFavCard=function(btn,id){
  if(favorites.has(id)){
    favorites.delete(id);
    btn.innerHTML='ü§ç';
  }else{
    favorites.add(id);
    btn.innerHTML='‚ù§Ô∏è';
  }
  localStorage.setItem("yb_favs",JSON.stringify([...favorites]));
  btn.style.transform='scale(1.3)';
  setTimeout(function(){btn.style.transform='scale(1)';},180);
};
window.toggleFav=function(id,btn){
  if(favorites.has(id)){favorites.delete(id);if(btn){btn.textContent="ü§ç";btn.classList.remove("fav");}}
  else{favorites.add(id);if(btn){btn.textContent="‚ù§Ô∏è";btn.classList.add("fav");}}
  localStorage.setItem("yb_favs",JSON.stringify([...favorites]));
};
window.toggleFavDetail=function(){
  if(!curItem) return;
  var id=curItem.id;
  var icon=document.getElementById("det-fav-icon");
  if(favorites.has(id)){
    favorites.delete(id);
    if(icon){icon.className="fa-regular fa-heart text-sm text-slate-400";}
  }else{
    favorites.add(id);
    if(icon){icon.className="fa-solid fa-heart text-sm text-rose-400";}
  }
  localStorage.setItem("yb_favs",JSON.stringify([...favorites]));
};
function renderFavs(){
  var el=document.getElementById("fav-listings");
  if(!el) return;
  var favItems=items.filter(function(i){return favorites.has(i.id);});
  if(!favItems.length){el.innerHTML='<p style="text-align:center;color:#94a3b8;font-size:11px;padding:24px 0;font-weight:700;text-transform:uppercase">Aucun favori</p>';return;}
  el.innerHTML=favItems.map(function(i){
    return '<div onclick="openDetail(\''+i.id+'\')" style="display:flex;align-items:center;gap:10px;padding:10px;background:#f8fafc;border-radius:14px;cursor:pointer;border:1px solid #e8ecf0;margin-bottom:8px"><img src="'+(i.imageUrl||"")+'" style="width:48px;height:48px;border-radius:10px;object-fit:contain;background:#fff;border:1px solid #e8ecf0;flex-shrink:0"><div style="flex:1;min-width:0"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div><button onclick="event.stopPropagation();toggleFav(\''+i.id+'\',null);renderFavs()" style="background:none;border:none;font-size:18px;cursor:pointer">‚ù§Ô∏è</button></div>';
  }).join("");
}

window.__injectDemoAndRender = function injectDemoData(){
  // Use same __demoItems from pre-script (already defined)
  if(typeof __demoItems === "undefined") return;
  var realIds=new Set(items.map(function(i){return i.id;}));
  __demoItems.forEach(function(d){if(!realIds.has(d.id)) items.push(d);});
  applyFilters();
  updateProfile();
}

function computeAndShowTrust(i){
  var score=0,details=[];
  if(i.imageUrl){score+=25;details.push({label:"Photo",ok:true});}else{details.push({label:"Pas de photo",ok:false});}
  if(i.description&&i.description.length>30){score+=20;details.push({label:"Description",ok:true});}else{details.push({label:"Description courte",ok:false});}
  if(i.city){score+=15;details.push({label:"Ville",ok:true});}else{details.push({label:"Ville manquante",ok:false});}
  if(i.shipping&&i.shipping.length){score+=15;details.push({label:"Livraison",ok:true});}else{details.push({label:"Livraison non renseign√©e",ok:false});}
  if(i.brand||i.model){score+=10;details.push({label:"Marque/Mod√®le",ok:true});}
  if(i.condition){score+=10;details.push({label:"√âtat",ok:true});}
  if(i.price>0){score+=5;details.push({label:"Prix",ok:true});}
  score=Math.min(100,score);
  var fill=document.getElementById("det-trust-fill");
  var label=document.getElementById("det-trust-label");
  var dets=document.getElementById("det-trust-details");
  if(!fill) return;
  fill.style.width=score+"%";
  fill.style.background=score>=70?"#22c55e":score>=40?"#f59e0b":"#ef4444";
  if(label) label.innerText=score+"/100 "+(score>=70?"Fiable ‚úÖ":score>=40?"Moyen ‚ö†Ô∏è":"Risqu√© ‚ùå");
  label.style.color=score>=70?"#22c55e":score>=40?"#f59e0b":"#ef4444";
  if(dets) dets.innerHTML=details.map(function(d){return'<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:99px;background:'+(d.ok?"#dcfce7":"#fee2e2")+';color:'+(d.ok?"#166534":"#991b1b")+'">'+d.label+'</span>';}).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// D√âTECTION FRAUDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectFraud(i){
  var warn=document.getElementById("det-fraud-warn");
  if(!warn) return;
  var price=parseFloat(i.price)||0;
  var cat=i.category||"";
  var similar=items.filter(function(x){return x.id!==i.id&&(x.category||"").toLowerCase()===cat.toLowerCase()&&parseFloat(x.price)>0;});
  if(similar.length>=2){
    var avg=similar.reduce(function(s,x){return s+parseFloat(x.price);},0)/similar.length;
    if(price<avg*0.25){warn.classList.remove("hidden");return;}
  }
  warn.classList.add("hidden");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRIX DU MARCH√â
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPriceRange(cat,excludeId){
  var similar=items.filter(function(i){return i.id!==excludeId&&(i.category||"").toLowerCase()===(cat||"").toLowerCase()&&parseFloat(i.price)>0;});
  if(similar.length<2) return null;
  var prices=similar.map(function(i){return parseFloat(i.price);}).sort(function(a,b){return a-b;});
  return{min:prices[0],max:prices[prices.length-1],avg:Math.round(prices.reduce(function(s,p){return s+p;},0)/prices.length)};
}
function suggestPrice(cat,excludeId){
  var range=getPriceRange(cat,excludeId);
  var el=document.getElementById("price-suggestion");
  var rangeEl=document.getElementById("price-range-txt");
  var verdictEl=document.getElementById("price-verdict");
  if(!el||!range) return;
  var inp=document.getElementById("scan-price");
  var userPrice=inp?parseFloat(inp.value):0;
  el.classList.remove("hidden");
  if(rangeEl) rangeEl.innerText=range.min+"‚Ç¨ ‚Äì "+range.max+"‚Ç¨ (moy. "+range.avg+"‚Ç¨)";
  if(verdictEl&&userPrice){
    if(userPrice<range.min*0.8){verdictEl.innerText="Tr√®s bas üî•";verdictEl.style.background="#fef3c7";verdictEl.style.color="#92400e";}
    else if(userPrice>range.max*1.2){verdictEl.innerText="√âlev√© ‚ö†Ô∏è";verdictEl.style.background="#fee2e2";verdictEl.style.color="#991b1b";}
    else{verdictEl.innerText="Prix juste ‚úÖ";verdictEl.style.background="#dcfce7";verdictEl.style.color="#166534";}
  }
}

window.updateChatSuggestions=function(){
  if(!curItem) return;
  var inp=document.getElementById("chat-inp");
  var phase=inp&&inp.value.length>0?"reply":"start";
  renderChatSuggestions(curItem,phase);
};

function renderChatSuggestions(item,phase){
  var el=document.getElementById("chat-suggestions");
  if(!el) return;
  var suggestions=phase==="start"?[
    "Toujours disponible ?","Dernier prix ?","Livraison possible ?","Vous acceptez les √©changes ?"
  ]:[
    "Merci pour l'info","Je suis int√©ress√©","Pouvez-vous faire mieux ?","Je prends !"
  ];
  el.innerHTML=suggestions.map(function(s){
    return '<button onclick="qMsg(\''+s+'\')" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:99px;padding:5px 12px;font-size:11px;font-weight:600;cursor:pointer;color:#1e293b;white-space:nowrap;flex-shrink:0">'+s+'</button>';
  }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTES SAUVEGARD√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var savedAlerts=JSON.parse(localStorage.getItem("yb_alerts")||"[]");
function renderAlerts(){
  var el=document.getElementById("alerts-list");
  if(!el) return;
  if(!savedAlerts.length){el.innerHTML='<p style="text-align:center;color:#94a3b8;font-size:11px;padding:16px 0;font-weight:700;text-transform:uppercase">Aucune alerte</p>';return;}
  el.innerHTML=savedAlerts.map(function(a,i){
    return '<div style="display:flex;align-items:center;justify-content:between;gap:8px;padding:10px;background:#f8fafc;border-radius:12px;margin-bottom:6px;border:1px solid #e8ecf0"><div style="flex:1"><p style="font-size:12px;font-weight:700;color:#1e293b">üîî '+a+'</p></div><button onclick="deleteAlert('+i+')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px;padding:2px 6px">‚úï</button></div>';
  }).join("");
}
window.openAlertes=function(){
  var m=document.getElementById("alertes-modal");
  if(m){m.classList.remove("hidden");m.classList.add("flex");}
};
window.closeAlertes=function(){
  var m=document.getElementById("alertes-modal");
  if(m){m.classList.add("hidden");m.classList.remove("flex");}
};
window.saveAlert=function(){
  var inp=document.getElementById("alert-query");
  if(!inp||!inp.value.trim()) return;
  savedAlerts.push(inp.value.trim());
  localStorage.setItem("yb_alerts",JSON.stringify(savedAlerts));
  inp.value="";
  renderAlerts();
  closeAlertes();
  toast("Alerte cr√©√©e ! üîî",true);
};
window.deleteAlert=function(i){
  savedAlerts.splice(i,1);
  localStorage.setItem("yb_alerts",JSON.stringify(savedAlerts));
  renderAlerts();
};
function checkAlertsOnNewItems(newItems){
  if(!savedAlerts.length) return;
  newItems.forEach(function(item){
    savedAlerts.forEach(function(alert){
      var keywords=alert.toLowerCase().split(/\s+/);
      var text=((item.itemName||"")+" "+(item.category||"")+" "+(item.city||"")).toLowerCase();
      if(keywords.some(function(k){return k.length>2&&text.includes(k);})){
        showPushBanner("üîî Alerte : "+alert,"Nouvelle annonce : "+(item.itemName||"")+" ‚Äî "+(item.price||0)+"‚Ç¨");
      }
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BADGES V√âRIFI√âS & VIEWER COUNT UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showVerifiedBadge(show){
  var b=document.getElementById("profile-verified");
  if(b) show?b.classList.remove("hidden"):b.classList.add("hidden");
}
function updateViewCount(item){
  var vc=(item.views||0)+1;
  var vb=document.getElementById("det-views-badge");
  var vc_el=document.getElementById("det-views-count");
  if(vb){vb.classList.remove("hidden");if(vc_el)vc_el.innerText=vc;}
  if(me&&item.userId!==me.uid){
    updateDoc(doc(db,"scans",item.id),{views:vc}).catch(function(){});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOST AUTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.toggleBoost=function(cb){
  if(cb.checked){toast("Boost auto activ√© ! ‚ú®",true);localStorage.setItem("yb_boost","1");}
  else{toast("Boost auto d√©sactiv√©");localStorage.removeItem("yb_boost");}
};
setTimeout(function(){
  var bt=document.getElementById("boost-toggle");
  if(bt) bt.checked=!!localStorage.getItem("yb_boost");
},500);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTAGE NATIF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.shareItem=function(){if(curItem) openShareModal();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUGGESTION PRIX IA dans scan
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePriceSuggestion(){
  var cat=document.getElementById("ai-cat-select");
  if(cat&&scanData) suggestPrice(cat.value,null);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARROUSEL PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var carPhotos=[],carIdx=0;
function buildCarousel(photos){
  carPhotos=photos&&photos.length?photos:[""];
  carIdx=0;
  var track=document.getElementById("det-carousel-track");
  var dots=document.getElementById("det-dots");
  var thumbs=document.getElementById("det-thumbs");
  if(!track) return;
  track.innerHTML=carPhotos.map(function(src){
    return '<div style="width:100%;height:100%;flex-shrink:0;background:#f8f8f8"><img src="'+src+'" style="width:100%;height:100%;object-fit:contain;display:block;"></div>';
  }).join("");
  if(carPhotos.length>1){
    if(dots) dots.innerHTML=carPhotos.map(function(_,i){return'<div class="photo-dot'+(i===0?' on':'')+'" onclick="goSlide('+i+')"></div>';}).join("");
    var prev=document.getElementById("det-prev"),next=document.getElementById("det-next");
    if(prev) prev.style.display="flex";
    if(next) next.style.display="flex";
  }else{
    if(dots) dots.innerHTML="";
    var prev=document.getElementById("det-prev"),next=document.getElementById("det-next");
    if(prev) prev.style.display="none";
    if(next) next.style.display="none";
  }
  if(thumbs) thumbs.innerHTML=carPhotos.length>1?carPhotos.map(function(src,i){return'<img class="photo-thumb'+(i===0?' active':'')+'" src="'+src+'" onclick="goSlide('+i+')">';}).join(""):"";
  goSlide(0);
}
window.carNav=function(dir){goSlide((carIdx+dir+carPhotos.length)%carPhotos.length);};
window.goSlide=function(idx){
  carIdx=idx;
  var track=document.getElementById("det-carousel-track");
  if(track) track.style.transform="translateX(-"+(idx*100)+"%)";
  document.querySelectorAll(".photo-dot").forEach(function(d,i){d.classList.toggle("on",i===idx);});
  document.querySelectorAll(".photo-thumb").forEach(function(t,i){t.classList.toggle("active",i===idx);});
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTOS SUPPL√âMENTAIRES (scan form)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var extraPhotos=[];
window.addExtraPhotos=function(inp){
  Array.from(inp.files||[]).forEach(function(f){
    if(extraPhotos.length>=4) return;
    var r=new FileReader();
    r.onload=function(ev){extraPhotos.push(ev.target.result);renderExtraPhotos();};
    r.readAsDataURL(f);
  });
  inp.value="";
};
function renderExtraPhotos(){
  var el=document.getElementById("extra-photos-list");
  if(!el) return;
  if(!extraPhotos.length){el.innerHTML='<p class="text-[10px] text-slate-500 self-center">Aucune photo suppl√©mentaire</p>';return;}
  el.innerHTML=extraPhotos.map(function(src,i){
    return '<div style="position:relative;flex-shrink:0"><img src="'+src+'" class="photo-thumb active"><div onclick="removeExtraPhoto('+i+')" style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:#ef4444;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;font-weight:900">√ó</div></div>';
  }).join("");
}
window.removeExtraPhoto=function(i){extraPhotos.splice(i,1);renderExtraPhotos();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTAGE R√âSEAUX SOCIAUX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openShareModal=function(){
  if(!curItem) return;
  document.getElementById("share-prev-img").src=curItem.imageUrl||"";
  document.getElementById("share-prev-title").innerText=curItem.itemName||"";
  document.getElementById("share-prev-price").innerText=(curItem.price||0)+"‚Ç¨";
  var url="https://youbiiiz.app/item/"+(curItem.id||"");
  document.getElementById("share-link-val").value=url;
  var m=document.getElementById("share-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeShareModal=function(){
  var m=document.getElementById("share-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.shareTo=function(net){
  if(!curItem) return;
  var title=encodeURIComponent((curItem.itemName||"")+" ‚Äî "+(curItem.price||0)+"‚Ç¨");
  var url=encodeURIComponent("https://youbiiiz.app/item/"+(curItem.id||""));
  var text=encodeURIComponent("üõç "+(curItem.itemName||"")+" ‚Äî "+(curItem.price||0)+"‚Ç¨ sur Youbiiiz ‚Üí ");
  var links={
    whatsapp:"https://wa.me/?text="+text+url,
    facebook:"https://www.facebook.com/sharer/sharer.php?u="+url,
    twitter:"https://twitter.com/intent/tweet?text="+text+"&url="+url,
    telegram:"https://t.me/share/url?url="+url+"&text="+text,
    messenger:"https://www.facebook.com/dialog/send?link="+url+"&app_id=123456789",
    sms:"sms:?body="+text+url
  };
  if(net==="instagram"||net==="tiktok"){
    var label=net==="instagram"?"story Instagram üì∏":"bio TikTok üéµ";
    navigator.clipboard.writeText(decodeURIComponent(text)+decodeURIComponent(url)).then(function(){toast("Texte copi√© ! Colle dans ta "+label,true);}).catch(function(){});
    closeShareModal();return;
  }
  if(links[net]) window.open(links[net],"_blank","noopener,width=600,height=500");
  closeShareModal();
};
window.copyShareLink=function(){
  var v=document.getElementById("share-link-val");
  navigator.clipboard.writeText(v.value).then(function(){toast("Lien copi√© ! üìã",true);}).catch(function(){v.select();document.execCommand("copy");toast("Lien copi√© !",true);});
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAIRE UNE OFFRE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openOffer=function(){
  if(!curItem) return;
  var price=parseFloat(curItem.price)||0;
  document.getElementById("offer-asked").innerText=price+"‚Ç¨";
  document.getElementById("offer-amount").value="";
  document.getElementById("offer-amount").placeholder=Math.round(price*0.85);
  document.getElementById("offer-hint").innerText="Conseil : proposez entre "+Math.round(price*0.75)+"‚Ç¨ et "+Math.round(price*0.92)+"‚Ç¨";
  var percs=[90,80,70];
  document.getElementById("offer-quick").innerHTML=percs.map(function(p){
    var v=Math.round(price*p/100);
    return '<button onclick="document.getElementById(\'offer-amount\').value='+v+'" style="background:#f1f5f9;border:1.5px solid #e2e8f0;border-radius:99px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;color:#0f172a">'+v+'‚Ç¨ <span style="color:#94a3b8;font-size:9px">(-'+(100-p)+'%)</span></button>';
  }).join("");
  var m=document.getElementById("offer-modal");m.classList.remove("hidden");m.classList.add("flex");
};
window.closeOffer=function(){var m=document.getElementById("offer-modal");m.classList.add("hidden");m.classList.remove("flex");};
window.sendOffer=function(){
  var amt=parseFloat(document.getElementById("offer-amount").value);
  if(!amt||amt<=0){toast("Entrez un montant valide");return;}
  if(curItem&&amt>=parseFloat(curItem.price)){toast("Votre offre doit √™tre inf√©rieure au prix");return;}
  closeOffer();
  openChat(curItem);
  setTimeout(function(){
    document.getElementById("chat-inp").value="Bonjour, je vous propose "+amt+"‚Ç¨ pour cet article. Est-ce que ce prix vous convient ?";
    sendMsg();
  },500);
  toast("Offre envoy√©e : "+amt+"‚Ç¨ ü§ù",true);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIGNALEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openReport=function(){var m=document.getElementById("report-modal");m.classList.remove("hidden");m.classList.add("flex");};
window.closeReport=function(){var m=document.getElementById("report-modal");m.classList.add("hidden");m.classList.remove("flex");};
window.submitReport=async function(reason){
  closeReport();
  if(!me||!curItem) return;
  try{
    await addDoc(collection(db,"reports"),{itemId:curItem.id,userId:me.uid,reason:reason,createdAt:serverTimestamp()});
    toast("Signalement envoy√©. Merci ! üôè",true);
  }catch(e){toast("Merci pour le signalement üôè",true);}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFIL VENDEUR PUBLIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openSellerProfile=function(){
  if(!curItem) return;
  var sellerId=curItem.userId;
  var sellerItems=items.filter(function(i){return i.userId===sellerId;});
  document.getElementById("sp-name").innerText="Vendeur #"+(sellerId||"").slice(0,8);
  document.getElementById("sp-count").innerText=sellerItems.length;
  var since=sellerItems.length&&sellerItems[sellerItems.length-1].createdAt?new Date((sellerItems[sellerItems.length-1].createdAt.seconds||0)*1000).toLocaleDateString("fr-FR",{month:"long",year:"numeric"}):"R√©cemment";
  document.getElementById("sp-since").innerText="Membre depuis "+since;
  getDoc(doc(db,"users",sellerId)).then(function(d){
    var rv=document.getElementById("sp-rating-val");
    if(d.exists()&&d.data().rating){if(rv)rv.innerText="‚òÖ"+d.data().rating;}
  }).catch(function(){});
  var el=document.getElementById("sp-listings");
  el.innerHTML=sellerItems.map(function(i){
    return '<div onclick="closeSellerProfile();openDetail(\''+i.id+'\')" style="cursor:pointer;background:#f8fafc;border:1px solid #e8ecf0;border-radius:14px;overflow:hidden"><div style="height:90px;background:#f1f5f9"><img src="'+(i.imageUrl||"")+'" style="width:100%;height:100%;object-fit:contain;background:#f8f8f8;display:block"></div><div style="padding:8px"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div></div>';
  }).join("")||'<p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;padding:24px">Aucune annonce active</p>';
  var m=document.getElementById("seller-profile-modal");m.classList.remove("hidden");m.classList.add("flex");
};
window.closeSellerProfile=function(){var m=document.getElementById("seller-profile-modal");m.classList.add("hidden");m.classList.remove("flex");};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANNONCES SIMILAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSimilar(item){
  var el=document.getElementById("det-similar");
  if(!el) return;
  var similar=items.filter(function(i){
    if(i.id===item.id) return false;
    var sameCat=(i.category||"").toLowerCase()===(item.category||"").toLowerCase();
    var price=parseFloat(item.price)||0;
    var iPrice=parseFloat(i.price)||0;
    return sameCat&&(!price||Math.abs(iPrice-price)<price*0.8);
  }).slice(0,6);
  if(!similar.length){el.innerHTML='<p style="font-size:11px;color:#94a3b8;padding:8px 0">Aucune annonce similaire</p>';return;}
  el.innerHTML=similar.map(function(i){
    return '<div onclick="openDetail(\''+i.id+'\')" style="flex-shrink:0;width:110px;cursor:pointer"><div style="width:110px;height:90px;background:#1e293b;border-radius:12px;overflow:hidden;margin-bottom:5px;border:1px solid rgba(148,163,184,.1)"><img src="'+(i.imageUrl||"")+'" style="width:100%;height:100%;object-fit:contain;display:block;background:#f8f8f8"></div><p style="font-size:11px;font-weight:700;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:13px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div>';
  }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIQUE DE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var browseHistory=JSON.parse(localStorage.getItem("yb_history")||"[]");
function addToHistory(item){
  browseHistory=browseHistory.filter(function(h){return h.id!==item.id;});
  browseHistory.unshift({id:item.id,name:item.itemName,price:item.price,img:item.imageUrl,ts:Date.now()});
  if(browseHistory.length>20) browseHistory=browseHistory.slice(0,20);
  localStorage.setItem("yb_history",JSON.stringify(browseHistory));
}
function renderHistory(){
  var el=document.getElementById("history-list");
  if(!el) return;
  var valid=browseHistory.filter(function(h){return items.find(function(i){return i.id===h.id;});});
  if(!valid.length){el.innerHTML='<p style="font-size:11px;color:#94a3b8;text-align:center;padding:12px 0">Aucune annonce consult√©e</p>';return;}
  el.innerHTML=valid.slice(0,8).map(function(h){
    var s=Math.floor((Date.now()-h.ts)/1000);
    var ago=s<60?"√† l'instant":s<3600?Math.floor(s/60)+"min":s<86400?Math.floor(s/3600)+"h":Math.floor(s/86400)+"j";
    return '<div onclick="openDetail(\''+h.id+'\')" style="display:flex;align-items:center;gap:10px;padding:8px;background:#f8fafc;border-radius:12px;cursor:pointer;border:1px solid #e8ecf0;margin-bottom:6px"><img src="'+(h.img||"")+'" style="width:44px;height:44px;border-radius:10px;object-fit:contain;background:#fff;border:1px solid #e8ecf0;flex-shrink:0"><div style="flex:1;min-width:0"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(h.name||"Objet")+'</p><p style="font-size:13px;font-weight:900;color:#0ea5e9">'+(h.price||0)+'‚Ç¨</p></div><p style="font-size:10px;color:#94a3b8;flex-shrink:0">'+ago+'</p></div>';
  }).join("");
}
window.clearHistory=function(){browseHistory=[];localStorage.removeItem("yb_history");renderHistory();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YOUBIIIZ COINS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var payMode="1x";
window.selectPayMode=function(mode){
  payMode=mode;
  document.getElementById("pay-mode-1x").className="pay3x-option"+(mode==="1x"?" selected":"");
  document.getElementById("pay-mode-3x").className="pay3x-option"+(mode==="3x"?" selected":"");
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECHERCHE PAR PHOTO (IA)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openSearchByPhoto=function(){
  var idle=document.getElementById("sph-idle");
  var load=document.getElementById("sph-loading");
  var res=document.getElementById("sph-results");
  if(idle)idle.classList.remove("hidden");
  if(load)load.classList.add("hidden");
  if(res)res.classList.add("hidden");
  var m=document.getElementById("search-photo-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeSearchPhoto=function(){var m=document.getElementById("search-photo-modal");m.classList.add("hidden");m.classList.remove("flex");};
window.onSearchPhoto=function(inp){
  var f=inp.files[0];if(!f)return;
  document.getElementById("sph-idle").classList.add("hidden");
  document.getElementById("sph-loading").classList.remove("hidden");
  var r=new FileReader();
  r.onload=function(ev){analyzeSearchPhoto(ev.target.result);};
  r.readAsDataURL(f);inp.value="";
};
async function analyzeSearchPhoto(b64){
  try{
    var mime=b64.indexOf("data:image/png")===0?"image/png":"image/jpeg";
    var resp=await fetch("https://analyzeimage-xjtnixfrra-uc.a.run.app",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({imageBase64:b64.split(",")[1],mimeType:mime})
    });
    var d=await resp.json();
    var detected=d.title||d.category||"Objet";
    document.getElementById("sph-loading").classList.add("hidden");
    document.getElementById("sph-results").classList.remove("hidden");
    document.getElementById("sph-detected").innerText=detected;
    var keywords=(detected+" "+(d.category||"")).toLowerCase().split(/[\s,]+/).filter(function(w){return w.length>3;});
    var matches=items.filter(function(i){
      var text=((i.itemName||"")+" "+(i.category||"")).toLowerCase();
      return keywords.some(function(k){return text.indexOf(k)>=0;});
    }).slice(0,5);
    var el=document.getElementById("sph-list");
    if(!matches.length){el.innerHTML='<p style="font-size:12px;color:#94a3b8;text-align:center;padding:16px">Aucune annonce similaire</p>';return;}
    el.innerHTML=matches.map(function(i){
      return '<div onclick="closeSearchPhoto();openDetail(\''+i.id+'\')" style="display:flex;align-items:center;gap:10px;padding:8px;background:#f8fafc;border-radius:12px;cursor:pointer;border:1px solid #e8ecf0;margin-bottom:6px"><img src="'+(i.imageUrl||"")+'" style="width:44px;height:44px;border-radius:8px;object-fit:contain;background:#fff;flex-shrink:0"><div style="flex:1;min-width:0"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div><i class="fa-solid fa-chevron-right" style="color:#94a3b8;font-size:11px;flex-shrink:0"></i></div>';
    }).join("");
  }catch(e){
    document.getElementById("sph-loading").classList.add("hidden");
    document.getElementById("sph-idle").classList.remove("hidden");
    toast("Erreur analyse image");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERRIDE openDetail: carrousel + similaires + historique + coins
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _origOpenDetail=window.openDetail;
window.openDetail=function(id){
  // merge demo items if not yet in items array
  if(window.__demoItems){
    var ids=new Set(items.map(function(x){return x.id;}));
    window.__demoItems.forEach(function(d){if(!ids.has(d.id))items.push(d);});
  }
  var i=items.find(function(x){return x.id===id;});
  if(!i) return;
  _origOpenDetail(id);
  var photos=[i.imageUrl].concat(i.extraPhotos||[]).filter(Boolean);
  buildCarousel(photos);
  renderSimilar(i);
  addToHistory(i);
  computeAndShowTrust(i);
  detectFraud(i);
  var price=parseFloat(i.price)||0;
  var coinsEl=document.getElementById("det-coins-earn");
  if(coinsEl&&price>0){coinsEl.classList.remove("hidden");coinsEl.innerText="ü™ô +"+(Math.round(price*0.05))+" coins si tu ach√®tes";}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERRIDE openPay: paiement 3x + coins
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _origOpenPay=window.openPay;
window.openPay=function(i){
  _origOpenPay(i);
  payMode="1x";
  var tot=parseFloat(i.price||0);
  var per3=Math.ceil(tot/3*100)/100;
  var el1=document.getElementById("pay-1x-amount");
  var el3=document.getElementById("pay-3x-amount");
  var el3d=document.getElementById("pay-3x-detail");
  if(el1) el1.innerText=tot+"‚Ç¨";
  if(el3) el3.innerText=per3+"‚Ç¨/mois";
  if(el3d) el3d.innerText="3 pr√©l√®vements de "+per3+"‚Ç¨ ¬∑ Total "+tot+"‚Ç¨ ¬∑ 0% de frais";
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERRIDE doStripe: gain coins apr√®s achat
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _origDoStripe=window.doStripe;
window.doStripe=async function(){
  await _origDoStripe();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERRIDE switchView: coins + historique + favs dans profil
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _origSwitchView=window.switchView;
window.switchView=function(v){
  _origSwitchView(v);
  if(v==="profile"){
    renderHistory();
    renderAlerts();
    renderFavs();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MYCARD am√©lior√©e avec stats vues
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

</script>
</body>
</html>
