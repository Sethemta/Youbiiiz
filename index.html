<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Youbiiiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050505;
            color: white;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* --- LOGO ENGINE (3i Balle au sol - Validé) --- */
        .brand-logo { display: inline-flex; align-items: baseline; font-weight: 800; line-height: 1; user-select: none; }
        .i-wrapper { display: inline-flex; align-items: flex-end; gap: 4px; margin: 0 4px; height: 100%; }
        .i-stem { width: 12px; height: 38px; background: #22d3ee; border-radius: 2px; }
        .i-dot { width: 12px; height: 12px; background: #22d3ee; border-radius: 2px; position: absolute; bottom: 48px; box-shadow: 0 0 20px rgba(34, 211, 238, 0.5); }
        .i-char { position: relative; display: flex; flex-direction: column; align-items: center; }

        header .i-stem { width: 5px; height: 16px; }
        header .i-dot { width: 5px; height: 5px; bottom: 20px; box-shadow: none; }
        header .i-wrapper { gap: 2px; margin: 0 2px; }

        @keyframes subtle-dribble {
            0%, 100% { transform: translateY(0); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(var(--bounce)); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .i-char:nth-child(1) .i-dot { --bounce: -10px; animation: subtle-dribble 0.9s infinite; }
        .i-char:nth-child(2) .i-dot { --bounce: -15px; animation: subtle-dribble 1.3s infinite 0.2s; }
        .i-char:nth-child(3) .i-dot { --bounce: -12px; animation: subtle-dribble 1.1s infinite 0.5s; }

        /* UI */
        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .nav-blur { background: rgba(5, 5, 5, 0.9); backdrop-filter: saturate(180%) blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.05); }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .scan-line-anim { animation: scanMove 2s linear infinite; }
        @keyframes scanMove { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* ERROR TOAST */
        #debug-console { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 10px 20px; border-radius: 99px; font-size: 12px; font-weight: bold; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; text-align: center; }
    </style>
</head>
<body class="bg-[#050505]">

    <div id="debug-console"></div>

    <!-- SPLASH SCREEN -->
    <div id="splash" class="fixed inset-0 z-[200] bg-[#050505] flex flex-col items-center justify-center transition-all duration-500">
        <div class="brand-logo text-7xl flex items-baseline">
            <span>YOUB</span>
            <span class="i-wrapper">
                <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
            </span>
            <span>Z</span>
        </div>
        <div class="mt-12 w-32 h-1 bg-zinc-900 rounded-full overflow-hidden">
            <div class="h-full bg-cyan-500 animate-[loading_2s_ease-in-out_infinite]" style="width: 50%"></div>
        </div>
        <p class="mt-4 text-[10px] text-zinc-600 font-bold uppercase tracking-widest">Connexion...</p>
        <style>@keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }</style>
    </div>

    <!-- APP -->
    <div id="app" class="hidden opacity-0 transition-opacity duration-700 h-screen flex flex-col">
        
        <header class="h-20 px-6 flex items-center justify-between nav-blur z-50 shrink-0">
            <div class="brand-logo text-2xl" onclick="switchView('home')">
                <span>YOUB</span>
                <span class="i-wrapper">
                    <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                    <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                    <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                </span>
                <span>Z</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="user-badge" class="text-[10px] font-mono text-zinc-500">...</div>
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center border border-white/10">
                    <i class="fa-solid fa-user text-sm text-white"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-32 relative">
            <div id="view-home" class="px-6 pt-6 max-w-lg mx-auto transition-all duration-300">
                
                <!-- BANNER SCAN -->
                <div class="glass-card rounded-[2.5rem] p-8 relative overflow-hidden mb-8 text-center cursor-pointer active:scale-95 transition-transform" onclick="startScan()">
                    <div class="relative z-10 flex flex-col items-center gap-4">
                        <div class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center shadow-[0_0_30px_rgba(34,211,238,0.4)] border-[4px] border-[#050505]">
                            <i class="fa-solid fa-camera text-3xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-extrabold tracking-tighter text-white">SCANNER UN OBJET</h1>
                            <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mt-1">IA active • Instantané</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6 border-b border-white/5 pb-2">
                    <h2 class="text-lg font-bold tracking-tight">Derniers Drops</h2>
                    <div class="text-[10px] text-green-500 font-bold uppercase flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Live Sync
                    </div>
                </div>

                <div id="feed" class="grid grid-cols-1 gap-4 pb-10">
                    <div class="py-10 text-center text-zinc-700">
                        <i class="fa-solid fa-circle-notch animate-spin text-2xl"></i>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-md h-20 glass-card rounded-full flex items-center justify-around px-8 shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-[100]">
            <button onclick="switchView('home')" class="text-2xl text-cyan-400"><i class="fa-solid fa-house"></i></button>
            <button onclick="startScan()" class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-full flex items-center justify-center text-white shadow-[0_0_25px_rgba(34,211,238,0.5)] -mt-8 border-[6px] border-[#050505] active:scale-90 transition-transform">
                <i class="fa-solid fa-plus text-2xl"></i>
            </button>
            <button class="text-2xl text-zinc-600"><i class="fa-solid fa-magnifying-glass"></i></button>
        </nav>
    </div>

    <!-- SCAN OVERLAY -->
    <div id="scan-overlay" class="fixed inset-0 z-[300] bg-black hidden flex-col p-6">
        <div class="flex justify-between items-center mb-6">
            <span class="text-xs font-bold tracking-[0.3em] text-cyan-500">SCANNER IA</span>
            <button onclick="stopScan()" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="flex-1 relative bg-zinc-900 rounded-[3rem] overflow-hidden border border-white/10 shadow-2xl flex flex-col justify-center items-center">
            <img id="scan-preview" class="absolute inset-0 w-full h-full object-cover hidden z-10">
            <div id="scan-line" class="hidden absolute w-full h-[3px] bg-cyan-400 shadow-[0_0_20px_#22d3ee] top-0 left-0 z-20 scan-line-anim"></div>
            
            <div id="scan-placeholder" class="text-center">
                <i class="fa-solid fa-camera text-4xl text-zinc-700 mb-4"></i>
                <p class="text-[10px] font-bold uppercase tracking-widest text-zinc-500">Alignez l'objet</p>
            </div>
            
            <!-- LOADER FORCÉ AVEC FOND -->
            <div id="uploading-msg" class="hidden absolute inset-0 bg-black/90 z-30 flex flex-col items-center justify-center">
                 <i class="fa-solid fa-circle-notch animate-spin text-cyan-500 text-4xl mb-4"></i>
                 <span class="text-cyan-500 text-xs font-bold animate-pulse text-center tracking-widest">ANALYSE EN COURS...</span>
            </div>
        </div>

        <!-- AI RESULTS -->
        <div id="ai-hud" class="hidden w-full mt-6 bg-zinc-900/50 p-6 rounded-[2rem] border border-white/10 modal-enter">
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs text-zinc-400 font-mono uppercase">Analyse terminée</span>
                <span class="text-xs text-green-400 font-bold"><i class="fa-solid fa-check-circle"></i> Succès</span>
            </div>
            
            <input id="ai-item-name" class="w-full bg-transparent text-xl font-extrabold text-white mb-4 border-b border-white/10 focus:border-cyan-500 outline-none pb-2" value="...">
            
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-black p-3 rounded-xl border border-white/10">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold">Prix Estimé</p>
                    <p id="ai-price" class="text-lg font-black text-cyan-400">...</p>
                </div>
                <div class="bg-black p-3 rounded-xl border border-white/10">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold">Catégorie</p>
                    <p id="ai-category" class="text-sm font-black text-white">...</p>
                </div>
                <div class="bg-black p-3 rounded-xl border border-white/10">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold">État</p>
                    <p id="ai-condition" class="text-sm font-black text-green-400">...</p>
                </div>
            </div>
            
            <div class="bg-black/50 p-3 rounded-xl border border-white/5 mb-6">
                <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Description Auto</p>
                <textarea id="ai-desc" class="w-full bg-transparent text-xs text-zinc-300 outline-none h-16 resize-none" readonly>...</textarea>
            </div>

            <button id="validate-btn" class="w-full bg-cyan-500 text-black font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">VALIDER & PUBLIER</button>
        </div>

        <!-- Canvas caché pour capturer la frame vidéo -->
        <canvas id="capture-canvas" class="hidden"></canvas>

        <!-- Bouton capture TOUJOURS au dessus de la vidéo -->
        <div class="h-24 flex items-center justify-center shrink-0" style="position:relative; z-index:50;">
            <input type="file" id="camera-input" class="hidden" accept="image/*" onchange="handleImageFile(event)">
            <button id="capture-btn" onclick="capturePhoto()" class="w-20 h-20 bg-white rounded-full border-[6px] border-black ring-2 ring-white active:scale-90 transition-all shadow-2xl"></button>
        </div>
    </div>

    <!-- Vidéo positionnée en fixed pour couvrir la zone aperçu sans déborder sur le bouton -->
    <video id="camera-video" class="hidden" style="position:fixed; top:120px; left:0; right:0; width:100%; height:calc(100% - 220px); object-fit:cover; z-index:310;" autoplay playsinline muted></video>

    <!-- PAIEMENT MODAL -->
    <div id="payment-modal" class="fixed inset-0 z-[400] bg-black/95 backdrop-blur-sm hidden items-end sm:items-center justify-center p-4">
        <div class="bg-[#0f0f0f] w-full max-w-md p-6 rounded-[2.5rem] border border-white/10 modal-enter shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-500"><i class="fa-solid fa-shield-halved"></i></div>
                    <span class="font-bold text-sm">Paiement Sécurisé</span>
                </div>
                <button onclick="closePayment()" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex gap-4 mb-8">
                <div id="pay-img" class="w-20 h-20 rounded-2xl bg-zinc-800 bg-cover bg-center border border-white/10"></div>
                <div class="flex-1">
                    <h4 id="pay-title" class="font-bold text-lg leading-tight mb-1">...</h4>
                    <p id="pay-price" class="text-cyan-500 font-extrabold text-2xl">0€</p>
                </div>
            </div>
            <button onclick="processPayment()" class="w-full bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-5 rounded-2xl flex justify-center items-center gap-2 shadow-[0_0_20px_rgba(34,211,238,0.3)] transition-all active:scale-95">
                <i class="fa-brands fa-apple-pay text-xl"></i> Payer & Bloquer
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDOSIhWwrlkhNfk8Y3-tl9IebJW0YBA7d4",
          authDomain: "youbiiiz-app.firebaseapp.com",
          projectId: "youbiiiz-app",
          storageBucket: "youbiiiz-app.firebasestorage.app",
          messagingSenderId: "664733497216",
          appId: "1:664733497216:web:ae19fbadf0fa509f59b365"
        };
        const GEMINI_API_KEY = "AIzaSyDdKLxF4Yc2LksNtwzmkotB2JhP_3cfL1c";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentScanData = null;

        // ✅ FIX 2 — allItems déclaré globalement
        let allItems = [];

        function logError(msg) {
            console.error(msg);
            const debug = document.getElementById('debug-console');
            debug.style.display = 'block';
            debug.innerText = msg;
        }

        // AUTH
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if(document.getElementById('user-badge')) document.getElementById('user-badge').innerText = `ID: ${user.uid.substring(0,4)}`;
                startApp();
            } else {
                signInAnonymously(auth).catch(e => {
                    logError("Auth Error: " + e.message);
                });
            }
        });

        function startApp() {
            setTimeout(() => {
                document.getElementById('splash').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
                setTimeout(() => document.getElementById('app').style.opacity = '1', 100);
                initFeed();
            }, 1000);
        }

        // DATA
        function initFeed() {
            const feedCol = collection(db, 'scans');
            onSnapshot(feedCol, (snapshot) => {
                // ✅ FIX 2 — on remplit allItems ici
                allItems = [];
                snapshot.forEach(doc => allItems.push({id: doc.id, ...doc.data()}));
                allItems.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderFeed(allItems);
            }, (error) => {
                logError("Feed Error: " + error.message);
            });
        }

        function renderFeed(items) {
            const container = document.getElementById('feed');
            if (items.length === 0) {
                container.innerHTML = `<div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Aucune annonce</div>`;
                return;
            }
            container.innerHTML = items.map(item => `
                <div class="glass-card rounded-[2rem] p-4 flex gap-4 items-center fade-in mb-4 group cursor-pointer" onclick="openPayment('${item.id}')">
                    <div class="w-20 h-20 rounded-2xl bg-zinc-800 overflow-hidden shrink-0 border border-white/5 relative">
                        <img src="${item.imageUrl}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-sm truncate text-white">${item.itemName}</h4>
                        <p class="text-cyan-400 font-extrabold text-lg">${item.price}€</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[9px] text-zinc-500 font-bold uppercase bg-zinc-900 px-2 py-0.5 rounded border border-white/5">${item.category || 'Divers'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ✅ CAMERA — getUserMedia avec fallback input file
        let cameraStream = null;

        window.startScan = async () => {
            document.getElementById('scan-overlay').classList.remove('hidden');
            document.getElementById('scan-overlay').classList.add('flex');
            await startCamera();
        };

        async function startCamera() {
            const video = document.getElementById('camera-video');
            const placeholder = document.getElementById('scan-placeholder');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = cameraStream;
                video.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } catch (err) {
                console.warn("getUserMedia échoué, fallback input file", err);
                document.getElementById('camera-input').click();
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            const video = document.getElementById('camera-video');
            video.srcObject = null;
            video.classList.add('hidden');
        }

        window.capturePhoto = () => {
            const video = document.getElementById('camera-video');
            // Si la vidéo est active, on capture une frame
            if (cameraStream && !video.classList.contains('hidden')) {
                const canvas = document.getElementById('capture-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const imgBase64 = canvas.toDataURL('image/jpeg', 0.9);
                stopCamera();
                processCapture(imgBase64);
            } else {
                // Fallback : ouvre l'input file
                document.getElementById('camera-input').click();
            }
        };

        // Fallback : si l'utilisateur sélectionne un fichier
        window.handleImageFile = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => processCapture(evt.target.result);
            reader.readAsDataURL(file);
        };

        function processCapture(imgBase64) {
            document.getElementById('scan-placeholder').classList.add('hidden');
            document.getElementById('capture-btn').classList.add('hidden');
            document.getElementById('uploading-msg').classList.remove('hidden');
            document.getElementById('scan-line').classList.remove('hidden');
            document.getElementById('scan-preview').src = imgBase64;
            document.getElementById('scan-preview').classList.remove('hidden');

            analyzeWithGemini(imgBase64);
        }

        async function analyzeWithGemini(imgBase64) {
            try {
                const prompt = `Tu es un expert en estimation de produits d'occasion. Analyse cette image avec une précision maximale.

Identifie :
- La marque exacte et le modèle précis du produit (ex: "Souris Gaming Alienware AW510M")
- Le prix de revente réaliste en euros sur le marché occasion français (base-toi sur les prix Leboncoin, Vinted, eBay FR)
- La catégorie précise (ex: "Informatique > Périphériques", "High-Tech", "Jeux vidéo", etc.)
- Une description vendeuse de 2-3 phrases mentionnant les caractéristiques clés visibles
- L'état estimé du produit (Neuf, Très bon état, Bon état, État correct)

Réponds UNIQUEMENT avec ce JSON valide, sans aucun texte autour :
{"title": "Marque Modèle exact", "price": 0, "category": "catégorie précise", "description": "description vendeuse 2-3 phrases", "condition": "état estimé"}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: "image/jpeg", data: imgBase64.split(',')[1] } },
                                { text: prompt }
                            ]
                        }],
                        generationConfig: { temperature: 0.1, maxOutputTokens: 600 }
                    })
                });

                const data = await response.json();

                // Affiche l'erreur brute si problème API
                if (data.error) {
                    logError("Erreur Gemini: " + data.error.message);
                    document.getElementById('uploading-msg').classList.add('hidden');
                    document.getElementById('scan-line').classList.add('hidden');
                    document.getElementById('capture-btn').classList.remove('hidden');
                    return;
                }

                const text = data.candidates[0].content.parts[0].text;
                const jsonStr = text.replace(/```json|```/g, '').trim();
                const aiData = JSON.parse(jsonStr);
                updateScanUI(aiData, imgBase64);

            } catch (err) {
                console.error("Erreur IA", err);
                logError("Erreur analyse IA: " + err.message);
                document.getElementById('uploading-msg').classList.add('hidden');
                document.getElementById('scan-line').classList.add('hidden');
                document.getElementById('capture-btn').classList.remove('hidden');
            }
        }

        function updateScanUI(result, img) {
            document.getElementById('uploading-msg').classList.add('hidden');
            document.getElementById('scan-line').classList.add('hidden');
            
            document.getElementById('ai-item-name').value = result.title;
            document.getElementById('ai-price').innerText = result.price + "€";
            document.getElementById('ai-category').innerText = result.category;
            if(document.getElementById('ai-desc')) document.getElementById('ai-desc').value = result.description || "";
            if(document.getElementById('ai-condition')) document.getElementById('ai-condition').innerText = result.condition || "Bon état";
            
            currentScanData = { 
                itemName: result.title, 
                price: result.price, 
                category: result.category,
                condition: result.condition || "Bon état",
                imageUrl: img
            };
            document.getElementById('ai-hud').classList.remove('hidden');
        }

        document.getElementById('validate-btn').addEventListener('click', async () => {
            if(!currentScanData || !currentUser) return;
            const finalTitle = document.getElementById('ai-item-name').value;
            
            try {
                await addDoc(collection(db, 'scans'), {
                    userId: currentUser.uid,
                    itemName: finalTitle,
                    price: currentScanData.price,
                    category: currentScanData.category,
                    condition: currentScanData.condition || "Bon état",
                    imageUrl: currentScanData.imageUrl, // ✅ FIX 3 — utilise bien .imageUrl
                    createdAt: serverTimestamp()
                });
                window.stopScan();
                window.switchView('home');
            } catch (err) { 
                logError("Publish Error: " + err.message);
                console.error(err); 
            }
        });

        window.stopScan = () => {
            stopCamera();
            document.getElementById('scan-overlay').classList.add('hidden');
            document.getElementById('scan-overlay').classList.remove('flex');
            document.getElementById('scan-preview').classList.add('hidden');
            document.getElementById('scan-placeholder').classList.remove('hidden');
            document.getElementById('ai-hud').classList.add('hidden');
            document.getElementById('uploading-msg').classList.add('hidden');
            document.getElementById('scan-line').classList.add('hidden');
            document.getElementById('capture-btn').classList.remove('hidden');
            document.getElementById('camera-input').value = ""; 
            currentScanData = null;
        };

        window.openPayment = (itemId) => {
            // ✅ FIX 2 — allItems est maintenant accessible
            const item = allItems.find(i => i.id === itemId);
            if(item) {
                document.getElementById('pay-img').style.backgroundImage = `url(${item.imageUrl})`;
                document.getElementById('pay-title').innerText = item.itemName;
                document.getElementById('pay-price').innerText = item.price + "€";
                document.getElementById('payment-modal').classList.remove('hidden');
                document.getElementById('payment-modal').classList.add('flex');
            }
        };

        window.closePayment = () => {
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('payment-modal').classList.remove('flex');
        };

        window.processPayment = () => { alert("Paiement validé !"); window.closePayment(); };

        window.switchView = (v) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
        };

        window.closeHud = () => {
            document.getElementById('ai-hud').classList.add('hidden');
            document.getElementById('scan-overlay').classList.add('hidden');
            document.getElementById('scan-overlay').classList.remove('flex');
            document.getElementById('scan-preview').classList.add('hidden');
            document.getElementById('scan-placeholder').classList.remove('hidden');
            document.getElementById('capture-btn').classList.remove('hidden');
        };
    </script>
</body>
</html>
