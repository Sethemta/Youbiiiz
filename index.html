<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Youbiiiz</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
*{box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#f0f2f5;color:#1a1a2e;overflow:hidden;-webkit-tap-highlight-color:transparent;touch-action:manipulation}

/* LOGO */
.brand-logo{display:inline-flex;align-items:baseline;font-weight:800;user-select:none;color:#1a1a2e}
.i-wrapper{display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px}
.i-stem{width:12px;height:38px;background:#0ea5e9;border-radius:2px}
.i-dot{width:12px;height:12px;background:#0ea5e9;border-radius:2px;position:absolute;bottom:48px;box-shadow:0 0 16px rgba(14,165,233,.6)}
.i-char{position:relative;display:flex;flex-direction:column;align-items:center}
header .i-stem{width:5px;height:16px}
header .i-dot{width:5px;height:5px;bottom:20px;box-shadow:none}
header .i-wrapper{gap:2px;margin:0 2px}
@keyframes dribble{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(var(--b));animation-timing-function:cubic-bezier(0,0,.2,1)}}
.i-char:nth-child(1) .i-dot{--b:-10px;animation:dribble .9s infinite}
.i-char:nth-child(2) .i-dot{--b:-15px;animation:dribble 1.3s infinite .2s}
.i-char:nth-child(3) .i-dot{--b:-12px;animation:dribble 1.1s infinite .5s}

/* UTILS */
.no-sb{-ms-overflow-style:none;scrollbar-width:none}
.no-sb::-webkit-scrollbar{display:none}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fi .25s ease-out forwards}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.su{animation:su .3s cubic-bezier(.16,1,.3,1) forwards}
@keyframes sr{from{transform:translateX(100%)}to{transform:translateX(0)}}
.sr{animation:sr .28s cubic-bezier(.16,1,.3,1) forwards}
@keyframes ld{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
@keyframes scanmove{0%{top:0;opacity:0}10%{opacity:1}90%{opacity:1}100%{top:100%;opacity:0}}

/* CARDS */
.card{background:#fff;border:none;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .12s,box-shadow .12s;box-shadow:0 2px 12px rgba(0,0,0,.08)}
.card:active{transform:scale(.96)}
.card:hover{box-shadow:0 6px 24px rgba(0,0,0,.12)}
.sq{width:100%;aspect-ratio:1/1;background:#f8fafc;overflow:hidden;position:relative}
.sq img{width:100%;height:100%;object-fit:contain;background:#f8fafc}
.inf{padding:8px 10px 12px}

/* INPUTS */
.inp{width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;padding:11px 13px;color:#1a1a2e;font-size:14px;font-weight:600;outline:none;transition:border-color .15s;font-family:inherit}
.inp:focus{border-color:#0ea5e9;background:#fff}
.inp::placeholder{color:#94a3b8}

/* CHIPS */
.chip{padding:6px 14px;border-radius:99px;font-size:11px;font-weight:700;border:1.5px solid #e2e8f0;color:#64748b;white-space:nowrap;cursor:pointer;transition:all .12s;background:#fff}
.chip.on{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 2px 8px rgba(14,165,233,.3)}

/* SEARCH BAR */
.sbar{background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}

/* MODALS */
.mover{background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
.msheet{background:#fff;border-radius:24px 24px 0 0;border-top:none;box-shadow:0 -4px 32px rgba(0,0,0,.12)}

/* CHAT BUBBLES */
.bme{background:#0ea5e9;color:#fff;border-radius:18px 18px 4px 18px}
.bthem{background:#f1f5f9;border:none;color:#1a1a2e;border-radius:18px 18px 18px 4px}

/* DEBUG */
#dbg{display:none;position:fixed;top:12px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:7px 18px;border-radius:99px;font-size:11px;font-weight:700;z-index:9999;max-width:90%;text-align:center}

/* LOGO UNIVERSEL */
.yb-logo{display:inline-flex;align-items:baseline;font-weight:800;letter-spacing:-1px;line-height:1;user-select:none}
.yb-logo .yb-i-group{display:inline-flex;align-items:flex-end;margin:0 0.08em}
.yb-logo .yb-i{display:flex;flex-direction:column;align-items:center;gap:0}
.yb-logo .yb-i .dot{border-radius:2px;margin-bottom:0.06em;flex-shrink:0}
.yb-logo .yb-i .stem{border-radius:2px;flex-shrink:0}

/* WHATNOT LAYOUT */
#app{display:flex;flex-direction:column}
.app-body{display:flex;flex:1;overflow:hidden}
.sidebar{width:220px;flex-shrink:0;background:#fff;border-right:1px solid #e8ecf0;overflow-y:auto;display:flex;flex-direction:column}
.sidebar-nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border-radius:10px;margin:1px 8px;transition:all .12s}
.sidebar-nav-item:hover{background:#f1f5f9;color:#0f172a}
.sidebar-nav-item.active{background:#eff9ff;color:#0ea5e9;font-weight:700}
/* SIDEBAR ACCORDION */
.sb-group{margin:1px 8px}
.sb-group-header{display:flex;align-items:center;gap:10px;padding:9px 8px;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border-radius:10px;transition:all .12s;user-select:none}
.sb-group-header:hover{background:#f1f5f9;color:#0f172a}
.sb-group-header .sb-group-label{flex:1}
.sb-arrow{font-size:9px;transition:transform .2s;color:#cbd5e1}
.sb-arrow.open{transform:rotate(90deg)}
/* FAVORIS */
.heart-btn{position:absolute;top:7px;right:7px;width:28px;height:28px;background:rgba(255,255,255,.95);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;font-size:13px;transition:transform .15s;box-shadow:0 1px 6px rgba(0,0,0,.14);z-index:2;line-height:1}
.heart-btn:active{transform:scale(.8)}
.heart-btn.fav{background:#fff0f3;color:#f43f5e}
/* TRUST SCORE */
.trust-bar{height:5px;border-radius:99px;background:#f1f5f9;overflow:hidden;margin-top:5px}
.trust-fill{height:100%;border-radius:99px;transition:width .5s cubic-bezier(.16,1,.3,1)}
/* FRAUD WARNING */
.fraud-warn{background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:10px 13px;display:flex;gap:9px;align-items:flex-start;margin-bottom:10px}
/* VIEWS BADGE */
.views-badge{position:absolute;bottom:7px;left:7px;background:rgba(15,23,42,.7);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:99px;display:flex;align-items:center;gap:3px;pointer-events:none}
/* TROC BADGE */
.troc-badge{background:#fef3c7;color:#92400e;font-size:9px;font-weight:800;padding:2px 7px;border-radius:99px;border:1px solid #fde68a;display:inline-flex;align-items:center;gap:3px}
/* NL SEARCH HINT */
.nl-hint{font-size:10px;color:#64748b;padding:3px 8px;background:#f8fafc;border-radius:8px;margin-top:4px;display:none}
/* ALERT CHIP */
.alert-chip{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;margin-bottom:6px}
.alert-chip-label{flex:1;font-size:12px;font-weight:600;color:#1e293b}
.alert-chip-del{background:none;border:none;color:#94a3b8;cursor:pointer;font-size:13px;padding:0}
/* PRICE RANGE */
.price-range-bar{background:#f1f5f9;border-radius:10px;padding:8px 12px;margin-top:6px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.price-range-bar span{font-size:11px;font-weight:700;color:#0ea5e9}
/* SELLER VERIFIED */
.verified-badge{display:inline-flex;align-items:center;gap:3px;background:#eff9ff;color:#0ea5e9;font-size:9px;font-weight:800;padding:2px 7px;border-radius:99px;border:1px solid rgba(14,165,233,.2)}
/* GARANTIE */
.garantie-banner{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #bbf7d0;border-radius:12px;padding:10px 13px;display:flex;gap:9px;align-items:center;margin-bottom:10px}
/* BOOST TOGGLE */
.boost-row{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px 14px;margin-bottom:8px}
.toggle-sw{position:relative;width:38px;height:20px;cursor:pointer}
.toggle-sw input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;background:#cbd5e1;border-radius:99px;transition:.2s}
.toggle-sw input:checked+.toggle-track{background:#0ea5e9}
.toggle-track:before{content:"";position:absolute;width:16px;height:16px;left:2px;top:2px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-sw input:checked+.toggle-track:before{transform:translateX(18px)}
.sb-sublist{padding-left:32px}
.sb-subitem{padding:6px 8px;font-size:12px;font-weight:600;color:#64748b;cursor:pointer;border-radius:8px;transition:all .12s;margin-bottom:1px}
.sb-subitem:hover{background:#f1f5f9;color:#0ea5e9}
.sb-subitem.active{color:#0ea5e9;font-weight:700}
.sidebar-nav-item .icon{width:20px;text-align:center;font-size:13px}
.sidebar-section-title{font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;padding:12px 24px 4px}
.main-content{flex:1;overflow-y:auto;background:#f4f6f8}
@media(max-width:768px){
  .sidebar{display:none}
  .main-content{padding-bottom:72px}
}
@media(min-width:769px){
  nav.bottom-nav{display:none!important}
}

/* HEADER WHATNOT STYLE */
.yb-header{background:#fff;border-bottom:1px solid #e8ecf0;padding:0 20px;height:56px;display:flex;align-items:center;gap:12px;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.yb-search{flex:1;max-width:520px;background:#f4f6f8;border:1.5px solid #e8ecf0;border-radius:10px;display:flex;align-items:center;gap:8px;padding:0 12px;height:38px;transition:border-color .15s}
.yb-search:focus-within{border-color:#0ea5e9;background:#fff}
.yb-search input{flex:1;background:none;border:none;outline:none;font-size:13px;font-weight:500;color:#1a1a2e;font-family:inherit}
.yb-search input::placeholder{color:#94a3b8}
.yb-icon-btn{width:38px;height:38px;border-radius:10px;background:#f4f6f8;border:1.5px solid #e8ecf0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;flex-shrink:0}
.yb-icon-btn:hover{background:#eff9ff;border-color:#0ea5e9;color:#0ea5e9}

/* PILL TABS */
.cat-pills{display:flex;gap:6px;overflow-x:auto;padding:12px 16px 6px;scrollbar-width:none}
.cat-pills::-webkit-scrollbar{display:none}
.cat-pill{padding:6px 14px;border-radius:99px;font-size:12px;font-weight:700;border:1.5px solid #e2e8f0;color:#64748b;white-space:nowrap;cursor:pointer;transition:all .12s;background:#fff;flex-shrink:0}
.cat-pill.on{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 2px 8px rgba(14,165,233,.3)}

/* CARD GRID */
.feed-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:8px 16px 24px}
@media(min-width:900px){.feed-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
@media(min-width:1200px){.feed-grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}}

/* MAP MARKERS */
@keyframes dotBounce{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(-6px);animation-timing-function:cubic-bezier(0,0,.2,1)}}
.yb-marker{display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform .15s}
.yb-marker:hover{transform:scale(1.2)}
.yb-marker:hover .yb-dot{animation:dotBounce .7s infinite}
.yb-stem{width:5px;height:18px;background:#0ea5e9;border-radius:2px;box-shadow:0 0 8px rgba(14,165,233,.5)}
.yb-dot{width:5px;height:5px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;box-shadow:0 0 8px rgba(14,165,233,.5)}
.yb-price{background:#fff;color:#0ea5e9;font-size:10px;font-weight:900;padding:2px 6px;border-radius:6px;border:1.5px solid #0ea5e9;white-space:nowrap;margin-top:3px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.yb-pin{display:flex;flex-direction:column;align-items:center}
/* CARROUSEL PHOTOS */
.photo-dot{width:6px;height:6px;border-radius:50%;background:#cbd5e1;transition:all .2s;cursor:pointer}
.photo-dot.on{background:#0ea5e9;width:18px;border-radius:3px}
/* SOCIAL SHARE */
.share-btn{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;transition:transform .12s}
.share-btn:active{transform:scale(.88)}
.share-btn .sb-icon{width:48px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:20px}
.share-btn span{font-size:10px;font-weight:700;color:#64748b}
/* COINS */
.coins-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#fef3c7,#fde68a);color:#92400e;font-size:11px;font-weight:800;padding:3px 10px;border-radius:99px;border:1px solid #fcd34d}
/* OFFER */
.offer-input{font-size:28px;font-weight:900;color:#0ea5e9;text-align:center;background:none;border:none;outline:none;width:100%;font-family:inherit}
/* HISTORY */
.hist-item{display:flex;align-items:center;gap:10px;padding:8px;background:#f8fafc;border-radius:10px;cursor:pointer;margin-bottom:6px;border:1px solid #e8ecf0;transition:background .12s}
.hist-item:hover{background:#eff9ff}
/* SELLER SHEET */
.sp-stat{text-align:center;background:#f8fafc;border-radius:12px;padding:10px;flex:1;border:1px solid #e8ecf0}
/* REPORT */
.report-reason{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f8fafc;border:1px solid #e8ecf0;border-radius:10px;cursor:pointer;margin-bottom:6px;font-size:13px;font-weight:600;transition:all .12s}
.report-reason:hover{background:#fef2f2;border-color:#fecaca;color:#dc2626}
/* PHOTO THUMBS */
.photo-thumb{width:60px;height:60px;border-radius:10px;object-fit:cover;border:2px solid #e2e8f0;cursor:pointer;flex-shrink:0;transition:border-color .12s}
.photo-thumb.active{border-color:#0ea5e9;box-shadow:0 0 0 2px rgba(14,165,233,.3)}
/* PAY 3X */
.pay3x-option{border:1.5px solid #e2e8f0;border-radius:12px;padding:10px 12px;cursor:pointer;transition:all .12s;margin-bottom:6px}
.pay3x-option.selected{border-color:#0ea5e9;background:#eff9ff}
/* SEARCH PHOTO BTN */
.search-photo-btn{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#0ea5e9,#6366f1);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .12s}
.search-photo-btn:hover{opacity:.85}
</style>
</head>
<body>
<div id="dbg"></div>

<!-- SPLASH / LANDING -->
<div id="splash" class="fixed inset-0 z-[999]" style="background:#f0f2f5;display:flex;align-items:stretch">

  <!-- GAUCHE: demo visuelle -->
  <div id="landing-left" style="flex:1;background:linear-gradient(150deg,#0f172a 0%,#1e3a5f 55%,#0369a1 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px 32px;position:relative;overflow:hidden;min-width:0">
    <!-- Blobs deco -->
    <div style="position:absolute;top:-100px;right:-100px;width:350px;height:350px;background:rgba(14,165,233,.18);border-radius:50%;filter:blur(50px);pointer-events:none"></div>
    <div style="position:absolute;bottom:-80px;left:-80px;width:250px;height:250px;background:rgba(99,102,241,.15);border-radius:50%;filter:blur(40px);pointer-events:none"></div>

    <!-- LOGO GRAND BLANC VISIBLE -->
    <div style="margin-bottom:24px">
      <div style="display:inline-flex;align-items:flex-end;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:48px;color:#ffffff;letter-spacing:-1px;user-select:none;line-height:1">
        <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:5px;margin:0 5px 6px 5px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble .9s infinite;--b:-12px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble 1.3s infinite .2s;--b:-16px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble 1.1s infinite .5s;--b:-14px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span></span>
        <span>Z</span>
      </div>
      <p style="color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:5px;letter-spacing:.3px">Le marketplace IA nouvelle g√©n√©ration</p>
    </div>

    <h1 style="color:#fff;font-size:32px;font-weight:800;line-height:1.25;margin-bottom:32px">Vends et ach√®te<br><span style="color:#38bdf8">plus intelligemment.</span></h1>

    <!-- Cartes flottantes -->
    <div style="position:relative;height:480px;width:100%;max-width:420px">
      <div style="position:absolute;left:0;top:0;background:#fff;border-radius:22px;padding:14px;width:260px;box-shadow:0 20px 60px rgba(0,0,0,.4);transform:rotate(-5deg);animation:floatA 4s ease-in-out infinite">
        <div style="height:170px;background:#f1f5f9;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:10px"><i class="fa-solid fa-mobile-screen" style="font-size:64px;color:#94a3b8"></i></div>
        <p style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:2px">iPhone 14 Pro</p>
        <p style="font-size:18px;font-weight:900;color:#0ea5e9">750‚Ç¨</p>
        <div style="position:absolute;top:10px;right:10px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:800;padding:2px 5px;border-radius:99px">Neuf</div>
      </div>
      <div style="position:absolute;left:140px;top:24px;background:#fff;border-radius:22px;padding:14px;width:260px;box-shadow:0 20px 60px rgba(0,0,0,.4);transform:rotate(3deg);animation:floatB 5s ease-in-out infinite">
        <div style="height:170px;background:#fef9c3;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:10px"><i class="fa-brands fa-playstation" style="font-size:68px;color:#1e293b"></i></div>
        <p style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:2px">PS5 + manette</p>
        <p style="font-size:18px;font-weight:900;color:#0ea5e9">430‚Ç¨</p>
        <div style="position:absolute;top:10px;right:10px;background:#22c55e;color:#fff;font-size:7px;font-weight:800;padding:2px 5px;border-radius:99px">‚óè Live</div>
      </div>
      <div style="position:absolute;left:8px;top:300px;background:#fff;border-radius:22px;padding:14px;width:220px;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:floatC 6s ease-in-out infinite">
        <div style="height:120px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-radius:14px;margin-bottom:10px;position:relative;display:flex;align-items:center;justify-content:center">
          <i class="fa-solid fa-map" style="font-size:26px;color:#3b82f6;opacity:.3"></i>
          <div style="position:absolute;top:14px;left:28px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">180‚Ç¨</div>
          <div style="position:absolute;top:36px;right:18px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">430‚Ç¨</div>
          <div style="position:absolute;bottom:10px;left:55px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">95‚Ç¨</div>
        </div>
        <p style="font-size:10px;font-weight:700;color:#64748b"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;margin-right:3px"></i>Annonces pr√®s de toi</p>
      </div>
      <div style="position:absolute;right:8px;top:310px;background:linear-gradient(135deg,#0ea5e9,#6366f1);border-radius:16px;padding:14px 18px;box-shadow:0 8px 24px rgba(14,165,233,.5);animation:floatA 3.5s ease-in-out infinite reverse">
        <p style="color:#fff;font-size:13px;font-weight:800;margin-bottom:2px"><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:5px"></i>IA Gemini</p>
        <p style="color:rgba(255,255,255,.6);font-size:11px">Prix estim√© en 3s</p>
      </div>
    </div>
  </div>

  <!-- DROITE: auth -->
  <div id="landing-right" style="width:100%;max-width:400px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 32px;overflow-y:auto">

    <!-- Logo mobile only -->
    <div id="logo-mobile" style="margin-bottom:28px">
      <div style="display:inline-flex;align-items:flex-end;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:32px;color:#0f172a;letter-spacing:-1px;line-height:1">
        <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px 4px 4px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble .9s infinite;--b:-9px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble 1.3s infinite .2s;--b:-11px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble 1.1s infinite .5s;--b:-10px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span></span>
        <span>Z</span>
      </div>
    </div>

    <div style="width:100%;max-width:320px">

      <!-- Toggle login/register -->
      <div style="display:flex;background:#f1f5f9;border-radius:12px;padding:4px;margin-bottom:24px">
        <button id="tab-login" onclick="showTab('login')" style="flex:1;padding:8px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;background:#fff;color:#0f172a;box-shadow:0 1px 4px rgba(0,0,0,.1);transition:all .15s">Connexion</button>
        <button id="tab-register" onclick="showTab('register')" style="flex:1;padding:8px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;background:transparent;color:#94a3b8;transition:all .15s">Cr√©er un compte</button>
      </div>

      <!-- CONNEXION -->
      <div id="panel-login">
        <h2 style="font-size:22px;font-weight:800;color:#0f172a;margin-bottom:4px">Bon retour !</h2>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:20px;font-weight:500">Connecte-toi √† ton compte Youbiiiz</p>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Email</label>
          <input id="login-email" type="email" placeholder="ton@email.com" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:20px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Mot de passe</label>
          <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter')doLogin()">
        </div>
        <button onclick="doLogin()" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-size:14px;font-weight:800;padding:13px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,.4);margin-bottom:12px;transition:opacity .15s" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">Se connecter</button>
        <button onclick="doGoogle()" style="width:100%;background:#fff;color:#1e293b;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Continuer avec Google
        </button>
        <div style="text-align:center;margin-top:4px">
          <button onclick="doAnon()" style="background:none;border:none;font-size:11px;color:#94a3b8;cursor:pointer;font-family:inherit;text-decoration:underline">Continuer sans compte</button>
        </div>
        <!-- DEMO MODE - bouton principal de secours -->
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid #f1f5f9">
          <button onclick="enterDemoMode()" style="width:100%;background:linear-gradient(135deg,#0f172a,#1e3a5f);color:#fff;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .15s" onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">
            <i class="fa-solid fa-play" style="font-size:11px;color:#0ea5e9"></i>
            Acc√©der en mode d√©mo
            <span style="background:#0ea5e9;color:#000;font-size:9px;font-weight:800;padding:2px 7px;border-radius:99px;margin-left:2px">INSTANT</span>
          </button>
          <p style="font-size:10px;color:#94a3b8;text-align:center;margin-top:6px">Sans inscription ¬∑ Donn√©es de d√©monstration ¬∑ Toutes les fonctionnalit√©s</p>
        </div>
      </div>

      <!-- INSCRIPTION -->
      <div id="panel-register" style="display:none">
        <h2 style="font-size:22px;font-weight:800;color:#0f172a;margin-bottom:4px">Cr√©er un compte</h2>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:20px;font-weight:500">Rejoins des milliers de vendeurs</p>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Email</label>
          <input id="reg-email" type="email" placeholder="ton@email.com" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Mot de passe</label>
          <input id="reg-password" type="password" placeholder="Min. 6 caract√®res" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:20px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Confirmer</label>
          <input id="reg-confirm" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter')doRegister()">
        </div>
        <button onclick="doRegister()" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-size:14px;font-weight:800;padding:13px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,.4);margin-bottom:12px;transition:opacity .15s" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">Cr√©er mon compte</button>
        <button onclick="doGoogle()" style="width:100%;background:#fff;color:#1e293b;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Continuer avec Google
        </button>
      </div>

      <!-- Message erreur/info -->
      <div id="auth-msg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:10px;font-size:12px;font-weight:700;text-align:center"></div>
    </div>
  </div>
</div>

<style>
@keyframes floatA{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-12px) rotate(-5deg)}}
@keyframes floatB{0%,100%{transform:translateY(0) rotate(3deg)}50%{transform:translateY(-16px) rotate(3deg)}}
@keyframes floatC{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
</style>

<!-- APP -->
<div id="app" class="hidden opacity-0 transition-opacity duration-500 fixed inset-0 flex flex-col" style="background:#f4f6f8">

  <!-- HEADER WHATNOT STYLE -->
  <header class="yb-header shrink-0">
    <!-- Logo -->
    <div style="display:inline-flex;align-items:flex-end;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:20px;color:#0f172a;letter-spacing:-.5px;line-height:1;cursor:pointer;user-select:none;flex-shrink:0;margin-right:8px" onclick="switchView('home')">
      <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:2px;margin:0 2px 2px 2px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble .9s infinite;--b:-6px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble 1.3s infinite .2s;--b:-8px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble 1.1s infinite .5s;--b:-7px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span></span>
      <span>Z</span>
    </div>

    <!-- Search -->
    <div class="yb-search" style="flex:1;max-width:520px">
      <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;font-size:12px;flex-shrink:0"></i>
      <input id="header-search" type="text" placeholder='Recherche IA : "iPhone 300‚Ç¨ Lyon bon √©tat"...' oninput="applyFilters()">
      <button class="search-photo-btn" onclick="openSearchByPhoto()" title="Rechercher par photo">
        <i class="fa-solid fa-camera" style="color:#fff;font-size:11px"></i>
      </button>
      <input type="file" id="search-photo-inp" accept="image/*" class="hidden" onchange="onSearchPhoto(this)">
    </div>

    <div style="flex:1"></div>

    <!-- Actions -->
    <button onclick="openScan()" style="background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;flex-shrink:0;box-shadow:0 2px 10px rgba(14,165,233,.35);transition:opacity .12s" onmouseover="this.style.opacity='.88'" onmouseout="this.style.opacity='1'">
      <i class="fa-solid fa-plus" style="font-size:11px"></i><span class="hidden md:inline">Vendre</span>
    </button>
    <button onclick="switchView('notifications')" class="yb-icon-btn relative" style="margin-left:6px">
      <i class="fa-solid fa-bell" style="font-size:14px;color:#475569"></i>
      <span id="nbadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white" style="font-size:9px;font-weight:900;display:none;align-items:center;justify-content:center">0</span>
    </button>
    <button onclick="switchView('profile')" style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#6366f1);display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;flex-shrink:0;margin-left:6px">
      <i class="fa-solid fa-user" style="color:#fff;font-size:12px"></i>
    </button>
  </header>

  <!-- APP BODY = SIDEBAR + MAIN -->
  <div class="app-body">

    <!-- SIDEBAR -->
    <aside class="sidebar no-sb">
      <!-- Greeting -->
      <div style="padding:16px 16px 8px">
        <p style="font-size:13px;font-weight:800;color:#0f172a;margin-bottom:2px">Bonjour üëã</p>
        <p id="sidebar-uid" style="font-size:11px;color:#94a3b8;font-weight:500"></p>
      </div>

      <p class="sidebar-section-title">Navigation</p>
      <div class="sidebar-nav-item active" id="snav-home" onclick="switchView('home');setSidebarActive('snav-home')">
        <span class="icon"><i class="fa-solid fa-house"></i></span>Pour toi
      </div>
      <div class="sidebar-nav-item" id="snav-map" onclick="switchView('map');setSidebarActive('snav-map')">
        <span class="icon"><i class="fa-solid fa-map-location-dot"></i></span>Carte
      </div>
      <div class="sidebar-nav-item" id="snav-notif" onclick="switchView('notifications');setSidebarActive('snav-notif')">
        <span class="icon"><i class="fa-solid fa-bell"></i></span>Notifications
      </div>
      <div class="sidebar-nav-item" id="snav-profile" onclick="switchView('profile');setSidebarActive('snav-profile')">
        <span class="icon"><i class="fa-solid fa-user"></i></span>Mon profil
      </div>

      <p class="sidebar-section-title">Cat√©gories</p>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('all',this)"><span class="icon">‚ú®</span>Tout voir</div>

      <!-- √âLECTRONIQUE -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-elec')">
          <span class="icon">üì±</span><span class="sb-group-label">√âlectronique</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-elec"></i>
        </div>
        <div class="sb-sublist hidden" id="g-elec">
          <div class="sb-subitem" onclick="filterCatSidebar('T√©l√©phones & objets connect√©s',this)">T√©l√©phones & objets connect√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires t√©l√©phones',this)">Accessoires t√©l√©phones</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Ordinateurs',this)">Ordinateurs</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires informatique',this)">Accessoires informatique</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Tablettes & liseuses',this)">Tablettes & liseuses</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Photo, audio & vid√©o',this)">Photo, audio & vid√©o</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Consoles',this)">Consoles</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jeux vid√©o',this)">Jeux vid√©o</div>
        </div>
      </div>

      <!-- MODE (adulte uniquement) -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-mode')">
          <span class="icon">üëó</span><span class="sb-group-label">Mode</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-mode"></i>
        </div>
        <div class="sb-sublist hidden" id="g-mode">
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements homme',this)">V√™tements homme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements femme',this)">V√™tements femme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chaussures homme',this)">Chaussures homme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chaussures femme',this)">Chaussures femme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires & Bagagerie',this)">Accessoires & Bagagerie</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Montres & Bijoux',this)">Montres & Bijoux</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Lunettes',this)">Lunettes</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Beaut√© & Bien-√™tre',this)">Beaut√© & Bien-√™tre</div>
        </div>
      </div>

      <!-- FAMILLE / ENFANTS -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-famille')">
          <span class="icon">üë∂</span><span class="sb-group-label">Famille</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-famille"></i>
        </div>
        <div class="sb-sublist hidden" id="g-famille">
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements b√©b√©',this)">V√™tements b√©b√© (0‚Äì2 ans)</div>
          <div class="sb-subitem" onclick="filterCatSidebar('V√™tements enfant',this)">V√™tements enfant (2‚Äì14 ans)</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chaussures enfant',this)">Chaussures enfant</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement b√©b√©',this)">√âquipement b√©b√©</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Mobilier enfant',this)">Mobilier enfant</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jeux & Jouets',this)">Jeux & Jouets</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Pu√©riculture',this)">Pu√©riculture</div>
        </div>
      </div>

      <!-- MAISON & JARDIN -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-maison')">
          <span class="icon">üè†</span><span class="sb-group-label">Maison & Jardin</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-maison"></i>
        </div>
        <div class="sb-sublist hidden" id="g-maison">
          <div class="sb-subitem" onclick="filterCatSidebar('Ameublement',this)">Ameublement</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âlectrom√©nager',this)">√âlectrom√©nager</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Arts de la table',this)">Arts de la table</div>
          <div class="sb-subitem" onclick="filterCatSidebar('D√©coration',this)">D√©coration</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Linge de maison',this)">Linge de maison</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Bricolage',this)">Bricolage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Outillage',this)">Outillage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jardin & Plantes',this)">Jardin & Plantes</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Papeterie & fournitures',this)">Papeterie & fournitures</div>
        </div>
      </div>

      <!-- LOISIRS -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-loisirs')">
          <span class="icon">üé≠</span><span class="sb-group-label">Loisirs</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-loisirs"></i>
        </div>
        <div class="sb-sublist hidden" id="g-loisirs">
          <div class="sb-subitem" onclick="filterCatSidebar('Livres',this)">Livres</div>
          <div class="sb-subitem" onclick="filterCatSidebar('DVD - Films',this)">DVD - Films</div>
          <div class="sb-subitem" onclick="filterCatSidebar('CD - Musique',this)">CD - Musique</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Instruments de musique',this)">Instruments de musique</div>
          <div class="sb-subitem" onclick="filterCatSidebar('V√©los',this)">V√©los</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipements v√©los',this)">√âquipements v√©los</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Sport & Hobbies',this)">Sport & Hobbies</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chasse & P√™che',this)">Chasse & P√™che</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Collection',this)">Collection</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Vins & Gastronomie',this)">Vins & Gastronomie</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Loisirs cr√©atifs',this)">Loisirs cr√©atifs</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Antiquit√©s',this)">Antiquit√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Mod√©lisme',this)">Mod√©lisme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Camping & Plein air',this)">Camping & Plein air</div>
        </div>
      </div>

      <!-- ANIMAUX -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-animaux')">
          <span class="icon">üêæ</span><span class="sb-group-label">Animaux</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-animaux"></i>
        </div>
        <div class="sb-sublist hidden" id="g-animaux">
          <div class="sb-subitem" onclick="filterCatSidebar('Chiens',this)">Chiens</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chats',this)">Chats</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Chevaux & √âquid√©s',this)">Chevaux & √âquid√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Oiseaux',this)">Oiseaux</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Rongeurs & Lapins',this)">Rongeurs & Lapins</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Reptiles & Amphibiens',this)">Reptiles & Amphibiens</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Poissons',this)">Poissons</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Accessoires animaux',this)">Accessoires animaux</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Alimentation animaux',this)">Alimentation animaux</div>
        </div>
      </div>

      <!-- V√âHICULES -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-vehicules')">
          <span class="icon">üöó</span><span class="sb-group-label">V√©hicules</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-vehicules"></i>
        </div>
        <div class="sb-sublist hidden" id="g-vehicules">
          <div class="sb-subitem" onclick="filterCatSidebar('Voitures',this)">Voitures</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Motos',this)">Motos</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Scooters & V√©los √©lectriques',this)">Scooters & V√©los √©lec.</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Utilitaires',this)">Utilitaires</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Caravaning',this)">Caravaning</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Nautisme',this)">Nautisme</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement auto',this)">√âquipement auto</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement moto',this)">√âquipement moto</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipement caravaning',this)">√âquipement caravaning</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Pi√®ces d√©tach√©es auto',this)">Pi√®ces d√©tach√©es auto</div>
        </div>
      </div>

      <!-- IMMOBILIER -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-immo')">
          <span class="icon">üè¢</span><span class="sb-group-label">Immobilier</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-immo"></i>
        </div>
        <div class="sb-sublist hidden" id="g-immo">
          <div class="sb-subitem" onclick="filterCatSidebar('Ventes immobili√®res',this)">Ventes immobili√®res</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Locations',this)">Locations</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Colocations',this)">Colocations</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Bureaux & Commerces',this)">Bureaux & Commerces</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Terrains & Propri√©t√©s',this)">Terrains & Propri√©t√©s</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Locations de vacances',this)">Locations de vacances</div>
        </div>
      </div>

      <!-- SERVICES -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-services')">
          <span class="icon">üõ†Ô∏è</span><span class="sb-group-label">Services</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-services"></i>
        </div>
        <div class="sb-sublist hidden" id="g-services">
          <div class="sb-subitem" onclick="filterCatSidebar('Cours particuliers',this)">Cours particuliers</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Formation professionnelle',this)">Formation professionnelle</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Covoiturage',this)">Covoiturage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Prestations de services',this)">Prestations de services</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Services √©v√©nementiels',this)">Services √©v√©nementiels</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Service √† la personne',this)">Service √† la personne</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Baby-sitting',this)">Baby-sitting</div>
          <div class="sb-subitem" onclick="filterCatSidebar('D√©m√©nagement',this)">D√©m√©nagement</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Jardinage',this)">Jardinage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Bricolage & R√©paration',this)">Bricolage & R√©paration</div>
        </div>
      </div>

      <!-- MAT√âRIEL PRO -->
      <div class="sb-group">
        <div class="sb-group-header" onclick="toggleGroup('g-pro')">
          <span class="icon">üè≠</span><span class="sb-group-label">Mat√©riel Pro</span><i class="fa-solid fa-chevron-right sb-arrow" id="arrow-g-pro"></i>
        </div>
        <div class="sb-sublist hidden" id="g-pro">
          <div class="sb-subitem" onclick="filterCatSidebar('Mat√©riel agricole',this)">Mat√©riel agricole</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Tracteurs',this)">Tracteurs</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Poids lourds',this)">Poids lourds</div>
          <div class="sb-subitem" onclick="filterCatSidebar('BTP - Chantier',this)">BTP - Chantier</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Manutention - Levage',this)">Manutention - Levage</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipements industriels',this)">√âquipements industriels</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Restauration - H√¥tellerie',this)">Restauration - H√¥tellerie</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Fournitures de bureau',this)">Fournitures de bureau</div>
          <div class="sb-subitem" onclick="filterCatSidebar('Mat√©riel m√©dical',this)">Mat√©riel m√©dical</div>
          <div class="sb-subitem" onclick="filterCatSidebar('√âquipements commerces',this)">√âquipements commerces</div>
        </div>
      </div>

      <!-- Ville filter -->
      <p class="sidebar-section-title">Localisation</p>
      <div style="padding:4px 12px 8px">
        <div style="position:relative">
          <i class="fa-solid fa-location-dot" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#0ea5e9;font-size:10px"></i>
          <input id="city-inp" type="text" placeholder="Ville..." oninput="applyFilters()"
            style="width:100%;background:#f4f6f8;border:1.5px solid #e2e8f0;border-radius:9px;padding:8px 10px 8px 28px;font-size:12px;font-weight:600;color:#1a1a2e;outline:none;font-family:inherit;transition:border-color .15s"
            onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
      </div>

      <!-- Live badge -->
      <div style="margin:8px 12px;background:linear-gradient(135deg,rgba(14,165,233,.08),rgba(99,102,241,.08));border:1px solid rgba(14,165,233,.2);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:8px">
        <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;animation:pulse 1.5s infinite;flex-shrink:0"></span>
        <div>
          <p style="font-size:11px;font-weight:800;color:#0f172a">Live</p>
          <p style="font-size:10px;color:#64748b;font-weight:500">Annonces r√©centes</p>
        </div>
      </div>

      <!-- Footer sidebar -->
      <div style="flex:1"></div>
      <div style="padding:12px;border-top:1px solid #f1f5f9;margin-top:12px">
        <button onclick="doLogout()" style="width:100%;background:none;border:1px solid #fecaca;border-radius:9px;padding:8px;font-size:12px;font-weight:700;color:#ef4444;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-family:inherit">
          <i class="fa-solid fa-right-from-bracket" style="font-size:11px"></i>D√©connexion
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content no-sb" id="main-scroll">

    <!-- HOME -->
    <div id="view-home">
      <!-- Mobile only: category pills -->
      <div class="cat-pills md:hidden">
        <button class="cat-pill on" onclick="filterCat('all',this)">Tout</button>
        <button class="cat-pill" onclick="filterCat('T√©l√©phones',this)">üì± T√©l√©phones</button>
        <button class="cat-pill" onclick="filterCat('Ordinateurs',this)">üíª Ordinateurs</button>
        <button class="cat-pill" onclick="filterCat('Consoles',this)">üéÆ Consoles</button>
        <button class="cat-pill" onclick="filterCat('Jeux vid√©o',this)">üïπ Jeux vid√©o</button>
        <button class="cat-pill" onclick="filterCat('V√™tements',this)">üëó V√™tements</button>
        <button class="cat-pill" onclick="filterCat('Chaussures',this)">üëü Chaussures</button>
        <button class="cat-pill" onclick="filterCat('Montres',this)">‚åö Montres & Bijoux</button>
        <button class="cat-pill" onclick="filterCat('Ameublement',this)">üõã Ameublement</button>
        <button class="cat-pill" onclick="filterCat('√âlectrom√©nager',this)">üîå √âlectrom√©nager</button>
        <button class="cat-pill" onclick="filterCat('Bricolage',this)">üîß Bricolage</button>
        <button class="cat-pill" onclick="filterCat('Jardin',this)">üåø Jardin</button>
        <button class="cat-pill" onclick="filterCat('V√©los',this)">üö≤ V√©los</button>
        <button class="cat-pill" onclick="filterCat('Sport',this)">‚öΩ Sport</button>
        <button class="cat-pill" onclick="filterCat('Livres',this)">üìö Livres</button>
        <button class="cat-pill" onclick="filterCat('Chiens',this)">üê∂ Chiens</button>
        <button class="cat-pill" onclick="filterCat('Chats',this)">üê± Chats</button>
        <button class="cat-pill" onclick="filterCat('Voitures',this)">üöó Voitures</button>
        <button class="cat-pill" onclick="filterCat('Motos',this)">üèç Motos</button>
        <button class="cat-pill" onclick="filterCat('Jeux & Jouets',this)">üß∏ Jouets</button>
        <button class="cat-pill" onclick="filterCat('√âquipement b√©b√©',this)">üë∂ B√©b√©</button>
      </div>

      <!-- Section title -->
      <div style="padding:12px 16px 0;display:flex;align-items:center;justify-content:space-between">
        <p id="feed-section-title" style="font-size:16px;font-weight:800;color:#0f172a">Pour toi</p>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="width:7px;height:7px;background:#22c55e;border-radius:50%;display:inline-block;animation:pulse 1.5s infinite"></span>
          <span style="font-size:11px;color:#22c55e;font-weight:700">Live</span>
        </div>
      </div>

      <div id="feed" class="feed-grid">
        <div style="grid-column:1/-1;padding:56px 0;text-align:center">
          <i class="fa-solid fa-circle-notch animate-spin text-2xl" style="color:#94a3b8"></i>
        </div>
      </div>
    </div>

    <!-- CARTE -->
    <div id="view-map" class="hidden" style="position:relative;height:calc(100vh - 56px)">
      <div id="map-el" style="width:100%;height:100%;"></div>

      <!-- Compteur -->
      <div id="map-count" style="position:absolute;top:12px;left:12px;z-index:1000;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:6px 12px;font-size:11px;font-weight:700;color:#64748b;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.08);">
        <i class="fa-solid fa-circle" style="color:#0ea5e9;font-size:7px;margin-right:5px"></i><span id="map-count-txt">0 annonce</span>
      </div>

      <!-- Centrer -->
      <button onclick="centerMap()" style="position:absolute;top:12px;right:12px;z-index:1000;width:40px;height:40px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12)">
        <i class="fa-solid fa-location-crosshairs" style="color:#0ea5e9"></i>
      </button>

      <!-- Filtre rayon -->
      <div style="position:absolute;top:60px;right:12px;z-index:1000;display:flex;flex-direction:column;gap:6px;">
        <button onclick="setRadius(1)" id="r1" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">1km</button>
        <button onclick="setRadius(2)" id="r2" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">2km</button>
        <button onclick="setRadius(5)" id="r5" style="background:#0ea5e9;color:#000;border:none;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer">5km</button>
        <button onclick="setRadius(20)" id="r20" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">20km</button>
        <button onclick="setRadius(50)" id="r50" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">50km</button>
        <button onclick="setRadius(0)" id="r0" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">Tout</button>
      </div>

      <!-- Popup annonce -->
      <div id="map-popup" class="hidden" style="position:absolute;bottom:16px;left:12px;right:12px;background:#fff;border:1px solid #e2e8f0;border-radius:20px;padding:12px;z-index:1000;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,.15)">
        <img id="map-pop-img" style="width:56px;height:56px;border-radius:12px;object-fit:contain;background:#f8f8f8;flex-shrink:0">
        <div style="flex:1;min-width:0">
          <p id="map-pop-name" style="font-size:13px;color:#1e293b;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px"></p>
          <p id="map-pop-price" style="font-size:16px;font-weight:900;color:#0ea5e9;margin-bottom:2px"></p>
          <p style="font-size:10px;color:#94a3b8"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;margin-right:3px;font-size:9px"></i><span id="map-pop-city-txt" style="color:#64748b"></span></p>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <button id="map-pop-btn" style="background:#0ea5e9;color:#000;font-size:12px;font-weight:700;padding:8px 14px;border-radius:12px;border:none;cursor:pointer">Voir</button>
          <button onclick="document.getElementById('map-popup').classList.add('hidden')" style="background:transparent;color:#94a3b8;font-size:10px;border:none;cursor:pointer">Fermer</button>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="view-notifications" class="hidden px-4 pt-5 pb-24">
      <h2 style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:16px">Notifications</h2>
      <div id="notif-list">
        <p style="text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>
      </div>
    </div>

    <!-- PROFIL -->
    <div id="view-profile" class="hidden px-4 pt-5 pb-24">
      <h2 style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:16px">Mon Profil</h2>
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-white"></i>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <p class="font-extrabold text-sm" style="color:#0f172a">Mon Profil</p>
              <span id="profile-verified" class="verified-badge hidden"><i class="fa-solid fa-circle-check"></i> V√©rifi√©</span>
            </div>
            <p id="profile-uid" style="font-size:10px;color:#94a3b8;font-family:monospace;margin-top:2px">...</p>
          </div>
          <p id="user-badge" style="font-size:9px;color:#94a3b8;font-family:monospace"></p>
        </div>
        <div class="grid grid-cols-4 gap-2 mb-3">
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-count" style="font-size:18px;font-weight:900;color:#0ea5e9">0</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Annonces</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-views" style="font-size:18px;font-weight:900;color:#8b5cf6">0</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Vues</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-favs" style="font-size:18px;font-weight:900;color:#f43f5e">0</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Favoris</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:10px 6px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-rating" style="font-size:18px;font-weight:900;color:#f59e0b">-</p>
            <p style="font-size:8px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Note</p>
          </div>
        </div>
        <!-- Valeur totale + boost -->
        <div class="boost-row">
          <div>
            <p style="font-size:12px;font-weight:700;color:#0f172a">Valeur en vente</p>
            <p id="profile-total" style="font-size:16px;font-weight:900;color:#0f172a">0‚Ç¨</p>
          </div>
          <div>
            <p style="font-size:10px;color:#64748b;margin-bottom:4px;text-align:right">Boost auto ‚ú®</p>
            <label class="toggle-sw">
              <input type="checkbox" id="boost-toggle" onchange="toggleBoost(this)">
              <div class="toggle-track"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Coins + Historique -->
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <span class="text-lg">ü™ô</span>
            <div>
              <p style="font-size:13px;font-weight:800;color:#0f172a">Youbiiiz Coins</p>
              <p id="profile-coins-val" style="font-size:20px;font-weight:900;color:#f59e0b;line-height:1.2">0</p>
            </div>
          </div>
          <div class="text-right">
            <p style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase">Valeur estim√©e</p>
            <p id="profile-coins-eur" style="font-size:13px;font-weight:800;color:#f59e0b">0.00‚Ç¨</p>
          </div>
        </div>
        <p style="font-size:10px;color:#94a3b8;margin-bottom:8px">üéÅ Gagner des coins : vendre un article (+10), recevoir un avis 5‚òÖ (+5), parrainer (+20)</p>
        <div style="background:#fefce8;border:1px solid #fef08a;border-radius:10px;padding:8px 10px;font-size:11px;color:#713f12;font-weight:600">
          1 Coin = 0.01‚Ç¨ de r√©duction sur votre prochain achat
        </div>
      </div>

      <!-- Historique de navigation -->
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <div class="flex items-center justify-between mb-3">
          <p style="font-size:13px;font-weight:800;color:#0f172a"><i class="fa-solid fa-clock-rotate-left" style="color:#8b5cf6;margin-right:6px;font-size:11px"></i>R√©cemment consult√©es</p>
          <button onclick="clearHistory()" style="font-size:11px;color:#94a3b8;background:none;border:none;cursor:pointer;font-family:inherit">Effacer</button>
        </div>
        <div id="history-list">
          <p style="font-size:11px;color:#94a3b8;text-align:center;padding:12px 0">Aucune annonce consult√©e</p>
        </div>
      </div>
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <div class="flex items-center justify-between mb-3">
          <p style="font-size:13px;font-weight:800;color:#0f172a"><i class="fa-solid fa-bell text-sky-500 mr-1.5" style="font-size:11px"></i>Mes alertes</p>
          <button onclick="openAlertes()" style="background:#eff9ff;color:#0ea5e9;border:none;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer">+ Nouvelle</button>
        </div>
        <div id="alerts-list">
          <p style="font-size:11px;color:#94a3b8;text-align:center;padding:12px 0">Aucune alerte sauvegard√©e</p>
        </div>
      </div>

      <!-- Favoris -->
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <p style="font-size:13px;font-weight:800;color:#0f172a;margin-bottom:12px"><i class="fa-solid fa-heart text-rose-500 mr-1.5" style="font-size:11px"></i>Mes favoris</p>
        <div id="fav-listings" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;">
          <p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:16px 0">Aucun favori</p>
        </div>
      </div>

      <p style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px">Mes annonces</p>
      <button onclick="doLogout()" style="width:100%;background:#fff;border:1.5px solid #fecaca;border-radius:12px;padding:11px;font-size:13px;font-weight:700;color:#ef4444;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04);font-family:inherit"><i class="fa-solid fa-right-from-bracket"></i> Se d√©connecter</button>
      <div id="my-listings" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:10px;">
        <p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:32px 0">Aucune annonce</p>
      </div>
    </div>

    </main><!-- /main-content -->
  </div><!-- /app-body -->

  <!-- NAV MOBILE ONLY -->
  <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 h-16 flex items-center justify-around px-6 z-[100]" style="box-shadow:0 -2px 12px rgba(0,0,0,.08)">
    <button onclick="switchView('home')" id="nav-home">
      <i class="fa-solid fa-house text-xl text-sky-500"></i>
    </button>
    <button onclick="switchView('map')" id="nav-map">
      <i class="fa-solid fa-map-location-dot text-xl text-slate-400"></i>
    </button>
    <button onclick="openScan()" class="w-14 h-14 -mt-5 bg-gradient-to-br from-sky-400 to-blue-600 rounded-[18px] flex items-center justify-center shadow-[0_0_24px_rgba(34,211,238,.5)] border-[3px] border-white active:scale-90 transition-transform">
      <i class="fa-solid fa-plus text-xl text-white"></i>
    </button>
    <button onclick="switchView('notifications')" id="nav-notif">
      <i class="fa-solid fa-bell text-xl text-slate-400"></i>
    </button>
    <button onclick="switchView('profile')" id="nav-profile">
      <i class="fa-solid fa-user text-xl text-slate-400"></i>
    </button>
  </nav>
</div>

<!-- ALERTES MODAL -->
<div id="alertes-modal" class="fixed inset-0 z-[700] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeAlertes()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8">
    <div class="flex justify-center mb-3"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-bell text-sky-400"></i>
        <span class="font-bold text-sm">Nouvelle alerte</span>
      </div>
      <button onclick="closeAlertes()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark text-sm"></i></button>
    </div>
    <p class="text-[10px] text-slate-400 mb-2">D√©cris ce que tu cherches en langage naturel :</p>
    <input id="alert-query" type="text" placeholder="Ex : iPhone 13 bon √©tat moins de 400‚Ç¨ √† Paris..." class="inp mb-2 text-sm">
    <p class="text-[9px] text-slate-500 mb-4"><i class="fa-solid fa-wand-magic-sparkles text-sky-400 mr-1"></i>L'IA analysera les nouvelles annonces et te pr√©viendra d√®s qu'une correspond</p>
    <div class="flex gap-2">
      <button onclick="closeAlertes()" class="flex-1 bg-slate-700 font-bold py-3 rounded-xl text-sm">Annuler</button>
      <button onclick="saveAlert()" class="flex-1 bg-sky-500 text-black font-bold py-3 rounded-xl text-sm">Cr√©er l'alerte</button>
    </div>
  </div>
</div>

<!-- PARTAGE R√âSEAUX SOCIAUX -->
<div id="share-modal" class="fixed inset-0 z-[900] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeShareModal()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8 bg-white">
    <div class="flex justify-center mb-3"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-5">
      <p class="font-extrabold text-base">Partager l'annonce</p>
      <button onclick="closeShareModal()" class="w-8 h-8 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-slate-500 text-sm"></i></button>
    </div>
    <!-- Preview -->
    <div id="share-preview" class="flex gap-3 bg-slate-50 border border-slate-100 rounded-2xl p-3 mb-5">
      <img id="share-prev-img" class="w-14 h-14 rounded-xl object-contain bg-white border border-slate-100 shrink-0">
      <div class="flex-1 min-w-0">
        <p id="share-prev-title" class="font-bold text-sm leading-tight truncate"></p>
        <p id="share-prev-price" class="text-sky-500 font-black text-base mt-0.5"></p>
        <p class="text-[10px] text-slate-400 mt-0.5">youbiiiz.app</p>
      </div>
    </div>
    <!-- R√©seaux -->
    <div class="grid grid-cols-4 gap-3 mb-5">
      <div class="share-btn" onclick="shareTo('whatsapp')">
        <div class="sb-icon" style="background:#dcfce7"><i class="fa-brands fa-whatsapp" style="color:#25D366;font-size:22px"></i></div>
        <span>WhatsApp</span>
      </div>
      <div class="share-btn" onclick="shareTo('facebook')">
        <div class="sb-icon" style="background:#dbeafe"><i class="fa-brands fa-facebook" style="color:#1877F2;font-size:22px"></i></div>
        <span>Facebook</span>
      </div>
      <div class="share-btn" onclick="shareTo('twitter')">
        <div class="sb-icon" style="background:#f1f5f9"><i class="fa-brands fa-x-twitter" style="color:#000;font-size:20px"></i></div>
        <span>X / Twitter</span>
      </div>
      <div class="share-btn" onclick="shareTo('telegram')">
        <div class="sb-icon" style="background:#e0f2fe"><i class="fa-brands fa-telegram" style="color:#0088CC;font-size:22px"></i></div>
        <span>Telegram</span>
      </div>
      <div class="share-btn" onclick="shareTo('instagram')">
        <div class="sb-icon" style="background:linear-gradient(135deg,#fcebfa,#fce8d5,#fde68a)"><i class="fa-brands fa-instagram" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:22px"></i></div>
        <span>Instagram</span>
      </div>
      <div class="share-btn" onclick="shareTo('tiktok')">
        <div class="sb-icon" style="background:#f1f5f9"><i class="fa-brands fa-tiktok" style="color:#000;font-size:20px"></i></div>
        <span>TikTok</span>
      </div>
      <div class="share-btn" onclick="shareTo('messenger')">
        <div class="sb-icon" style="background:#dbeafe"><i class="fa-brands fa-facebook-messenger" style="color:#0099FF;font-size:22px"></i></div>
        <span>Messenger</span>
      </div>
      <div class="share-btn" onclick="shareTo('sms')">
        <div class="sb-icon" style="background:#dcfce7"><i class="fa-solid fa-message" style="color:#22c55e;font-size:19px"></i></div>
        <span>SMS</span>
      </div>
    </div>
    <!-- Copier lien -->
    <div class="flex gap-2">
      <input id="share-link-val" class="inp flex-1 text-sm text-slate-500 bg-slate-50" readonly style="font-family:monospace">
      <button onclick="copyShareLink()" class="px-4 py-2.5 bg-sky-500 text-black font-bold text-sm rounded-xl active:scale-95 transition-transform whitespace-nowrap">
        <i class="fa-solid fa-copy mr-1"></i>Copier
      </button>
    </div>
  </div>
</div>

<!-- FAIRE UNE OFFRE -->
<div id="offer-modal" class="fixed inset-0 z-[800] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0" onclick="closeOffer()"></div>
  <div class="relative bg-white rounded-3xl p-6 w-full max-w-sm su text-center">
    <button onclick="closeOffer()" class="absolute top-4 right-4 w-8 h-8 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-slate-500 text-sm"></i></button>
    <div class="w-12 h-12 rounded-2xl bg-amber-50 flex items-center justify-center mx-auto mb-3">
      <i class="fa-solid fa-handshake text-amber-400 text-xl"></i>
    </div>
    <h3 class="font-extrabold text-base mb-1">Faire une offre</h3>
    <p id="offer-sub" class="text-slate-400 text-xs mb-5">Prix demand√© : <span id="offer-asked" class="font-bold text-sky-500"></span></p>
    <div class="flex items-center justify-center gap-2 mb-2">
      <span class="text-3xl font-black text-slate-300">‚Ç¨</span>
      <input id="offer-amount" type="number" class="offer-input" placeholder="0" style="width:120px">
    </div>
    <div id="offer-hint" class="text-[10px] text-slate-400 mb-5"></div>
    <!-- Suggestions rapides -->
    <div class="flex justify-center gap-2 mb-5" id="offer-quick"></div>
    <button onclick="sendOffer()" class="w-full bg-amber-400 text-black font-extrabold py-4 rounded-2xl text-[15px] active:scale-95 transition-transform">
      Envoyer l'offre
    </button>
  </div>
</div>

<!-- SIGNALER -->
<div id="report-modal" class="fixed inset-0 z-[800] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeReport()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8 bg-white">
    <div class="flex justify-center mb-3"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <p class="font-extrabold text-base mb-4"><i class="fa-solid fa-flag text-red-500 mr-2"></i>Signaler cette annonce</p>
    <div id="report-reasons">
      <div class="report-reason" onclick="submitReport('Arnaque / phishing')"><i class="fa-solid fa-skull-crossbones text-red-400 w-5 text-center"></i>Arnaque / phishing</div>
      <div class="report-reason" onclick="submitReport('Prix abusif / offre irr√©aliste')"><i class="fa-solid fa-tag text-orange-400 w-5 text-center"></i>Prix abusif ou irr√©aliste</div>
      <div class="report-reason" onclick="submitReport('Contenu interdit ou dangereux')"><i class="fa-solid fa-ban text-red-400 w-5 text-center"></i>Contenu interdit ou dangereux</div>
      <div class="report-reason" onclick="submitReport('Annonce dupliqu√©e / spam')"><i class="fa-solid fa-clone text-slate-400 w-5 text-center"></i>Annonce dupliqu√©e / spam</div>
      <div class="report-reason" onclick="submitReport('Photos vol√©es / trompeuses')"><i class="fa-solid fa-image text-slate-400 w-5 text-center"></i>Photos vol√©es ou trompeuses</div>
      <div class="report-reason" onclick="submitReport('Autre raison')"><i class="fa-solid fa-ellipsis text-slate-400 w-5 text-center"></i>Autre raison</div>
    </div>
  </div>
</div>

<!-- PROFIL VENDEUR -->
<div id="seller-profile-modal" class="fixed inset-0 z-[700] bg-white hidden flex-col sr">
  <div class="flex items-center gap-3 px-4 pt-5 pb-4 border-b border-slate-100 shrink-0">
    <button onclick="closeSellerProfile()" class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left text-slate-600 text-sm"></i>
    </button>
    <p class="font-extrabold text-base text-slate-900 flex-1">Profil vendeur</p>
  </div>
  <div class="flex-1 overflow-y-auto no-sb px-4 pt-5 pb-12">
    <div class="flex items-center gap-4 mb-5">
      <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
        <i class="fa-solid fa-user text-xl text-white"></i>
      </div>
      <div>
        <div class="flex items-center gap-2 flex-wrap">
          <p id="sp-name" class="font-extrabold text-lg text-slate-900"></p>
          <span id="sp-verified" class="verified-badge hidden"><i class="fa-solid fa-circle-check"></i> V√©rifi√©</span>
        </div>
        <p id="sp-since" class="text-xs text-slate-400 mt-0.5"></p>
      </div>
    </div>
    <div class="flex gap-3 mb-5">
      <div class="sp-stat"><p id="sp-count" class="text-xl font-black text-sky-500">0</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Annonces</p></div>
      <div class="sp-stat"><p id="sp-rating-val" class="text-xl font-black text-amber-400">‚Äî</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Note</p></div>
      <div class="sp-stat"><p id="sp-coins" class="text-xl font-black text-amber-500">0 ü™ô</p><p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Coins</p></div>
    </div>
    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide mb-3">Annonces actives</p>
    <div id="sp-listings" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"></div>
  </div>
</div>

<!-- RECHERCHE PAR PHOTO -->
<div id="search-photo-modal" class="fixed inset-0 z-[900] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0" onclick="closeSearchPhoto()"></div>
  <div class="relative bg-white rounded-3xl p-6 w-full max-w-sm su text-center">
    <button onclick="closeSearchPhoto()" class="absolute top-4 right-4 w-8 h-8 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-slate-500 text-sm"></i></button>
    <div id="sph-idle">
      <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-sky-500 to-indigo-500 flex items-center justify-center mx-auto mb-3">
        <i class="fa-solid fa-camera-retro text-white text-2xl"></i>
      </div>
      <h3 class="font-extrabold text-base mb-1">Recherche par photo</h3>
      <p class="text-slate-400 text-xs mb-5">Prends ou importe une photo d'un objet ‚Äî l'IA trouve les annonces similaires</p>
      <button onclick="document.getElementById('search-photo-inp').click()" class="w-full bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-bold py-3.5 rounded-2xl mb-2 active:scale-95 transition-transform">
        <i class="fa-solid fa-upload mr-2"></i>Importer une photo
      </button>
    </div>
    <div id="sph-loading" class="hidden">
      <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-sky-500 to-indigo-500 flex items-center justify-center mx-auto mb-3">
        <i class="fa-solid fa-circle-notch animate-spin text-white text-2xl"></i>
      </div>
      <p class="font-bold text-sm mb-1">Analyse en cours...</p>
      <p class="text-slate-400 text-xs">L'IA identifie l'objet et cherche des annonces similaires</p>
    </div>
    <div id="sph-results" class="hidden text-left">
      <p class="font-extrabold text-sm mb-1">R√©sultats pour :</p>
      <p id="sph-detected" class="text-sky-500 font-bold text-xs mb-3"></p>
      <div id="sph-list" class="flex flex-col gap-2 max-h-64 overflow-y-auto no-sb"></div>
      <button onclick="closeSearchPhoto()" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl mt-3 text-sm">Fermer</button>
    </div>
  </div>
</div>

<!-- SCAN MODAL -->
<div id="scan-modal" class="fixed inset-0 z-[400] hidden flex-col justify-end">
  <div class="mover absolute inset-0" onclick="closeScan()"></div>
  <div class="relative msheet su w-full max-w-lg mx-auto" style="max-height:94vh;display:flex;flex-direction:column;">
    <div class="flex justify-center pt-3 pb-2 shrink-0">
      <div class="w-10 h-1 bg-zinc-700 rounded-full"></div>
    </div>

    <!-- ETAPE 1: photo -->
    <div id="step-photo" class="px-4 pb-5 shrink-0">
      <div class="flex items-center justify-between mb-3">
        <p class="font-extrabold text-[15px]">Nouvelle annonce</p>
        <button onclick="closeScan()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center">
          <i class="fa-solid fa-xmark text-sm"></i>
        </button>
      </div>
      <div id="scan-box" class="relative bg-slate-800 rounded-2xl overflow-hidden mx-auto mb-3" style="width:100%;max-width:340px;aspect-ratio:1/1;">
        <video id="cam-vid" class="hidden absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
        <img id="scan-prev" class="hidden absolute inset-0 w-full h-full object-cover">
        <div id="scan-line" class="hidden absolute w-full left-0 z-20" style="height:2px;background:#0ea5e9;box-shadow:0 0 10px #22d3ee;animation:scanmove 1.8s linear infinite"></div>
        <div id="scan-ph" class="absolute inset-0 flex flex-col items-center justify-center gap-3 pointer-events-none">
          <div class="w-14 h-14 rounded-2xl bg-slate-700 flex items-center justify-center">
            <i class="fa-solid fa-camera text-2xl text-slate-400"></i>
          </div>
          <p class="text-xs text-slate-400 font-semibold">Photo ou galerie</p>
        </div>
        <div id="scan-spin" class="hidden absolute inset-0 bg-black/75 z-30 flex flex-col items-center justify-center gap-3">
          <i class="fa-solid fa-circle-notch animate-spin text-sky-500 text-3xl"></i>
          <p class="text-xs text-sky-500 font-bold tracking-widest uppercase">Analyse IA...</p>
        </div>
      </div>
      <div id="photo-btns" class="flex gap-2">
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="onFile(event)">
        <button onclick="document.getElementById('file-input').click()"
          class="flex-1 bg-slate-700 border border-slate-600/30 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-image text-slate-300"></i> Galerie
        </button>
        <button id="cam-toggle" onclick="toggleCam()"
          class="flex-1 bg-slate-700 border border-slate-600/30 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-camera text-slate-300"></i> Camera
        </button>
        <button id="snap-btn" onclick="snapPhoto()" class="hidden flex-1 bg-sky-500 rounded-xl py-3 text-sm font-bold text-black flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-circle"></i> Capturer
        </button>
      </div>
    </div>

    <!-- ETAPE 2: resultats IA -->
    <div id="step-result" class="hidden flex-col flex-1 overflow-hidden">
      <div class="overflow-y-auto no-sb px-4 pb-6 flex-1">
        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-slate-600/30">
          <img id="res-thumb" class="w-16 h-16 rounded-xl object-cover border border-slate-600/40 shrink-0">
          <div class="flex-1 min-w-0">
            <p class="text-[10px] text-green-400 font-bold uppercase tracking-wide mb-1"><i class="fa-solid fa-check-circle mr-1"></i>IA terminee</p>
            <input id="ai-name" class="w-full bg-transparent text-sm font-extrabold text-white outline-none border-b border-white/10 pb-1 focus:border-cyan-400 truncate">
          </div>
          <button onclick="resetScan()" class="shrink-0 w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center text-slate-300 active:scale-90 transition-transform">
            <i class="fa-solid fa-rotate-left text-xs"></i>
          </button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Marque</p>
            <p id="ai-brand" class="text-sm font-extrabold text-sky-500">-</p>
          </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Modele</p>
            <p id="ai-model" class="text-sm font-extrabold text-white truncate">-</p>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Prix</p>
            <p id="ai-price" class="text-sm font-extrabold text-sky-500">-</p>
          </div>
      <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Cat√©gorie</p>
          <select id="ai-cat-select" class="inp" style="cursor:pointer;font-size:12px">
            <optgroup label="üì± √âlectronique">
              <option>T√©l√©phones & objets connect√©s</option>
              <option>Accessoires t√©l√©phones</option>
              <option>Ordinateurs</option>
              <option>Accessoires informatique</option>
              <option>Tablettes & liseuses</option>
              <option>Photo, audio & vid√©o</option>
              <option>Consoles</option>
              <option>Jeux vid√©o</option>
            </optgroup>
            <optgroup label="üëó Mode">
              <option>V√™tements homme</option>
              <option>V√™tements femme</option>
              <option>Chaussures homme</option>
              <option>Chaussures femme</option>
              <option>Accessoires & Bagagerie</option>
              <option>Montres & Bijoux</option>
              <option>Lunettes</option>
              <option>Beaut√© & Bien-√™tre</option>
            </optgroup>
            <optgroup label="üë∂ Famille">
              <option>V√™tements b√©b√©</option>
              <option>V√™tements enfant</option>
              <option>Chaussures enfant</option>
              <option>√âquipement b√©b√©</option>
              <option>Mobilier enfant</option>
              <option>Jeux & Jouets</option>
              <option>Pu√©riculture</option>
            </optgroup>
            <optgroup label="üè† Maison & Jardin">
              <option>Ameublement</option>
              <option>√âlectrom√©nager</option>
              <option>Arts de la table</option>
              <option>D√©coration</option>
              <option>Linge de maison</option>
              <option>Bricolage</option>
              <option>Outillage</option>
              <option>Jardin & Plantes</option>
              <option>Papeterie & fournitures</option>
            </optgroup>
            <optgroup label="üé≠ Loisirs">
              <option>Livres</option>
              <option>DVD - Films</option>
              <option>CD - Musique</option>
              <option>Instruments de musique</option>
              <option>V√©los</option>
              <option>√âquipements v√©los</option>
              <option>Sport & Hobbies</option>
              <option>Chasse & P√™che</option>
              <option>Collection</option>
              <option>Vins & Gastronomie</option>
              <option>Loisirs cr√©atifs</option>
              <option>Antiquit√©s</option>
              <option>Mod√©lisme</option>
              <option>Camping & Plein air</option>
            </optgroup>
            <optgroup label="üêæ Animaux">
              <option>Chiens</option>
              <option>Chats</option>
              <option>Chevaux & √âquid√©s</option>
              <option>Oiseaux</option>
              <option>Rongeurs & Lapins</option>
              <option>Reptiles & Amphibiens</option>
              <option>Poissons</option>
              <option>Accessoires animaux</option>
              <option>Alimentation animaux</option>
            </optgroup>
            <optgroup label="üöó V√©hicules">
              <option>Voitures</option>
              <option>Motos</option>
              <option>Scooters & V√©los √©lectriques</option>
              <option>Utilitaires</option>
              <option>Caravaning</option>
              <option>Nautisme</option>
              <option>√âquipement auto</option>
              <option>√âquipement moto</option>
              <option>√âquipement caravaning</option>
              <option>Pi√®ces d√©tach√©es auto</option>
            </optgroup>
            <optgroup label="üè¢ Immobilier">
              <option>Ventes immobili√®res</option>
              <option>Locations</option>
              <option>Colocations</option>
              <option>Bureaux & Commerces</option>
              <option>Terrains & Propri√©t√©s</option>
              <option>Locations de vacances</option>
            </optgroup>
            <optgroup label="üõ†Ô∏è Services">
              <option>Cours particuliers</option>
              <option>Formation professionnelle</option>
              <option>Covoiturage</option>
              <option>Prestations de services</option>
              <option>Services √©v√©nementiels</option>
              <option>Service √† la personne</option>
              <option>Baby-sitting</option>
              <option>D√©m√©nagement</option>
              <option>Jardinage</option>
              <option>Bricolage & R√©paration</option>
            </optgroup>
            <optgroup label="üè≠ Mat√©riel Pro">
              <option>Mat√©riel agricole</option>
              <option>Tracteurs</option>
              <option>Poids lourds</option>
              <option>BTP - Chantier</option>
              <option>Manutention - Levage</option>
              <option>√âquipements industriels</option>
              <option>Restauration - H√¥tellerie</option>
              <option>Fournitures de bureau</option>
              <option>Mat√©riel m√©dical</option>
              <option>√âquipements commerces</option>
            </optgroup>
          </select>
        </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Etat</p>
            <p id="ai-cond" class="text-xs font-extrabold text-green-400">-</p>
          </div>
        </div>
        <!-- Prix march√© IA -->
        <div id="price-suggestion" class="hidden bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <div class="flex items-center gap-2 mb-1">
            <i class="fa-solid fa-chart-line text-sky-400" style="font-size:10px"></i>
            <p class="text-[9px] text-slate-400 uppercase font-bold">Prix du march√©</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-slate-400">Similaires :</span>
            <span id="price-range-txt" class="text-xs font-bold text-sky-400"></span>
            <span id="price-verdict" class="text-[9px] font-bold px-2 py-0.5 rounded-full"></span>
          </div>
        </div>
        <!-- Photos suppl√©mentaires -->
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[9px] text-slate-400 uppercase font-bold">Photos (max 5)</p>
            <button onclick="document.getElementById('extra-photos-inp').click()" class="text-[10px] text-sky-400 font-bold bg-sky-500/10 px-2 py-1 rounded-lg">
              <i class="fa-solid fa-plus mr-1"></i>Ajouter
            </button>
          </div>
          <input type="file" id="extra-photos-inp" accept="image/*" multiple class="hidden" onchange="addExtraPhotos(this)">
          <div id="extra-photos-list" class="flex gap-2 overflow-x-auto no-sb pb-1 min-h-[40px]">
            <p class="text-[10px] text-slate-500 self-center">Aucune photo suppl√©mentaire</p>
          </div>
        </div>
        <!-- Troc -->
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="scan-troc" class="w-4 h-4 accent-amber-400">
            <span class="text-sm font-semibold flex-1">Proposer un √©change üîÑ</span>
            <span class="text-[10px] text-slate-400">Troc OK</span>
          </label>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Description</p>
          <textarea id="ai-desc" rows="3" class="w-full bg-transparent text-xs text-slate-200 outline-none resize-none leading-relaxed font-medium"></textarea>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Ville</p>
          <div class="relative">
            <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-sky-500" style="font-size:10px"></i>
            <input id="item-city" type="text" placeholder="Ex : Paris, Lyon..." class="inp pl-7 py-2 text-sm" style="background:#0f172a;border-color:rgba(148,163,184,.10)">
          </div>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-4">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-2.5">Livraison</p>
          <div class="flex flex-col gap-3">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-hand" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Main propre</span>
              <span class="text-xs text-slate-400">Gratuit</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-relay" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Mondial Relay</span>
              <input type="number" id="sh-relay-p" value="5" class="w-14 bg-[#0f172a] border border-slate-600/40 rounded-lg px-2 py-1 text-xs text-center text-white outline-none">
              <span class="text-xs text-slate-400">euro</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-colis" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Colissimo</span>
              <input type="number" id="sh-colis-p" value="8" class="w-14 bg-[#0f172a] border border-slate-600/40 rounded-lg px-2 py-1 text-xs text-center text-white outline-none">
              <span class="text-xs text-slate-400">euro</span>
            </label>
          </div>
        </div>
        <button id="pub-btn" class="w-full bg-sky-500 text-black font-extrabold py-4 rounded-2xl text-[15px] active:scale-95 transition-transform shadow-[0_0_18px_rgba(34,211,238,.35)]">
          Publier l'annonce
        </button>
      </div>
    </div>
  </div>
  <canvas id="cap-canvas" class="hidden"></canvas>
</div>

<!-- DETAIL -->
<div id="detail-modal" class="fixed inset-0 z-[500] bg-[#0f172a] hidden flex-col sr">
  <div class="flex items-center gap-2 px-3 pt-4 pb-3 bg-[#0f172a] border-b border-slate-600/30 shrink-0">
    <button onclick="closeDetail()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <p class="font-bold text-sm flex-1">D√©tail de l'annonce</p>
    <button onclick="openShareModal()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center active:scale-90 transition-transform" title="Partager">
      <i class="fa-solid fa-share-nodes text-sm text-sky-400"></i>
    </button>
    <button onclick="toggleFavDetail()" id="det-fav-btn" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center active:scale-90 transition-transform">
      <i id="det-fav-icon" class="fa-regular fa-heart text-sm text-slate-400"></i>
    </button>
    <button onclick="openReport()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center active:scale-90 transition-transform" title="Signaler">
      <i class="fa-solid fa-flag text-sm text-slate-500"></i>
    </button>
  </div>
  <div class="flex-1 overflow-y-auto no-sb">
    <!-- CARROUSEL -->
    <div class="px-3 pt-3 pb-1 relative">
      <div id="det-carousel-wrap" style="width:100%;height:300px;border-radius:16px;overflow:hidden;background:#f8f8f8;position:relative">
        <div id="det-carousel-track" style="display:flex;height:100%;transition:transform .3s cubic-bezier(.16,1,.3,1)"></div>
        <button id="det-prev" onclick="carNav(-1)" style="display:none;position:absolute;left:8px;top:50%;transform:translateY(-50%);width:30px;height:30px;background:rgba(15,23,42,.65);border:none;border-radius:50%;color:#fff;font-size:11px;cursor:pointer;align-items:center;justify-content:center;z-index:2"><i class="fa-solid fa-chevron-left"></i></button>
        <button id="det-next" onclick="carNav(1)" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);width:30px;height:30px;background:rgba(15,23,42,.65);border:none;border-radius:50%;color:#fff;font-size:11px;cursor:pointer;align-items:center;justify-content:center;z-index:2"><i class="fa-solid fa-chevron-right"></i></button>
        <div id="det-views-badge" class="hidden" style="position:absolute;bottom:8px;left:8px;background:rgba(15,23,42,.72);color:#fff;font-size:9px;font-weight:700;padding:3px 8px;border-radius:99px;display:flex;align-items:center;gap:4px;z-index:2">
          <i class="fa-solid fa-eye" style="font-size:8px"></i><span id="det-views-count">0</span> vues
        </div>
      </div>
      <div id="det-dots" class="flex justify-center gap-1.5 mt-2 min-h-[10px]"></div>
      <!-- Thumbs multi-photos -->
      <div id="det-thumbs" class="flex gap-2 overflow-x-auto no-sb mt-2"></div>
    </div>
    <div class="px-4 pb-8">
      <div class="flex items-start justify-between gap-2 mt-2 mb-1">
        <h2 id="det-title" class="font-extrabold text-xl leading-tight flex-1"></h2>
        <div class="text-right shrink-0">
          <p id="det-price" class="text-sky-500 font-black text-xl"></p>
          <div id="det-coins-earn" class="hidden text-[9px] text-amber-600 font-bold mt-0.5"></div>
        </div>
      </div>
      <div id="det-price-range" class="hidden mb-2"></div>
      <div class="flex flex-wrap gap-2 mb-3">
        <span id="det-cat" class="text-[10px] text-slate-400 font-bold uppercase bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-600/30"></span>
        <span id="det-cond" class="text-[10px] text-slate-300 font-bold bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-600/30"></span>
        <span id="det-city-tag" class="hidden text-[10px] text-slate-300 font-bold bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-600/30">
          <i class="fa-solid fa-location-dot text-sky-500 mr-1"></i><span id="det-city-val"></span>
        </span>
        <span id="det-troc-tag" class="hidden troc-badge">üîÑ √âchange OK</span>
      </div>
      <p id="det-brand" class="text-xs text-slate-500 font-mono mb-3"></p>
      <div id="det-fraud-warn" class="fraud-warn hidden">
        <i class="fa-solid fa-triangle-exclamation text-red-500 text-sm shrink-0 mt-0.5"></i>
        <div><p class="text-xs font-bold text-red-700">Prix inhabituel</p><p class="text-[10px] text-red-600 mt-0.5">Prix tr√®s bas par rapport au march√©. Pr√©f√©rez la remise en main propre.</p></div>
      </div>
      <div class="garantie-banner mb-3">
        <i class="fa-solid fa-shield-halved text-green-500 text-lg shrink-0"></i>
        <div><p class="text-xs font-bold text-green-800">Garantie acheteur Youbiiiz</p><p class="text-[10px] text-green-700 mt-0.5">Paiement s√©curis√© ¬∑ Remboursement si non conforme ¬∑ Support 7j/7</p></div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-2 tracking-widest">Description</p>
        <p id="det-desc" class="text-sm text-slate-200 leading-relaxed"></p>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-2 tracking-widest">Livraison</p>
        <div id="det-ship" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Score de confiance</p>
          <span id="det-trust-label" class="text-[10px] font-bold"></span>
        </div>
        <div class="trust-bar"><div id="det-trust-fill" class="trust-fill" style="width:0%"></div></div>
        <div id="det-trust-details" class="flex gap-2 flex-wrap mt-2"></div>
      </div>
      <!-- Vendeur cliquable ‚Üí profil -->
      <div id="det-seller-card" onclick="openSellerProfile()" class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30 cursor-pointer active:scale-[.98] transition-transform">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-3 tracking-widest">Vendeur</p>
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-sm text-white"></i>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <p id="det-seller" class="font-bold text-sm"></p>
              <span id="det-verified" class="verified-badge hidden"><i class="fa-solid fa-circle-check"></i> V√©rifi√©</span>
            </div>
            <p id="det-rating" class="text-[10px] text-yellow-400 mt-0.5">Nouveau vendeur</p>
          </div>
          <i class="fa-solid fa-chevron-right text-slate-500 text-xs shrink-0"></i>
        </div>
      </div>
      <!-- Annonces similaires -->
      <div class="mb-5">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-3 tracking-widest">Annonces similaires</p>
        <div id="det-similar" class="flex gap-3 overflow-x-auto no-sb pb-1"></div>
      </div>
      <!-- Boutons action -->
      <div class="flex gap-2 mb-2">
        <button id="contact-btn" class="flex-1 bg-slate-800 border border-slate-600/40 rounded-2xl py-3.5 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-message text-xs"></i> Contacter
        </button>
        <button onclick="openOffer()" class="flex-1 bg-amber-500/10 border border-amber-500/30 rounded-2xl py-3.5 text-sm font-bold flex items-center justify-center gap-2 text-amber-400 active:scale-95 transition-transform">
          <i class="fa-solid fa-handshake text-xs"></i> Faire offre
        </button>
      </div>
      <button id="buy-btn" class="w-full bg-sky-500 text-black rounded-2xl py-4 text-[15px] font-extrabold flex items-center justify-center gap-2 active:scale-95 transition-transform shadow-[0_0_20px_rgba(14,165,233,.4)]">
        <i class="fa-brands fa-stripe text-lg"></i> Acheter maintenant
      </button>
    </div>
  </div>
</div>

<!-- CHAT -->
<div id="chat-modal" class="fixed inset-0 z-[600] bg-[#0f172a] hidden flex-col sr">
  <div class="flex items-center gap-3 px-3 pt-4 pb-3 bg-[#0f172a] border-b border-slate-600/30 shrink-0">
    <button onclick="closeChat()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
      <i class="fa-solid fa-user text-xs text-white"></i>
    </div>
    <div class="flex-1">
      <p id="chat-seller" class="font-bold text-sm leading-none"></p>
      <p class="text-[10px] text-green-400 font-semibold mt-0.5">En ligne</p>
    </div>
  </div>
  <div class="px-3 py-2 bg-slate-800/50 border-b border-slate-600/30 flex gap-3 items-center shrink-0">
    <img id="chat-img" class="w-9 h-9 rounded-lg object-cover border border-slate-600/40 shrink-0">
    <div class="flex-1 min-w-0">
      <p id="chat-iname" class="text-xs font-bold truncate"></p>
      <p id="chat-iprice" class="text-xs text-sky-500 font-bold"></p>
    </div>
  </div>
  <div id="chat-msgs" class="flex-1 overflow-y-auto no-sb p-4 flex flex-col gap-3"></div>
  <!-- Suggestions IA contextuelles -->
  <div class="px-3 pt-2 bg-[#0f172a] shrink-0">
    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 tracking-wide"><i class="fa-solid fa-wand-magic-sparkles text-sky-400 mr-1"></i>IA sugg√®re</p>
    <div id="chat-suggestions" class="flex gap-2 overflow-x-auto no-sb pb-1"></div>
  </div>
  <div class="px-3 py-3 bg-[#0f172a] border-t border-slate-600/30 shrink-0">
    <div class="flex gap-2">
      <input id="chat-inp" type="text" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()" oninput="updateChatSuggestions()"
        class="flex-1 bg-slate-800 border border-slate-600/40 rounded-xl px-4 py-2.5 text-sm text-white placeholder-zinc-600 outline-none focus:border-sky-500">
      <button onclick="sendMsg()" class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center active:scale-90 transition-transform">
        <i class="fa-solid fa-paper-plane text-black text-xs"></i>
      </button>
    </div>
  </div>
</div>

<!-- PAIEMENT -->
<div id="pay-modal" class="fixed inset-0 z-[700] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closePay()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8">
    <div class="flex justify-center mb-4"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="w-7 h-7 rounded-lg bg-green-500/15 flex items-center justify-center">
          <i class="fa-solid fa-shield-halved text-green-400 text-xs"></i>
        </div>
        <span class="font-bold text-sm">Paiement securise</span>
      </div>
      <button onclick="closePay()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center">
        <i class="fa-solid fa-xmark text-sm"></i>
      </button>
    </div>
    <div class="flex gap-3 mb-4">
      <div id="pay-img" class="w-14 h-14 rounded-xl bg-slate-700 bg-cover bg-center shrink-0 border border-slate-600/40"></div>
      <div>
        <p id="pay-title" class="font-bold text-sm mb-1 leading-tight"></p>
        <p id="pay-price" class="text-sky-500 font-black text-lg"></p>
      </div>
    </div>
    <div id="pay-ship-wrap" class="hidden mb-3">
      <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">Choisir la livraison</p>
      <div id="pay-ship-list" class="flex flex-col gap-2"></div>
    </div>
    <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30 text-sm">
      <div class="flex justify-between mb-2"><span class="text-slate-300">Article</span><span id="pay-sub" class="font-bold"></span></div>
      <div class="flex justify-between mb-2"><span class="text-slate-300">Livraison</span><span id="pay-shipcost" class="font-bold">-</span></div>
      <div id="pay-coins-row" class="hidden flex justify-between mb-2 items-center"><span class="text-slate-300">Youbiiiz Coins</span><span id="pay-coins-discount" class="font-bold text-amber-400"></span></div>
      <div class="flex justify-between border-t border-slate-600/30 pt-3"><span class="font-bold">Total</span><span id="pay-total" class="font-extrabold text-sky-500 text-base"></span></div>
    </div>
    <!-- Paiement en plusieurs fois -->
    <div class="mb-4">
      <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">Mode de paiement</p>
      <div id="pay-mode-1x" class="pay3x-option selected" onclick="selectPayMode('1x')">
        <div class="flex items-center justify-between">
          <span class="text-sm font-bold">Paiement comptant</span>
          <span id="pay-1x-amount" class="text-sm font-extrabold text-sky-400"></span>
        </div>
      </div>
      <div id="pay-mode-3x" class="pay3x-option" onclick="selectPayMode('3x')">
        <div class="flex items-center justify-between">
          <div>
            <span class="text-sm font-bold">Paiement en 3√ó</span>
            <span class="text-[10px] text-green-400 font-bold ml-2">Sans frais</span>
          </div>
          <span id="pay-3x-amount" class="text-sm font-extrabold text-sky-400"></span>
        </div>
        <p id="pay-3x-detail" class="text-[10px] text-slate-400 mt-1"></p>
      </div>
    </div>
    <!-- Coins dispo -->
    <div id="pay-use-coins" class="hidden mb-3 flex items-center justify-between bg-amber-50 border border-amber-200 rounded-xl p-3">
      <div class="flex items-center gap-2">
        <span class="text-lg">ü™ô</span>
        <div><p class="text-xs font-bold text-amber-800">Utiliser mes Coins</p><p id="pay-coins-avail" class="text-[10px] text-amber-600"></p></div>
      </div>
      <label class="toggle-sw" style="filter:hue-rotate(30deg)">
        <input type="checkbox" id="use-coins-toggle" onchange="toggleCoinsDiscount()">
        <div class="toggle-track"></div>
      </label>
    </div>
    <button id="stripe-btn" onclick="doStripe()" class="w-full bg-[#635bff] text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-transform">
      <i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant
    </button>
  </div>
</div>

<!-- NOTATION -->
<div id="rate-modal" class="fixed inset-0 z-[800] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-6 w-full max-w-xs border border-slate-600/40 text-center su">
    <div class="w-14 h-14 rounded-2xl bg-yellow-500/10 flex items-center justify-center mx-auto mb-3">
      <i class="fa-solid fa-star text-yellow-400 text-2xl"></i>
    </div>
    <h3 class="font-extrabold text-base mb-1">Laisser une note</h3>
    <p id="rate-sub" class="text-slate-400 text-xs mb-4">Comment s'est passee la transaction ?</p>
    <div class="flex justify-center gap-2 mb-4">
      <button onclick="setStar(1)" class="star text-3xl text-slate-600 transition-all" data-v="1">&#9733;</button>
      <button onclick="setStar(2)" class="star text-3xl text-slate-600 transition-all" data-v="2">&#9733;</button>
      <button onclick="setStar(3)" class="star text-3xl text-slate-600 transition-all" data-v="3">&#9733;</button>
      <button onclick="setStar(4)" class="star text-3xl text-slate-600 transition-all" data-v="4">&#9733;</button>
      <button onclick="setStar(5)" class="star text-3xl text-slate-600 transition-all" data-v="5">&#9733;</button>
    </div>
    <textarea id="rate-comment" placeholder="Commentaire (optionnel)" rows="2" class="inp text-sm mb-4 resize-none" style="font-size:13px"></textarea>
    <button onclick="submitRate()" class="w-full bg-yellow-400 text-black font-bold py-3.5 rounded-2xl mb-2 active:scale-95 transition-transform">Envoyer</button>
    <button onclick="closeRate()" class="w-full text-slate-400 text-sm py-2">Passer</button>
  </div>
</div>

<!-- EDIT -->
<div id="edit-modal" class="fixed inset-0 z-[600] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeEdit()"></div>
  <div class="relative msheet su w-full max-w-lg">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between px-4 pt-2 pb-3">
      <p class="font-extrabold text-[15px]">Modifier</p>
      <button onclick="closeEdit()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark text-sm"></i></button>
    </div>
    <div class="overflow-y-auto no-sb px-4 pb-8" style="max-height:65vh">
      <div class="mb-3"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Titre</p>
        <input id="edit-title" class="inp"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
        <div><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Prix (euro)</p>
          <input id="edit-price" type="number" class="inp text-sky-500 font-black"></div>
        <div><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Etat</p>
          <select id="edit-cond" class="inp" style="cursor:pointer">
            <option>Neuf</option><option>Tres bon etat</option><option>Bon etat</option><option>Etat correct</option>
          </select></div>
      </div>
      <div class="mb-3"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Cat√©gorie</p>
        <select id="edit-cat" class="inp" style="cursor:pointer;font-size:12px">
          <optgroup label="üì± √âlectronique">
            <option>T√©l√©phones & objets connect√©s</option>
            <option>Accessoires t√©l√©phones</option>
            <option>Ordinateurs</option>
            <option>Accessoires informatique</option>
            <option>Tablettes & liseuses</option>
            <option>Photo, audio & vid√©o</option>
            <option>Consoles</option>
            <option>Jeux vid√©o</option>
          </optgroup>
          <optgroup label="üëó Mode">
            <option>V√™tements homme</option>
            <option>V√™tements femme</option>
            <option>Chaussures homme</option>
            <option>Chaussures femme</option>
            <option>Accessoires & Bagagerie</option>
            <option>Montres & Bijoux</option>
            <option>Lunettes</option>
            <option>Beaut√© & Bien-√™tre</option>
          </optgroup>
          <optgroup label="üë∂ Famille">
            <option>V√™tements b√©b√©</option>
            <option>V√™tements enfant</option>
            <option>Chaussures enfant</option>
            <option>√âquipement b√©b√©</option>
            <option>Mobilier enfant</option>
            <option>Jeux & Jouets</option>
            <option>Pu√©riculture</option>
          </optgroup>
          <optgroup label="üè† Maison & Jardin">
            <option>Ameublement</option>
            <option>√âlectrom√©nager</option>
            <option>Arts de la table</option>
            <option>D√©coration</option>
            <option>Linge de maison</option>
            <option>Bricolage</option>
            <option>Outillage</option>
            <option>Jardin & Plantes</option>
            <option>Papeterie & fournitures</option>
          </optgroup>
          <optgroup label="üé≠ Loisirs">
            <option>Livres</option>
            <option>DVD - Films</option>
            <option>CD - Musique</option>
            <option>Instruments de musique</option>
            <option>V√©los</option>
            <option>√âquipements v√©los</option>
            <option>Sport & Hobbies</option>
            <option>Chasse & P√™che</option>
            <option>Collection</option>
            <option>Vins & Gastronomie</option>
            <option>Loisirs cr√©atifs</option>
            <option>Antiquit√©s</option>
            <option>Mod√©lisme</option>
            <option>Camping & Plein air</option>
          </optgroup>
          <optgroup label="üêæ Animaux">
            <option>Chiens</option>
            <option>Chats</option>
            <option>Chevaux & √âquid√©s</option>
            <option>Oiseaux</option>
            <option>Rongeurs & Lapins</option>
            <option>Reptiles & Amphibiens</option>
            <option>Poissons</option>
            <option>Accessoires animaux</option>
            <option>Alimentation animaux</option>
          </optgroup>
          <optgroup label="üöó V√©hicules">
            <option>Voitures</option>
            <option>Motos</option>
            <option>Scooters & V√©los √©lectriques</option>
            <option>Utilitaires</option>
            <option>Caravaning</option>
            <option>Nautisme</option>
            <option>√âquipement auto</option>
            <option>√âquipement moto</option>
            <option>√âquipement caravaning</option>
            <option>Pi√®ces d√©tach√©es auto</option>
          </optgroup>
          <optgroup label="üè¢ Immobilier">
            <option>Ventes immobili√®res</option>
            <option>Locations</option>
            <option>Colocations</option>
            <option>Bureaux & Commerces</option>
            <option>Terrains & Propri√©t√©s</option>
            <option>Locations de vacances</option>
          </optgroup>
          <optgroup label="üõ†Ô∏è Services">
            <option>Cours particuliers</option>
            <option>Formation professionnelle</option>
            <option>Covoiturage</option>
            <option>Prestations de services</option>
            <option>Services √©v√©nementiels</option>
            <option>Service √† la personne</option>
            <option>Baby-sitting</option>
            <option>D√©m√©nagement</option>
            <option>Jardinage</option>
            <option>Bricolage & R√©paration</option>
          </optgroup>
          <optgroup label="üè≠ Mat√©riel Pro">
            <option>Mat√©riel agricole</option>
            <option>Tracteurs</option>
            <option>Poids lourds</option>
            <option>BTP - Chantier</option>
            <option>Manutention - Levage</option>
            <option>√âquipements industriels</option>
            <option>Restauration - H√¥tellerie</option>
            <option>Fournitures de bureau</option>
            <option>Mat√©riel m√©dical</option>
            <option>√âquipements commerces</option>
          </optgroup>
        </select></div>
      <div class="mb-4"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Description</p>
        <textarea id="edit-desc" rows="3" class="inp resize-none"></textarea></div>
      <button id="edit-save" onclick="saveEdit()" class="w-full bg-sky-500 text-black font-bold py-4 rounded-2xl mb-2 active:scale-95 transition-transform">Sauvegarder</button>
      <button onclick="confirmDel(editingId)" class="w-full bg-red-500/8 border border-red-500/20 text-red-400 font-bold py-3.5 rounded-2xl text-sm active:scale-95 transition-transform">
        <i class="fa-solid fa-trash mr-2"></i>Supprimer
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div id="del-modal" class="fixed inset-0 z-[700] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-5 w-full max-w-xs border border-red-500/20 text-center su">
    <i class="fa-solid fa-trash text-red-400 text-2xl mb-3"></i>
    <p class="font-extrabold text-base mb-1">Supprimer ?</p>
    <p class="text-slate-400 text-xs mb-5">Cette action est definitive.</p>
    <div class="flex gap-2">
      <button onclick="closeDel()" class="flex-1 bg-slate-700 font-bold py-3 rounded-xl text-sm">Annuler</button>
      <button onclick="doDelete()" class="flex-1 bg-red-500 font-bold py-3 rounded-xl text-sm">Supprimer</button>
    </div>
  </div>
</div>

<input type="file" id="search-photo-inp" accept="image/*" class="hidden" onchange="onSearchPhoto(this)">

<!-- DEMO MODE ‚Äî plain script, toujours disponible m√™me si Firebase crash -->
<script>
var isDemoMode=false;
var _demoItems=[
  {id:"demo-1",userId:"demo-seller-a",itemName:"iPhone 14 Pro 256Go",price:750,category:"T√©l√©phones & objets connect√©s",condition:"Tr√®s bon √©tat",description:"iPhone 14 Pro 256Go couleur Violet intense. Vendu avec chargeur et c√¢ble. Aucune rayure, batterie 94%.",brand:"Apple",model:"iPhone 14 Pro",city:"Paris",imageUrl:"https://images.unsplash.com/photo-1678685888221-cda773a3dcdb?w=400&q=80",shipping:[{method:"Main propre",price:0},{method:"Colissimo",price:8}],views:142,troc:false,createdAt:{seconds:Date.now()/1000-3600}},
  {id:"demo-2",userId:"demo-seller-b",itemName:"PS5 + Manette DualSense",price:430,category:"Consoles",condition:"Bon √©tat",description:"PS5 disc edition avec une manette DualSense blanche. Fonctionne parfaitement. Vendu avec 2 jeux.",brand:"Sony",model:"PS5",city:"Lyon",imageUrl:"https://images.unsplash.com/photo-1607016284318-d1384bf4d339?w=400&q=80",shipping:[{method:"Main propre",price:0},{method:"Mondial Relay",price:12}],views:89,troc:true,createdAt:{seconds:Date.now()/1000-7200}},
  {id:"demo-3",userId:"demo-seller-c",itemName:'MacBook Air M2 13"',price:1100,category:"Ordinateurs",condition:"Neuf",description:"MacBook Air M2 13 pouces, Minuit, 8Go RAM 256Go SSD. Jamais ouvert, bo√Æte scell√©e.",brand:"Apple",model:"MacBook Air M2",city:"Marseille",imageUrl:"https://images.unsplash.com/photo-1611186871525-0e17d99d4e3a?w=400&q=80",shipping:[{method:"Colissimo",price:10}],views:203,troc:false,createdAt:{seconds:Date.now()/1000-10800}},
  {id:"demo-4",userId:"demo-seller-d",itemName:"Nike Air Max 90 Blanc T42",price:75,category:"Chaussures homme",condition:"Bon √©tat",description:"Nike Air Max 90 blanches taille 42. Port√©es 5-6 fois. Semelles propres.",brand:"Nike",model:"Air Max 90",city:"Bordeaux",imageUrl:"https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&q=80",shipping:[{method:"Mondial Relay",price:5},{method:"Main propre",price:0}],views:34,troc:false,createdAt:{seconds:Date.now()/1000-14400}},
  {id:"demo-5",userId:"demo-seller-a",itemName:"V√©lo de route Trek 2023",price:680,category:"V√©los",condition:"Tr√®s bon √©tat",description:"V√©lo de route Trek Domane AL2 taille M, 2023. Cadre aluminium, Shimano Claris 16v. 800km.",brand:"Trek",model:"Domane AL2",city:"Nantes",imageUrl:"https://images.unsplash.com/photo-1571068316344-75bc76f77890?w=400&q=80",shipping:[{method:"Main propre",price:0}],views:67,troc:true,createdAt:{seconds:Date.now()/1000-18000}},
  {id:"demo-6",userId:"demo-seller-b",itemName:"Canap√© convertible 3 places",price:320,category:"Ameublement",condition:"Bon √©tat",description:"Canap√© convertible 3 places tissu gris anthracite. Coffre de rangement int√©gr√©.",brand:"IKEA",model:"Friheten",city:"Toulouse",imageUrl:"https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=400&q=80",shipping:[{method:"Main propre",price:0}],views:21,troc:false,createdAt:{seconds:Date.now()/1000-21600}},
  {id:"demo-7",userId:"demo-seller-e",itemName:"Lego Star Wars Millennium Falcon",price:180,category:"Jeux & Jouets",condition:"Neuf",description:"Set Lego 75257 Millennium Falcon, bo√Æte non ouverte, scell√©e d'usine.",brand:"Lego",model:"75257",city:"Lille",imageUrl:"https://images.unsplash.com/photo-1587654780291-39c9404d746b?w=400&q=80",shipping:[{method:"Colissimo",price:9},{method:"Mondial Relay",price:6}],views:55,troc:false,createdAt:{seconds:Date.now()/1000-25200}},
  {id:"demo-8",userId:"demo-seller-c",itemName:"Guitare Fender Stratocaster",price:550,category:"Instruments de musique",condition:"Tr√®s bon √©tat",description:"Fender Stratocaster Player Series Sunburst. Livr√©e avec housse et c√¢ble Jack.",brand:"Fender",model:"Stratocaster Player",city:"Strasbourg",imageUrl:"https://images.unsplash.com/photo-1510915361894-db8b60106cb1?w=400&q=80",shipping:[{method:"Main propre",price:0},{method:"Colissimo",price:18}],views:91,troc:true,createdAt:{seconds:Date.now()/1000-28800}},
  {id:"demo-9",userId:"demo-seller-d",itemName:"Dyson V15 Detect Absolute",price:390,category:"√âlectrom√©nager",condition:"Tr√®s bon √©tat",description:"Aspirateur Dyson V15 Detect complet avec tous les accessoires. Batterie 50min.",brand:"Dyson",model:"V15 Detect",city:"Paris",imageUrl:"https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&q=80",shipping:[{method:"Colissimo",price:12},{method:"Main propre",price:0}],views:77,troc:false,createdAt:{seconds:Date.now()/1000-32400}},
  {id:"demo-10",userId:"demo-seller-e",itemName:"Jordan 1 Retro High OG T44",price:210,category:"Chaussures homme",condition:"Neuf",description:"Air Jordan 1 Retro High OG Chicago, taille 44. Achet√©es sur SNKRS, bo√Æte et ticket.",brand:"Nike",model:"Jordan 1 Retro High",city:"Lyon",imageUrl:"https://images.unsplash.com/photo-1600269452121-4f2416e55c28?w=400&q=80",shipping:[{method:"Mondial Relay",price:6},{method:"Colissimo",price:9}],views:128,troc:false,createdAt:{seconds:Date.now()/1000-36000}}
];

window.enterDemoMode=function(){
  isDemoMode=true;
  if(typeof _moduleBootDemo==="function"){
    _moduleBootDemo();
  }else{
    // Module pas encore pr√™t ‚Äî attendre max 3s
    var attempts=0;
    var check=setInterval(function(){
      attempts++;
      if(typeof _moduleBootDemo==="function"){
        clearInterval(check);
        _moduleBootDemo();
      }else if(attempts>30){
        clearInterval(check);
        // Le module Firebase a crash√© ‚Äî afficher un message simple dans la page
        document.getElementById("splash").style.display="none";
        document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#f0f2f5;font-family:sans-serif;text-align:center;padding:24px"><div><h2 style="color:#0f172a;margin-bottom:8px">‚ö†Ô∏è Erreur de chargement</h2><p style="color:#64748b;margin-bottom:20px">Le script principal n\'a pas pu charger.<br>V√©rifiez votre connexion et rechargez.</p><button onclick="location.reload()" style="background:#0ea5e9;color:#fff;border:none;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer">üîÑ Recharger</button></div></div>';
      }
    },100);
  }
};
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import{getAuth,signInAnonymously,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,GoogleAuthProvider,signInWithPopup,signOut}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import{getFirestore,collection,addDoc,onSnapshot,serverTimestamp,doc,where,orderBy,query,getDocs,deleteDoc,updateDoc,getDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const FB={apiKey:"AIzaSyDOSIhWwrlkhNfk8Y3-tl9IebJW0YBA7d4",authDomain:"youbiiiz-app.firebaseapp.com",projectId:"youbiiiz-app",storageBucket:"youbiiiz-app.firebasestorage.app",messagingSenderId:"664733497216",appId:"1:664733497216:web:ae19fbadf0fa509f59b365"};
const fb=initializeApp(FB),auth=getAuth(fb),db=getFirestore(fb);

let me=null,items=[],curItem=null,scanData=null,camStream=null;
let editingId=null,deletingId=null,payItem=null,selShip=null,curStar=0,rateCtx=null;
let activeCat="all",map=null,userLat=null,userLng=null,mapMarkers=[];
var extraPhotos=[];
var favorites=new Set(JSON.parse(localStorage.getItem("yb_favs")||"[]"));

// Expose boot function for demo mode (called from plain script)
window._moduleBootDemo=function(){
  try{
    // 1. Charger les donn√©es d√©mo
    items=_demoItems.map(function(i){return Object.assign({},i);});
    me={uid:"demo-user-001",email:"demo@youbiiiz.app",emailVerified:true,isDemo:true};

    // 2. Cacher le splash d√©finitivement
    var splash=document.getElementById("splash");
    if(splash){splash.style.display="none";splash.style.pointerEvents="none";splash.style.visibility="hidden";}

    // 3. Montrer l'app
    var app=document.getElementById("app");
    app.classList.remove("hidden");
    app.classList.remove("opacity-0");
    app.style.opacity="1";
    app.style.pointerEvents="auto";

    // 4. Remplir le feed
    try{applyFilters();}catch(e){console.error("applyFilters",e);}

    // 5. UI sidebar/header
    var suid=document.getElementById("sidebar-uid");
    if(suid) suid.innerText="demo@youbiiiz.app";
    var badge=document.getElementById("user-badge");
    if(badge) badge.innerText="D√âMO";

    // 6. Notifs d√©mo
    try{initNotifsDemo();}catch(e){}

    // 7. Banni√®re d√©mo (fine, en haut)
    var existing=document.getElementById("demo-banner");
    if(!existing){
      var b=document.createElement("div");
      b.id="demo-banner";
      b.style.cssText="position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(90deg,#0ea5e9,#6366f1);color:#fff;font-size:11px;font-weight:700;text-align:center;padding:5px 12px;display:flex;align-items:center;justify-content:center;gap:8px";
      b.innerHTML='üéÆ MODE D√âMO ‚Äî <span style="font-weight:500">10 annonces de test ¬∑ Toutes les features actives</span> <button onclick="this.parentElement.remove()" style="background:rgba(255,255,255,.25);border:none;color:#fff;border-radius:99px;padding:0 8px;cursor:pointer;font-size:13px;line-height:20px;margin-left:6px">‚úï</button>';
      document.body.prepend(b);
      // D√©caler le header pour ne pas cacher sous la banni√®re
      var header=document.querySelector(".yb-header");
      if(header) header.style.marginTop="30px";
    }

  }catch(e){
    console.error("Demo boot error:",e);
    // Fallback ultime
    alert("Erreur d√©mo: "+e.message+"\n\nRechargez la page.");
  }
};

function initNotifsDemo(){
  var demoNotifs=[
    {id:"dn1",type:"sale",message:"üéâ Votre iPhone 14 Pro a √©t√© achet√© !",read:false,createdAt:{seconds:Date.now()/1000-1800}},
    {id:"dn2",type:"rating",message:"‚≠ê Vous avez re√ßu une note de 5 √©toiles",read:true,createdAt:{seconds:Date.now()/1000-7200}},
    {id:"dn3",type:"payment_success",message:"‚úÖ Paiement valid√© ‚Äî 430‚Ç¨ re√ßus",read:true,createdAt:{seconds:Date.now()/1000-86400}}
  ];
  var nb=document.getElementById("nbadge");
  if(nb){nb.classList.remove("hidden");nb.innerText="1";}
  var emojis={payment_success:"‚úÖ",payment_initiated:"üí≥",sale:"üéâ",rating:"‚≠ê"};
  var nl=document.getElementById("notif-list");
  if(!nl) return;
  nl.innerHTML=demoNotifs.map(function(n){
    var date=new Date(n.createdAt.seconds*1000).toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"});
    return '<div style="background:#1e293b;border:1px solid rgba(148,163,184,.10);border-radius:16px;padding:14px;margin-bottom:8px;opacity:'+(n.read?.55:1)+'"><div style="display:flex;gap:10px;align-items:flex-start"><span style="font-size:18px">'+(emojis[n.type]||"üîî")+'</span><div style="flex:1"><p style="font-size:13px;font-weight:700;margin-bottom:3px">'+n.message+'</p><p style="font-size:10px;color:#94a3b8">'+date+"</p></div>"+(n.read?"":'<span style="width:7px;height:7px;background:#0ea5e9;border-radius:99px;margin-top:3px;flex-shrink:0;display:block"></span>')+"</div></div>";
  }).join("");
}

window.onerror=(m,s,l)=>{toast("JS:"+m+" L"+l);};
function toast(m,ok){
  var e=document.getElementById("dbg");
  e.style.display="block";
  e.style.background=ok?"#22c55e":"#ef4444";
  e.innerText=m;
  setTimeout(function(){e.style.display="none";},3500);
}

onAuthStateChanged(auth,function(u){
  if(u){
    me=u;
    var badge=document.getElementById("user-badge");
    if(badge) badge.innerText="ID:"+u.uid.slice(0,4);
    var puid=document.getElementById("profile-uid");
    if(puid) puid.innerText=(u.email||"Anonyme")+" ¬∑ "+u.uid.slice(0,8)+"...";
    boot();
  }
  // Sinon: landing page reste visible, l'user doit se connecter
});

// AUTH FUNCTIONS
window.showTab=function(tab){
  document.getElementById("panel-login").style.display=tab==="login"?"block":"none";
  document.getElementById("panel-register").style.display=tab==="register"?"block":"none";
  document.getElementById("tab-login").style.background=tab==="login"?"#fff":"transparent";
  document.getElementById("tab-login").style.color=tab==="login"?"#0f172a":"#94a3b8";
  document.getElementById("tab-login").style.boxShadow=tab==="login"?"0 1px 4px rgba(0,0,0,.1)":"none";
  document.getElementById("tab-register").style.background=tab==="register"?"#fff":"transparent";
  document.getElementById("tab-register").style.color=tab==="register"?"#0f172a":"#94a3b8";
  document.getElementById("tab-register").style.boxShadow=tab==="register"?"0 1px 4px rgba(0,0,0,.1)":"none";
  hideAuthMsg();
};

function showAuthMsg(msg,ok){
  var el=document.getElementById("auth-msg");
  el.style.display="block";
  el.style.background=ok?"#f0fdf4":"#fef2f2";
  el.style.color=ok?"#166534":"#dc2626";
  el.style.border=ok?"1px solid #bbf7d0":"1px solid #fecaca";
  el.innerText=msg;
}
function hideAuthMsg(){document.getElementById("auth-msg").style.display="none";}

window.doLogin=async function(){
  var email=document.getElementById("login-email").value.trim();
  var pass=document.getElementById("login-password").value;
  if(!email||!pass){showAuthMsg("Remplis tous les champs");return;}
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    var msgs={"auth/user-not-found":"Compte introuvable","auth/wrong-password":"Mot de passe incorrect","auth/invalid-email":"Email invalide","auth/invalid-credential":"Email ou mot de passe incorrect"};
    showAuthMsg(msgs[e.code]||"Erreur: "+e.message);
  }
};

window.doRegister=async function(){
  var email=document.getElementById("reg-email").value.trim();
  var pass=document.getElementById("reg-password").value;
  var conf=document.getElementById("reg-confirm").value;
  if(!email||!pass||!conf){showAuthMsg("Remplis tous les champs");return;}
  if(pass.length<6){showAuthMsg("Mot de passe trop court (min. 6 car.)");return;}
  if(pass!==conf){showAuthMsg("Les mots de passe ne correspondent pas");return;}
  try{
    await createUserWithEmailAndPassword(auth,email,pass);
  }catch(e){
    var msgs={"auth/email-already-in-use":"Email d√©j√† utilis√©","auth/invalid-email":"Email invalide","auth/weak-password":"Mot de passe trop faible"};
    showAuthMsg(msgs[e.code]||"Erreur: "+e.message);
  }
};

window.doGoogle=async function(){
  try{
    var provider=new GoogleAuthProvider();
    await signInWithPopup(auth,provider);
  }catch(e){
    if(e.code!=="auth/popup-closed-by-user") showAuthMsg("Erreur Google: "+e.message);
  }
};

window.doAnon=async function(){
  try{
    await signInAnonymously(auth);
  }catch(e){
    // Firebase anon d√©sactiv√© ou erreur r√©seau ‚Üí fallback d√©mo
    enterDemoMode();
  }
};


window.doLogout=async function(){
  if(isDemoMode){
    isDemoMode=false;me=null;items=[];
    document.getElementById("app").classList.add("hidden");
    document.getElementById("app").style.opacity="0";
    document.getElementById("splash").style.display="flex";
    return;
  }
  try{
    await signOut(auth);
    document.getElementById("app").classList.add("hidden");
    document.getElementById("app").style.opacity="0";
    document.getElementById("splash").style.display="flex";
    me=null;
  }catch(e){toast("Erreur: "+e.message);}
};

function boot(){
  document.getElementById("splash").style.display="none";
  document.getElementById("app").classList.remove("hidden");
  setTimeout(function(){document.getElementById("app").style.opacity="1";},80);
  // Set sidebar greeting
  var suid=document.getElementById("sidebar-uid");
  if(suid&&me) suid.innerText=(me.email||"Anonyme");
  initFeed();
  initNotifs();
  checkPayReturn();
  initPush();
}

async function initPush(){
  // Firebase Messaging d√©sactiv√© (service worker non disponible en dev)
  // Les notifications push sont g√©r√©es via showPushBanner() en fallback
}

function showPushBanner(title,body){
  var el=document.createElement("div");
  el.style.cssText="position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9000;background:#1e293b;border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:12px 16px;max-width:320px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5);display:flex;align-items:center;gap:12px;animation:su .3s cubic-bezier(.16,1,.3,1)";
  el.innerHTML='<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22d3ee,#3b82f6);flex-shrink:0;display:flex;align-items:center;justify-content:center"><i class="fa-solid fa-bell" style="color:#000;font-size:14px"></i></div><div style="flex:1;min-width:0"><p style="font-size:13px;font-weight:700;margin:0 0 2px">'+title+'</p><p style="font-size:11px;color:#94a3b8;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+body+'</p></div><button onclick="this.parentElement.remove()" style="background:none;border:none;color:#94a3b8;cursor:pointer;padding:4px;font-size:14px">x</button>';
  document.body.appendChild(el);
  setTimeout(function(){if(el.parentElement)el.remove();},5000);
}

function initFeed(){
  if(isDemoMode){applyFilters();updateProfile();return;}
  var prevIds=new Set();
  onSnapshot(collection(db,"scans"),function(snap){
    var newItems=[];
    items=[];
    snap.forEach(function(d){
      var item=Object.assign({id:d.id},d.data());
      items.push(item);
      if(!prevIds.has(d.id)) newItems.push(item);
      prevIds.add(d.id);
    });
    items.sort(function(a,b){return(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0);});
    applyFilters();
    updateProfile();
    if(newItems.length&&prevIds.size>newItems.length) checkAlertsOnNewItems(newItems);
  },function(e){toast("Feed:"+e.message);});
}

function card(i){
  var cond=i.condition?'<span style="position:absolute;top:7px;left:7px;background:#0f172a;color:#fff;font-size:9px;font-weight:700;padding:2px 8px;border-radius:99px">'+i.condition+"</span>":"";
  var isFav=favorites.has(i.id);
  var heart='<button class="heart-btn'+(isFav?' fav':'')+'" onclick="event.stopPropagation();toggleFav(\''+i.id+'\',this)">'+(isFav?'‚ù§Ô∏è':'ü§ç')+'</button>';
  var views=i.views?'<div class="views-badge"><i class="fa-solid fa-eye" style="font-size:7px"></i>'+i.views+'</div>':"";
  var troc=i.troc?'<div style="position:absolute;bottom:7px;right:7px;background:#fef3c7;color:#92400e;font-size:8px;font-weight:800;padding:2px 6px;border-radius:99px;border:1px solid #fde68a">üîÑ</div>':"";
  var city=i.city?'<p style="font-size:10px;color:#94a3b8;margin-top:4px"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;font-size:8px;margin-right:2px"></i>'+i.city+"</p>":"";
  return '<div class="card fi" onclick="openDetail(\''+i.id+'\')"><div class="sq"><img src="'+(i.imageUrl||"")+'" loading="lazy">'+cond+heart+views+troc+'</div><div class="inf"><p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;color:#1e293b">'+(i.itemName||"Objet")+'</p><p style="font-size:16px;font-weight:900;color:#0ea5e9">'+(i.price||0)+"‚Ç¨</p>"+city+"</div></div>";
}

function renderFeed(list){
  var el=document.getElementById("feed");
  if(!list.length){el.innerHTML='<div style="grid-column:1/-1;padding:56px 0;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase">Aucune annonce</div>';return;}
  el.innerHTML=list.map(card).join("");
}

window.applyFilters=function(){
  var cat=activeCat;
  var city=(document.getElementById("city-inp").value||"").toLowerCase().trim();
  var raw=(document.getElementById("header-search").value||"").toLowerCase().trim();

  // Natural language parsing
  var q=raw;
  var nlMaxPrice=null,nlMinPrice=null,nlCity=null,nlCond=null;
  // Price patterns: "moins de 300‚Ç¨", "max 300", "300‚Ç¨ max", "300 euros", "sous 400"
  var maxMatch=raw.match(/(?:moins de|max\.?\s*|sous|under|<)\s*(\d+)\s*[‚Ç¨e]?/i)||raw.match(/(\d+)\s*[‚Ç¨e]\s*(?:max|maxi)/i);
  if(maxMatch) nlMaxPrice=parseFloat(maxMatch[1]);
  var minMatch=raw.match(/(?:min\.?\s*|plus de|√† partir de|>)\s*(\d+)\s*[‚Ç¨e]?/i)||raw.match(/(\d+)\s*[‚Ç¨e]\s*(?:min|mini)/i);
  if(minMatch) nlMinPrice=parseFloat(minMatch[1]);
  // Remove price patterns from query
  q=q.replace(/(?:moins de|max\.?|sous|plus de|√† partir de|min\.?)\s*\d+\s*[‚Ç¨euros]*/gi,"").replace(/\d+\s*[‚Ç¨e](?:\s*(?:max|maxi|min|mini))?/gi,"").trim();
  // Condition keywords
  if(/\bneuf\b/.test(q)) nlCond="neuf";
  else if(/\bbon √©tat\b|bon etat/.test(q)) nlCond="bon";
  else if(/\btr√®s bon\b|tres bon\b|tb√©\b|tbe\b/.test(q)) nlCond="tres";
  q=q.replace(/\b(neuf|bon √©tat|bon etat|tr√®s bon √©tat|tres bon √©tat|tb√©|tbe)\b/gi,"").trim();

  var list=items;
  if(cat!=="all") list=list.filter(function(i){return(i.category||"").toLowerCase().indexOf(cat.toLowerCase())>=0;});
  if(city) list=list.filter(function(i){return(i.city||"").toLowerCase().indexOf(city)>=0;});
  // NL city (from search query - look for known city patterns)
  if(nlCity) list=list.filter(function(i){return(i.city||"").toLowerCase().indexOf(nlCity)>=0;});
  if(nlMaxPrice!==null) list=list.filter(function(i){return(parseFloat(i.price)||0)<=nlMaxPrice;});
  if(nlMinPrice!==null) list=list.filter(function(i){return(parseFloat(i.price)||0)>=nlMinPrice;});
  if(nlCond) list=list.filter(function(i){return(i.condition||"").toLowerCase().indexOf(nlCond)>=0;});
  if(q) list=list.filter(function(i){return(i.itemName||"").toLowerCase().indexOf(q)>=0||(i.description||"").toLowerCase().indexOf(q)>=0||(i.city||"").toLowerCase().indexOf(q)>=0;});
  renderFeed(list);
};

window.filterCat=function(cat,btn){
  activeCat=cat;
  document.querySelectorAll(".cat-pill").forEach(function(b){b.classList.remove("on");});
  if(btn) btn.classList.add("on");
  applyFilters();
  // Update section title
  var titles={"all":"Pour toi","High-Tech":"High-Tech","Jeux video":"Jeux vid√©o","Informatique":"Informatique","Mode":"Mode","Maison":"Maison","Sport":"Sport","Divers":"Divers"};
  var t=document.getElementById("feed-section-title");
  if(t) t.innerText=titles[cat]||cat;
};

window.toggleGroup=function(id){
  var list=document.getElementById(id);
  var arrow=document.getElementById("arrow-"+id);
  if(!list) return;
  var isHidden=list.classList.contains("hidden");
  list.classList.toggle("hidden");
  if(arrow) arrow.classList.toggle("open",isHidden);
};

window.filterCatSidebar=function(cat,el){
  activeCat=cat;
  // Clear all active states
  document.querySelectorAll(".sidebar-nav-item,.sb-subitem").forEach(function(b){b.classList.remove("active");});
  el.classList.add("active");
  applyFilters();
  var t=document.getElementById("feed-section-title");
  if(t) t.innerText=cat==="all"?"Pour toi":cat;
  switchView("home");
};

window.setSidebarActive=function(id){
  ["snav-home","snav-map","snav-notif","snav-profile"].forEach(function(n){
    var el=document.getElementById(n);
    if(el) el.classList.remove("active");
  });
  var el=document.getElementById(id);
  if(el) el.classList.add("active");
};

window.switchView=function(v){
  ["home","map","notifications","profile"].forEach(function(n){
    var el=document.getElementById("view-"+n);
    if(el){
      if(n==="map"){
        el.style.display=n===v?"block":"none";
      }else{
        el.classList[n===v?"remove":"add"]("hidden");
      }
    }
  });
  document.getElementById("main-scroll").style.overflowY=v==="map"?"hidden":"auto";
  ["home","map","notif","profile"].forEach(function(n){
    var el=document.getElementById("nav-"+n);
    if(el){
      var icon=el.querySelector("i");
      if(icon) icon.style.color=v===n||("notifications"===v&&n==="notif")?"#0ea5e9":"#94a3b8";
    }
  });
  if(v==="map"){
    if(!userLat) askGeo();
    setTimeout(function(){
      initMap();
      renderMapMarkers();
      if(map) map.invalidateSize();
    },250);
  }
  if(v==="notifications"&&me&&!isDemoMode){
    getDocs(query(collection(db,"notifications"),where("userId","==",me.uid),where("read","==",false))).then(function(s){
      s.forEach(function(d){updateDoc(doc(db,"notifications",d.id),{read:true});});
    });
  }
  if(v==="notifications"&&isDemoMode) initNotifsDemo();
  if(v==="profile") loadMyRating();
};

function updateProfile(){
  if(!me) return;
  var mine=items.filter(function(i){return i.userId===me.uid;});
  document.getElementById("profile-count").innerText=mine.length;
  var totalVal=mine.reduce(function(s,i){return s+(parseFloat(i.price)||0);},0);
  document.getElementById("profile-total").innerText=totalVal+"‚Ç¨";
  var totalViews=mine.reduce(function(s,i){return s+(i.views||0);},0);
  document.getElementById("profile-views").innerText=totalViews;
  // Favorites received = items of mine that are in others' favs (proxy: count favs in localStorage that match mine)
  document.getElementById("profile-favs").innerText=mine.length*2; // simulated
  // Verified badge
  var verBadge=document.getElementById("profile-verified");
  if(me.emailVerified&&verBadge) verBadge.classList.remove("hidden");
  var el=document.getElementById("my-listings");
  el.innerHTML=mine.length?mine.map(myCard).join(""):'<p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:32px 0">Aucune annonce</p>';
  renderAlerts();
  renderFavs();
}

// SCAN
window.openScan=function(){
  var m=document.getElementById("scan-modal");
  m.classList.remove("hidden");
  m.classList.add("flex");
};
window.closeScan=function(){
  stopCam();resetScan();
  var m=document.getElementById("scan-modal");
  m.classList.remove("flex");
  m.classList.add("hidden");
};
window.resetScan=function(){
  stopCam();scanData=null;
  document.getElementById("scan-prev").classList.add("hidden");
  document.getElementById("scan-prev").src="";
  document.getElementById("scan-ph").classList.remove("hidden");
  document.getElementById("scan-spin").classList.add("hidden");
  document.getElementById("scan-line").classList.add("hidden");
  document.getElementById("photo-btns").classList.remove("hidden");
  document.getElementById("snap-btn").classList.add("hidden");
  document.getElementById("cam-toggle").classList.remove("hidden");
  document.getElementById("step-photo").classList.remove("hidden");
  document.getElementById("step-result").classList.add("hidden");
  document.getElementById("step-result").classList.remove("flex");
  document.getElementById("pub-btn").innerText="Publier l'annonce";
  document.getElementById("pub-btn").disabled=false;
  document.getElementById("file-input").value="";
  var ps=document.getElementById("price-suggestion");
  if(ps) ps.classList.add("hidden");
  var st=document.getElementById("scan-troc");
  if(st) st.checked=false;
  extraPhotos=[];renderExtraPhotos();
  ["sh-hand","sh-relay","sh-colis"].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.checked=false;
  });
};
window.toggleCam=async function(){
  if(camStream){stopCam();return;}
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1080},height:{ideal:1080}},audio:false});
    var v=document.getElementById("cam-vid");
    v.srcObject=camStream;v.classList.remove("hidden");
    document.getElementById("scan-ph").classList.add("hidden");
    document.getElementById("cam-toggle").classList.add("hidden");
    document.getElementById("snap-btn").classList.remove("hidden");
  }catch(e){document.getElementById("file-input").click();}
};
function stopCam(){
  if(camStream){camStream.getTracks().forEach(function(t){t.stop();});camStream=null;}
  var v=document.getElementById("cam-vid");
  v.srcObject=null;v.classList.add("hidden");
}
window.snapPhoto=function(){
  var v=document.getElementById("cam-vid"),c=document.getElementById("cap-canvas");
  c.width=v.videoWidth;c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);
  stopCam();
  document.getElementById("snap-btn").classList.add("hidden");
  processImg(c.toDataURL("image/jpeg",1.0));
};
window.onFile=function(e){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){processImg(ev.target.result);};
  r.readAsDataURL(f);
};
function processImg(raw){
  document.getElementById("scan-ph").classList.add("hidden");
  document.getElementById("photo-btns").classList.add("hidden");
  document.getElementById("scan-spin").classList.remove("hidden");
  cropImage(raw).then(function(opt){
    document.getElementById("scan-prev").src=opt;
    document.getElementById("scan-prev").classList.remove("hidden");
    document.getElementById("scan-line").classList.remove("hidden");
    callGemini(opt);
  });
}
function cropImage(b64){
  return new Promise(function(resolve){
    var img=new Image();
    img.onload=function(){
      var w=img.naturalWidth||img.width;
      var h=img.naturalHeight||img.height;
      if(!w||!h){resolve(b64);return;}
      // Calcul pour tenir l'image entiere dans 400x400 avec padding
      var scale=Math.min(400/w,400/h);
      var dw=Math.round(w*scale);
      var dh=Math.round(h*scale);
      var dx=Math.round((400-dw)/2);
      var dy=Math.round((400-dh)/2);
      var c=document.createElement("canvas");
      c.width=400;c.height=400;
      var ctx=c.getContext("2d");
      ctx.fillStyle="#f5f5f5";
      ctx.fillRect(0,0,400,400);
      ctx.drawImage(img,0,0,w,h,dx,dy,dw,dh);
      resolve(c.toDataURL("image/jpeg",0.82));
    };
    img.onerror=function(){resolve(b64);};
    img.src=b64;
  });
}
async function callGemini(b64){
  try{
    var mime=b64.indexOf("data:image/png")===0?"image/png":"image/jpeg";
    var r=await fetch("https://analyzeimage-xjtnixfrra-uc.a.run.app",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({imageBase64:b64.split(",")[1],mimeType:mime})
    });
    var d=await r.json();
    if(d.error){toast("IA:"+d.error);resetScan();return;}
    showResult(d,b64);
  }catch(e){toast("IA:"+e.message);resetScan();}
}
function showResult(d,img){
  document.getElementById("scan-spin").classList.add("hidden");
  document.getElementById("scan-line").classList.add("hidden");
  document.getElementById("res-thumb").src=img;
  document.getElementById("ai-name").value=d.title||"";
  document.getElementById("ai-price").innerText=(d.price||0)+"‚Ç¨";
  // Set the category select - find closest match
  var catSel=document.getElementById("ai-cat-select");
  if(catSel&&d.category){
    var opts=Array.from(catSel.options);
    var match=opts.find(function(o){return o.value.toLowerCase().indexOf((d.category||"").toLowerCase())>=0||(d.category||"").toLowerCase().indexOf(o.value.toLowerCase())>=0;});
    if(match) catSel.value=match.value;
  }
  document.getElementById("ai-desc").value=d.description||"";
  document.getElementById("ai-cond").innerText=d.condition||"";
  document.getElementById("ai-brand").innerText=d.brand||"-";
  document.getElementById("ai-model").innerText=d.model||"-";
  scanData={itemName:d.title,price:d.price,category:d.category,condition:d.condition||"Bon etat",description:d.description||"",brand:d.brand||"",model:d.model||"",imageUrl:img,shipping:[]};
  // Price suggestion based on category
  var range=getPriceRange(d.category||"",null,d.price);
  if(range){
    var ps=document.getElementById("price-suggestion");
    ps.classList.remove("hidden");
    document.getElementById("price-range-txt").innerText=range.min+"‚Ç¨ ‚Äì "+range.max+"‚Ç¨";
    var verdict=document.getElementById("price-verdict");
    var p=parseFloat(d.price)||0;
    if(p<range.min*0.7){verdict.innerText="‚¨á Prix bas";verdict.style.background="#dcfce7";verdict.style.color="#166534";}
    else if(p>range.max*1.2){verdict.innerText="‚¨Ü Prix √©lev√©";verdict.style.background="#fef3c7";verdict.style.color="#92400e";}
    else{verdict.innerText="‚úì Prix juste";verdict.style.background="#eff9ff";verdict.style.color="#0369a1";}
  }
  document.getElementById("step-photo").classList.add("hidden");
  document.getElementById("step-result").classList.remove("hidden");
  document.getElementById("step-result").classList.add("flex");
}
window.updShip=function(){
  if(!scanData) return;
  var o=[];
  if(document.getElementById("sh-hand").checked) o.push({method:"Main propre",price:0});
  if(document.getElementById("sh-relay").checked) o.push({method:"Mondial Relay",price:parseFloat(document.getElementById("sh-relay-p").value)||5});
  if(document.getElementById("sh-colis").checked) o.push({method:"Colissimo",price:parseFloat(document.getElementById("sh-colis-p").value)||8});
  scanData.shipping=o;
};
document.getElementById("pub-btn").addEventListener("click",async function(){
  if(!scanData||!me) return;
  updShip();
  var btn=document.getElementById("pub-btn");
  btn.innerText="Publication...";btn.disabled=true;
  try{
    var city=document.getElementById("item-city").value.trim();
    var newItem={
      userId:me.uid,
      itemName:document.getElementById("ai-name").value,
      price:scanData.price,
      category:document.getElementById("ai-cat-select").value||scanData.category,
      condition:scanData.condition,
      description:document.getElementById("ai-desc").value,
      brand:scanData.brand,
      model:scanData.model,
      shipping:scanData.shipping,
      troc:document.getElementById("scan-troc").checked||false,
      extraPhotos:extraPhotos.length?extraPhotos:[],
      city:city,
      imageUrl:scanData.imageUrl,
      views:0,
      createdAt:{seconds:Date.now()/1000}
    };
    if(isDemoMode){
      // Demo: ajouter localement
      newItem.id="demo-new-"+Date.now();
      items.unshift(newItem);
      addCoins(Math.round((newItem.price||0)*0.05),"Annonce publi√©e üéâ");
    }else{
      var coords=city?await geocodeAndSave(city):null;
      newItem.lat=coords?coords.lat:null;
      newItem.lng=coords?coords.lng:null;
      newItem.createdAt=serverTimestamp();
      await addDoc(collection(db,"scans"),newItem);
    }
    closeScan();
    switchView("home");
    applyFilters();
    toast("Annonce publi√©e ! üéâ",true);
  }catch(e){
    toast("Erreur:"+e.message);
    btn.innerText="Publier l'annonce";
    btn.disabled=false;
  }
});

// DETAIL
window.openDetail=function(id){
  var i=items.find(function(x){return x.id===id;});
  if(!i) return;
  curItem=i;
  // det-img kept for legacy compatibility, carousel will override
  var legacyImg=document.getElementById("det-img");
  if(legacyImg) legacyImg.src=i.imageUrl||"";
  document.getElementById("det-title").innerText=i.itemName||"";
  document.getElementById("det-price").innerText=(i.price||0)+"‚Ç¨";
  document.getElementById("det-cat").innerText=i.category||"";
  document.getElementById("det-cond").innerText=i.condition||"";
  document.getElementById("det-desc").innerText=i.description||"Aucune description.";
  document.getElementById("det-seller").innerText="Vendeur #"+(i.userId||"").slice(0,6);
  document.getElementById("det-brand").innerText=[i.brand,i.model].filter(Boolean).join(" - ");
  var ct=document.getElementById("det-city-tag");
  if(i.city){document.getElementById("det-city-val").innerText=i.city;ct.classList.remove("hidden");}
  else{ct.classList.add("hidden");}
  // Troc badge
  var trocTag=document.getElementById("det-troc-tag");
  i.troc?trocTag.classList.remove("hidden"):trocTag.classList.add("hidden");
  // Shipping
  var sh=document.getElementById("det-ship");
  if(i.shipping&&i.shipping.length){
    sh.innerHTML=i.shipping.map(function(s){
      return '<span style="background:#1e3a5f;border:1px solid rgba(148,163,184,.10);border-radius:10px;padding:5px 10px;font-size:11px;font-weight:700">'+s.method+' <span style="color:#0ea5e9">'+(s.price===0?"Gratuit":s.price+"‚Ç¨")+"</span></span>";
    }).join("");
  }else{
    sh.innerHTML='<span style="font-size:12px;color:#94a3b8">Non renseign√©</span>';
  }
  // Fav state
  var favIcon=document.getElementById("det-fav-icon");
  if(favorites.has(i.id)){favIcon.className="fa-solid fa-heart text-sm text-rose-400";}
  else{favIcon.className="fa-regular fa-heart text-sm text-slate-400";}
  // Views counter
  var viewCount=(i.views||0)+1;
  if(me&&i.userId!==me.uid&&!isDemoMode){
    updateDoc(doc(db,"scans",i.id),{views:viewCount}).catch(function(){});
  }
  var vb=document.getElementById("det-views-badge");
  if(viewCount>0){vb.classList.remove("hidden");document.getElementById("det-views-count").innerText=viewCount;}
  else{vb.classList.add("hidden");}
  // Price range comparison
  var range=getPriceRange(i.category,i.id);
  var prDiv=document.getElementById("det-price-range");
  if(range){
    prDiv.classList.remove("hidden");
    prDiv.innerHTML='<div style="display:flex;align-items:center;gap:6px;font-size:10px;color:#64748b"><i class="fa-solid fa-chart-bar" style="color:#8b5cf6;font-size:9px"></i>Similaires sur Youbiiiz : <strong style="color:#8b5cf6">'+range.min+'‚Ç¨ ‚Äì '+range.max+'‚Ç¨</strong></div>';
  }else{prDiv.classList.add("hidden");}
  // Trust score
  computeAndShowTrust(i);
  // Fraud detection
  detectFraud(i);
  // Verified seller
  var verBadge=document.getElementById("det-verified");
  if(i.userId&&me&&i.userId===me.uid&&me.emailVerified){verBadge.classList.remove("hidden");}
  else{verBadge.classList.add("hidden");}
  document.getElementById("contact-btn").onclick=function(){openChat(i);};
  document.getElementById("buy-btn").onclick=function(){openPay(i);};
  loadSellerRating(i.userId);
  var m=document.getElementById("detail-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeDetail=function(){
  var m=document.getElementById("detail-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};

// CHAT
window.openChat=function(i){
  curItem=i;
  document.getElementById("chat-seller").innerText="Vendeur #"+(i.userId||"").slice(0,6);
  document.getElementById("chat-iname").innerText=i.itemName||"";
  document.getElementById("chat-iprice").innerText=(i.price||0)+"‚Ç¨";
  document.getElementById("chat-img").src=i.imageUrl||"";
  document.getElementById("chat-msgs").innerHTML='<div style="text-align:center;padding:16px 0"><span style="font-size:10px;color:#94a3b8;background:#1e3a5f;padding:4px 12px;border-radius:99px;font-weight:700;text-transform:uppercase">D√©but de conversation</span></div>';
  renderChatSuggestions(i,"start");
  var m=document.getElementById("chat-modal");
  m.classList.remove("hidden");m.classList.add("flex");
  closeDetail();
};
window.closeChat=function(){
  var m=document.getElementById("chat-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.sendMsg=function(){
  var inp=document.getElementById("chat-inp"),t=inp.value.trim();if(!t)return;
  addBubble(t,true);inp.value="";
  var i=curItem||{};
  var price=i.price||0;
  var name=i.itemName||"cet article";
  var t_low=t.toLowerCase();
  var rep="";
  // Context-aware AI responses
  if(/dispo|disponible/.test(t_low)) rep="Oui, "+name+" est toujours disponible ! üëç";
  else if(/prix|combien|dernier/.test(t_low)) rep="Le prix est "+price+"‚Ç¨, je peux faire "+Math.round(price*0.93)+"‚Ç¨ si vous achetez rapidement.";
  else if(/livraison|envoyer|expedition/.test(t_low)){
    var ships=i.shipping&&i.shipping.length?i.shipping.map(function(s){return s.method+(s.price?(" "+s.price+"‚Ç¨"):" gratuit");}).join(", "):"remise en main propre";
    rep="Livraison disponible : "+ships+" üì¶";
  }
  else if(/photo|image|voir/.test(t_low)) rep="Je peux vous envoyer d'autres photos, l'article est en parfait √©tat comme montr√© üì∏";
  else if(/n√©gocier|n√©go|baisser|r√©duire/.test(t_low)) rep="Je peux aller jusqu'√† "+Math.round(price*0.9)+"‚Ç¨, c'est mon dernier prix ü§ù";
  else if(/√©tat|condition|defaut|d√©faut|usure/.test(t_low)) rep="L'article est en "+(i.condition||"bon √©tat")+", aucun d√©faut visible. Tout fonctionne parfaitement ‚úÖ";
  else if(/troc|√©change|echanger/.test(t_low)) rep=i.troc?"Oui je suis ouvert √† l'√©change, qu'est-ce que vous proposez ?":"Je pr√©f√®re une vente directe, d√©sol√©.";
  else if(/merci|super|ok|parfait|accord/.test(t_low)) rep="Parfait ! N'h√©sitez pas si vous avez d'autres questions üòä";
  else{
    var generic=["D'accord, je vous confirme √ßa rapidement !","Pas de probl√®me, article toujours disponible.","C'est vendu avec "+price+"‚Ç¨ - je peux pr√©voir un remise en main propre aussi.","Je peux envoyer plus de photos si besoin.","Article en excellent √©tat, vendu uniquement par particulier."];
    rep=generic[Math.floor(Math.random()*generic.length)];
  }
  setTimeout(function(){
    addBubble(rep,false);
    renderChatSuggestions(curItem,"reply");
  },800+Math.random()*600);
};
window.qMsg=function(m){document.getElementById("chat-inp").value=m;sendMsg();};
function addBubble(t,mine){
  var el=document.getElementById("chat-msgs");
  var d=document.createElement("div");
  d.className="flex "+(mine?"justify-end":"justify-start");
  d.innerHTML='<div class="max-w-[72%] px-4 py-2 text-sm font-medium '+(mine?"bme":"bthem")+'">'+t+"</div>";
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}

// PAIEMENT
window.openPay=function(i){
  payItem=i;selShip=null;
  document.getElementById("pay-img").style.backgroundImage="url("+i.imageUrl+")";
  document.getElementById("pay-title").innerText=i.itemName;
  document.getElementById("pay-price").innerText=i.price+"euro";
  document.getElementById("pay-sub").innerText=i.price+"euro";
  document.getElementById("pay-shipcost").innerText="-";
  document.getElementById("pay-total").innerText=i.price+"euro";
  var wrap=document.getElementById("pay-ship-wrap"),list=document.getElementById("pay-ship-list");
  if(i.shipping&&i.shipping.length){
    wrap.classList.remove("hidden");
    list.innerHTML=i.shipping.map(function(s,idx){
      return '<label style="display:flex;align-items:center;gap:10px;background:#1e3a5f;border:1px solid rgba(148,163,184,.10);border-radius:12px;padding:10px 12px;cursor:pointer"><input type="radio" name="ship" value="'+idx+'" onchange="selShipping('+idx+')" style="accent-color:#0ea5e9"><span style="font-size:13px;font-weight:600;flex:1">'+s.method+'</span><span style="font-size:13px;font-weight:800;color:#0ea5e9">'+(s.price===0?"Gratuit":s.price+"euro")+"</span></label>";
    }).join("");
  }else{wrap.classList.add("hidden");}
  var m=document.getElementById("pay-modal");
  m.classList.remove("hidden");m.classList.add("flex");
  closeDetail();
};
window.selShipping=function(idx){
  selShip=payItem.shipping[idx];
  var tot=(parseFloat(payItem.price)||0)+selShip.price;
  document.getElementById("pay-shipcost").innerText=selShip.price===0?"Gratuit":selShip.price+"euro";
  document.getElementById("pay-total").innerText=tot+"euro";
};
window.closePay=function(){
  var m=document.getElementById("pay-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.doStripe=async function(){
  if(!payItem||!me) return;
  if(payItem.shipping&&payItem.shipping.length&&!selShip){toast("Choisissez un mode de livraison");return;}
  if(isDemoMode){
    var btn=document.getElementById("stripe-btn");
    btn.innerHTML='<i class="fa-solid fa-circle-notch animate-spin mr-2"></i>Simulation...';btn.disabled=true;
    setTimeout(function(){
      closePay();
      addCoins(Math.round((payItem.price||0)*0.05),"Achat effectu√© üõç");
      toast("üí≥ Paiement simul√© avec succ√®s ! +"+Math.round((payItem.price||0)*0.05)+" coins ü™ô",true);
      btn.innerHTML='<i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant';btn.disabled=false;
    },1500);
    return;
  }
  btn.innerHTML='<i class="fa-solid fa-circle-notch animate-spin mr-2"></i>Redirection...';btn.disabled=true;
  try{
    var shipCost=selShip?selShip.price:0;
    var tot=(parseFloat(payItem.price)||0)+shipCost;
    var r=await fetch("https://createpayment-xjtnixfrra-uc.a.run.app",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:tot,itemName:payItem.itemName,itemId:payItem.id,buyerId:me.uid,sellerId:payItem.userId})});
    var d=await r.json();
    if(d.error){toast("Stripe:"+d.error);return;}
    await addDoc(collection(db,"notifications"),{userId:payItem.userId,type:"payment_initiated",message:"Paiement pour "+payItem.itemName,itemId:payItem.id,read:false,createdAt:serverTimestamp()});
    window.location.href=d.url;
  }catch(e){toast("Erreur:"+e.message);}
  btn.innerHTML='<i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant';btn.disabled=false;
};
function checkPayReturn(){
  var p=new URLSearchParams(window.location.search);
  if(p.get("payment")!=="success") return;
  history.replaceState({},"","/");
  var iid=p.get("itemId"),sid=p.get("sellerId");
  setTimeout(async function(){
    if(!me) return;
    try{
      await addDoc(collection(db,"notifications"),{userId:me.uid,type:"payment_success",message:"Paiement valide ! Contactez le vendeur.",itemId:iid||"",read:false,createdAt:serverTimestamp()});
      if(sid) await addDoc(collection(db,"notifications"),{userId:sid,type:"sale",message:"Votre article vient d'etre achete !",itemId:iid||"",read:false,createdAt:serverTimestamp()});
      rateCtx={targetUserId:sid,role:"buyer",itemId:iid||""};
      setTimeout(function(){openRate("vendeur");},2000);
    }catch(e){}
  },1500);
}

// NOTIFS
function initNotifs(){
  if(!me) return;
  if(isDemoMode){
    // Demo notifications
    var demoNotifs=[
      {id:"dn1",type:"sale",message:"üéâ Votre iPhone 14 Pro a √©t√© achet√© !",read:false,createdAt:{seconds:Date.now()/1000-1800}},
      {id:"dn2",type:"rating",message:"‚≠ê Vous avez re√ßu une note de 5 √©toiles",read:true,createdAt:{seconds:Date.now()/1000-7200}},
      {id:"dn3",type:"payment_success",message:"‚úÖ Paiement valid√© pour PS5 + Manette",read:true,createdAt:{seconds:Date.now()/1000-86400}}
    ];
    var nb=document.getElementById("nbadge");
    nb.classList.remove("hidden");nb.innerText="1";
    var emojis={payment_success:"‚úÖ",payment_initiated:"üí≥",sale:"üéâ",rating:"‚≠ê"};
    document.getElementById("notif-list").innerHTML=demoNotifs.map(function(n){
      var date=new Date(n.createdAt.seconds*1000).toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"});
      return '<div style="background:#1e293b;border:1px solid rgba(148,163,184,.10);border-radius:16px;padding:14px;margin-bottom:8px;cursor:pointer;opacity:'+(n.read?".5":"1")+'"><div style="display:flex;gap:10px;align-items:flex-start"><span style="font-size:18px">'+(emojis[n.type]||"üîî")+'</span><div style="flex:1"><p style="font-size:13px;font-weight:700;margin-bottom:3px">'+n.message+'</p><p style="font-size:10px;color:#94a3b8">'+date+"</p></div>"+(n.read?"":'<span style="width:7px;height:7px;background:#0ea5e9;border-radius:99px;margin-top:3px;flex-shrink:0;display:block"></span>')+"</div></div>";
    }).join("");
    return;
  }
  var q=query(collection(db,"notifications"),where("userId","==",me.uid));
  onSnapshot(q,function(snap){
    var list=[];
    snap.forEach(function(d){list.push(Object.assign({id:d.id},d.data()));});
    list.sort(function(a,b){return(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0);});
    var unread=list.filter(function(n){return !n.read;}).length;
    var b=document.getElementById("nbadge");
    b.classList.toggle("hidden",unread===0);
    if(unread) b.innerText=unread;
    var emojis={payment_success:"‚úÖ",payment_initiated:"üí≥",sale:"üéâ",rating:"‚≠ê"};
    document.getElementById("notif-list").innerHTML=list.length?list.map(function(n){
      var date=n.createdAt?new Date(n.createdAt.seconds*1000).toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):"";
      return '<div onclick="markRead(\''+n.id+'\')" style="background:#1e293b;border:1px solid rgba(148,163,184,.10);border-radius:16px;padding:14px;margin-bottom:8px;cursor:pointer;opacity:'+(n.read?".5":"1")+'"><div style="display:flex;gap:10px;align-items:flex-start"><span style="font-size:18px">'+(emojis[n.type]||"bell")+'</span><div style="flex:1"><p style="font-size:13px;font-weight:700;margin-bottom:3px">'+n.message+'</p><p style="font-size:10px;color:#94a3b8">'+date+"</p></div>"+(n.read?"":'<span style="width:7px;height:7px;background:#0ea5e9;border-radius:99px;margin-top:3px;flex-shrink:0;display:block"></span>')+"</div></div>";
    }).join(""):'<p style="text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>';
  });
}
window.markRead=async function(id){if(isDemoMode)return;await updateDoc(doc(db,"notifications",id),{read:true});};

// NOTATION
window.openRate=function(role){
  curStar=0;
  document.querySelectorAll(".star").forEach(function(s){s.style.color="#3f3f46";s.style.transform="scale(1)";});
  document.getElementById("rate-comment").value="";
  document.getElementById("rate-sub").innerText=role==="buyer"?"Comment s'est comporte l'acheteur ?":"Comment etait le vendeur ?";
  var m=document.getElementById("rate-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeRate=function(){
  var m=document.getElementById("rate-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.setStar=function(v){
  curStar=v;
  document.querySelectorAll(".star").forEach(function(s){
    var sv=parseInt(s.dataset.v);
    s.style.color=sv<=v?"#facc15":"#3f3f46";
    s.style.transform=sv<=v?"scale(1.15)":"scale(1)";
  });
};
window.submitRate=async function(){
  if(!curStar){toast("Choisissez une note");return;}
  if(isDemoMode){closeRate();toast("Note de "+curStar+"‚òÖ envoy√©e ! üôè",true);return;}
  if(!rateCtx) return;
  try{
    await addDoc(collection(db,"ratings"),{targetUserId:rateCtx.targetUserId,fromUserId:me.uid,itemId:rateCtx.itemId,rating:curStar,comment:document.getElementById("rate-comment").value,createdAt:serverTimestamp()});
    await updUserRating(rateCtx.targetUserId);
    await addDoc(collection(db,"notifications"),{userId:rateCtx.targetUserId,type:"rating",message:"Vous avez recu une note de "+curStar+"etoiles",read:false,createdAt:serverTimestamp()});
    closeRate();toast("Note envoyee !",true);
  }catch(e){toast("Erreur:"+e.message);}
};
async function updUserRating(uid){
  try{
    var s=await getDocs(query(collection(db,"ratings"),where("targetUserId","==",uid)));
    var r=[];s.forEach(function(d){r.push(d.data().rating);});
    if(!r.length) return;
    var avg=(r.reduce(function(a,b){return a+b;},0)/r.length).toFixed(1);
    await updateDoc(doc(db,"users",uid),{rating:parseFloat(avg),ratingCount:r.length});
  }catch(e){}
}
async function loadSellerRating(uid){
  var el=document.getElementById("det-rating");
  if(isDemoMode){if(el)el.innerText="‚òÖ4.8 / 5 (12 avis)";return;}
  try{
    var d=await getDoc(doc(db,"users",uid));
    if(d.exists()&&d.data().rating){
      var r=d.data().rating,n=d.data().ratingCount||0;
      var stars="";
      for(var k=1;k<=5;k++) stars+=k<=Math.round(r)?"‚òÖ":"‚òÜ";
      el.innerText=stars+" "+r+"/5 ("+n+" avis)";
    }else{el.innerText="Nouveau vendeur";}
  }catch(e){}
}
async function loadMyRating(){
  if(!me) return;
  if(isDemoMode){var el=document.getElementById("profile-rating");if(el)el.innerText="‚òÖ4.8";return;}
  try{
    var d=await getDoc(doc(db,"users",me.uid));
    if(d.exists()&&d.data().rating) document.getElementById("profile-rating").innerText="‚òÖ"+d.data().rating;
  }catch(e){}
}

// EDIT / DELETE
window.openEdit=function(id){
  var i=items.find(function(x){return x.id===id;});if(!i)return;
  editingId=id;
  document.getElementById("edit-title").value=i.itemName||"";
  document.getElementById("edit-price").value=i.price||0;
  document.getElementById("edit-desc").value=i.description||"";
  document.getElementById("edit-cond").value=i.condition||"Bon etat";
  document.getElementById("edit-cat").value=i.category||"Divers";
  var m=document.getElementById("edit-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeEdit=function(){
  var m=document.getElementById("edit-modal");
  m.classList.add("hidden");m.classList.remove("flex");
  editingId=null;
};
window.saveEdit=async function(){
  if(!editingId) return;
  var btn=document.getElementById("edit-save");btn.innerText="Sauvegarde...";btn.disabled=true;
  var updates={
    itemName:document.getElementById("edit-title").value,
    price:parseFloat(document.getElementById("edit-price").value)||0,
    description:document.getElementById("edit-desc").value,
    condition:document.getElementById("edit-cond").value,
    category:document.getElementById("edit-cat").value
  };
  if(isDemoMode){
    var idx=items.findIndex(function(i){return i.id===editingId;});
    if(idx>=0) Object.assign(items[idx],updates);
    applyFilters();closeEdit();toast("Modifi√© !",true);
  }else{
    try{
      await updateDoc(doc(db,"scans",editingId),updates);
      closeEdit();
    }catch(e){toast("Erreur:"+e.message);}
  }
  btn.innerText="Sauvegarder";btn.disabled=false;
};
window.confirmDel=function(id){
  deletingId=id;closeEdit();
  var m=document.getElementById("del-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeDel=function(){
  var m=document.getElementById("del-modal");
  m.classList.add("hidden");m.classList.remove("flex");
  deletingId=null;
};
window.doDelete=async function(){
  if(!deletingId) return;
  if(isDemoMode){
    items=items.filter(function(i){return i.id!==deletingId;});
    applyFilters();closeDel();toast("Supprim√©",true);return;
  }
  try{await deleteDoc(doc(db,"scans",deletingId));closeDel();}
  catch(e){toast("Erreur:"+e.message);}
};

// CARTE
var clusterGroup=null,userMarker=null,activeRadius=5;

function initMap(){
  if(map) return;
  var lat=userLat||46.2276,lng=userLng||2.2137,zoom=userLat?13:6;
  map=L.map("map-el",{zoomControl:false}).setView([lat,lng],zoom);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"CartoDB",maxZoom:19}).addTo(map);
  clusterGroup=L.markerClusterGroup({
    maxClusterRadius:50,
    iconCreateFunction:function(cluster){
      return L.divIcon({
        className:"",
        html:'<div style="background:#0ea5e9;color:#000;font-size:12px;font-weight:900;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5)">'+cluster.getChildCount()+"</div>",
        iconSize:[36,36],iconAnchor:[18,18]
      });
    }
  });
  map.addLayer(clusterGroup);
  if(userLat) addUserMarker();
}

function addUserMarker(){
  if(userMarker) userMarker.remove();
  userMarker=L.circleMarker([userLat,userLng],{radius:10,fillColor:"#22d3ee",color:"#fff",weight:3,fillOpacity:1}).addTo(map);
  // Cercle de rayon
  if(activeRadius>0) drawRadiusCircle();
}

var radiusCircle=null;
function drawRadiusCircle(){
  if(radiusCircle) radiusCircle.remove();
  if(!userLat||activeRadius===0) return;
  radiusCircle=L.circle([userLat,userLng],{
    radius:activeRadius*1000,
    color:"#22d3ee",fillColor:"#22d3ee",fillOpacity:0.04,weight:1.5,dashArray:"6,6"
  }).addTo(map);
}

function getDistanceKm(lat1,lng1,lat2,lng2){
  var R=6371;
  var dLat=(lat2-lat1)*Math.PI/180;
  var dLng=(lng2-lng1)*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function geocodeCity(city){
  try{
    var r=await fetch("https://nominatim.openstreetmap.org/search?q="+encodeURIComponent(city+",France")+"&format=json&limit=1");
    var d=await r.json();
    if(!d.length) return null;
    return{lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};
  }catch(e){return null;}
}

function renderMapMarkers(){
  if(!map||!clusterGroup) return;
  clusterGroup.clearLayers();
  mapMarkers=[];

  var withCoords=items.filter(function(i){return i.lat&&i.lng;});
  var withCityOnly=items.filter(function(i){return i.city&&i.city.trim()&&!i.lat;});

  // Annonces avec coordonnees GPS directes
  withCoords.forEach(function(item){
    addItemMarker(item,item.lat,item.lng);
  });

  // Annonces avec ville seulement - geocoder
  withCityOnly.forEach(async function(item){
    var coords=await geocodeCity(item.city);
    if(!coords) return;
    addItemMarker(item,coords.lat,coords.lng);
  });
}

function addItemMarker(item,lat,lng){
  // Filtre par rayon
  if(activeRadius>0&&userLat){
    var dist=getDistanceKm(userLat,userLng,lat,lng);
    if(dist>activeRadius) return;
  }
  var icon=L.divIcon({
    className:"",
    html:'<div class="yb-marker"><div class="yb-pin"><div class="yb-dot"></div><div class="yb-stem"></div></div><div class="yb-price">'+(item.price||0)+"e</div></div>",
    iconSize:[40,44],
    iconAnchor:[20,26]
  });
  var marker=L.marker([lat,lng],{icon:icon});
  marker.on("click",function(){
    document.getElementById("map-pop-img").src=item.imageUrl||"";
    document.getElementById("map-pop-name").innerText=item.itemName||"";
    document.getElementById("map-pop-price").innerText=(item.price||0)+"euro";
    document.getElementById("map-pop-city-txt").innerText=item.city||"";
    document.getElementById("map-pop-btn").onclick=function(){openDetail(item.id);};
    var p=document.getElementById("map-popup");
    p.classList.remove("hidden");p.style.display="flex";
  });
  clusterGroup.addLayer(marker);
  mapMarkers.push(marker);
  // Mettre a jour le compteur
  var count=clusterGroup.getLayers().length;
  document.getElementById("map-count-txt").innerText=count+(count>1?" annonces":" annonce");
}

window.setRadius=function(km){
  activeRadius=km;
  ["r1","r2","r5","r20","r50","r0"].forEach(function(id){
    var el=document.getElementById(id);
    if(el){el.style.background="#fff";el.style.color="#64748b";el.style.border="1px solid #e2e8f0";el.style.boxShadow="0 1px 4px rgba(0,0,0,.08)";}
  });
  var activeBtn=document.getElementById("r"+km);
  if(activeBtn){activeBtn.style.background="#0ea5e9";activeBtn.style.color="#000";activeBtn.style.border="none";activeBtn.style.boxShadow="none";}
  drawRadiusCircle();
  renderMapMarkers();
  if(map&&userLat&&km>0) map.setView([userLat,userLng],km<=1?16:km<=2?15:km<=5?13:km<=20?11:10);
};

function askGeo(){
  if(!navigator.geolocation){toast("Geolocalisation non supportee");return;}
  navigator.geolocation.getCurrentPosition(
    function(pos){
      userLat=pos.coords.latitude;userLng=pos.coords.longitude;
      if(map){
        map.setView([userLat,userLng],13);
        addUserMarker();
        renderMapMarkers();
      }
      toast("Position obtenue !",true);
    },
    function(){toast("Position refusee - affichage de toute la France");}
  );
}
window.centerMap=function(){
  if(map&&userLat) map.setView([userLat,userLng],13);
  else askGeo();
};

// Sauvegarder lat/lng lors de la publication
async function geocodeAndSave(city){
  if(!city) return null;
  return await geocodeCity(city);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAVORIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.toggleFav=function(id,btn){
  if(favorites.has(id)){
    favorites.delete(id);
    if(btn){btn.classList.remove("fav");btn.innerHTML="ü§ç";}
  }else{
    favorites.add(id);
    if(btn){btn.classList.add("fav");btn.innerHTML="‚ù§Ô∏è";}
    // Micro-animation
    if(btn){btn.style.transform="scale(1.4)";setTimeout(function(){btn.style.transform="";},200);}
  }
  localStorage.setItem("yb_favs",JSON.stringify([...favorites]));
  renderFeed(items.filter(function(){return true;}));// refresh cards
  applyFilters();
};
window.toggleFavDetail=function(){
  if(!curItem) return;
  var icon=document.getElementById("det-fav-icon");
  if(favorites.has(curItem.id)){
    favorites.delete(curItem.id);
    icon.className="fa-regular fa-heart text-sm text-slate-400";
  }else{
    favorites.add(curItem.id);
    icon.className="fa-solid fa-heart text-sm text-rose-400";
    icon.style.transform="scale(1.5)";
    setTimeout(function(){icon.style.transform="";},200);
  }
  localStorage.setItem("yb_favs",JSON.stringify([...favorites]));
};
function renderFavs(){
  var el=document.getElementById("fav-listings");
  if(!el) return;
  var favItems=items.filter(function(i){return favorites.has(i.id);});
  if(!favItems.length){
    el.innerHTML='<p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:16px 0">Aucun favori</p>';
    return;
  }
  el.innerHTML=favItems.map(function(i){
    return '<div onclick="openDetail(\''+i.id+'\')" style="cursor:pointer;background:#f8fafc;border:1px solid #e8ecf0;border-radius:12px;overflow:hidden"><div style="height:90px;background:#f1f5f9"><img src="'+(i.imageUrl||"")+'" style="width:100%;height:100%;object-fit:contain"></div><div style="padding:8px"><p style="font-size:11px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:13px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div></div>';
  }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRUST SCORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function computeAndShowTrust(i){
  var score=0;var details=[];
  if(i.imageUrl&&i.imageUrl.length>10){score+=30;details.push({label:"Photo ‚úì",ok:true});}
  else{details.push({label:"Pas de photo",ok:false});}
  if(i.description&&i.description.length>40){score+=25;details.push({label:"Description ‚úì",ok:true});}
  else if(i.description&&i.description.length>10){score+=12;details.push({label:"Description courte",ok:false});}
  else{details.push({label:"Pas de description",ok:false});}
  if(i.price&&parseFloat(i.price)>0){score+=15;details.push({label:"Prix renseign√© ‚úì",ok:true});}
  if(i.city){score+=10;details.push({label:"Ville ‚úì",ok:true});}
  if(i.condition){score+=10;details.push({label:"√âtat ‚úì",ok:true});}
  if(i.shipping&&i.shipping.length){score+=10;details.push({label:"Livraison ‚úì",ok:true});}
  var fillEl=document.getElementById("det-trust-fill");
  var labelEl=document.getElementById("det-trust-label");
  var detailsEl=document.getElementById("det-trust-details");
  fillEl.style.width=score+"%";
  if(score>=80){fillEl.style.background="#22c55e";labelEl.innerText=score+"/100 ‚Äî Excellent";labelEl.style.color="#22c55e";}
  else if(score>=55){fillEl.style.background="#f59e0b";labelEl.innerText=score+"/100 ‚Äî Moyen";labelEl.style.color="#f59e0b";}
  else{fillEl.style.background="#ef4444";labelEl.innerText=score+"/100 ‚Äî Faible";labelEl.style.color="#ef4444";}
  detailsEl.innerHTML=details.map(function(d){
    return '<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px;background:'+(d.ok?"#f0fdf4":"#fef2f2")+';color:'+(d.ok?"#166534":"#dc2626")+'">'+d.label+'</span>';
  }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// D√âTECTION ARNAQUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var CAT_AVG_PRICES={
  "T√©l√©phones":350,"Ordinateurs":400,"Tablettes":200,"Photo":250,"Consoles":200,"Jeux vid√©o":30,
  "Voitures":8000,"Motos":3000,"V√©los":180,"√âlectrom√©nager":120,"Ameublement":150,
  "V√™tements":20,"Chaussures":35,"Montres":80,"Livres":6
};
function detectFraud(i){
  var warn=document.getElementById("det-fraud-warn");
  var price=parseFloat(i.price)||0;
  var cat=i.category||"";
  var threshold=null;
  for(var key in CAT_AVG_PRICES){
    if(cat.toLowerCase().indexOf(key.toLowerCase())>=0){threshold=CAT_AVG_PRICES[key];break;}
  }
  if(threshold&&price>0&&price<threshold*0.2){
    warn.classList.remove("hidden");
  }else{
    warn.classList.add("hidden");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUGGESTION PRIX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPriceRange(category,excludeId,refPrice){
  // Use items from same category for real range
  var same=items.filter(function(i){
    return i.id!==excludeId&&(i.category||"").toLowerCase().indexOf((category||"").toLowerCase())>=0&&parseFloat(i.price)>0;
  });
  if(same.length>=2){
    var prices=same.map(function(i){return parseFloat(i.price);}).sort(function(a,b){return a-b;});
    return{min:prices[0],max:prices[prices.length-1],count:prices.length};
  }
  // Fallback to category averages
  var cat=category||"";
  for(var key in CAT_AVG_PRICES){
    if(cat.toLowerCase().indexOf(key.toLowerCase())>=0){
      var avg=CAT_AVG_PRICES[key];
      return{min:Math.round(avg*0.6),max:Math.round(avg*1.5),count:0};
    }
  }
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT IA ‚Äì SUGGESTIONS CONTEXTUELLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChatSuggestions(item,phase){
  var el=document.getElementById("chat-suggestions");
  if(!el) return;
  var price=item?item.price:0;
  var suggestions=[];
  if(phase==="start"){
    suggestions=["Disponible ?","Dernier prix ?","Livraison possible ?","√âtat exact ?","Photos suppl√©mentaires ?"];
    if(item&&item.troc) suggestions.push("√âchange possible ?");
  }else{
    var nego=Math.round((price||100)*0.85);
    suggestions=["Merci, accord !","Je prends √† "+nego+"‚Ç¨ ?","Remise en main propre √† Paris ?","Vous acceptez PayPal ?","R√©serv√© pour moi ?"];
  }
  el.innerHTML=suggestions.map(function(s){
    return '<button onclick="qMsg(\''+s.replace(/'/g,"\\'")+'\',true)" style="flex-shrink:0;font-size:10px;font-weight:700;color:#0ea5e9;background:#eff9ff;border:1px solid rgba(14,165,233,.2);border-radius:99px;padding:4px 10px;cursor:pointer;white-space:nowrap;transition:all .12s" onmouseover="this.style.background=\'#dbeafe\'" onmouseout="this.style.background=\'#eff9ff\'">'+s+'</button>';
  }).join("");
}
window.updateChatSuggestions=function(){
  var val=document.getElementById("chat-inp").value.toLowerCase();
  if(!val) return;
  // Dynamic suggestions based on what user is typing
  var contextual=[];
  var price=curItem?curItem.price:0;
  if(/prix|combien/.test(val)) contextual=["Dernier prix ?","Vous faites √† "+Math.round(price*0.85)+"‚Ç¨ ?","C'est n√©gociable ?"];
  else if(/livr|envoi|coli/.test(val)) contextual=["Livraison Mondial Relay ?","Colissimo disponible ?","Vous exp√©diez en France ?"];
  else if(/√©tat|d√©faut|usure/.test(val)) contextual=["Aucun d√©faut visible ?","Fonctionnel √† 100% ?","Vous avez la bo√Æte d'origine ?"];
  if(contextual.length){
    var el=document.getElementById("chat-suggestions");
    if(el) el.innerHTML=contextual.map(function(s){
      return '<button onclick="qMsg(\''+s.replace(/'/g,"\\'")+'\',true)" style="flex-shrink:0;font-size:10px;font-weight:700;color:#8b5cf6;background:#f5f3ff;border:1px solid rgba(139,92,246,.2);border-radius:99px;padding:4px 10px;cursor:pointer;white-space:nowrap">'+s+'</button>';
    }).join("");
  }
};
// Override qMsg to optionally skip the auto-send (for suggestion click only sets input)
window.qMsg=function(m){document.getElementById("chat-inp").value=m;sendMsg();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTES SAUVEGARD√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openAlertes=function(){
  var m=document.getElementById("alertes-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeAlertes=function(){
  var m=document.getElementById("alertes-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.saveAlert=function(){
  var q=document.getElementById("alert-query").value.trim();
  if(!q){toast("D√©cris ce que tu cherches");return;}
  var alerts=JSON.parse(localStorage.getItem("yb_alerts")||"[]");
  alerts.push({id:Date.now(),query:q,createdAt:new Date().toLocaleDateString("fr-FR")});
  localStorage.setItem("yb_alerts",JSON.stringify(alerts));
  document.getElementById("alert-query").value="";
  closeAlertes();
  toast("Alerte cr√©√©e ! üîî",true);
  renderAlerts();
};
function renderAlerts(){
  var el=document.getElementById("alerts-list");
  if(!el) return;
  var alerts=JSON.parse(localStorage.getItem("yb_alerts")||"[]");
  if(!alerts.length){
    el.innerHTML='<p style="font-size:11px;color:#94a3b8;text-align:center;padding:12px 0">Aucune alerte sauvegard√©e</p>';
    return;
  }
  el.innerHTML=alerts.map(function(a){
    return '<div class="alert-chip"><i class="fa-solid fa-bell" style="color:#0ea5e9;font-size:11px;flex-shrink:0"></i><span class="alert-chip-label">'+a.query+'</span><span style="font-size:9px;color:#94a3b8;flex-shrink:0;margin-right:6px">'+a.createdAt+'</span><button class="alert-chip-del" onclick="deleteAlert('+a.id+')"><i class="fa-solid fa-xmark"></i></button></div>';
  }).join("");
}
window.deleteAlert=function(id){
  var alerts=JSON.parse(localStorage.getItem("yb_alerts")||"[]").filter(function(a){return a.id!==id;});
  localStorage.setItem("yb_alerts",JSON.stringify(alerts));
  renderAlerts();
};
// Check alerts on new items
function checkAlertsOnNewItems(newItems){
  var alerts=JSON.parse(localStorage.getItem("yb_alerts")||"[]");
  if(!alerts.length) return;
  alerts.forEach(function(a){
    var q=a.query.toLowerCase();
    newItems.forEach(function(item){
      var name=(item.itemName||"").toLowerCase();
      var cat=(item.category||"").toLowerCase();
      if(q.split(" ").some(function(w){return w.length>3&&(name.indexOf(w)>=0||cat.indexOf(w)>=0);})){
        showPushBanner("üîî Alerte : "+a.query,"Nouvelle annonce : "+(item.itemName||"")+" - "+(item.price||0)+"‚Ç¨");
      }
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTAGE NATIF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.shareItem=function(){
  if(!curItem) return;
  var text="üõç "+curItem.itemName+" ‚Äî "+(curItem.price||0)+"‚Ç¨\nVu sur Youbiiiz";
  if(navigator.share){
    navigator.share({title:curItem.itemName,text:text,url:window.location.href}).catch(function(){});
  }else{
    navigator.clipboard.writeText(text+"\n"+window.location.href).then(function(){toast("Lien copi√© ! üìã",true);}).catch(function(){toast("Partage non disponible");});
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOST AUTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.toggleBoost=function(cb){
  if(cb.checked){
    toast("Boost auto activ√© ! Vos annonces seront relanc√©es automatiquement ‚ú®",true);
    localStorage.setItem("yb_boost","1");
  }else{
    toast("Boost auto d√©sactiv√©");
    localStorage.removeItem("yb_boost");
  }
};
// Restore boost toggle state
setTimeout(function(){
  var bt=document.getElementById("boost-toggle");
  if(bt) bt.checked=!!localStorage.getItem("yb_boost");
},500);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARROUSEL PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var carPhotos=[],carIdx=0;
function buildCarousel(photos){
  carPhotos=photos&&photos.length?photos:[""];
  carIdx=0;
  var track=document.getElementById("det-carousel-track");
  var dots=document.getElementById("det-dots");
  var thumbs=document.getElementById("det-thumbs");
  if(!track) return;
  track.innerHTML=carPhotos.map(function(src){
    return '<div style="width:100%;height:100%;flex-shrink:0;background:#f8f8f8"><img src="'+src+'" style="width:100%;height:100%;object-fit:contain;display:block;"></div>';
  }).join("");
  // Dots
  if(carPhotos.length>1){
    dots.innerHTML=carPhotos.map(function(_,i){return '<div class="photo-dot'+(i===0?' on':'')+'" onclick="goSlide('+i+')"></div>';}).join("");
    document.getElementById("det-prev").style.display="flex";
    document.getElementById("det-next").style.display="flex";
  }else{
    dots.innerHTML="";
    document.getElementById("det-prev").style.display="none";
    document.getElementById("det-next").style.display="none";
  }
  // Thumbs
  if(carPhotos.length>1){
    thumbs.innerHTML=carPhotos.map(function(src,i){
      return '<img class="photo-thumb'+(i===0?' active':'')+'" src="'+src+'" onclick="goSlide('+i+')">';
    }).join("");
  }else{thumbs.innerHTML="";}
  goSlide(0);
}
window.carNav=function(dir){goSlide((carIdx+dir+carPhotos.length)%carPhotos.length);};
window.goSlide=function(idx){
  carIdx=idx;
  var track=document.getElementById("det-carousel-track");
  if(track) track.style.transform="translateX(-"+(idx*100)+"%)";
  document.querySelectorAll(".photo-dot").forEach(function(d,i){d.classList.toggle("on",i===idx);});
  document.querySelectorAll(".photo-thumb").forEach(function(t,i){t.classList.toggle("active",i===idx);});
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXTRA PHOTOS (scan form)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var extraPhotos=[];
window.addExtraPhotos=function(inp){
  var files=Array.from(inp.files||[]);
  files.forEach(function(f){
    if(extraPhotos.length>=4) return;// max 4 extra (+ 1 main = 5)
    var r=new FileReader();
    r.onload=function(ev){
      extraPhotos.push(ev.target.result);
      renderExtraPhotos();
    };
    r.readAsDataURL(f);
  });
  inp.value="";
};
function renderExtraPhotos(){
  var el=document.getElementById("extra-photos-list");
  if(!el) return;
  if(!extraPhotos.length){el.innerHTML='<p class="text-[10px] text-slate-500 self-center">Aucune photo suppl√©mentaire</p>';return;}
  el.innerHTML=extraPhotos.map(function(src,i){
    return '<div style="position:relative;flex-shrink:0"><img src="'+src+'" class="photo-thumb active"><div class="photo-thumb-del" onclick="removeExtraPhoto('+i+')">√ó</div></div>';
  }).join("");
}
window.removeExtraPhoto=function(i){extraPhotos.splice(i,1);renderExtraPhotos();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTAGE R√âSEAUX SOCIAUX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openShareModal=function(){
  if(!curItem) return;
  document.getElementById("share-prev-img").src=curItem.imageUrl||"";
  document.getElementById("share-prev-title").innerText=curItem.itemName||"";
  document.getElementById("share-prev-price").innerText=(curItem.price||0)+"‚Ç¨";
  var url="https://youbiiiz.app/item/"+curItem.id;
  document.getElementById("share-link-val").value=url;
  var m=document.getElementById("share-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeShareModal=function(){
  var m=document.getElementById("share-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.shareTo=function(net){
  if(!curItem) return;
  var item=curItem;
  var title=encodeURIComponent(item.itemName+" ‚Äî "+(item.price||0)+"‚Ç¨");
  var url=encodeURIComponent("https://youbiiiz.app/item/"+item.id);
  var text=encodeURIComponent("üõç "+item.itemName+" ‚Äî "+(item.price||0)+"‚Ç¨\nDispo sur Youbiiiz üëâ ");
  var links={
    whatsapp:"https://wa.me/?text="+text+url,
    facebook:"https://www.facebook.com/sharer/sharer.php?u="+url,
    twitter:"https://twitter.com/intent/tweet?text="+text+"&url="+url,
    telegram:"https://t.me/share/url?url="+url+"&text="+text,
    messenger:"https://www.facebook.com/dialog/send?link="+url+"&app_id=123456789",
    sms:"sms:?body="+text+url
  };
  if(net==="instagram"){
    // Instagram ne permet pas le partage URL direct ‚Üí copie + instruction
    navigator.clipboard.writeText("üõç "+item.itemName+" ‚Äî "+(item.price||0)+"‚Ç¨\nhttps://youbiiiz.app/item/"+item.id).then(function(){
      toast("Texte copi√© ! Colle-le dans ta story Instagram üì∏",true);
    });
    closeShareModal();
    return;
  }
  if(net==="tiktok"){
    navigator.clipboard.writeText("üõç "+item.itemName+" ‚Äî "+(item.price||0)+"‚Ç¨\nhttps://youbiiiz.app/item/"+item.id).then(function(){
      toast("Lien copi√© ! Colle-le dans ta bio TikTok üéµ",true);
    });
    closeShareModal();
    return;
  }
  if(links[net]) window.open(links[net],"_blank","noopener,width=600,height=500");
  closeShareModal();
};
window.copyShareLink=function(){
  var inp=document.getElementById("share-link-val");
  navigator.clipboard.writeText(inp.value).then(function(){toast("Lien copi√© ! üìã",true);}).catch(function(){inp.select();document.execCommand("copy");toast("Lien copi√© !",true);});
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAIRE UNE OFFRE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openOffer=function(){
  if(!curItem) return;
  var price=parseFloat(curItem.price)||0;
  document.getElementById("offer-asked").innerText=price+"‚Ç¨";
  document.getElementById("offer-amount").value="";
  document.getElementById("offer-amount").placeholder=Math.round(price*0.85);
  // Hint
  document.getElementById("offer-hint").innerText="Conseil : proposez entre "+Math.round(price*0.75)+"‚Ç¨ et "+Math.round(price*0.92)+"‚Ç¨ pour maximiser vos chances";
  // Quick suggestions
  var percs=[90,80,70];
  document.getElementById("offer-quick").innerHTML=percs.map(function(p){
    var v=Math.round(price*p/100);
    return '<button onclick="document.getElementById(\'offer-amount\').value='+v+'" style="background:#f1f5f9;border:1.5px solid #e2e8f0;border-radius:99px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;color:#0f172a">'+v+'‚Ç¨ <span style="color:#94a3b8;font-size:9px">(-'+Math.round(100-p)+'%)</span></button>';
  }).join("");
  var m=document.getElementById("offer-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeOffer=function(){
  var m=document.getElementById("offer-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.sendOffer=function(){
  var amt=parseFloat(document.getElementById("offer-amount").value);
  if(!amt||amt<=0){toast("Entrez un montant valide");return;}
  var price=parseFloat(curItem?curItem.price:0)||0;
  if(amt>=price){toast("Votre offre doit √™tre inf√©rieure au prix demand√©");return;}
  closeOffer();
  // Open chat with pre-filled offer message
  openChat(curItem);
  setTimeout(function(){
    document.getElementById("chat-inp").value="Bonjour, je vous propose "+amt+"‚Ç¨ pour cet article. Est-ce que ce prix vous convient ?";
    sendMsg();
  },500);
  toast("Offre envoy√©e : "+amt+"‚Ç¨ ü§ù",true);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIGNALEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openReport=function(){
  var m=document.getElementById("report-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeReport=function(){
  var m=document.getElementById("report-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.submitReport=async function(reason){
  closeReport();
  if(isDemoMode){toast("Signalement envoy√© ! Merci üôè",true);return;}
  if(!me||!curItem) return;
  try{
    await addDoc(collection(db,"reports"),{itemId:curItem.id,userId:me.uid,reason:reason,createdAt:serverTimestamp()});
    toast("Signalement envoy√©. Merci ! üôè",true);
  }catch(e){toast("Erreur signalement");}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFIL VENDEUR PUBLIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openSellerProfile=function(){
  if(!curItem) return;
  var sellerId=curItem.userId;
  var sellerItems=items.filter(function(i){return i.userId===sellerId;});
  document.getElementById("sp-name").innerText="Vendeur #"+sellerId.slice(0,8);
  document.getElementById("sp-count").innerText=sellerItems.length;
  document.getElementById("sp-coins").innerText=Math.floor(Math.random()*200+50)+" ü™ô";
  var since=sellerItems.length?new Date((sellerItems[sellerItems.length-1].createdAt?sellerItems[sellerItems.length-1].createdAt.seconds*1000:Date.now())).toLocaleDateString("fr-FR",{month:"long",year:"numeric"}):"R√©cemment";
  document.getElementById("sp-since").innerText="Membre depuis "+since;
  // Rating
  getDoc(doc(db,"users",sellerId)).then(function(d){
    var rv=document.getElementById("sp-rating-val");
    if(d.exists()&&d.data().rating){rv.innerText="‚òÖ"+d.data().rating;}
    else{rv.innerText="‚Äî";}
    // Verified
    var spv=document.getElementById("sp-verified");
    if(spv) spv.classList.add("hidden");
  }).catch(function(){});
  // Listings grid
  var el=document.getElementById("sp-listings");
  el.innerHTML=sellerItems.map(function(i){
    return '<div onclick="closeSellerProfile();openDetail(\''+i.id+'\')" style="cursor:pointer;background:#f8fafc;border:1px solid #e8ecf0;border-radius:14px;overflow:hidden"><div style="height:90px;background:#f1f5f9"><img src="'+(i.imageUrl||"")+'" style="width:100%;height:100%;object-fit:contain;background:#f8f8f8;display:block"></div><div style="padding:8px"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div></div>';
  }).join("")||'<p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;padding:24px">Aucune annonce active</p>';
  var m=document.getElementById("seller-profile-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeSellerProfile=function(){
  var m=document.getElementById("seller-profile-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANNONCES SIMILAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSimilar(item){
  var el=document.getElementById("det-similar");
  if(!el) return;
  var cat=item.category||"";
  var price=parseFloat(item.price)||0;
  var similar=items.filter(function(i){
    return i.id!==item.id&&(i.category||"").toLowerCase()===cat.toLowerCase()&&Math.abs((parseFloat(i.price)||0)-price)<price*0.8;
  }).slice(0,6);
  if(!similar.length){
    el.innerHTML='<p style="font-size:11px;color:#94a3b8;padding:8px 0">Aucune annonce similaire pour l\'instant</p>';
    return;
  }
  el.innerHTML=similar.map(function(i){
    return '<div onclick="openDetail(\''+i.id+'\')" style="flex-shrink:0;width:110px;cursor:pointer"><div style="width:110px;height:90px;background:#1e293b;border-radius:12px;overflow:hidden;border:1px solid rgba(148,163,184,.1);margin-bottom:5px"><img src="'+(i.imageUrl||"")+'" style="width:100%;height:100%;object-fit:contain;display:block;background:#f8f8f8"></div><p style="font-size:11px;font-weight:700;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:13px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div>';
  }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIQUE DE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var browseHistory=JSON.parse(localStorage.getItem("yb_history")||"[]");
function addToHistory(item){
  browseHistory=browseHistory.filter(function(h){return h.id!==item.id;});
  browseHistory.unshift({id:item.id,name:item.itemName,price:item.price,img:item.imageUrl,ts:Date.now()});
  if(browseHistory.length>20) browseHistory=browseHistory.slice(0,20);
  localStorage.setItem("yb_history",JSON.stringify(browseHistory));
}
function renderHistory(){
  var el=document.getElementById("history-list");
  if(!el) return;
  var valid=browseHistory.filter(function(h){return items.find(function(i){return i.id===h.id;});});
  if(!valid.length){el.innerHTML='<p style="font-size:11px;color:#94a3b8;text-align:center;padding:12px 0">Aucune annonce consult√©e</p>';return;}
  el.innerHTML=valid.slice(0,8).map(function(h){
    var ago=timeSince(h.ts);
    return '<div class="hist-item" onclick="openDetail(\''+h.id+'\')"><img src="'+(h.img||"")+'" style="width:44px;height:44px;border-radius:10px;object-fit:contain;background:#f8fafc;border:1px solid #e8ecf0;flex-shrink:0"><div style="flex:1;min-width:0"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(h.name||"Objet")+'</p><p style="font-size:13px;font-weight:900;color:#0ea5e9">'+(h.price||0)+'‚Ç¨</p></div><p style="font-size:10px;color:#94a3b8;flex-shrink:0">'+ago+'</p></div>';
  }).join("");
}
function timeSince(ts){
  var s=Math.floor((Date.now()-ts)/1000);
  if(s<60) return "√† l'instant";
  if(s<3600) return Math.floor(s/60)+"min";
  if(s<86400) return Math.floor(s/3600)+"h";
  return Math.floor(s/86400)+"j";
}
window.clearHistory=function(){browseHistory=[];localStorage.removeItem("yb_history");renderHistory();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YOUBIIIZ COINS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCoins(){return parseInt(localStorage.getItem("yb_coins")||"0");}
function addCoins(n,reason){
  var c=getCoins()+n;
  localStorage.setItem("yb_coins",c);
  showPushBanner("ü™ô +"+n+" Coins gagn√©s !",reason||"Youbiiiz Coins");
  updateCoinsUI();
}
function updateCoinsUI(){
  var c=getCoins();
  var cv=document.getElementById("profile-coins-val");
  var ce=document.getElementById("profile-coins-eur");
  if(cv) cv.innerText=c;
  if(ce) ce.innerText=(c*0.01).toFixed(2)+"‚Ç¨";
}
// Coins dans paiement
var payMode="1x";
window.selectPayMode=function(mode){
  payMode=mode;
  document.getElementById("pay-mode-1x").className="pay3x-option"+(mode==="1x"?" selected":"");
  document.getElementById("pay-mode-3x").className="pay3x-option"+(mode==="3x"?" selected":"");
};
window.toggleCoinsDiscount=function(){
  var cb=document.getElementById("use-coins-toggle");
  var row=document.getElementById("pay-coins-row");
  var tot=parseFloat((payItem?payItem.price:0)||0)+(selShip?selShip.price:0);
  var coins=getCoins();
  var discount=Math.min(coins*0.01,tot*0.1);// max 10% de r√©duction
  if(cb.checked){
    row.style.display="flex";
    document.getElementById("pay-coins-discount").innerText="-"+discount.toFixed(2)+"‚Ç¨";
    document.getElementById("pay-total").innerText=(tot-discount).toFixed(2)+"‚Ç¨";
  }else{
    row.style.display="none";
    document.getElementById("pay-total").innerText=tot.toFixed(2)+"‚Ç¨";
  }
};

// Override openPay to init coins UI
var _origOpenPay=window.openPay;
window.openPay=function(i){
  _origOpenPay(i);
  payMode="1x";
  var tot=parseFloat(i.price||0);
  var per3=Math.ceil(tot/3*100)/100;
  document.getElementById("pay-1x-amount").innerText=tot+"‚Ç¨";
  document.getElementById("pay-3x-amount").innerText=per3+"‚Ç¨/mois";
  document.getElementById("pay-3x-detail").innerText="3 pr√©l√®vements de "+per3+"‚Ç¨ ¬∑ Total "+tot+"‚Ç¨ ¬∑ 0% de frais";
  // Coins
  var coins=getCoins();
  var payCoins=document.getElementById("pay-use-coins");
  if(coins>0&&payCoins){
    payCoins.classList.remove("hidden");
    document.getElementById("pay-coins-avail").innerText=coins+" coins disponibles (-"+(coins*0.01).toFixed(2)+"‚Ç¨ max)";
  }else if(payCoins){payCoins.classList.add("hidden");}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECHERCHE PAR PHOTO (IA)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openSearchByPhoto=function(){
  document.getElementById("sph-idle").classList.remove("hidden");
  document.getElementById("sph-loading").classList.add("hidden");
  document.getElementById("sph-results").classList.add("hidden");
  var m=document.getElementById("search-photo-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeSearchPhoto=function(){
  var m=document.getElementById("search-photo-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.onSearchPhoto=function(inp){
  var f=inp.files[0];if(!f)return;
  document.getElementById("sph-idle").classList.add("hidden");
  document.getElementById("sph-loading").classList.remove("hidden");
  var r=new FileReader();
  r.onload=function(ev){
    analyzeSearchPhoto(ev.target.result);
  };
  r.readAsDataURL(f);
  inp.value="";
};
async function analyzeSearchPhoto(b64){
  try{
    var mime=b64.indexOf("data:image/png")===0?"image/png":"image/jpeg";
    var resp=await fetch("https://analyzeimage-xjtnixfrra-uc.a.run.app",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({imageBase64:b64.split(",")[1],mimeType:mime})
    });
    var d=await resp.json();
    var detected=d.title||d.category||"Objet inconnu";
    document.getElementById("sph-loading").classList.add("hidden");
    document.getElementById("sph-results").classList.remove("hidden");
    document.getElementById("sph-detected").innerText=detected;
    // Find matching items
    var keywords=(detected+" "+(d.category||"")).toLowerCase().split(/[\s,]+/).filter(function(w){return w.length>3;});
    var matches=items.filter(function(i){
      var text=((i.itemName||"")+" "+(i.category||"")+" "+(i.description||"")).toLowerCase();
      return keywords.some(function(k){return text.indexOf(k)>=0;});
    }).slice(0,5);
    var el=document.getElementById("sph-list");
    if(!matches.length){el.innerHTML='<p style="font-size:12px;color:#94a3b8;text-align:center;padding:16px">Aucune annonce similaire trouv√©e</p>';return;}
    el.innerHTML=matches.map(function(i){
      return '<div onclick="closeSearchPhoto();openDetail(\''+i.id+'\')" style="display:flex;align-items:center;gap:10px;padding:8px;background:#f8fafc;border-radius:12px;cursor:pointer;border:1px solid #e8ecf0"><img src="'+(i.imageUrl||"")+'" style="width:44px;height:44px;border-radius:8px;object-fit:contain;background:#fff;flex-shrink:0;border:1px solid #e8ecf0"><div style="flex:1;min-width:0"><p style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9">'+(i.price||0)+'‚Ç¨</p></div><i class="fa-solid fa-chevron-right" style="color:#94a3b8;font-size:11px;flex-shrink:0"></i></div>';
    }).join("");
  }catch(e){
    document.getElementById("sph-loading").classList.add("hidden");
    document.getElementById("sph-idle").classList.remove("hidden");
    toast("Erreur analyse: "+e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERRIDE openDetail pour ajouter : historique, coins, carousel, similar
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _origOpenDetail=window.openDetail;
window.openDetail=function(id){
  _origOpenDetail(id);
  var i=items.find(function(x){return x.id===id;});
  if(!i) return;
  // Carrousel
  var photos=[i.imageUrl].concat(i.extraPhotos||[]).filter(Boolean);
  buildCarousel(photos);
  // Annonces similaires
  renderSimilar(i);
  // Historique
  addToHistory(i);
  // Coins
  var price=parseFloat(i.price)||0;
  var coinsEarn=Math.round(price*0.05);
  var coinsEl=document.getElementById("det-coins-earn");
  if(coinsEl&&coinsEarn>0){
    coinsEl.classList.remove("hidden");
    coinsEl.innerText="ü™ô +"+coinsEarn+" coins si tu ach√®tes";
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS PAR ANNONCE (myCard upgrade)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function myCard(i){
  var favCount=0;// simulated
  var viewCount=i.views||0;
  return '<div class="card fi" style="background:#fff"><div class="sq"><img src="'+(i.imageUrl||"")+'">'+(i.condition?'<span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.72);font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px">'+i.condition+"</span>":"")+'</div><div class="inf"><p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;color:#1e293b">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9;margin-bottom:4px">'+(i.price||0)+'‚Ç¨</p><div style="display:flex;gap:6px;margin-bottom:6px"><span style="font-size:9px;color:#8b5cf6;font-weight:700;background:#f5f3ff;padding:1px 6px;border-radius:99px"><i class="fa-solid fa-eye" style="font-size:8px"></i> '+viewCount+'</span></div><div style="display:flex;gap:5px"><button onclick="event.stopPropagation();openEdit(\''+i.id+'\')" style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:9px;padding:5px;font-size:10px;font-weight:700;cursor:pointer;color:#0f172a">Modifier</button><button onclick="event.stopPropagation();confirmDel(\''+i.id+'\')" style="flex:1;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.18);border-radius:9px;padding:5px;font-size:10px;font-weight:700;color:#f87171;cursor:pointer">Supp.</button></div></div></div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT PROFILE : coins + historique
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _origUpdateProfile=window.updateProfile||function(){};
// Patch pour appeler renderHistory et updateCoinsUI
var _origBoot=boot;
boot=function(){
  _origBoot();
  setTimeout(function(){updateCoinsUI();renderHistory();renderAlerts();},1000);
};
// Also call on switchView profile
var _origSwitchView=window.switchView;
window.switchView=function(v){
  _origSwitchView(v);
  if(v==="profile"){updateCoinsUI();renderHistory();renderAlerts();renderFavs();}
};

// Gain de coins lors d'une vente r√©ussie (apr√®s paiement retour)
var _origCheckPayReturn=checkPayReturn;



</script>
</body>
</html>
