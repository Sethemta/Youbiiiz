<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Youbiiiz</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
*{box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#0a0a0a;color:#fff;overflow:hidden;-webkit-tap-highlight-color:transparent;touch-action:manipulation}

/* LOGO */
.brand-logo{display:inline-flex;align-items:baseline;font-weight:800;user-select:none}
.i-wrapper{display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px}
.i-stem{width:12px;height:38px;background:#22d3ee;border-radius:2px}
.i-dot{width:12px;height:12px;background:#22d3ee;border-radius:2px;position:absolute;bottom:48px;box-shadow:0 0 20px rgba(34,211,238,.5)}
.i-char{position:relative;display:flex;flex-direction:column;align-items:center}
header .i-stem{width:5px;height:16px}
header .i-dot{width:5px;height:5px;bottom:20px;box-shadow:none}
header .i-wrapper{gap:2px;margin:0 2px}
@keyframes dribble{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(var(--b));animation-timing-function:cubic-bezier(0,0,.2,1)}}
.i-char:nth-child(1) .i-dot{--b:-10px;animation:dribble .9s infinite}
.i-char:nth-child(2) .i-dot{--b:-15px;animation:dribble 1.3s infinite .2s}
.i-char:nth-child(3) .i-dot{--b:-12px;animation:dribble 1.1s infinite .5s}

/* UTILS */
.no-sb{-ms-overflow-style:none;scrollbar-width:none}
.no-sb::-webkit-scrollbar{display:none}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fi .25s ease-out forwards}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.su{animation:su .3s cubic-bezier(.16,1,.3,1) forwards}
@keyframes sr{from{transform:translateX(100%)}to{transform:translateX(0)}}
.sr{animation:sr .28s cubic-bezier(.16,1,.3,1) forwards}
@keyframes ld{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
@keyframes sm{0%{top:0;opacity:0}10%{opacity:1}90%{opacity:1}100%{top:100%;opacity:0}}

/* CARD */
.card{background:#161616;border:1px solid rgba(255,255,255,.07);border-radius:14px;overflow:hidden;cursor:pointer;transition:transform .12s}
.card:active{transform:scale(.96)}
.card .sq{width:100%;aspect-ratio:1/1;background:#1c1c1c;overflow:hidden;position:relative}
.card .sq img{width:100%;height:100%;object-fit:cover}
.card .inf{padding:8px 10px 10px}

/* INPUTS */
.inp{width:100%;background:#1c1c1c;border:1.5px solid rgba(255,255,255,.08);border-radius:12px;padding:11px 13px;color:#fff;font-size:14px;font-weight:600;outline:none;transition:border-color .15s;font-family:inherit}
.inp:focus{border-color:#22d3ee}

/* CHIP */
.chip{padding:5px 13px;border-radius:99px;font-size:11px;font-weight:700;border:1.5px solid rgba(255,255,255,.08);color:#71717a;white-space:nowrap;cursor:pointer;transition:all .12s;background:transparent}
.chip.on{background:#22d3ee;color:#000;border-color:#22d3ee}

/* SEARCH */
.sbar{background:#161616;border:1.5px solid rgba(255,255,255,.07);border-radius:12px}

/* MODAL BG */
.mover{background:rgba(0,0,0,.8);backdrop-filter:blur(6px)}
.msheet{background:#111;border-radius:24px 24px 0 0;border-top:1px solid rgba(255,255,255,.07)}

/* BUBBLES */
.bme{background:#22d3ee;color:#000;border-radius:18px 18px 4px 18px}
.bthem{background:#1e1e1e;border:1px solid rgba(255,255,255,.07);border-radius:18px 18px 18px 4px}

/* DBG */
#dbg{display:none;position:fixed;top:12px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:7px 18px;border-radius:99px;font-size:11px;font-weight:700;z-index:9999;max-width:90%;text-align:center}
</style>
</head>
<body>
<div id="dbg"></div>

<!-- SPLASH -->
<div id="splash" class="fixed inset-0 z-[999] bg-[#0a0a0a] flex flex-col items-center justify-center">
  <div class="brand-logo text-6xl flex items-baseline">
    <span>YOUB</span>
    <span class="i-wrapper">
      <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
      <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
      <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
    </span>
    <span>Z</span>
  </div>
  <div class="mt-10 w-28 h-0.5 bg-zinc-900 rounded-full overflow-hidden">
    <div class="h-full bg-cyan-500 rounded-full" style="width:35%;animation:ld 1.6s ease-in-out infinite"></div>
  </div>
  <p class="mt-3 text-[10px] text-zinc-600 font-bold uppercase tracking-widest">Connexion...</p>
</div>

<!-- APP -->
<div id="app" class="hidden opacity-0 transition-opacity duration-500 fixed inset-0 flex flex-col">

  <!-- HEADER -->
  <header class="shrink-0 bg-[#0a0a0a] px-3 pt-4 pb-2 flex items-center gap-2 border-b border-white/5">
    <div class="brand-logo text-[19px] shrink-0 cursor-pointer" onclick="switchView('home')">
      <span>YOUB</span>
      <span class="i-wrapper">
        <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
        <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
        <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
      </span>
      <span>Z</span>
    </div>
    <div class="flex-1 relative">
      <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" style="font-size:11px"></i>
      <input id="header-search" type="text" placeholder="Rechercher un objet, une ville..." oninput="onSearch(this.value)"
        class="sbar w-full pl-8 pr-3 py-2 text-[13px] font-medium text-white placeholder-zinc-600 outline-none">
    </div>
    <button onclick="switchView('notifications')" class="relative shrink-0 w-9 h-9 rounded-xl bg-zinc-900 border border-white/7 flex items-center justify-center">
      <i class="fa-solid fa-bell text-zinc-400" style="font-size:13px"></i>
      <span id="nbadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[9px] font-black flex items-center justify-center">0</span>
    </button>
    <button onclick="switchView('profile')" id="hdr-profile" class="shrink-0 w-9 h-9 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
      <i class="fa-solid fa-user text-white" style="font-size:11px"></i>
    </button>
  </header>

  <!-- MAIN -->
  <main class="flex-1 overflow-y-auto no-sb">

    <!-- HOME -->
    <div id="view-home" class="px-3 pt-3 pb-24">
      <!-- Cat√©gories -->
      <div class="flex gap-2 overflow-x-auto no-sb pb-2">
        <button class="chip on" onclick="filterCat('all',this)">Tout</button>
        <button class="chip" onclick="filterCat('High-Tech',this)">High-Tech</button>
        <button class="chip" onclick="filterCat('Jeux vid√©o',this)">Jeux vid√©o</button>
        <button class="chip" onclick="filterCat('Informatique',this)">Informatique</button>
        <button class="chip" onclick="filterCat('Mode',this)">Mode</button>
        <button class="chip" onclick="filterCat('Maison',this)">Maison</button>
        <button class="chip" onclick="filterCat('Sport',this)">Sport</button>
      </div>
      <!-- Filtre ville -->
      <div class="flex items-center gap-2 mt-2 mb-3">
        <div class="relative flex-1">
          <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-cyan-500" style="font-size:10px"></i>
          <input id="city-inp" type="text" placeholder="Filtrer par ville..." oninput="filterCity(this.value)"
            class="sbar w-full pl-7 pr-3 py-1.5 text-xs font-semibold text-white placeholder-zinc-600 outline-none">
        </div>
        <div class="flex items-center gap-1.5 shrink-0">
          <span class="w-1.5 h-1.5 bg-green-400 rounded-full" style="animation:dribble 1.5s infinite"></span>
          <span class="text-[10px] text-green-400 font-bold">Live</span>
        </div>
      </div>
      <!-- Grille 2 colonnes -->
      <div id="feed" class="grid grid-cols-2 gap-3">
        <div class="col-span-2 py-14 text-center">
          <i class="fa-solid fa-circle-notch animate-spin text-zinc-700 text-2xl"></i>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="view-notifications" class="hidden px-4 pt-5 pb-24">
      <h2 class="font-extrabold text-base mb-4">Notifications</h2>
      <div id="notif-list">
        <p class="text-center text-zinc-600 text-xs font-bold uppercase py-12">Aucune notification</p>
      </div>
    </div>

    <!-- PROFIL -->
    <div id="view-profile" class="hidden px-3 pt-4 pb-24">
      <div class="bg-[#161616] border border-white/6 rounded-2xl p-4 mb-4">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-white"></i>
          </div>
          <div class="flex-1">
            <p class="font-extrabold text-sm">Mon Profil</p>
            <p id="profile-uid" class="text-[10px] text-zinc-500 font-mono mt-0.5">...</p>
          </div>
          <p id="user-badge" class="text-[9px] text-zinc-700 font-mono"></p>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div class="bg-black/40 rounded-xl p-3 text-center">
            <p id="profile-count" class="text-xl font-black text-cyan-400">0</p>
            <p class="text-[9px] text-zinc-500 font-bold uppercase mt-0.5">Annonces</p>
          </div>
          <div class="bg-black/40 rounded-xl p-3 text-center">
            <p id="profile-total" class="text-xl font-black">0‚Ç¨</p>
            <p class="text-[9px] text-zinc-500 font-bold uppercase mt-0.5">Valeur</p>
          </div>
          <div class="bg-black/40 rounded-xl p-3 text-center">
            <p id="profile-rating" class="text-xl font-black text-yellow-400">‚Äî</p>
            <p class="text-[9px] text-zinc-500 font-bold uppercase mt-0.5">Note</p>
          </div>
        </div>
      </div>
      <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-3">Mes annonces</p>
      <div id="my-listings" class="grid grid-cols-2 gap-3">
        <p class="col-span-2 text-center text-zinc-600 text-xs font-bold uppercase py-8">Aucune annonce</p>
      </div>
    </div>

  </main>

  <!-- NAV -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#0a0a0a] border-t border-white/5 h-[60px] flex items-center justify-around px-8 z-[100]" style="backdrop-filter:blur(20px)">
    <button onclick="switchView('home')" id="nav-home">
      <i class="fa-solid fa-house text-xl text-cyan-400"></i>
    </button>
    <button onclick="openScan()" class="w-14 h-14 -mt-6 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-[18px] flex items-center justify-center shadow-[0_0_24px_rgba(34,211,238,.5)] border-[3px] border-[#0a0a0a] active:scale-90 transition-transform">
      <i class="fa-solid fa-plus text-xl text-white"></i>
    </button>
    <button onclick="switchView('profile')" id="nav-profile">
      <i class="fa-solid fa-user text-xl text-zinc-600"></i>
    </button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCAN MODAL ‚Äî bottom sheet Instagram
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scan-modal" class="fixed inset-0 z-[400] hidden flex-col justify-end">
  <div class="mover absolute inset-0" onclick="closeScan()"></div>
  <div class="relative msheet su w-full max-w-lg mx-auto" style="max-height:94vh;display:flex;flex-direction:column;">

    <!-- Handle -->
    <div class="flex justify-center pt-3 pb-2 shrink-0">
      <div class="w-10 h-1 bg-zinc-700 rounded-full"></div>
    </div>

    <!-- √âTAPE 1 : photo -->
    <div id="step-photo" class="px-4 pb-5 shrink-0">
      <div class="flex items-center justify-between mb-3">
        <p class="font-extrabold text-[15px]">Nouvelle annonce</p>
        <button onclick="closeScan()" class="w-8 h-8 rounded-xl bg-zinc-800 flex items-center justify-center">
          <i class="fa-solid fa-xmark text-sm"></i>
        </button>
      </div>

      <!-- Photo preview carr√©e -->
      <div id="scan-box" class="relative bg-zinc-900 rounded-2xl overflow-hidden mx-auto mb-3" style="width:100%;max-width:340px;aspect-ratio:1/1;">
        <video id="cam-vid" class="hidden absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
        <img id="scan-prev" class="hidden absolute inset-0 w-full h-full object-cover">
        <!-- Scan line -->
        <div id="scan-line" class="hidden absolute w-full left-0 z-20" style="height:2px;background:#22d3ee;box-shadow:0 0 10px #22d3ee;animation:sm 1.8s linear infinite"></div>
        <!-- Placeholder -->
        <div id="scan-ph" class="absolute inset-0 flex flex-col items-center justify-center gap-3 pointer-events-none">
          <div class="w-14 h-14 rounded-2xl bg-zinc-800 flex items-center justify-center">
            <i class="fa-solid fa-camera text-2xl text-zinc-500"></i>
          </div>
          <p class="text-xs text-zinc-500 font-semibold">Photo ou galerie</p>
        </div>
        <!-- Spinner -->
        <div id="scan-spin" class="hidden absolute inset-0 bg-black/75 z-30 flex flex-col items-center justify-center gap-3">
          <i class="fa-solid fa-circle-notch animate-spin text-cyan-400 text-3xl"></i>
          <p class="text-xs text-cyan-400 font-bold tracking-widest uppercase">Analyse IA...</p>
        </div>
      </div>

      <!-- Boutons photo -->
      <div id="photo-btns" class="flex gap-2">
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="onFile(event)">
        <button onclick="document.getElementById('file-input').click()"
          class="flex-1 bg-zinc-800 border border-white/8 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-image text-zinc-400"></i> Galerie
        </button>
        <button id="cam-toggle" onclick="toggleCam()"
          class="flex-1 bg-zinc-800 border border-white/8 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-camera text-zinc-400"></i> Cam√©ra
        </button>
        <button id="snap-btn" onclick="snapPhoto()" class="hidden flex-1 bg-cyan-500 rounded-xl py-3 text-sm font-bold text-black flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-circle"></i> Capturer
        </button>
      </div>
    </div>

    <!-- √âTAPE 2 : r√©sultats IA -->
    <div id="step-result" class="hidden flex-col flex-1 overflow-hidden">
      <div class="overflow-y-auto no-sb px-4 pb-6 flex-1">

        <!-- Header r√©sultat -->
        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/6">
          <img id="res-thumb" class="w-16 h-16 rounded-xl object-cover border border-white/8 shrink-0">
          <div class="flex-1 min-w-0">
            <p class="text-[10px] text-green-400 font-bold uppercase tracking-wide mb-1"><i class="fa-solid fa-check-circle mr-1"></i>IA termin√©e</p>
            <input id="ai-name" class="w-full bg-transparent text-sm font-extrabold text-white outline-none border-b border-white/10 pb-1 focus:border-cyan-400 truncate">
          </div>
          <button onclick="resetScan()" class="shrink-0 w-8 h-8 rounded-xl bg-zinc-800 flex items-center justify-center text-zinc-400 active:scale-90 transition-transform" title="Reprendre une photo">
            <i class="fa-solid fa-rotate-left text-xs"></i>
          </button>
        </div>

        <!-- Infos IA -->
        <div class="grid grid-cols-2 gap-2 mb-2">
          <div class="bg-zinc-900 rounded-xl p-3 border border-white/5">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Marque</p>
            <p id="ai-brand" class="text-sm font-extrabold text-cyan-400">‚Äî</p>
          </div>
          <div class="bg-zinc-900 rounded-xl p-3 border border-white/5">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Mod√®le</p>
            <p id="ai-model" class="text-sm font-extrabold text-white truncate">‚Äî</p>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <div class="bg-zinc-900 rounded-xl p-3 border border-white/5">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Prix</p>
            <p id="ai-price" class="text-sm font-extrabold text-cyan-400">‚Äî</p>
          </div>
          <div class="bg-zinc-900 rounded-xl p-3 border border-white/5">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Cat√©gorie</p>
            <p id="ai-cat" class="text-xs font-extrabold text-white">‚Äî</p>
          </div>
          <div class="bg-zinc-900 rounded-xl p-3 border border-white/5">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">√âtat</p>
            <p id="ai-cond" class="text-xs font-extrabold text-green-400">‚Äî</p>
          </div>
        </div>

        <!-- Description -->
        <div class="bg-zinc-900 rounded-xl p-3 border border-white/5 mb-2">
          <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">Description</p>
          <textarea id="ai-desc" rows="3" class="w-full bg-transparent text-xs text-zinc-300 outline-none resize-none leading-relaxed font-medium"></textarea>
        </div>

        <!-- Ville -->
        <div class="bg-zinc-900 rounded-xl p-3 border border-white/5 mb-2">
          <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">Ville</p>
          <div class="relative">
            <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-cyan-500" style="font-size:10px"></i>
            <input id="item-city" type="text" placeholder="Ex : Paris, Lyon, Montpellier..."
              class="inp pl-7 py-2 text-sm" style="background:#0a0a0a;border-color:rgba(255,255,255,.06)">
          </div>
        </div>

        <!-- Livraison -->
        <div class="bg-zinc-900 rounded-xl p-3 border border-white/5 mb-4">
          <p class="text-[9px] text-zinc-500 uppercase font-bold mb-2.5">Livraison</p>
          <div class="flex flex-col gap-3">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-hand" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">ü§ù Main propre</span>
              <span class="text-xs text-zinc-500">Gratuit</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-relay" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">üì¶ Mondial Relay</span>
              <input type="number" id="sh-relay-p" value="5" class="w-14 bg-[#0a0a0a] border border-white/8 rounded-lg px-2 py-1 text-xs text-center text-white outline-none focus:border-cyan-500">
              <span class="text-xs text-zinc-500">‚Ç¨</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-colis" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">üöö Colissimo</span>
              <input type="number" id="sh-colis-p" value="8" class="w-14 bg-[#0a0a0a] border border-white/8 rounded-lg px-2 py-1 text-xs text-center text-white outline-none focus:border-cyan-500">
              <span class="text-xs text-zinc-500">‚Ç¨</span>
            </label>
          </div>
        </div>

        <button id="pub-btn" class="w-full bg-cyan-500 text-black font-extrabold py-4 rounded-2xl text-[15px] active:scale-95 transition-transform shadow-[0_0_18px_rgba(34,211,238,.35)]">
          Publier l'annonce
        </button>
      </div>
    </div>

  </div>
  <canvas id="cap-canvas" class="hidden"></canvas>
</div>

<!-- DETAIL -->
<div id="detail-modal" class="fixed inset-0 z-[500] bg-[#0a0a0a] hidden flex-col sr">
  <div class="flex items-center gap-3 px-3 pt-4 pb-3 bg-[#0a0a0a] border-b border-white/5 shrink-0">
    <button onclick="closeDetail()" class="w-9 h-9 rounded-xl bg-zinc-900 flex items-center justify-center active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <p class="font-bold text-sm">D√©tail de l'annonce</p>
  </div>
  <div class="flex-1 overflow-y-auto no-sb">
    <div class="px-3 pt-3 pb-2">
      <div class="w-full rounded-2xl overflow-hidden bg-zinc-900" style="aspect-ratio:1/1;">
        <img id="det-img" class="w-full h-full object-cover">
      </div>
    </div>
    <div class="px-4 pb-8">
      <div class="flex items-start justify-between gap-2 mt-3 mb-2">
        <h2 id="det-title" class="font-extrabold text-xl leading-tight flex-1"></h2>
        <p id="det-price" class="text-cyan-400 font-black text-xl shrink-0"></p>
      </div>
      <div class="flex flex-wrap gap-2 mb-4">
        <span id="det-cat" class="text-[10px] text-zinc-500 font-bold uppercase bg-zinc-900 px-2.5 py-1 rounded-lg border border-white/5"></span>
        <span id="det-cond" class="text-[10px] text-zinc-400 font-bold bg-zinc-900 px-2.5 py-1 rounded-lg border border-white/5"></span>
        <span id="det-city-tag" class="hidden text-[10px] text-zinc-400 font-bold bg-zinc-900 px-2.5 py-1 rounded-lg border border-white/5">
          <i class="fa-solid fa-location-dot text-cyan-500 mr-1"></i><span id="det-city-val"></span>
        </span>
      </div>
      <p id="det-brand" class="text-xs text-zinc-600 font-mono mb-3"></p>
      <div class="bg-zinc-900 rounded-xl p-4 mb-3 border border-white/5">
        <p class="text-[9px] text-zinc-500 uppercase font-bold mb-2 tracking-widest">Description</p>
        <p id="det-desc" class="text-sm text-zinc-300 leading-relaxed"></p>
      </div>
      <div class="bg-zinc-900 rounded-xl p-4 mb-3 border border-white/5">
        <p class="text-[9px] text-zinc-500 uppercase font-bold mb-2 tracking-widest">Livraison</p>
        <div id="det-ship" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="bg-zinc-900 rounded-xl p-4 mb-5 border border-white/5">
        <p class="text-[9px] text-zinc-500 uppercase font-bold mb-3 tracking-widest">Vendeur</p>
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-xs text-white"></i>
          </div>
          <div>
            <p id="det-seller" class="font-bold text-sm"></p>
            <p id="det-rating" class="text-[10px] text-yellow-400 mt-0.5">Nouveau vendeur</p>
          </div>
        </div>
      </div>
      <div class="flex gap-3">
        <button id="contact-btn" class="flex-1 bg-zinc-900 border border-white/8 rounded-2xl py-3.5 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-message text-xs"></i> Contacter
        </button>
        <button id="buy-btn" class="flex-1 bg-cyan-500 text-black rounded-2xl py-3.5 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-brands fa-stripe text-base"></i> Acheter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CHAT -->
<div id="chat-modal" class="fixed inset-0 z-[600] bg-[#0a0a0a] hidden flex-col sr">
  <div class="flex items-center gap-3 px-3 pt-4 pb-3 bg-[#0a0a0a] border-b border-white/5 shrink-0">
    <button onclick="closeChat()" class="w-9 h-9 rounded-xl bg-zinc-900 flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shrink-0">
      <i class="fa-solid fa-user text-xs text-white"></i>
    </div>
    <div class="flex-1">
      <p id="chat-seller" class="font-bold text-sm leading-none"></p>
      <p class="text-[10px] text-green-400 font-semibold mt-0.5">En ligne</p>
    </div>
  </div>
  <div class="px-3 py-2 bg-zinc-900/50 border-b border-white/5 flex gap-3 items-center shrink-0">
    <img id="chat-img" class="w-9 h-9 rounded-lg object-cover border border-white/8 shrink-0">
    <div class="flex-1 min-w-0">
      <p id="chat-iname" class="text-xs font-bold truncate"></p>
      <p id="chat-iprice" class="text-xs text-cyan-400 font-bold"></p>
    </div>
  </div>
  <div id="chat-msgs" class="flex-1 overflow-y-auto no-sb p-4 flex flex-col gap-3"></div>
  <div class="px-3 py-3 bg-[#0a0a0a] border-t border-white/5 shrink-0">
    <div class="flex gap-2 overflow-x-auto no-sb mb-2">
      <button onclick="qMsg('Disponible ?')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Disponible ?</button>
      <button onclick="qMsg('Dernier prix ?')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Dernier prix ?</button>
      <button onclick="qMsg('Livraison possible ?')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Livraison ?</button>
    </div>
    <div class="flex gap-2">
      <input id="chat-inp" type="text" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()"
        class="flex-1 bg-zinc-900 border border-white/8 rounded-xl px-4 py-2.5 text-sm text-white placeholder-zinc-600 outline-none focus:border-cyan-500">
      <button onclick="sendMsg()" class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center active:scale-90 transition-transform">
        <i class="fa-solid fa-paper-plane text-black text-xs"></i>
      </button>
    </div>
  </div>
</div>

<!-- PAIEMENT -->
<div id="pay-modal" class="fixed inset-0 z-[700] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closePay()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8">
    <div class="flex justify-center mb-4"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="w-7 h-7 rounded-lg bg-green-500/15 flex items-center justify-center">
          <i class="fa-solid fa-shield-halved text-green-400 text-xs"></i>
        </div>
        <span class="font-bold text-sm">Paiement s√©curis√©</span>
      </div>
      <button onclick="closePay()" class="w-8 h-8 rounded-xl bg-zinc-800 flex items-center justify-center">
        <i class="fa-solid fa-xmark text-sm"></i>
      </button>
    </div>
    <div class="flex gap-3 mb-4">
      <div id="pay-img" class="w-14 h-14 rounded-xl bg-zinc-800 bg-cover bg-center shrink-0 border border-white/8"></div>
      <div>
        <p id="pay-title" class="font-bold text-sm mb-1 leading-tight"></p>
        <p id="pay-price" class="text-cyan-400 font-black text-lg"></p>
      </div>
    </div>
    <div id="pay-ship-wrap" class="hidden mb-3">
      <p class="text-[9px] text-zinc-500 uppercase font-bold mb-2">Choisir la livraison</p>
      <div id="pay-ship-list" class="flex flex-col gap-2"></div>
    </div>
    <div class="bg-zinc-900 rounded-xl p-4 mb-4 border border-white/5 text-sm">
      <div class="flex justify-between mb-2"><span class="text-zinc-400">Article</span><span id="pay-sub" class="font-bold"></span></div>
      <div class="flex justify-between mb-3"><span class="text-zinc-400">Livraison</span><span id="pay-shipcost" class="font-bold">‚Äî</span></div>
      <div class="flex justify-between border-t border-white/5 pt-3"><span class="font-bold">Total</span><span id="pay-total" class="font-extrabold text-cyan-400 text-base"></span></div>
    </div>
    <button id="stripe-btn" onclick="doStripe()" class="w-full bg-[#635bff] text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-transform">
      <i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant
    </button>
  </div>
</div>

<!-- NOTATION -->
<div id="rate-modal" class="fixed inset-0 z-[800] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-6 w-full max-w-xs border border-white/8 text-center su">
    <div class="w-14 h-14 rounded-2xl bg-yellow-500/10 flex items-center justify-center mx-auto mb-3">
      <i class="fa-solid fa-star text-yellow-400 text-2xl"></i>
    </div>
    <h3 class="font-extrabold text-base mb-1">Laisser une note</h3>
    <p id="rate-sub" class="text-zinc-500 text-xs mb-4">Comment s'est pass√©e cette transaction ?</p>
    <div class="flex justify-center gap-2 mb-4">
      <button onclick="setStar(1)" class="star text-3xl text-zinc-700 transition-all" data-v="1">‚òÖ</button>
      <button onclick="setStar(2)" class="star text-3xl text-zinc-700 transition-all" data-v="2">‚òÖ</button>
      <button onclick="setStar(3)" class="star text-3xl text-zinc-700 transition-all" data-v="3">‚òÖ</button>
      <button onclick="setStar(4)" class="star text-3xl text-zinc-700 transition-all" data-v="4">‚òÖ</button>
      <button onclick="setStar(5)" class="star text-3xl text-zinc-700 transition-all" data-v="5">‚òÖ</button>
    </div>
    <textarea id="rate-comment" placeholder="Commentaire (optionnel)" rows="2"
      class="inp text-sm mb-4 resize-none" style="font-size:13px"></textarea>
    <button onclick="submitRate()" class="w-full bg-yellow-400 text-black font-bold py-3.5 rounded-2xl mb-2 active:scale-95 transition-transform">Envoyer</button>
    <button onclick="closeRate()" class="w-full text-zinc-500 text-sm py-2">Passer</button>
  </div>
</div>

<!-- EDIT -->
<div id="edit-modal" class="fixed inset-0 z-[600] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeEdit()"></div>
  <div class="relative msheet su w-full max-w-lg">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between px-4 pt-2 pb-3">
      <p class="font-extrabold text-[15px]">Modifier</p>
      <button onclick="closeEdit()" class="w-8 h-8 rounded-xl bg-zinc-800 flex items-center justify-center"><i class="fa-solid fa-xmark text-sm"></i></button>
    </div>
    <div class="overflow-y-auto no-sb px-4 pb-8" style="max-height:65vh">
      <div class="mb-3"><p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">Titre</p>
        <input id="edit-title" class="inp"></div>
      <div class="grid grid-cols-2 gap-2 mb-3">
        <div><p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">Prix (‚Ç¨)</p>
          <input id="edit-price" type="number" class="inp text-cyan-400 font-black"></div>
        <div><p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">√âtat</p>
          <select id="edit-cond" class="inp" style="cursor:pointer">
            <option>Neuf</option><option>Tr√®s bon √©tat</option><option>Bon √©tat</option><option>√âtat correct</option>
          </select></div>
      </div>
      <div class="mb-3"><p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">Cat√©gorie</p>
        <select id="edit-cat" class="inp" style="cursor:pointer">
          <option>High-Tech</option><option>Jeux vid√©o</option><option>Informatique</option>
          <option>Mode</option><option>Maison</option><option>Sport</option><option>Divers</option>
        </select></div>
      <div class="mb-4"><p class="text-[9px] text-zinc-500 uppercase font-bold mb-1.5">Description</p>
        <textarea id="edit-desc" rows="3" class="inp resize-none"></textarea></div>
      <button id="edit-save" onclick="saveEdit()" class="w-full bg-cyan-500 text-black font-bold py-4 rounded-2xl mb-2 active:scale-95 transition-transform">
        Sauvegarder
      </button>
      <button onclick="confirmDel(editingId)" class="w-full bg-red-500/8 border border-red-500/20 text-red-400 font-bold py-3.5 rounded-2xl text-sm active:scale-95 transition-transform">
        <i class="fa-solid fa-trash mr-2"></i>Supprimer l'annonce
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div id="del-modal" class="fixed inset-0 z-[700] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-5 w-full max-w-xs border border-red-500/20 text-center su">
    <i class="fa-solid fa-trash text-red-400 text-2xl mb-3"></i>
    <p class="font-extrabold text-base mb-1">Supprimer ?</p>
    <p class="text-zinc-500 text-xs mb-5">Cette action est d√©finitive.</p>
    <div class="flex gap-2">
      <button onclick="closeDel()" class="flex-1 bg-zinc-800 font-bold py-3 rounded-xl text-sm">Annuler</button>
      <button onclick="doDelete()" class="flex-1 bg-red-500 font-bold py-3 rounded-xl text-sm">Supprimer</button>
    </div>
  </div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import{getAuth,signInAnonymously,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import{getFirestore,collection,addDoc,onSnapshot,serverTimestamp,doc,query,where,orderBy,getDocs,deleteDoc,updateDoc,getDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const FB={apiKey:"AIzaSyDOSIhWwrlkhNfk8Y3-tl9IebJW0YBA7d4",authDomain:"youbiiiz-app.firebaseapp.com",projectId:"youbiiiz-app",storageBucket:"youbiiiz-app.firebasestorage.app",messagingSenderId:"664733497216",appId:"1:664733497216:web:ae19fbadf0fa509f59b365"};
const fb=initializeApp(FB),auth=getAuth(fb),db=getFirestore(fb);

let me=null,items=[],curItem=null,scanData=null,camStream=null;
let editingId=null,deletingId=null,payItem=null,selShip=null,curStar=0,rateCtx=null;

// ERR
window.onerror=(m,s,l)=>{const e=document.getElementById('dbg');e.style.display='block';e.innerText='JS:'+m+' L'+l;};
function toast(m,ok=false){const e=document.getElementById('dbg');e.style.display='block';e.style.background=ok?'#22c55e':'#ef4444';e.innerText=m;setTimeout(()=>e.style.display='none',3500);}

// AUTH
onAuthStateChanged(auth,u=>{
  if(u){me=u;document.getElementById('user-badge').innerText='ID:'+u.uid.slice(0,4);document.getElementById('profile-uid').innerText=u.uid.slice(0,18)+'...';boot();}
  else signInAnonymously(auth).catch(e=>toast('Auth:'+e.message));
});

function boot(){
  setTimeout(()=>{
    document.getElementById('splash').style.display='none';
    document.getElementById('app').classList.remove('hidden');
    setTimeout(()=>document.getElementById('app').style.opacity='1',80);
    initFeed();initNotifs();checkPayReturn();
  },900);
}

// ‚îÄ‚îÄ FEED ‚îÄ‚îÄ
function initFeed(){
  onSnapshot(collection(db,'scans'),snap=>{
    items=[];snap.forEach(d=>items.push({id:d.id,...d.data()}));
    items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    renderFeed(items);updateProfile();
  },e=>toast('Feed:'+e.message));
}

function renderFeed(list){
  const el=document.getElementById('feed');
  if(!list.length){el.innerHTML='<div class="col-span-2 py-14 text-center text-zinc-700 text-xs font-bold uppercase">Aucune annonce</div>';return;}
  el.innerHTML=list.map(card).join('');
}

function card(i){
  return`<div class="card fi" onclick="openDetail('${i.id}')">
    <div class="sq">
      <img src="${i.imageUrl||''}" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\'width:100%;height:100%;display:flex;align-items:center;justify-content:center\'><i class=\'fa-solid fa-image text-zinc-700 text-2xl\'></i></div>'">
      ${i.condition?`<span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.72);backdrop-filter:blur(6px);font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px;border:1px solid rgba(255,255,255,.1)">${i.condition}</span>`:''}
    </div>
    <div class="inf">
      <p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px">${i.itemName||'Objet'}</p>
      <p style="font-size:15px;font-weight:900;color:#22d3ee">${i.price||0}‚Ç¨</p>
      ${i.city?`<p style="font-size:10px;color:#52525b;margin-top:3px"><i class="fa-solid fa-location-dot" style="color:#22d3ee;font-size:8px;margin-right:2px"></i>${i.city}</p>`:''}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ FILTRES ‚îÄ‚îÄ
window.filterCat=(cat,btn)=>{
  document.querySelectorAll('.chip').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  applyFilters();
};
window.filterCity=()=>applyFilters();
window.onSearch=()=>applyFilters();

function applyFilters(){
  const cat=document.querySelector('.chip.on')?.textContent?.trim()||'Tout';
  const city=(document.getElementById('city-inp').value||'').toLowerCase().trim();
  const q=(document.getElementById('header-search').value||'').toLowerCase().trim();
  let list=items;
  if(cat!=='Tout') list=list.filter(i=>(i.category||'').toLowerCase().includes(cat.toLowerCase()));
  if(city) list=list.filter(i=>(i.city||'').toLowerCase().includes(city));
  if(q) list=list.filter(i=>(i.itemName||'').toLowerCase().includes(q)||(i.description||'').toLowerCase().includes(q)||(i.city||'').toLowerCase().includes(q));
  renderFeed(list);
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
window.switchView=v=>{
  ['home','notifications','profile'].forEach(n=>{
    document.getElementById('view-'+n)[n===v?'classList':'classList'][n===v?'remove':'add']('hidden');
  });
  document.getElementById('nav-home').querySelector('i').className='fa-solid fa-house text-xl '+(v==='home'?'text-cyan-400':'text-zinc-600');
  document.getElementById('nav-profile').querySelector('i').className='fa-solid fa-user text-xl '+(v==='profile'?'text-cyan-400':'text-zinc-600');
  if(v==='notifications'&&me){
    getDocs(query(collection(db,'notifications'),where('userId','==',me.uid),where('read','==',false))).then(s=>s.forEach(d=>updateDoc(doc(db,'notifications',d.id),{read:true})));
  }
  if(v==='profile') loadMyRating();
};

// ‚îÄ‚îÄ PROFIL ‚îÄ‚îÄ
function updateProfile(){
  if(!me) return;
  const mine=items.filter(i=>i.userId===me.uid);
  document.getElementById('profile-count').innerText=mine.length;
  document.getElementById('profile-total').innerText=mine.reduce((s,i)=>s+(parseFloat(i.price)||0),0)+'‚Ç¨';
  const el=document.getElementById('my-listings');
  el.innerHTML=mine.length?mine.map(myCard).join(''):'<p class="col-span-2 text-center text-zinc-600 text-xs font-bold uppercase py-8">Aucune annonce</p>';
}

function myCard(i){
  return`<div class="card fi">
    <div class="sq"><img src="${i.imageUrl||''}">
      ${i.condition?`<span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.72);font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px">${i.condition}</span>`:''}
    </div>
    <div class="inf">
      <p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px">${i.itemName||'Objet'}</p>
      <p style="font-size:14px;font-weight:900;color:#22d3ee;margin-bottom:6px">${i.price||0}‚Ç¨</p>
      <div style="display:flex;gap:5px">
        <button onclick="event.stopPropagation();openEdit('${i.id}')" style="flex:1;background:#1e1e1e;border:1px solid rgba(255,255,255,.08);border-radius:9px;padding:5px;font-size:10px;font-weight:700;cursor:pointer"><i class="fa-solid fa-pen"></i> Modif.</button>
        <button onclick="event.stopPropagation();confirmDel('${i.id}')" style="flex:1;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.18);border-radius:9px;padding:5px;font-size:10px;font-weight:700;color:#f87171;cursor:pointer"><i class="fa-solid fa-trash"></i> Supp.</button>
      </div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ SCAN ‚îÄ‚îÄ
window.openScan=()=>{
  document.getElementById('scan-modal').classList.remove('hidden');
  document.getElementById('scan-modal').classList.add('flex');
};
window.closeScan=()=>{stopCam();resetScan();document.getElementById('scan-modal').classList.remove('flex');document.getElementById('scan-modal').classList.add('hidden');};
window.resetScan=()=>{
  stopCam();scanData=null;
  document.getElementById('scan-prev').classList.add('hidden');document.getElementById('scan-prev').src='';
  document.getElementById('scan-ph').classList.remove('hidden');
  document.getElementById('scan-spin').classList.add('hidden');
  document.getElementById('scan-line').classList.add('hidden');
  document.getElementById('photo-btns').classList.remove('hidden');
  document.getElementById('snap-btn').classList.add('hidden');
  document.getElementById('cam-toggle').classList.remove('hidden');
  document.getElementById('step-photo').classList.remove('hidden');
  document.getElementById('step-result').classList.add('hidden');
  document.getElementById('step-result').classList.remove('flex');
  document.getElementById('pub-btn').innerText="Publier l'annonce";
  document.getElementById('pub-btn').disabled=false;
  document.getElementById('file-input').value='';
  ['sh-hand','sh-relay','sh-colis'].forEach(id=>{const el=document.getElementById(id);if(el)el.checked=false;});
};

window.toggleCam=async()=>{
  if(camStream){stopCam();return;}
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1080},height:{ideal:1080}},audio:false});
    const v=document.getElementById('cam-vid');v.srcObject=camStream;v.classList.remove('hidden');
    document.getElementById('scan-ph').classList.add('hidden');
    document.getElementById('cam-toggle').classList.add('hidden');
    document.getElementById('snap-btn').classList.remove('hidden');
  }catch{document.getElementById('file-input').click();}
};

function stopCam(){
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}
  const v=document.getElementById('cam-vid');v.srcObject=null;v.classList.add('hidden');
}

window.snapPhoto=()=>{
  const v=document.getElementById('cam-vid'),c=document.getElementById('cap-canvas');
  c.width=v.videoWidth;c.height=v.videoHeight;
  c.getContext('2d').drawImage(v,0,0);
  stopCam();
  document.getElementById('snap-btn').classList.add('hidden');
  processImg(c.toDataURL('image/jpeg',1.0));
};

window.onFile=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>processImg(ev.target.result);r.readAsDataURL(f);};

function processImg(raw){
  document.getElementById('scan-ph').classList.add('hidden');
  document.getElementById('photo-btns').classList.add('hidden');
  document.getElementById('scan-spin').classList.remove('hidden');
  cropImage(raw,.92).then(opt=>{
    document.getElementById('scan-prev').src=opt;
    document.getElementById('scan-prev').classList.remove('hidden');
    document.getElementById('scan-line').classList.remove('hidden');
    callGemini(opt);
  });
}

function cropImage(b64,q){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      // Crop carr√© centr√©
      const s=Math.min(img.width,img.height);
      const sx=Math.floor((img.width-s)/2),sy=Math.floor((img.height-s)/2);
      // Taille de sortie max 600px ‚Äî suffisant pour l'affichage mobile
      const OUT=600;
      const c=document.createElement('canvas');c.width=OUT;c.height=OUT;
      const ctx=c.getContext('2d');
      ctx.fillStyle='#111';ctx.fillRect(0,0,OUT,OUT);
      ctx.drawImage(img,sx,sy,s,s,0,0,OUT,OUT);
      // Qualit√© adaptative : si > 200ko on r√©duit encore
      let result=c.toDataURL('image/jpeg',0.80);
      if(result.length>270000){
        // R√©duire √† 400px
        const c2=document.createElement('canvas');c2.width=400;c2.height=400;
        c2.getContext('2d').drawImage(c,0,0,400,400);
        result=c2.toDataURL('image/jpeg',0.75);
      }
      res(result);
    };
    img.onerror=()=>res(b64);img.src=b64;
  });
}

async function callGemini(b64){
  try{
    const mime=b64.startsWith('data:image/png')?'image/png':'image/jpeg';
    const r=await fetch('https://analyzeimage-xjtnixfrra-uc.a.run.app',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageBase64:b64.split(',')[1],mimeType:mime})});
    const d=await r.json();
    if(d.error){toast('IA:'+d.error);resetScan();return;}
    showResult(d,b64);
  }catch(e){toast('IA:'+e.message);resetScan();}
}

function showResult(d,img){
  document.getElementById('scan-spin').classList.add('hidden');
  document.getElementById('scan-line').classList.add('hidden');
  document.getElementById('res-thumb').src=img;
  document.getElementById('ai-name').value=d.title||'';
  document.getElementById('ai-price').innerText=(d.price||0)+'‚Ç¨';
  document.getElementById('ai-cat').innerText=d.category||'';
  document.getElementById('ai-desc').value=d.description||'';
  document.getElementById('ai-cond').innerText=d.condition||'';
  document.getElementById('ai-brand').innerText=d.brand||'‚Äî';
  document.getElementById('ai-model').innerText=d.model||'‚Äî';
  scanData={itemName:d.title,price:d.price,category:d.category,condition:d.condition||'Bon √©tat',description:d.description||'',brand:d.brand||'',model:d.model||'',imageUrl:img,shipping:[]};
  document.getElementById('step-photo').classList.add('hidden');
  document.getElementById('step-result').classList.remove('hidden');
  document.getElementById('step-result').classList.add('flex');
}

window.updShip=()=>{
  if(!scanData)return;
  const o=[];
  if(document.getElementById('sh-hand')?.checked)o.push({method:'Remise en main propre',price:0});
  if(document.getElementById('sh-relay')?.checked)o.push({method:'Mondial Relay',price:parseFloat(document.getElementById('sh-relay-p').value)||5});
  if(document.getElementById('sh-colis')?.checked)o.push({method:'Colissimo',price:parseFloat(document.getElementById('sh-colis-p').value)||8});
  scanData.shipping=o;
};

document.getElementById('pub-btn').addEventListener('click',async()=>{
  if(!scanData||!me)return;
  updShip();
  const btn=document.getElementById('pub-btn');
  btn.innerText='Publication...';btn.disabled=true;
  try{
    const city=document.getElementById('item-city').value.trim();
    await addDoc(collection(db,'scans'),{
      userId:me.uid,
      itemName:document.getElementById('ai-name').value,
      price:scanData.price,category:scanData.category,
      condition:scanData.condition,description:document.getElementById('ai-desc').value,
      brand:scanData.brand,model:scanData.model,shipping:scanData.shipping,
      city,imageUrl:scanData.imageUrl,createdAt:serverTimestamp()
    });
    closeScan();switchView('home');
    toast('‚úÖ Annonce publi√©e !',true);
  }catch(e){toast('Erreur:'+e.message);btn.innerText="Publier l'annonce";btn.disabled=false;}
});

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ
window.openDetail=id=>{
  const i=items.find(x=>x.id===id);if(!i)return;curItem=i;
  document.getElementById('det-img').src=i.imageUrl||'';
  document.getElementById('det-title').innerText=i.itemName||'';
  document.getElementById('det-price').innerText=(i.price||0)+'‚Ç¨';
  document.getElementById('det-cat').innerText=i.category||'';
  document.getElementById('det-cond').innerText=i.condition||'';
  document.getElementById('det-desc').innerText=i.description||'Aucune description.';
  document.getElementById('det-seller').innerText='Vendeur #'+(i.userId||'').slice(0,6);
  document.getElementById('det-brand').innerText=[i.brand,i.model].filter(Boolean).join(' ‚Äî ');
  const ct=document.getElementById('det-city-tag');
  if(i.city){document.getElementById('det-city-val').innerText=i.city;ct.classList.remove('hidden');}else ct.classList.add('hidden');
  const sh=document.getElementById('det-ship');
  sh.innerHTML=i.shipping?.length?i.shipping.map(s=>`<span style="background:#1c1c1c;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:5px 10px;font-size:11px;font-weight:700">${s.method} <span style="color:#22d3ee">${s.price===0?'Gratuit':s.price+'‚Ç¨'}</span></span>`).join(''):'<span style="font-size:12px;color:#52525b">Non renseign√©</span>';
  document.getElementById('contact-btn').onclick=()=>openChat(i);
  document.getElementById('buy-btn').onclick=()=>openPay(i);
  loadSellerRating(i.userId);
  const m=document.getElementById('detail-modal');m.classList.remove('hidden');m.classList.add('flex');
};
window.closeDetail=()=>{const m=document.getElementById('detail-modal');m.classList.add('hidden');m.classList.remove('flex');};

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ
window.openChat=i=>{
  curItem=i;
  document.getElementById('chat-seller').innerText='Vendeur #'+(i.userId||'').slice(0,6);
  document.getElementById('chat-iname').innerText=i.itemName||'';
  document.getElementById('chat-iprice').innerText=(i.price||0)+'‚Ç¨';
  document.getElementById('chat-img').src=i.imageUrl||'';
  document.getElementById('chat-msgs').innerHTML='<div style="text-align:center;padding:16px 0"><span style="font-size:10px;color:#52525b;background:#1c1c1c;padding:4px 12px;border-radius:99px;font-weight:700;text-transform:uppercase">D√©but de conversation</span></div>';
  const m=document.getElementById('chat-modal');m.classList.remove('hidden');m.classList.add('flex');
  closeDetail();
};
window.closeChat=()=>{const m=document.getElementById('chat-modal');m.classList.add('hidden');m.classList.remove('flex');};
window.sendMsg=()=>{
  const inp=document.getElementById('chat-inp'),t=inp.value.trim();if(!t)return;
  addBubble(t,true);inp.value='';
  const reps=["Oui, disponible üòä","Je peux baisser un peu.","Envoi en Mondial Relay possible.","Article en parfait √©tat.","Je peux envoyer d'autres photos."];
  setTimeout(()=>addBubble(reps[Math.floor(Math.random()*reps.length)],false),1100);
};
window.qMsg=m=>{document.getElementById('chat-inp').value=m;sendMsg();};
function addBubble(t,mine){
  const el=document.getElementById('chat-msgs');
  const d=document.createElement('div');d.className='flex '+(mine?'justify-end':'justify-start');
  d.innerHTML=`<div class="max-w-[72%] px-4 py-2 text-sm font-medium ${mine?'bme':'bthem'}">${t}</div>`;
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}

// ‚îÄ‚îÄ STRIPE ‚îÄ‚îÄ
window.openPay=i=>{
  payItem=i;selShip=null;
  document.getElementById('pay-img').style.backgroundImage=`url(${i.imageUrl})`;
  document.getElementById('pay-title').innerText=i.itemName;
  document.getElementById('pay-price').innerText=i.price+'‚Ç¨';
  document.getElementById('pay-sub').innerText=i.price+'‚Ç¨';
  document.getElementById('pay-shipcost').innerText='‚Äî';
  document.getElementById('pay-total').innerText=i.price+'‚Ç¨';
  const wrap=document.getElementById('pay-ship-wrap'),list=document.getElementById('pay-ship-list');
  if(i.shipping?.length){
    wrap.classList.remove('hidden');
    list.innerHTML=i.shipping.map((s,idx)=>`<label style="display:flex;align-items:center;gap:10px;background:#1c1c1c;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px 12px;cursor:pointer">
      <input type="radio" name="ship" value="${idx}" onchange="selShipping(${idx})" style="accent-color:#22d3ee">
      <span style="font-size:13px;font-weight:600;flex:1">${s.method}</span>
      <span style="font-size:13px;font-weight:800;color:#22d3ee">${s.price===0?'Gratuit':s.price+'‚Ç¨'}</span>
    </label>`).join('');
  }else wrap.classList.add('hidden');
  const m=document.getElementById('pay-modal');m.classList.remove('hidden');m.classList.add('flex');
  closeDetail();
};
window.selShipping=idx=>{
  selShip=payItem.shipping[idx];
  const tot=(parseFloat(payItem.price)||0)+selShip.price;
  document.getElementById('pay-shipcost').innerText=selShip.price===0?'Gratuit':selShip.price+'‚Ç¨';
  document.getElementById('pay-total').innerText=tot+'‚Ç¨';
};
window.closePay=()=>{const m=document.getElementById('pay-modal');m.classList.add('hidden');m.classList.remove('flex');};
window.doStripe=async()=>{
  if(!payItem||!me)return;
  if(payItem.shipping?.length&&!selShip){toast('Choisissez un mode de livraison');return;}
  const btn=document.getElementById('stripe-btn');btn.innerHTML='<i class="fa-solid fa-circle-notch animate-spin mr-2"></i>Redirection...';btn.disabled=true;
  try{
    const shipCost=selShip?selShip.price:0;
    const tot=(parseFloat(payItem.price)||0)+shipCost;
    const r=await fetch('https://createpayment-xjtnixfrra-uc.a.run.app',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:tot,itemName:payItem.itemName,itemId:payItem.id,buyerId:me.uid,sellerId:payItem.userId})});
    const d=await r.json();
    if(d.error){toast('Stripe:'+d.error);return;}
    await addDoc(collection(db,'notifications'),{userId:payItem.userId,type:'payment_initiated',message:`Paiement pour "${payItem.itemName}"`,itemId:payItem.id,read:false,createdAt:serverTimestamp()});
    window.location.href=d.url;
  }catch(e){toast('Erreur:'+e.message);}
  btn.innerHTML='<i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant';btn.disabled=false;
};

function checkPayReturn(){
  const p=new URLSearchParams(window.location.search);
  if(p.get('payment')!=='success')return;
  history.replaceState({},'','/');
  const iid=p.get('itemId'),sid=p.get('sellerId');
  setTimeout(async()=>{
    if(!me)return;
    try{
      await addDoc(collection(db,'notifications'),{userId:me.uid,type:'payment_success',message:'Paiement valid√© ! Contactez le vendeur.',itemId:iid||'',read:false,createdAt:serverTimestamp()});
      if(sid)await addDoc(collection(db,'notifications'),{userId:sid,type:'sale',message:"Votre article vient d'√™tre achet√© !",itemId:iid||'',read:false,createdAt:serverTimestamp()});
      rateCtx={targetUserId:sid,role:'buyer',itemId:iid||''};
      setTimeout(()=>openRate('vendeur'),2000);
    }catch{}
  },1500);
}

// ‚îÄ‚îÄ NOTIFS ‚îÄ‚îÄ
function initNotifs(){
  if(!me)return;
  const q=query(collection(db,'notifications'),where('userId','==',me.uid),orderBy('createdAt','desc'));
  onSnapshot(q,snap=>{
    const list=[];snap.forEach(d=>list.push({id:d.id,...d.data()}));
    const unread=list.filter(n=>!n.read).length;
    const b=document.getElementById('nbadge');
    b.classList.toggle('hidden',unread===0);if(unread)b.innerText=unread;
    const icons={payment_success:'‚úÖ',payment_initiated:'üí≥',sale:'üéâ',rating:'‚≠ê'};
    document.getElementById('notif-list').innerHTML=list.length?list.map(n=>`
      <div onclick="markRead('${n.id}')" style="background:#161616;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;margin-bottom:8px;cursor:pointer;opacity:${n.read?.5:1}">
        <div style="display:flex;gap:10px;align-items:flex-start">
          <span style="font-size:18px">${icons[n.type]||'üîî'}</span>
          <div style="flex:1">
            <p style="font-size:13px;font-weight:700;margin-bottom:3px">${n.message}</p>
            <p style="font-size:10px;color:#52525b">${n.createdAt?new Date(n.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):''}</p>
          </div>
          ${!n.read?'<span style="width:7px;height:7px;background:#22d3ee;border-radius:99px;margin-top:3px;flex-shrink:0"></span>':''}
        </div>
      </div>`).join(''):'<p style="text-align:center;color:#3f3f46;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>';
  });
}
window.markRead=async id=>updateDoc(doc(db,'notifications',id),{read:true});

// ‚îÄ‚îÄ NOTATION ‚îÄ‚îÄ
window.openRate=role=>{
  curStar=0;
  document.querySelectorAll('.star').forEach(s=>{s.style.color='#3f3f46';s.style.transform='scale(1)';});
  document.getElementById('rate-comment').value='';
  document.getElementById('rate-sub').innerText=role==='buyer'?"Comment s'est comport√© l'acheteur ?":"Comment √©tait le vendeur ?";
  const m=document.getElementById('rate-modal');m.classList.remove('hidden');m.classList.add('flex');
};
window.closeRate=()=>{const m=document.getElementById('rate-modal');m.classList.add('hidden');m.classList.remove('flex');};
window.setStar=v=>{
  curStar=v;
  document.querySelectorAll('.star').forEach(s=>{const sv=parseInt(s.dataset.v);s.style.color=sv<=v?'#facc15':'#3f3f46';s.style.transform=sv<=v?'scale(1.15)':'scale(1)';});
};
window.submitRate=async()=>{
  if(!curStar){toast('Choisissez une note');return;}
  if(!rateCtx)return;
  try{
    await addDoc(collection(db,'ratings'),{targetUserId:rateCtx.targetUserId,fromUserId:me.uid,itemId:rateCtx.itemId,rating:curStar,comment:document.getElementById('rate-comment').value,createdAt:serverTimestamp()});
    await updUserRating(rateCtx.targetUserId);
    await addDoc(collection(db,'notifications'),{userId:rateCtx.targetUserId,type:'rating',message:`Vous avez re√ßu une note de ${curStar}‚òÖ`,read:false,createdAt:serverTimestamp()});
    closeRate();toast('‚≠ê Note envoy√©e !',true);
  }catch(e){toast('Erreur:'+e.message);}
};
async function updUserRating(uid){
  try{
    const s=await getDocs(query(collection(db,'ratings'),where('targetUserId','==',uid)));
    const r=[];s.forEach(d=>r.push(d.data().rating));
    if(!r.length)return;
    const avg=(r.reduce((a,b)=>a+b,0)/r.length).toFixed(1);
    await updateDoc(doc(db,'users',uid),{rating:parseFloat(avg),ratingCount:r.length});
  }catch{}
}
async function loadSellerRating(uid){
  try{
    const d=await getDoc(doc(db,'users',uid));
    const el=document.getElementById('det-rating');
    if(d.exists()&&d.data().rating){const r=d.data().rating,n=d.data().ratingCount||0;el.innerText='‚òÖ'.repeat(Math.round(r))+'‚òÜ'.repeat(5-Math.round(r))+` ${r}/5 (${n} avis)`;}
    else el.innerText='Nouveau vendeur';
  }catch{}
}
async function loadMyRating(){
  if(!me)return;
  try{const d=await getDoc(doc(db,'users',me.uid));if(d.exists()&&d.data().rating)document.getElementById('profile-rating').innerText='‚òÖ'+d.data().rating;}catch{}
}

// ‚îÄ‚îÄ EDIT / DELETE ‚îÄ‚îÄ
window.openEdit=id=>{
  const i=items.find(x=>x.id===id);if(!i)return;
  editingId=id;
  document.getElementById('edit-title').value=i.itemName||'';
  document.getElementById('edit-price').value=i.price||0;
  document.getElementById('edit-desc').value=i.description||'';
  document.getElementById('edit-cond').value=i.condition||'Bon √©tat';
  document.getElementById('edit-cat').value=i.category||'Divers';
  const m=document.getElementById('edit-modal');m.classList.remove('hidden');m.classList.add('flex');
};
window.closeEdit=()=>{const m=document.getElementById('edit-modal');m.classList.add('hidden');m.classList.remove('flex');editingId=null;};
window.saveEdit=async()=>{
  if(!editingId)return;
  const btn=document.getElementById('edit-save');btn.innerText='Sauvegarde...';btn.disabled=true;
  try{
    await updateDoc(doc(db,'scans',editingId),{
      itemName:document.getElementById('edit-title').value,
      price:parseFloat(document.getElementById('edit-price').value)||0,
      description:document.getElementById('edit-desc').value,
      condition:document.getElementById('edit-cond').value,
      category:document.getElementById('edit-cat').value
    });closeEdit();
  }catch(e){toast('Erreur:'+e.message);}
  btn.innerText='Sauvegarder';btn.disabled=false;
};
window.confirmDel=id=>{deletingId=id;closeEdit();const m=document.getElementById('del-modal');m.classList.remove('hidden');m.classList.add('flex');};
window.closeDel=()=>{const m=document.getElementById('del-modal');m.classList.add('hidden');m.classList.remove('flex');deletingId=null;};
window.doDelete=async()=>{
  if(!deletingId)return;
  try{await deleteDoc(doc(db,'scans',deletingId));closeDel();}
  catch(e){toast('Erreur:'+e.message);}
};
</script>
</body>
</html>
