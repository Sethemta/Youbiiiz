<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Youbiiiz</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
*{box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#f0f2f5;color:#1a1a2e;overflow:hidden;-webkit-tap-highlight-color:transparent;touch-action:manipulation}

/* LOGO */
.brand-logo{display:inline-flex;align-items:baseline;font-weight:800;user-select:none;color:#1a1a2e}
.i-wrapper{display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px}
.i-stem{width:12px;height:38px;background:#0ea5e9;border-radius:2px}
.i-dot{width:12px;height:12px;background:#0ea5e9;border-radius:2px;position:absolute;bottom:48px;box-shadow:0 0 16px rgba(14,165,233,.6)}
.i-char{position:relative;display:flex;flex-direction:column;align-items:center}
header .i-stem{width:5px;height:16px}
header .i-dot{width:5px;height:5px;bottom:20px;box-shadow:none}
header .i-wrapper{gap:2px;margin:0 2px}
@keyframes dribble{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(var(--b));animation-timing-function:cubic-bezier(0,0,.2,1)}}
.i-char:nth-child(1) .i-dot{--b:-10px;animation:dribble .9s infinite}
.i-char:nth-child(2) .i-dot{--b:-15px;animation:dribble 1.3s infinite .2s}
.i-char:nth-child(3) .i-dot{--b:-12px;animation:dribble 1.1s infinite .5s}

/* UTILS */
.no-sb{-ms-overflow-style:none;scrollbar-width:none}
.no-sb::-webkit-scrollbar{display:none}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fi .25s ease-out forwards}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.su{animation:su .3s cubic-bezier(.16,1,.3,1) forwards}
@keyframes sr{from{transform:translateX(100%)}to{transform:translateX(0)}}
.sr{animation:sr .28s cubic-bezier(.16,1,.3,1) forwards}
@keyframes ld{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
@keyframes scanmove{0%{top:0;opacity:0}10%{opacity:1}90%{opacity:1}100%{top:100%;opacity:0}}

/* CARDS */
.card{background:#fff;border:none;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .12s,box-shadow .12s;box-shadow:0 2px 12px rgba(0,0,0,.08)}
.card:active{transform:scale(.96)}
.card:hover{box-shadow:0 6px 24px rgba(0,0,0,.12)}
.sq{width:100%;aspect-ratio:1/1;background:#f8fafc;overflow:hidden;position:relative}
.sq img{width:100%;height:100%;object-fit:contain;background:#f8fafc}
.inf{padding:8px 10px 12px}

/* INPUTS */
.inp{width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:12px;padding:11px 13px;color:#1a1a2e;font-size:14px;font-weight:600;outline:none;transition:border-color .15s;font-family:inherit}
.inp:focus{border-color:#0ea5e9;background:#fff}
.inp::placeholder{color:#94a3b8}

/* CHIPS */
.chip{padding:6px 14px;border-radius:99px;font-size:11px;font-weight:700;border:1.5px solid #e2e8f0;color:#64748b;white-space:nowrap;cursor:pointer;transition:all .12s;background:#fff}
.chip.on{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 2px 8px rgba(14,165,233,.3)}

/* SEARCH BAR */
.sbar{background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}

/* MODALS */
.mover{background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
.msheet{background:#fff;border-radius:24px 24px 0 0;border-top:none;box-shadow:0 -4px 32px rgba(0,0,0,.12)}

/* CHAT BUBBLES */
.bme{background:#0ea5e9;color:#fff;border-radius:18px 18px 4px 18px}
.bthem{background:#f1f5f9;border:none;color:#1a1a2e;border-radius:18px 18px 18px 4px}

/* DEBUG */
#dbg{display:none;position:fixed;top:12px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:7px 18px;border-radius:99px;font-size:11px;font-weight:700;z-index:9999;max-width:90%;text-align:center}

/* LOGO UNIVERSEL */
.yb-logo{display:inline-flex;align-items:baseline;font-weight:800;letter-spacing:-1px;line-height:1;user-select:none}
.yb-logo .yb-i-group{display:inline-flex;align-items:flex-end;margin:0 0.08em}
.yb-logo .yb-i{display:flex;flex-direction:column;align-items:center;gap:0}
.yb-logo .yb-i .dot{border-radius:2px;margin-bottom:0.06em;flex-shrink:0}
.yb-logo .yb-i .stem{border-radius:2px;flex-shrink:0}

/* WHATNOT LAYOUT */
#app{display:flex;flex-direction:column}
.app-body{display:flex;flex:1;overflow:hidden}
.sidebar{width:220px;flex-shrink:0;background:#fff;border-right:1px solid #e8ecf0;overflow-y:auto;display:flex;flex-direction:column}
.sidebar-nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border-radius:10px;margin:1px 8px;transition:all .12s}
.sidebar-nav-item:hover{background:#f1f5f9;color:#0f172a}
.sidebar-nav-item.active{background:#eff9ff;color:#0ea5e9;font-weight:700}
.sidebar-nav-item .icon{width:20px;text-align:center;font-size:13px}
.sidebar-section-title{font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;padding:12px 24px 4px}
.main-content{flex:1;overflow-y:auto;background:#f4f6f8}
@media(max-width:768px){
  .sidebar{display:none}
  .main-content{padding-bottom:72px}
}
@media(min-width:769px){
  nav.bottom-nav{display:none!important}
}

/* HEADER WHATNOT STYLE */
.yb-header{background:#fff;border-bottom:1px solid #e8ecf0;padding:0 20px;height:56px;display:flex;align-items:center;gap:12px;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.yb-search{flex:1;max-width:520px;background:#f4f6f8;border:1.5px solid #e8ecf0;border-radius:10px;display:flex;align-items:center;gap:8px;padding:0 12px;height:38px;transition:border-color .15s}
.yb-search:focus-within{border-color:#0ea5e9;background:#fff}
.yb-search input{flex:1;background:none;border:none;outline:none;font-size:13px;font-weight:500;color:#1a1a2e;font-family:inherit}
.yb-search input::placeholder{color:#94a3b8}
.yb-icon-btn{width:38px;height:38px;border-radius:10px;background:#f4f6f8;border:1.5px solid #e8ecf0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;flex-shrink:0}
.yb-icon-btn:hover{background:#eff9ff;border-color:#0ea5e9;color:#0ea5e9}

/* PILL TABS */
.cat-pills{display:flex;gap:6px;overflow-x:auto;padding:12px 16px 6px;scrollbar-width:none}
.cat-pills::-webkit-scrollbar{display:none}
.cat-pill{padding:6px 14px;border-radius:99px;font-size:12px;font-weight:700;border:1.5px solid #e2e8f0;color:#64748b;white-space:nowrap;cursor:pointer;transition:all .12s;background:#fff;flex-shrink:0}
.cat-pill.on{background:#0ea5e9;color:#fff;border-color:#0ea5e9;box-shadow:0 2px 8px rgba(14,165,233,.3)}

/* CARD GRID */
.feed-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:8px 16px 24px}
@media(min-width:900px){.feed-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
@media(min-width:1200px){.feed-grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}}

/* MAP MARKERS */
@keyframes dotBounce{0%,100%{transform:translateY(0);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(-6px);animation-timing-function:cubic-bezier(0,0,.2,1)}}
.yb-marker{display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform .15s}
.yb-marker:hover{transform:scale(1.2)}
.yb-marker:hover .yb-dot{animation:dotBounce .7s infinite}
.yb-stem{width:5px;height:18px;background:#0ea5e9;border-radius:2px;box-shadow:0 0 8px rgba(14,165,233,.5)}
.yb-dot{width:5px;height:5px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;box-shadow:0 0 8px rgba(14,165,233,.5)}
.yb-price{background:#fff;color:#0ea5e9;font-size:10px;font-weight:900;padding:2px 6px;border-radius:6px;border:1.5px solid #0ea5e9;white-space:nowrap;margin-top:3px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.yb-pin{display:flex;flex-direction:column;align-items:center}
</style>
</head>
<body>
<div id="dbg"></div>

<!-- SPLASH / LANDING -->
<div id="splash" class="fixed inset-0 z-[999]" style="background:#f0f2f5;display:flex;align-items:stretch">

  <!-- GAUCHE: demo visuelle -->
  <div id="landing-left" style="flex:1;background:linear-gradient(150deg,#0f172a 0%,#1e3a5f 55%,#0369a1 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px 32px;position:relative;overflow:hidden;min-width:0">
    <!-- Blobs deco -->
    <div style="position:absolute;top:-100px;right:-100px;width:350px;height:350px;background:rgba(14,165,233,.18);border-radius:50%;filter:blur(50px);pointer-events:none"></div>
    <div style="position:absolute;bottom:-80px;left:-80px;width:250px;height:250px;background:rgba(99,102,241,.15);border-radius:50%;filter:blur(40px);pointer-events:none"></div>

    <!-- LOGO GRAND BLANC VISIBLE -->
    <div style="margin-bottom:24px">
      <div style="display:inline-flex;align-items:flex-end;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:48px;color:#ffffff;letter-spacing:-1px;user-select:none;line-height:1">
        <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:5px;margin:0 5px 6px 5px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble .9s infinite;--b:-12px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble 1.3s infinite .2s;--b:-16px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:6px;height:6px;background:#fff;border-radius:2px;margin-bottom:2px;display:block;box-shadow:0 0 12px rgba(255,255,255,.9);animation:dribble 1.1s infinite .5s;--b:-14px"></span><span style="width:6px;height:35px;background:#fff;border-radius:2px;display:block;box-shadow:0 0 8px rgba(255,255,255,.5)"></span></span></span>
        <span>Z</span>
      </div>
      <p style="color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:5px;letter-spacing:.3px">Le marketplace IA nouvelle g√©n√©ration</p>
    </div>

    <h1 style="color:#fff;font-size:32px;font-weight:800;line-height:1.25;margin-bottom:32px">Vends et ach√®te<br><span style="color:#38bdf8">plus intelligemment.</span></h1>

    <!-- Cartes flottantes -->
    <div style="position:relative;height:480px;width:100%;max-width:420px">
      <div style="position:absolute;left:0;top:0;background:#fff;border-radius:22px;padding:14px;width:260px;box-shadow:0 20px 60px rgba(0,0,0,.4);transform:rotate(-5deg);animation:floatA 4s ease-in-out infinite">
        <div style="height:170px;background:#f1f5f9;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:10px"><i class="fa-solid fa-mobile-screen" style="font-size:64px;color:#94a3b8"></i></div>
        <p style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:2px">iPhone 14 Pro</p>
        <p style="font-size:18px;font-weight:900;color:#0ea5e9">750‚Ç¨</p>
        <div style="position:absolute;top:10px;right:10px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:800;padding:2px 5px;border-radius:99px">Neuf</div>
      </div>
      <div style="position:absolute;left:140px;top:24px;background:#fff;border-radius:22px;padding:14px;width:260px;box-shadow:0 20px 60px rgba(0,0,0,.4);transform:rotate(3deg);animation:floatB 5s ease-in-out infinite">
        <div style="height:170px;background:#fef9c3;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:10px"><i class="fa-brands fa-playstation" style="font-size:68px;color:#1e293b"></i></div>
        <p style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:2px">PS5 + manette</p>
        <p style="font-size:18px;font-weight:900;color:#0ea5e9">430‚Ç¨</p>
        <div style="position:absolute;top:10px;right:10px;background:#22c55e;color:#fff;font-size:7px;font-weight:800;padding:2px 5px;border-radius:99px">‚óè Live</div>
      </div>
      <div style="position:absolute;left:8px;top:300px;background:#fff;border-radius:22px;padding:14px;width:220px;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:floatC 6s ease-in-out infinite">
        <div style="height:120px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-radius:14px;margin-bottom:10px;position:relative;display:flex;align-items:center;justify-content:center">
          <i class="fa-solid fa-map" style="font-size:26px;color:#3b82f6;opacity:.3"></i>
          <div style="position:absolute;top:14px;left:28px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">180‚Ç¨</div>
          <div style="position:absolute;top:36px;right:18px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">430‚Ç¨</div>
          <div style="position:absolute;bottom:10px;left:55px;background:#0ea5e9;color:#fff;font-size:7px;font-weight:900;padding:2px 4px;border-radius:99px">95‚Ç¨</div>
        </div>
        <p style="font-size:10px;font-weight:700;color:#64748b"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;margin-right:3px"></i>Annonces pr√®s de toi</p>
      </div>
      <div style="position:absolute;right:8px;top:310px;background:linear-gradient(135deg,#0ea5e9,#6366f1);border-radius:16px;padding:14px 18px;box-shadow:0 8px 24px rgba(14,165,233,.5);animation:floatA 3.5s ease-in-out infinite reverse">
        <p style="color:#fff;font-size:13px;font-weight:800;margin-bottom:2px"><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:5px"></i>IA Gemini</p>
        <p style="color:rgba(255,255,255,.6);font-size:11px">Prix estim√© en 3s</p>
      </div>
    </div>
  </div>

  <!-- DROITE: auth -->
  <div id="landing-right" style="width:100%;max-width:400px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 32px;overflow-y:auto">

    <!-- Logo mobile only -->
    <div id="logo-mobile" style="margin-bottom:28px">
      <div style="display:inline-flex;align-items:flex-end;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:32px;color:#0f172a;letter-spacing:-1px;line-height:1">
        <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:4px;margin:0 4px 4px 4px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble .9s infinite;--b:-9px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble 1.3s infinite .2s;--b:-11px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:4px;height:4px;background:#0ea5e9;border-radius:2px;margin-bottom:2px;display:block;animation:dribble 1.1s infinite .5s;--b:-10px"></span><span style="width:4px;height:23px;background:#0ea5e9;border-radius:2px;display:block"></span></span></span>
        <span>Z</span>
      </div>
    </div>

    <div style="width:100%;max-width:320px">

      <!-- Toggle login/register -->
      <div style="display:flex;background:#f1f5f9;border-radius:12px;padding:4px;margin-bottom:24px">
        <button id="tab-login" onclick="showTab('login')" style="flex:1;padding:8px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;background:#fff;color:#0f172a;box-shadow:0 1px 4px rgba(0,0,0,.1);transition:all .15s">Connexion</button>
        <button id="tab-register" onclick="showTab('register')" style="flex:1;padding:8px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;background:transparent;color:#94a3b8;transition:all .15s">Cr√©er un compte</button>
      </div>

      <!-- CONNEXION -->
      <div id="panel-login">
        <h2 style="font-size:22px;font-weight:800;color:#0f172a;margin-bottom:4px">Bon retour !</h2>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:20px;font-weight:500">Connecte-toi √† ton compte Youbiiiz</p>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Email</label>
          <input id="login-email" type="email" placeholder="ton@email.com" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:20px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Mot de passe</label>
          <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter')doLogin()">
        </div>
        <button onclick="doLogin()" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-size:14px;font-weight:800;padding:13px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,.4);margin-bottom:12px;transition:opacity .15s" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">Se connecter</button>
        <button onclick="doGoogle()" style="width:100%;background:#fff;color:#1e293b;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Continuer avec Google
        </button>
        <div style="text-align:center">
          <button onclick="doAnon()" style="background:none;border:none;font-size:11px;color:#94a3b8;cursor:pointer;font-family:inherit;text-decoration:underline">Continuer sans compte</button>
        </div>
      </div>

      <!-- INSCRIPTION -->
      <div id="panel-register" style="display:none">
        <h2 style="font-size:22px;font-weight:800;color:#0f172a;margin-bottom:4px">Cr√©er un compte</h2>
        <p style="font-size:12px;color:#94a3b8;margin-bottom:20px;font-weight:500">Rejoins des milliers de vendeurs</p>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Email</label>
          <input id="reg-email" type="email" placeholder="ton@email.com" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Mot de passe</label>
          <input id="reg-password" type="password" placeholder="Min. 6 caract√®res" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
        <div style="margin-bottom:20px">
          <label style="font-size:11px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">Confirmer</label>
          <input id="reg-confirm" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:11px;padding:11px 13px;color:#0f172a;font-size:14px;font-weight:600;outline:none;font-family:inherit;transition:border-color .15s" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter')doRegister()">
        </div>
        <button onclick="doRegister()" style="width:100%;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-size:14px;font-weight:800;padding:13px;border-radius:12px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,.4);margin-bottom:12px;transition:opacity .15s" onmouseover="this.style.opacity='.9'" onmouseout="this.style.opacity='1'">Cr√©er mon compte</button>
        <button onclick="doGoogle()" style="width:100%;background:#fff;color:#1e293b;font-size:13px;font-weight:700;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#fff'">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Continuer avec Google
        </button>
      </div>

      <!-- Message erreur/info -->
      <div id="auth-msg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:10px;font-size:12px;font-weight:700;text-align:center"></div>
    </div>
  </div>
</div>

<style>
@keyframes floatA{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-12px) rotate(-5deg)}}
@keyframes floatB{0%,100%{transform:translateY(0) rotate(3deg)}50%{transform:translateY(-16px) rotate(3deg)}}
@keyframes floatC{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
</style>

<!-- APP -->
<div id="app" class="hidden opacity-0 transition-opacity duration-500 fixed inset-0 flex flex-col" style="background:#f4f6f8">

  <!-- HEADER WHATNOT STYLE -->
  <header class="yb-header shrink-0">
    <!-- Logo -->
    <div style="display:inline-flex;align-items:flex-end;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:20px;color:#0f172a;letter-spacing:-.5px;line-height:1;cursor:pointer;user-select:none;flex-shrink:0;margin-right:8px" onclick="switchView('home')">
      <span>YOUB</span><span style="display:inline-flex;align-items:flex-end;gap:2px;margin:0 2px 2px 2px;line-height:0"><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble .9s infinite;--b:-6px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble 1.3s infinite .2s;--b:-8px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span><span style="display:inline-flex;flex-direction:column;align-items:center"><span style="width:3px;height:3px;background:#0ea5e9;border-radius:1px;margin-bottom:1px;display:block;animation:dribble 1.1s infinite .5s;--b:-7px"></span><span style="width:3px;height:14px;background:#0ea5e9;border-radius:1px;display:block"></span></span></span>
      <span>Z</span>
    </div>

    <!-- Search -->
    <div class="yb-search" style="flex:1;max-width:520px">
      <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;font-size:12px;flex-shrink:0"></i>
      <input id="header-search" type="text" placeholder="Rechercher des annonces..." oninput="applyFilters()">
    </div>

    <div style="flex:1"></div>

    <!-- Actions -->
    <button onclick="openScan()" style="background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;flex-shrink:0;box-shadow:0 2px 10px rgba(14,165,233,.35);transition:opacity .12s" onmouseover="this.style.opacity='.88'" onmouseout="this.style.opacity='1'">
      <i class="fa-solid fa-plus" style="font-size:11px"></i><span class="hidden md:inline">Vendre</span>
    </button>
    <button onclick="switchView('notifications')" class="yb-icon-btn relative" style="margin-left:6px">
      <i class="fa-solid fa-bell" style="font-size:14px;color:#475569"></i>
      <span id="nbadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white" style="font-size:9px;font-weight:900;display:none;align-items:center;justify-content:center">0</span>
    </button>
    <button onclick="switchView('profile')" style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#6366f1);display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;flex-shrink:0;margin-left:6px">
      <i class="fa-solid fa-user" style="color:#fff;font-size:12px"></i>
    </button>
  </header>

  <!-- APP BODY = SIDEBAR + MAIN -->
  <div class="app-body">

    <!-- SIDEBAR -->
    <aside class="sidebar no-sb">
      <!-- Greeting -->
      <div style="padding:16px 16px 8px">
        <p style="font-size:13px;font-weight:800;color:#0f172a;margin-bottom:2px">Bonjour üëã</p>
        <p id="sidebar-uid" style="font-size:11px;color:#94a3b8;font-weight:500"></p>
      </div>

      <p class="sidebar-section-title">Navigation</p>
      <div class="sidebar-nav-item active" id="snav-home" onclick="switchView('home');setSidebarActive('snav-home')">
        <span class="icon"><i class="fa-solid fa-house"></i></span>Pour toi
      </div>
      <div class="sidebar-nav-item" id="snav-map" onclick="switchView('map');setSidebarActive('snav-map')">
        <span class="icon"><i class="fa-solid fa-map-location-dot"></i></span>Carte
      </div>
      <div class="sidebar-nav-item" id="snav-notif" onclick="switchView('notifications');setSidebarActive('snav-notif')">
        <span class="icon"><i class="fa-solid fa-bell"></i></span>Notifications
      </div>
      <div class="sidebar-nav-item" id="snav-profile" onclick="switchView('profile');setSidebarActive('snav-profile')">
        <span class="icon"><i class="fa-solid fa-user"></i></span>Mon profil
      </div>

      <p class="sidebar-section-title">Cat√©gories</p>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('all',this)"><span class="icon">‚ú®</span>Tout voir</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('High-Tech',this)"><span class="icon">üì±</span>High-Tech</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('Jeux video',this)"><span class="icon">üéÆ</span>Jeux vid√©o</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('Informatique',this)"><span class="icon">üíª</span>Informatique</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('Mode',this)"><span class="icon">üëï</span>Mode</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('Maison',this)"><span class="icon">üè†</span>Maison</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('Sport',this)"><span class="icon">‚öΩ</span>Sport</div>
      <div class="sidebar-nav-item" onclick="filterCatSidebar('Divers',this)"><span class="icon">üóÉÔ∏è</span>Divers</div>

      <!-- Ville filter -->
      <p class="sidebar-section-title">Localisation</p>
      <div style="padding:4px 12px 8px">
        <div style="position:relative">
          <i class="fa-solid fa-location-dot" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#0ea5e9;font-size:10px"></i>
          <input id="city-inp" type="text" placeholder="Ville..." oninput="applyFilters()"
            style="width:100%;background:#f4f6f8;border:1.5px solid #e2e8f0;border-radius:9px;padding:8px 10px 8px 28px;font-size:12px;font-weight:600;color:#1a1a2e;outline:none;font-family:inherit;transition:border-color .15s"
            onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='#e2e8f0'">
        </div>
      </div>

      <!-- Live badge -->
      <div style="margin:8px 12px;background:linear-gradient(135deg,rgba(14,165,233,.08),rgba(99,102,241,.08));border:1px solid rgba(14,165,233,.2);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:8px">
        <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;animation:pulse 1.5s infinite;flex-shrink:0"></span>
        <div>
          <p style="font-size:11px;font-weight:800;color:#0f172a">Live</p>
          <p style="font-size:10px;color:#64748b;font-weight:500">Annonces r√©centes</p>
        </div>
      </div>

      <!-- Footer sidebar -->
      <div style="flex:1"></div>
      <div style="padding:12px;border-top:1px solid #f1f5f9;margin-top:12px">
        <button onclick="doLogout()" style="width:100%;background:none;border:1px solid #fecaca;border-radius:9px;padding:8px;font-size:12px;font-weight:700;color:#ef4444;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-family:inherit">
          <i class="fa-solid fa-right-from-bracket" style="font-size:11px"></i>D√©connexion
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content no-sb" id="main-scroll">

    <!-- HOME -->
    <div id="view-home">
      <!-- Mobile only: category pills -->
      <div class="cat-pills md:hidden">
        <button class="cat-pill on" onclick="filterCat('all',this)">Tout</button>
        <button class="cat-pill" onclick="filterCat('High-Tech',this)">üì± High-Tech</button>
        <button class="cat-pill" onclick="filterCat('Jeux video',this)">üéÆ Jeux vid√©o</button>
        <button class="cat-pill" onclick="filterCat('Informatique',this)">üíª Informatique</button>
        <button class="cat-pill" onclick="filterCat('Mode',this)">üëï Mode</button>
        <button class="cat-pill" onclick="filterCat('Maison',this)">üè† Maison</button>
        <button class="cat-pill" onclick="filterCat('Sport',this)">‚öΩ Sport</button>
      </div>

      <!-- Section title -->
      <div style="padding:12px 16px 0;display:flex;align-items:center;justify-content:space-between">
        <p id="feed-section-title" style="font-size:16px;font-weight:800;color:#0f172a">Pour toi</p>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="width:7px;height:7px;background:#22c55e;border-radius:50%;display:inline-block;animation:pulse 1.5s infinite"></span>
          <span style="font-size:11px;color:#22c55e;font-weight:700">Live</span>
        </div>
      </div>

      <div id="feed" class="feed-grid">
        <div style="grid-column:1/-1;padding:56px 0;text-align:center">
          <i class="fa-solid fa-circle-notch animate-spin text-2xl" style="color:#94a3b8"></i>
        </div>
      </div>
    </div>

    <!-- CARTE -->
    <div id="view-map" class="hidden" style="position:relative;height:calc(100vh - 56px)">
      <div id="map-el" style="width:100%;height:100%;"></div>

      <!-- Compteur -->
      <div id="map-count" style="position:absolute;top:12px;left:12px;z-index:1000;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:6px 12px;font-size:11px;font-weight:700;color:#64748b;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.08);">
        <i class="fa-solid fa-circle" style="color:#0ea5e9;font-size:7px;margin-right:5px"></i><span id="map-count-txt">0 annonce</span>
      </div>

      <!-- Centrer -->
      <button onclick="centerMap()" style="position:absolute;top:12px;right:12px;z-index:1000;width:40px;height:40px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12)">
        <i class="fa-solid fa-location-crosshairs" style="color:#0ea5e9"></i>
      </button>

      <!-- Filtre rayon -->
      <div style="position:absolute;top:60px;right:12px;z-index:1000;display:flex;flex-direction:column;gap:6px;">
        <button onclick="setRadius(5)" id="r5" style="background:#0ea5e9;color:#000;border:none;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer">5km</button>
        <button onclick="setRadius(20)" id="r20" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">20km</button>
        <button onclick="setRadius(50)" id="r50" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">50km</button>
        <button onclick="setRadius(0)" id="r0" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;border-radius:10px;padding:5px 10px;font-size:10px;font-weight:800;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08)">Tout</button>
      </div>

      <!-- Popup annonce -->
      <div id="map-popup" class="hidden" style="position:absolute;bottom:16px;left:12px;right:12px;background:#fff;border:1px solid #e2e8f0;border-radius:20px;padding:12px;z-index:1000;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,.15)">
        <img id="map-pop-img" style="width:56px;height:56px;border-radius:12px;object-fit:contain;background:#f8f8f8;flex-shrink:0">
        <div style="flex:1;min-width:0">
          <p id="map-pop-name" style="font-size:13px;color:#1e293b;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px"></p>
          <p id="map-pop-price" style="font-size:16px;font-weight:900;color:#0ea5e9;margin-bottom:2px"></p>
          <p style="font-size:10px;color:#94a3b8"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;margin-right:3px;font-size:9px"></i><span id="map-pop-city-txt" style="color:#64748b"></span></p>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <button id="map-pop-btn" style="background:#0ea5e9;color:#000;font-size:12px;font-weight:700;padding:8px 14px;border-radius:12px;border:none;cursor:pointer">Voir</button>
          <button onclick="document.getElementById('map-popup').classList.add('hidden')" style="background:transparent;color:#94a3b8;font-size:10px;border:none;cursor:pointer">Fermer</button>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="view-notifications" class="hidden px-4 pt-5 pb-24">
      <h2 style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:16px">Notifications</h2>
      <div id="notif-list">
        <p style="text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>
      </div>
    </div>

    <!-- PROFIL -->
    <div id="view-profile" class="hidden px-4 pt-5 pb-24">
      <h2 style="font-size:18px;font-weight:800;color:#0f172a;margin-bottom:16px">Mon Profil</h2>
      <div style="background:#fff;border:1px solid #e8ecf0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-white"></i>
          </div>
          <div class="flex-1">
            <p class="font-extrabold text-sm" style="color:#0f172a">Mon Profil</p>
            <p id="profile-uid" style="font-size:10px;color:#94a3b8;font-family:monospace;margin-top:2px">...</p>
          </div>
          <p id="user-badge" style="font-size:9px;color:#94a3b8;font-family:monospace"></p>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div style="background:#f8fafc;border-radius:12px;padding:12px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-count" style="font-size:20px;font-weight:900;color:#0ea5e9">0</p>
            <p style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Annonces</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:12px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-total" style="font-size:20px;font-weight:900;color:#0f172a">0‚Ç¨</p>
            <p style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Valeur</p>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:12px;text-align:center;border:1px solid #e8ecf0">
            <p id="profile-rating" style="font-size:20px;font-weight:900;color:#f59e0b">-</p>
            <p style="font-size:9px;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:2px">Note</p>
          </div>
        </div>
      </div>
      <p style="font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px">Mes annonces</p>
      <button onclick="doLogout()" style="width:100%;background:#fff;border:1.5px solid #fecaca;border-radius:12px;padding:11px;font-size:13px;font-weight:700;color:#ef4444;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04);font-family:inherit"><i class="fa-solid fa-right-from-bracket"></i> Se d√©connecter</button>
      <div id="my-listings" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:10px;">
        <p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:32px 0">Aucune annonce</p>
      </div>
    </div>

    </main><!-- /main-content -->
  </div><!-- /app-body -->

  <!-- NAV MOBILE ONLY -->
  <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 h-16 flex items-center justify-around px-6 z-[100]" style="box-shadow:0 -2px 12px rgba(0,0,0,.08)">
    <button onclick="switchView('home')" id="nav-home">
      <i class="fa-solid fa-house text-xl text-sky-500"></i>
    </button>
    <button onclick="switchView('map')" id="nav-map">
      <i class="fa-solid fa-map-location-dot text-xl text-slate-400"></i>
    </button>
    <button onclick="openScan()" class="w-14 h-14 -mt-5 bg-gradient-to-br from-sky-400 to-blue-600 rounded-[18px] flex items-center justify-center shadow-[0_0_24px_rgba(34,211,238,.5)] border-[3px] border-white active:scale-90 transition-transform">
      <i class="fa-solid fa-plus text-xl text-white"></i>
    </button>
    <button onclick="switchView('notifications')" id="nav-notif">
      <i class="fa-solid fa-bell text-xl text-slate-400"></i>
    </button>
    <button onclick="switchView('profile')" id="nav-profile">
      <i class="fa-solid fa-user text-xl text-slate-400"></i>
    </button>
  </nav>
</div>

<!-- SCAN MODAL -->
<div id="scan-modal" class="fixed inset-0 z-[400] hidden flex-col justify-end">
  <div class="mover absolute inset-0" onclick="closeScan()"></div>
  <div class="relative msheet su w-full max-w-lg mx-auto" style="max-height:94vh;display:flex;flex-direction:column;">
    <div class="flex justify-center pt-3 pb-2 shrink-0">
      <div class="w-10 h-1 bg-zinc-700 rounded-full"></div>
    </div>

    <!-- ETAPE 1: photo -->
    <div id="step-photo" class="px-4 pb-5 shrink-0">
      <div class="flex items-center justify-between mb-3">
        <p class="font-extrabold text-[15px]">Nouvelle annonce</p>
        <button onclick="closeScan()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center">
          <i class="fa-solid fa-xmark text-sm"></i>
        </button>
      </div>
      <div id="scan-box" class="relative bg-slate-800 rounded-2xl overflow-hidden mx-auto mb-3" style="width:100%;max-width:340px;aspect-ratio:1/1;">
        <video id="cam-vid" class="hidden absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
        <img id="scan-prev" class="hidden absolute inset-0 w-full h-full object-cover">
        <div id="scan-line" class="hidden absolute w-full left-0 z-20" style="height:2px;background:#0ea5e9;box-shadow:0 0 10px #22d3ee;animation:scanmove 1.8s linear infinite"></div>
        <div id="scan-ph" class="absolute inset-0 flex flex-col items-center justify-center gap-3 pointer-events-none">
          <div class="w-14 h-14 rounded-2xl bg-slate-700 flex items-center justify-center">
            <i class="fa-solid fa-camera text-2xl text-slate-400"></i>
          </div>
          <p class="text-xs text-slate-400 font-semibold">Photo ou galerie</p>
        </div>
        <div id="scan-spin" class="hidden absolute inset-0 bg-black/75 z-30 flex flex-col items-center justify-center gap-3">
          <i class="fa-solid fa-circle-notch animate-spin text-sky-500 text-3xl"></i>
          <p class="text-xs text-sky-500 font-bold tracking-widest uppercase">Analyse IA...</p>
        </div>
      </div>
      <div id="photo-btns" class="flex gap-2">
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="onFile(event)">
        <button onclick="document.getElementById('file-input').click()"
          class="flex-1 bg-slate-700 border border-slate-600/30 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-image text-slate-300"></i> Galerie
        </button>
        <button id="cam-toggle" onclick="toggleCam()"
          class="flex-1 bg-slate-700 border border-slate-600/30 rounded-xl py-3 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-camera text-slate-300"></i> Camera
        </button>
        <button id="snap-btn" onclick="snapPhoto()" class="hidden flex-1 bg-sky-500 rounded-xl py-3 text-sm font-bold text-black flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-circle"></i> Capturer
        </button>
      </div>
    </div>

    <!-- ETAPE 2: resultats IA -->
    <div id="step-result" class="hidden flex-col flex-1 overflow-hidden">
      <div class="overflow-y-auto no-sb px-4 pb-6 flex-1">
        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-slate-600/30">
          <img id="res-thumb" class="w-16 h-16 rounded-xl object-cover border border-slate-600/40 shrink-0">
          <div class="flex-1 min-w-0">
            <p class="text-[10px] text-green-400 font-bold uppercase tracking-wide mb-1"><i class="fa-solid fa-check-circle mr-1"></i>IA terminee</p>
            <input id="ai-name" class="w-full bg-transparent text-sm font-extrabold text-white outline-none border-b border-white/10 pb-1 focus:border-cyan-400 truncate">
          </div>
          <button onclick="resetScan()" class="shrink-0 w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center text-slate-300 active:scale-90 transition-transform">
            <i class="fa-solid fa-rotate-left text-xs"></i>
          </button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Marque</p>
            <p id="ai-brand" class="text-sm font-extrabold text-sky-500">-</p>
          </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Modele</p>
            <p id="ai-model" class="text-sm font-extrabold text-white truncate">-</p>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Prix</p>
            <p id="ai-price" class="text-sm font-extrabold text-sky-500">-</p>
          </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Categorie</p>
            <p id="ai-cat" class="text-xs font-extrabold text-white">-</p>
          </div>
          <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30">
            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Etat</p>
            <p id="ai-cond" class="text-xs font-extrabold text-green-400">-</p>
          </div>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Description</p>
          <textarea id="ai-desc" rows="3" class="w-full bg-transparent text-xs text-slate-200 outline-none resize-none leading-relaxed font-medium"></textarea>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-2">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Ville</p>
          <div class="relative">
            <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-sky-500" style="font-size:10px"></i>
            <input id="item-city" type="text" placeholder="Ex : Paris, Lyon..." class="inp pl-7 py-2 text-sm" style="background:#0f172a;border-color:rgba(148,163,184,.10)">
          </div>
        </div>
        <div class="bg-slate-800 rounded-xl p-3 border border-slate-600/30 mb-4">
          <p class="text-[9px] text-slate-400 uppercase font-bold mb-2.5">Livraison</p>
          <div class="flex flex-col gap-3">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-hand" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Main propre</span>
              <span class="text-xs text-slate-400">Gratuit</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-relay" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Mondial Relay</span>
              <input type="number" id="sh-relay-p" value="5" class="w-14 bg-[#0f172a] border border-slate-600/40 rounded-lg px-2 py-1 text-xs text-center text-white outline-none">
              <span class="text-xs text-slate-400">euro</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="sh-colis" class="w-4 h-4 accent-cyan-500" onchange="updShip()">
              <span class="text-sm font-semibold flex-1">Colissimo</span>
              <input type="number" id="sh-colis-p" value="8" class="w-14 bg-[#0f172a] border border-slate-600/40 rounded-lg px-2 py-1 text-xs text-center text-white outline-none">
              <span class="text-xs text-slate-400">euro</span>
            </label>
          </div>
        </div>
        <button id="pub-btn" class="w-full bg-sky-500 text-black font-extrabold py-4 rounded-2xl text-[15px] active:scale-95 transition-transform shadow-[0_0_18px_rgba(34,211,238,.35)]">
          Publier l'annonce
        </button>
      </div>
    </div>
  </div>
  <canvas id="cap-canvas" class="hidden"></canvas>
</div>

<!-- DETAIL -->
<div id="detail-modal" class="fixed inset-0 z-[500] bg-[#0f172a] hidden flex-col sr">
  <div class="flex items-center gap-3 px-3 pt-4 pb-3 bg-[#0f172a] border-b border-slate-600/30 shrink-0">
    <button onclick="closeDetail()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <p class="font-bold text-sm">Detail de l'annonce</p>
  </div>
  <div class="flex-1 overflow-y-auto no-sb">
    <div class="px-3 pt-3 pb-2">
      <div style="width:100%;height:380px;background:#f8f8f8;border-radius:16px;overflow:hidden;">
        <img id="det-img" style="width:100%;height:100%;object-fit:contain;display:block;">
      </div>
    </div>
    <div class="px-4 pb-8">
      <div class="flex items-start justify-between gap-2 mt-3 mb-2">
        <h2 id="det-title" class="font-extrabold text-xl leading-tight flex-1"></h2>
        <p id="det-price" class="text-sky-500 font-black text-xl shrink-0"></p>
      </div>
      <div class="flex flex-wrap gap-2 mb-4">
        <span id="det-cat" class="text-[10px] text-slate-400 font-bold uppercase bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-600/30"></span>
        <span id="det-cond" class="text-[10px] text-slate-300 font-bold bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-600/30"></span>
        <span id="det-city-tag" class="hidden text-[10px] text-slate-300 font-bold bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-600/30">
          <i class="fa-solid fa-location-dot text-sky-500 mr-1"></i><span id="det-city-val"></span>
        </span>
      </div>
      <p id="det-brand" class="text-xs text-slate-500 font-mono mb-3"></p>
      <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-2 tracking-widest">Description</p>
        <p id="det-desc" class="text-sm text-slate-200 leading-relaxed"></p>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-600/30">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-2 tracking-widest">Livraison</p>
        <div id="det-ship" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 mb-5 border border-slate-600/30">
        <p class="text-[9px] text-slate-400 uppercase font-bold mb-3 tracking-widest">Vendeur</p>
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-user text-xs text-white"></i>
          </div>
          <div>
            <p id="det-seller" class="font-bold text-sm"></p>
            <p id="det-rating" class="text-[10px] text-yellow-400 mt-0.5">Nouveau vendeur</p>
          </div>
        </div>
      </div>
      <div class="flex gap-3">
        <button id="contact-btn" class="flex-1 bg-slate-800 border border-slate-600/40 rounded-2xl py-3.5 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-solid fa-message text-xs"></i> Contacter
        </button>
        <button id="buy-btn" class="flex-1 bg-sky-500 text-black rounded-2xl py-3.5 text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
          <i class="fa-brands fa-stripe text-base"></i> Acheter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CHAT -->
<div id="chat-modal" class="fixed inset-0 z-[600] bg-[#0f172a] hidden flex-col sr">
  <div class="flex items-center gap-3 px-3 pt-4 pb-3 bg-[#0f172a] border-b border-slate-600/30 shrink-0">
    <button onclick="closeChat()" class="w-9 h-9 rounded-xl bg-slate-800 flex items-center justify-center">
      <i class="fa-solid fa-arrow-left text-sm"></i>
    </button>
    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shrink-0">
      <i class="fa-solid fa-user text-xs text-white"></i>
    </div>
    <div class="flex-1">
      <p id="chat-seller" class="font-bold text-sm leading-none"></p>
      <p class="text-[10px] text-green-400 font-semibold mt-0.5">En ligne</p>
    </div>
  </div>
  <div class="px-3 py-2 bg-slate-800/50 border-b border-slate-600/30 flex gap-3 items-center shrink-0">
    <img id="chat-img" class="w-9 h-9 rounded-lg object-cover border border-slate-600/40 shrink-0">
    <div class="flex-1 min-w-0">
      <p id="chat-iname" class="text-xs font-bold truncate"></p>
      <p id="chat-iprice" class="text-xs text-sky-500 font-bold"></p>
    </div>
  </div>
  <div id="chat-msgs" class="flex-1 overflow-y-auto no-sb p-4 flex flex-col gap-3"></div>
  <div class="px-3 py-3 bg-[#0f172a] border-t border-slate-600/30 shrink-0">
    <div class="flex gap-2 overflow-x-auto no-sb mb-2">
      <button onclick="qMsg('Disponible ?')" class="text-[10px] text-slate-300 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-600/30 whitespace-nowrap">Disponible ?</button>
      <button onclick="qMsg('Dernier prix ?')" class="text-[10px] text-slate-300 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-600/30 whitespace-nowrap">Dernier prix ?</button>
      <button onclick="qMsg('Livraison possible ?')" class="text-[10px] text-slate-300 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-600/30 whitespace-nowrap">Livraison ?</button>
    </div>
    <div class="flex gap-2">
      <input id="chat-inp" type="text" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()"
        class="flex-1 bg-slate-800 border border-slate-600/40 rounded-xl px-4 py-2.5 text-sm text-white placeholder-zinc-600 outline-none focus:border-sky-500">
      <button onclick="sendMsg()" class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center active:scale-90 transition-transform">
        <i class="fa-solid fa-paper-plane text-black text-xs"></i>
      </button>
    </div>
  </div>
</div>

<!-- PAIEMENT -->
<div id="pay-modal" class="fixed inset-0 z-[700] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closePay()"></div>
  <div class="relative msheet su w-full max-w-lg p-5 pb-8">
    <div class="flex justify-center mb-4"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="w-7 h-7 rounded-lg bg-green-500/15 flex items-center justify-center">
          <i class="fa-solid fa-shield-halved text-green-400 text-xs"></i>
        </div>
        <span class="font-bold text-sm">Paiement securise</span>
      </div>
      <button onclick="closePay()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center">
        <i class="fa-solid fa-xmark text-sm"></i>
      </button>
    </div>
    <div class="flex gap-3 mb-4">
      <div id="pay-img" class="w-14 h-14 rounded-xl bg-slate-700 bg-cover bg-center shrink-0 border border-slate-600/40"></div>
      <div>
        <p id="pay-title" class="font-bold text-sm mb-1 leading-tight"></p>
        <p id="pay-price" class="text-sky-500 font-black text-lg"></p>
      </div>
    </div>
    <div id="pay-ship-wrap" class="hidden mb-3">
      <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">Choisir la livraison</p>
      <div id="pay-ship-list" class="flex flex-col gap-2"></div>
    </div>
    <div class="bg-slate-800 rounded-xl p-4 mb-4 border border-slate-600/30 text-sm">
      <div class="flex justify-between mb-2"><span class="text-slate-300">Article</span><span id="pay-sub" class="font-bold"></span></div>
      <div class="flex justify-between mb-3"><span class="text-slate-300">Livraison</span><span id="pay-shipcost" class="font-bold">-</span></div>
      <div class="flex justify-between border-t border-slate-600/30 pt-3"><span class="font-bold">Total</span><span id="pay-total" class="font-extrabold text-sky-500 text-base"></span></div>
    </div>
    <button id="stripe-btn" onclick="doStripe()" class="w-full bg-[#635bff] text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-transform">
      <i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant
    </button>
  </div>
</div>

<!-- NOTATION -->
<div id="rate-modal" class="fixed inset-0 z-[800] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-6 w-full max-w-xs border border-slate-600/40 text-center su">
    <div class="w-14 h-14 rounded-2xl bg-yellow-500/10 flex items-center justify-center mx-auto mb-3">
      <i class="fa-solid fa-star text-yellow-400 text-2xl"></i>
    </div>
    <h3 class="font-extrabold text-base mb-1">Laisser une note</h3>
    <p id="rate-sub" class="text-slate-400 text-xs mb-4">Comment s'est passee la transaction ?</p>
    <div class="flex justify-center gap-2 mb-4">
      <button onclick="setStar(1)" class="star text-3xl text-slate-600 transition-all" data-v="1">&#9733;</button>
      <button onclick="setStar(2)" class="star text-3xl text-slate-600 transition-all" data-v="2">&#9733;</button>
      <button onclick="setStar(3)" class="star text-3xl text-slate-600 transition-all" data-v="3">&#9733;</button>
      <button onclick="setStar(4)" class="star text-3xl text-slate-600 transition-all" data-v="4">&#9733;</button>
      <button onclick="setStar(5)" class="star text-3xl text-slate-600 transition-all" data-v="5">&#9733;</button>
    </div>
    <textarea id="rate-comment" placeholder="Commentaire (optionnel)" rows="2" class="inp text-sm mb-4 resize-none" style="font-size:13px"></textarea>
    <button onclick="submitRate()" class="w-full bg-yellow-400 text-black font-bold py-3.5 rounded-2xl mb-2 active:scale-95 transition-transform">Envoyer</button>
    <button onclick="closeRate()" class="w-full text-slate-400 text-sm py-2">Passer</button>
  </div>
</div>

<!-- EDIT -->
<div id="edit-modal" class="fixed inset-0 z-[600] hidden items-end justify-center">
  <div class="mover absolute inset-0" onclick="closeEdit()"></div>
  <div class="relative msheet su w-full max-w-lg">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-700 rounded-full"></div></div>
    <div class="flex items-center justify-between px-4 pt-2 pb-3">
      <p class="font-extrabold text-[15px]">Modifier</p>
      <button onclick="closeEdit()" class="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark text-sm"></i></button>
    </div>
    <div class="overflow-y-auto no-sb px-4 pb-8" style="max-height:65vh">
      <div class="mb-3"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Titre</p>
        <input id="edit-title" class="inp"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
        <div><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Prix (euro)</p>
          <input id="edit-price" type="number" class="inp text-sky-500 font-black"></div>
        <div><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Etat</p>
          <select id="edit-cond" class="inp" style="cursor:pointer">
            <option>Neuf</option><option>Tres bon etat</option><option>Bon etat</option><option>Etat correct</option>
          </select></div>
      </div>
      <div class="mb-3"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Categorie</p>
        <select id="edit-cat" class="inp" style="cursor:pointer">
          <option>High-Tech</option><option>Jeux video</option><option>Informatique</option>
          <option>Mode</option><option>Maison</option><option>Sport</option><option>Divers</option>
        </select></div>
      <div class="mb-4"><p class="text-[9px] text-slate-400 uppercase font-bold mb-1.5">Description</p>
        <textarea id="edit-desc" rows="3" class="inp resize-none"></textarea></div>
      <button id="edit-save" onclick="saveEdit()" class="w-full bg-sky-500 text-black font-bold py-4 rounded-2xl mb-2 active:scale-95 transition-transform">Sauvegarder</button>
      <button onclick="confirmDel(editingId)" class="w-full bg-red-500/8 border border-red-500/20 text-red-400 font-bold py-3.5 rounded-2xl text-sm active:scale-95 transition-transform">
        <i class="fa-solid fa-trash mr-2"></i>Supprimer
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div id="del-modal" class="fixed inset-0 z-[700] hidden items-center justify-center px-5">
  <div class="mover absolute inset-0"></div>
  <div class="relative bg-[#111] rounded-3xl p-5 w-full max-w-xs border border-red-500/20 text-center su">
    <i class="fa-solid fa-trash text-red-400 text-2xl mb-3"></i>
    <p class="font-extrabold text-base mb-1">Supprimer ?</p>
    <p class="text-slate-400 text-xs mb-5">Cette action est definitive.</p>
    <div class="flex gap-2">
      <button onclick="closeDel()" class="flex-1 bg-slate-700 font-bold py-3 rounded-xl text-sm">Annuler</button>
      <button onclick="doDelete()" class="flex-1 bg-red-500 font-bold py-3 rounded-xl text-sm">Supprimer</button>
    </div>
  </div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import{getAuth,signInAnonymously,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,GoogleAuthProvider,signInWithPopup,signOut}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import{getFirestore,collection,addDoc,onSnapshot,serverTimestamp,doc,where,orderBy,query,getDocs,deleteDoc,updateDoc,getDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import{getMessaging,getToken,onMessage}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

const FB={apiKey:"AIzaSyDOSIhWwrlkhNfk8Y3-tl9IebJW0YBA7d4",authDomain:"youbiiiz-app.firebaseapp.com",projectId:"youbiiiz-app",storageBucket:"youbiiiz-app.firebasestorage.app",messagingSenderId:"664733497216",appId:"1:664733497216:web:ae19fbadf0fa509f59b365"};
const fb=initializeApp(FB),auth=getAuth(fb),db=getFirestore(fb);

let me=null,items=[],curItem=null,scanData=null,camStream=null;
let editingId=null,deletingId=null,payItem=null,selShip=null,curStar=0,rateCtx=null;
let activeCat="all",map=null,userLat=null,userLng=null,mapMarkers=[];

window.onerror=(m,s,l)=>{toast("JS:"+m+" L"+l);};
function toast(m,ok){
  var e=document.getElementById("dbg");
  e.style.display="block";
  e.style.background=ok?"#22c55e":"#ef4444";
  e.innerText=m;
  setTimeout(function(){e.style.display="none";},3500);
}

onAuthStateChanged(auth,function(u){
  if(u){
    me=u;
    var badge=document.getElementById("user-badge");
    if(badge) badge.innerText="ID:"+u.uid.slice(0,4);
    var puid=document.getElementById("profile-uid");
    if(puid) puid.innerText=(u.email||"Anonyme")+" ¬∑ "+u.uid.slice(0,8)+"...";
    boot();
  }
  // Sinon: landing page reste visible, l'user doit se connecter
});

// AUTH FUNCTIONS
window.showTab=function(tab){
  document.getElementById("panel-login").style.display=tab==="login"?"block":"none";
  document.getElementById("panel-register").style.display=tab==="register"?"block":"none";
  document.getElementById("tab-login").style.background=tab==="login"?"#fff":"transparent";
  document.getElementById("tab-login").style.color=tab==="login"?"#0f172a":"#94a3b8";
  document.getElementById("tab-login").style.boxShadow=tab==="login"?"0 1px 4px rgba(0,0,0,.1)":"none";
  document.getElementById("tab-register").style.background=tab==="register"?"#fff":"transparent";
  document.getElementById("tab-register").style.color=tab==="register"?"#0f172a":"#94a3b8";
  document.getElementById("tab-register").style.boxShadow=tab==="register"?"0 1px 4px rgba(0,0,0,.1)":"none";
  hideAuthMsg();
};

function showAuthMsg(msg,ok){
  var el=document.getElementById("auth-msg");
  el.style.display="block";
  el.style.background=ok?"#f0fdf4":"#fef2f2";
  el.style.color=ok?"#166534":"#dc2626";
  el.style.border=ok?"1px solid #bbf7d0":"1px solid #fecaca";
  el.innerText=msg;
}
function hideAuthMsg(){document.getElementById("auth-msg").style.display="none";}

window.doLogin=async function(){
  var email=document.getElementById("login-email").value.trim();
  var pass=document.getElementById("login-password").value;
  if(!email||!pass){showAuthMsg("Remplis tous les champs");return;}
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    var msgs={"auth/user-not-found":"Compte introuvable","auth/wrong-password":"Mot de passe incorrect","auth/invalid-email":"Email invalide","auth/invalid-credential":"Email ou mot de passe incorrect"};
    showAuthMsg(msgs[e.code]||"Erreur: "+e.message);
  }
};

window.doRegister=async function(){
  var email=document.getElementById("reg-email").value.trim();
  var pass=document.getElementById("reg-password").value;
  var conf=document.getElementById("reg-confirm").value;
  if(!email||!pass||!conf){showAuthMsg("Remplis tous les champs");return;}
  if(pass.length<6){showAuthMsg("Mot de passe trop court (min. 6 car.)");return;}
  if(pass!==conf){showAuthMsg("Les mots de passe ne correspondent pas");return;}
  try{
    await createUserWithEmailAndPassword(auth,email,pass);
  }catch(e){
    var msgs={"auth/email-already-in-use":"Email d√©j√† utilis√©","auth/invalid-email":"Email invalide","auth/weak-password":"Mot de passe trop faible"};
    showAuthMsg(msgs[e.code]||"Erreur: "+e.message);
  }
};

window.doGoogle=async function(){
  try{
    var provider=new GoogleAuthProvider();
    await signInWithPopup(auth,provider);
  }catch(e){
    if(e.code!=="auth/popup-closed-by-user") showAuthMsg("Erreur Google: "+e.message);
  }
};

window.doAnon=async function(){
  try{
    await signInAnonymously(auth);
  }catch(e){showAuthMsg("Erreur: "+e.message);}
};

window.doLogout=async function(){
  try{
    await signOut(auth);
    document.getElementById("app").classList.add("hidden");
    document.getElementById("app").style.opacity="0";
    document.getElementById("splash").style.display="flex";
    me=null;
  }catch(e){toast("Erreur: "+e.message);}
};

function boot(){
  document.getElementById("splash").style.display="none";
  document.getElementById("app").classList.remove("hidden");
  setTimeout(function(){document.getElementById("app").style.opacity="1";},80);
  // Set sidebar greeting
  var suid=document.getElementById("sidebar-uid");
  if(suid&&me) suid.innerText=(me.email||"Anonyme");
  initFeed();
  initNotifs();
  checkPayReturn();
  initPush();
}

async function initPush(){
  try{
    if(!("Notification" in window)) return;
    // Enregistrer le service worker
    if("serviceWorker" in navigator){
      await navigator.serviceWorker.register("/firebase-messaging-sw.js");
    }
    // Demander permission si pas encore fait
    var perm=await Notification.requestPermission();
    if(perm!=="granted") return;
    // Obtenir le token FCM
    var messaging=getMessaging(fb);
    var token=await getToken(messaging,{vapidKey:"BFF7R8CFoHmggVoEN0l0wrWb202z2yz4n0CELTxEZIAXWJ_GmWwpDRqs9X-X_s7lFTxxnl4svix3-tTg5WVbqRk"});
    if(token&&me){
      // Sauvegarder le token dans Firestore
      await updateDoc(doc(db,"users",me.uid),{fcmToken:token,updatedAt:serverTimestamp()}).catch(async function(){
        await addDoc(collection(db,"users"),{userId:me.uid,fcmToken:token,updatedAt:serverTimestamp()});
      });
      console.log("FCM token enregistre");
    }
    // Notifications en premier plan (app ouverte)
    onMessage(messaging,function(payload){
      var title=payload.notification?payload.notification.title:"Youbiiiz";
      var body=payload.notification?payload.notification.body:"Nouvelle notification";
      showPushBanner(title,body);
    });
  }catch(e){
    console.log("Push non disponible:",e.message);
  }
}

function showPushBanner(title,body){
  var el=document.createElement("div");
  el.style.cssText="position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9000;background:#1e293b;border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:12px 16px;max-width:320px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5);display:flex;align-items:center;gap:12px;animation:su .3s cubic-bezier(.16,1,.3,1)";
  el.innerHTML='<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22d3ee,#3b82f6);flex-shrink:0;display:flex;align-items:center;justify-content:center"><i class="fa-solid fa-bell" style="color:#000;font-size:14px"></i></div><div style="flex:1;min-width:0"><p style="font-size:13px;font-weight:700;margin:0 0 2px">'+title+'</p><p style="font-size:11px;color:#94a3b8;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+body+'</p></div><button onclick="this.parentElement.remove()" style="background:none;border:none;color:#94a3b8;cursor:pointer;padding:4px;font-size:14px">x</button>';
  document.body.appendChild(el);
  setTimeout(function(){if(el.parentElement)el.remove();},5000);
}

function initFeed(){
  onSnapshot(collection(db,"scans"),function(snap){
    items=[];
    snap.forEach(function(d){items.push(Object.assign({id:d.id},d.data()));});
    items.sort(function(a,b){return(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0);});
    applyFilters();
    updateProfile();
  },function(e){toast("Feed:"+e.message);});
}

function card(i){
  var cond=i.condition?'<span style="position:absolute;top:7px;left:7px;background:#0f172a;color:#fff;font-size:9px;font-weight:700;padding:2px 8px;border-radius:99px">'+i.condition+"</span>":"";
  var city=i.city?'<p style="font-size:10px;color:#94a3b8;margin-top:4px"><i class="fa-solid fa-location-dot" style="color:#0ea5e9;font-size:8px;margin-right:2px"></i>'+i.city+"</p>":"";
  return '<div class="card fi" onclick="openDetail(\''+i.id+'\')"><div class="sq"><img src="'+(i.imageUrl||"")+'" loading="lazy">'+cond+'</div><div class="inf"><p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;color:#1e293b">'+(i.itemName||"Objet")+'</p><p style="font-size:16px;font-weight:900;color:#0ea5e9">'+(i.price||0)+"‚Ç¨</p>"+city+"</div></div>";
}

function myCard(i){
  return '<div class="card fi"><div class="sq"><img src="'+(i.imageUrl||"")+'">'+(i.condition?'<span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.72);font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px">'+i.condition+"</span>":"")+'</div><div class="inf"><p style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px">'+(i.itemName||"Objet")+'</p><p style="font-size:14px;font-weight:900;color:#0ea5e9;margin-bottom:6px">'+(i.price||0)+'euro</p><div style="display:flex;gap:5px"><button onclick="event.stopPropagation();openEdit(\''+i.id+'\')" style="flex:1;background:#1e293b;border:1px solid rgba(148,163,184,.15);border-radius:9px;padding:5px;font-size:10px;font-weight:700;cursor:pointer">Modif.</button><button onclick="event.stopPropagation();confirmDel(\''+i.id+'\')" style="flex:1;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.18);border-radius:9px;padding:5px;font-size:10px;font-weight:700;color:#f87171;cursor:pointer">Supp.</button></div></div></div>';
}

function renderFeed(list){
  var el=document.getElementById("feed");
  if(!list.length){el.innerHTML='<div style="grid-column:1/-1;padding:56px 0;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase">Aucune annonce</div>';return;}
  el.innerHTML=list.map(card).join("");
}

window.applyFilters=function(){
  var cat=activeCat;
  var city=(document.getElementById("city-inp").value||"").toLowerCase().trim();
  var q=(document.getElementById("header-search").value||"").toLowerCase().trim();
  var list=items;
  if(cat!=="all") list=list.filter(function(i){return(i.category||"").toLowerCase().indexOf(cat.toLowerCase())>=0;});
  if(city) list=list.filter(function(i){return(i.city||"").toLowerCase().indexOf(city)>=0;});
  if(q) list=list.filter(function(i){return(i.itemName||"").toLowerCase().indexOf(q)>=0||(i.description||"").toLowerCase().indexOf(q)>=0||(i.city||"").toLowerCase().indexOf(q)>=0;});
  renderFeed(list);
};

window.filterCat=function(cat,btn){
  activeCat=cat;
  document.querySelectorAll(".cat-pill").forEach(function(b){b.classList.remove("on");});
  if(btn) btn.classList.add("on");
  applyFilters();
  // Update section title
  var titles={"all":"Pour toi","High-Tech":"High-Tech","Jeux video":"Jeux vid√©o","Informatique":"Informatique","Mode":"Mode","Maison":"Maison","Sport":"Sport","Divers":"Divers"};
  var t=document.getElementById("feed-section-title");
  if(t) t.innerText=titles[cat]||cat;
};

window.filterCatSidebar=function(cat,el){
  activeCat=cat;
  document.querySelectorAll(".sidebar-nav-item").forEach(function(b){if(b.getAttribute("onclick")&&b.getAttribute("onclick").indexOf("filterCat")>=0)b.classList.remove("active");});
  el.classList.add("active");
  applyFilters();
  var titles={"all":"Pour toi","High-Tech":"High-Tech","Jeux video":"Jeux vid√©o","Informatique":"Informatique","Mode":"Mode","Maison":"Maison","Sport":"Sport","Divers":"Divers"};
  var t=document.getElementById("feed-section-title");
  if(t) t.innerText=titles[cat]||cat;
  switchView("home");
};

window.setSidebarActive=function(id){
  ["snav-home","snav-map","snav-notif","snav-profile"].forEach(function(n){
    var el=document.getElementById(n);
    if(el) el.classList.remove("active");
  });
  var el=document.getElementById(id);
  if(el) el.classList.add("active");
};

window.switchView=function(v){
  ["home","map","notifications","profile"].forEach(function(n){
    var el=document.getElementById("view-"+n);
    if(el){
      if(n==="map"){
        el.style.display=n===v?"block":"none";
      }else{
        el.classList[n===v?"remove":"add"]("hidden");
      }
    }
  });
  document.getElementById("main-scroll").style.overflowY=v==="map"?"hidden":"auto";
  ["home","map","notif","profile"].forEach(function(n){
    var el=document.getElementById("nav-"+n);
    if(el){
      var icon=el.querySelector("i");
      if(icon) icon.style.color=v===n||("notifications"===v&&n==="notif")?"#0ea5e9":"#94a3b8";
    }
  });
  if(v==="map"){
    if(!userLat) askGeo();
    setTimeout(function(){
      initMap();
      renderMapMarkers();
      if(map) map.invalidateSize();
    },250);
  }
  if(v==="notifications"&&me){
    getDocs(query(collection(db,"notifications"),where("userId","==",me.uid),where("read","==",false))).then(function(s){
      s.forEach(function(d){updateDoc(doc(db,"notifications",d.id),{read:true});});
    });
  }
  if(v==="profile") loadMyRating();
};

function updateProfile(){
  if(!me) return;
  var mine=items.filter(function(i){return i.userId===me.uid;});
  document.getElementById("profile-count").innerText=mine.length;
  document.getElementById("profile-total").innerText=mine.reduce(function(s,i){return s+(parseFloat(i.price)||0);},0)+"euro";
  var el=document.getElementById("my-listings");
  el.innerHTML=mine.length?mine.map(myCard).join(""):'<p style="grid-column:1/-1;text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:32px 0">Aucune annonce</p>';
}

// SCAN
window.openScan=function(){
  var m=document.getElementById("scan-modal");
  m.classList.remove("hidden");
  m.classList.add("flex");
};
window.closeScan=function(){
  stopCam();resetScan();
  var m=document.getElementById("scan-modal");
  m.classList.remove("flex");
  m.classList.add("hidden");
};
window.resetScan=function(){
  stopCam();scanData=null;
  document.getElementById("scan-prev").classList.add("hidden");
  document.getElementById("scan-prev").src="";
  document.getElementById("scan-ph").classList.remove("hidden");
  document.getElementById("scan-spin").classList.add("hidden");
  document.getElementById("scan-line").classList.add("hidden");
  document.getElementById("photo-btns").classList.remove("hidden");
  document.getElementById("snap-btn").classList.add("hidden");
  document.getElementById("cam-toggle").classList.remove("hidden");
  document.getElementById("step-photo").classList.remove("hidden");
  document.getElementById("step-result").classList.add("hidden");
  document.getElementById("step-result").classList.remove("flex");
  document.getElementById("pub-btn").innerText="Publier l'annonce";
  document.getElementById("pub-btn").disabled=false;
  document.getElementById("file-input").value="";
  ["sh-hand","sh-relay","sh-colis"].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.checked=false;
  });
};
window.toggleCam=async function(){
  if(camStream){stopCam();return;}
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1080},height:{ideal:1080}},audio:false});
    var v=document.getElementById("cam-vid");
    v.srcObject=camStream;v.classList.remove("hidden");
    document.getElementById("scan-ph").classList.add("hidden");
    document.getElementById("cam-toggle").classList.add("hidden");
    document.getElementById("snap-btn").classList.remove("hidden");
  }catch(e){document.getElementById("file-input").click();}
};
function stopCam(){
  if(camStream){camStream.getTracks().forEach(function(t){t.stop();});camStream=null;}
  var v=document.getElementById("cam-vid");
  v.srcObject=null;v.classList.add("hidden");
}
window.snapPhoto=function(){
  var v=document.getElementById("cam-vid"),c=document.getElementById("cap-canvas");
  c.width=v.videoWidth;c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);
  stopCam();
  document.getElementById("snap-btn").classList.add("hidden");
  processImg(c.toDataURL("image/jpeg",1.0));
};
window.onFile=function(e){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){processImg(ev.target.result);};
  r.readAsDataURL(f);
};
function processImg(raw){
  document.getElementById("scan-ph").classList.add("hidden");
  document.getElementById("photo-btns").classList.add("hidden");
  document.getElementById("scan-spin").classList.remove("hidden");
  cropImage(raw).then(function(opt){
    document.getElementById("scan-prev").src=opt;
    document.getElementById("scan-prev").classList.remove("hidden");
    document.getElementById("scan-line").classList.remove("hidden");
    callGemini(opt);
  });
}
function cropImage(b64){
  return new Promise(function(resolve){
    var img=new Image();
    img.onload=function(){
      var w=img.naturalWidth||img.width;
      var h=img.naturalHeight||img.height;
      if(!w||!h){resolve(b64);return;}
      // Calcul pour tenir l'image entiere dans 400x400 avec padding
      var scale=Math.min(400/w,400/h);
      var dw=Math.round(w*scale);
      var dh=Math.round(h*scale);
      var dx=Math.round((400-dw)/2);
      var dy=Math.round((400-dh)/2);
      var c=document.createElement("canvas");
      c.width=400;c.height=400;
      var ctx=c.getContext("2d");
      ctx.fillStyle="#f5f5f5";
      ctx.fillRect(0,0,400,400);
      ctx.drawImage(img,0,0,w,h,dx,dy,dw,dh);
      resolve(c.toDataURL("image/jpeg",0.82));
    };
    img.onerror=function(){resolve(b64);};
    img.src=b64;
  });
}
async function callGemini(b64){
  try{
    var mime=b64.indexOf("data:image/png")===0?"image/png":"image/jpeg";
    var r=await fetch("https://analyzeimage-xjtnixfrra-uc.a.run.app",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({imageBase64:b64.split(",")[1],mimeType:mime})
    });
    var d=await r.json();
    if(d.error){toast("IA:"+d.error);resetScan();return;}
    showResult(d,b64);
  }catch(e){toast("IA:"+e.message);resetScan();}
}
function showResult(d,img){
  document.getElementById("scan-spin").classList.add("hidden");
  document.getElementById("scan-line").classList.add("hidden");
  document.getElementById("res-thumb").src=img;
  document.getElementById("ai-name").value=d.title||"";
  document.getElementById("ai-price").innerText=(d.price||0)+"euro";
  document.getElementById("ai-cat").innerText=d.category||"";
  document.getElementById("ai-desc").value=d.description||"";
  document.getElementById("ai-cond").innerText=d.condition||"";
  document.getElementById("ai-brand").innerText=d.brand||"-";
  document.getElementById("ai-model").innerText=d.model||"-";
  scanData={itemName:d.title,price:d.price,category:d.category,condition:d.condition||"Bon etat",description:d.description||"",brand:d.brand||"",model:d.model||"",imageUrl:img,shipping:[]};
  document.getElementById("step-photo").classList.add("hidden");
  document.getElementById("step-result").classList.remove("hidden");
  document.getElementById("step-result").classList.add("flex");
}
window.updShip=function(){
  if(!scanData) return;
  var o=[];
  if(document.getElementById("sh-hand").checked) o.push({method:"Main propre",price:0});
  if(document.getElementById("sh-relay").checked) o.push({method:"Mondial Relay",price:parseFloat(document.getElementById("sh-relay-p").value)||5});
  if(document.getElementById("sh-colis").checked) o.push({method:"Colissimo",price:parseFloat(document.getElementById("sh-colis-p").value)||8});
  scanData.shipping=o;
};
document.getElementById("pub-btn").addEventListener("click",async function(){
  if(!scanData||!me) return;
  updShip();
  var btn=document.getElementById("pub-btn");
  btn.innerText="Publication...";btn.disabled=true;
  try{
    var city=document.getElementById("item-city").value.trim();
    // Geocoder la ville pour la carte
    var coords=city?await geocodeAndSave(city):null;
    await addDoc(collection(db,"scans"),{
      userId:me.uid,
      itemName:document.getElementById("ai-name").value,
      price:scanData.price,
      category:scanData.category,
      condition:scanData.condition,
      description:document.getElementById("ai-desc").value,
      brand:scanData.brand,
      model:scanData.model,
      shipping:scanData.shipping,
      city:city,
      lat:coords?coords.lat:null,
      lng:coords?coords.lng:null,
      imageUrl:scanData.imageUrl,
      createdAt:serverTimestamp()
    });
    closeScan();
    switchView("home");
    toast("Annonce publiee !",true);
  }catch(e){
    toast("Erreur:"+e.message);
    btn.innerText="Publier l'annonce";
    btn.disabled=false;
  }
});

// DETAIL
window.openDetail=function(id){
  var i=items.find(function(x){return x.id===id;});
  if(!i) return;
  curItem=i;
  document.getElementById("det-img").src=i.imageUrl||"";
  document.getElementById("det-title").innerText=i.itemName||"";
  document.getElementById("det-price").innerText=(i.price||0)+"euro";
  document.getElementById("det-cat").innerText=i.category||"";
  document.getElementById("det-cond").innerText=i.condition||"";
  document.getElementById("det-desc").innerText=i.description||"Aucune description.";
  document.getElementById("det-seller").innerText="Vendeur #"+(i.userId||"").slice(0,6);
  document.getElementById("det-brand").innerText=[i.brand,i.model].filter(Boolean).join(" - ");
  var ct=document.getElementById("det-city-tag");
  if(i.city){document.getElementById("det-city-val").innerText=i.city;ct.classList.remove("hidden");}
  else{ct.classList.add("hidden");}
  var sh=document.getElementById("det-ship");
  if(i.shipping&&i.shipping.length){
    sh.innerHTML=i.shipping.map(function(s){
      return '<span style="background:#1e3a5f;border:1px solid rgba(148,163,184,.10);border-radius:10px;padding:5px 10px;font-size:11px;font-weight:700">'+s.method+' <span style="color:#0ea5e9">'+(s.price===0?"Gratuit":s.price+"euro")+"</span></span>";
    }).join("");
  }else{
    sh.innerHTML='<span style="font-size:12px;color:#94a3b8">Non renseigne</span>';
  }
  document.getElementById("contact-btn").onclick=function(){openChat(i);};
  document.getElementById("buy-btn").onclick=function(){openPay(i);};
  loadSellerRating(i.userId);
  var m=document.getElementById("detail-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeDetail=function(){
  var m=document.getElementById("detail-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};

// CHAT
window.openChat=function(i){
  curItem=i;
  document.getElementById("chat-seller").innerText="Vendeur #"+(i.userId||"").slice(0,6);
  document.getElementById("chat-iname").innerText=i.itemName||"";
  document.getElementById("chat-iprice").innerText=(i.price||0)+"euro";
  document.getElementById("chat-img").src=i.imageUrl||"";
  document.getElementById("chat-msgs").innerHTML='<div style="text-align:center;padding:16px 0"><span style="font-size:10px;color:#94a3b8;background:#1e3a5f;padding:4px 12px;border-radius:99px;font-weight:700;text-transform:uppercase">Debut de conversation</span></div>';
  var m=document.getElementById("chat-modal");
  m.classList.remove("hidden");m.classList.add("flex");
  closeDetail();
};
window.closeChat=function(){
  var m=document.getElementById("chat-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.sendMsg=function(){
  var inp=document.getElementById("chat-inp"),t=inp.value.trim();if(!t)return;
  addBubble(t,true);inp.value="";
  var reps=["Oui disponible !","Je peux baisser un peu.","Envoi Mondial Relay possible.","Article en parfait etat.","Je peux envoyer plus de photos."];
  setTimeout(function(){addBubble(reps[Math.floor(Math.random()*reps.length)],false);},1100);
};
window.qMsg=function(m){document.getElementById("chat-inp").value=m;sendMsg();};
function addBubble(t,mine){
  var el=document.getElementById("chat-msgs");
  var d=document.createElement("div");
  d.className="flex "+(mine?"justify-end":"justify-start");
  d.innerHTML='<div class="max-w-[72%] px-4 py-2 text-sm font-medium '+(mine?"bme":"bthem")+'">'+t+"</div>";
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}

// PAIEMENT
window.openPay=function(i){
  payItem=i;selShip=null;
  document.getElementById("pay-img").style.backgroundImage="url("+i.imageUrl+")";
  document.getElementById("pay-title").innerText=i.itemName;
  document.getElementById("pay-price").innerText=i.price+"euro";
  document.getElementById("pay-sub").innerText=i.price+"euro";
  document.getElementById("pay-shipcost").innerText="-";
  document.getElementById("pay-total").innerText=i.price+"euro";
  var wrap=document.getElementById("pay-ship-wrap"),list=document.getElementById("pay-ship-list");
  if(i.shipping&&i.shipping.length){
    wrap.classList.remove("hidden");
    list.innerHTML=i.shipping.map(function(s,idx){
      return '<label style="display:flex;align-items:center;gap:10px;background:#1e3a5f;border:1px solid rgba(148,163,184,.10);border-radius:12px;padding:10px 12px;cursor:pointer"><input type="radio" name="ship" value="'+idx+'" onchange="selShipping('+idx+')" style="accent-color:#0ea5e9"><span style="font-size:13px;font-weight:600;flex:1">'+s.method+'</span><span style="font-size:13px;font-weight:800;color:#0ea5e9">'+(s.price===0?"Gratuit":s.price+"euro")+"</span></label>";
    }).join("");
  }else{wrap.classList.add("hidden");}
  var m=document.getElementById("pay-modal");
  m.classList.remove("hidden");m.classList.add("flex");
  closeDetail();
};
window.selShipping=function(idx){
  selShip=payItem.shipping[idx];
  var tot=(parseFloat(payItem.price)||0)+selShip.price;
  document.getElementById("pay-shipcost").innerText=selShip.price===0?"Gratuit":selShip.price+"euro";
  document.getElementById("pay-total").innerText=tot+"euro";
};
window.closePay=function(){
  var m=document.getElementById("pay-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.doStripe=async function(){
  if(!payItem||!me) return;
  if(payItem.shipping&&payItem.shipping.length&&!selShip){toast("Choisissez un mode de livraison");return;}
  var btn=document.getElementById("stripe-btn");
  btn.innerHTML='<i class="fa-solid fa-circle-notch animate-spin mr-2"></i>Redirection...';btn.disabled=true;
  try{
    var shipCost=selShip?selShip.price:0;
    var tot=(parseFloat(payItem.price)||0)+shipCost;
    var r=await fetch("https://createpayment-xjtnixfrra-uc.a.run.app",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:tot,itemName:payItem.itemName,itemId:payItem.id,buyerId:me.uid,sellerId:payItem.userId})});
    var d=await r.json();
    if(d.error){toast("Stripe:"+d.error);return;}
    await addDoc(collection(db,"notifications"),{userId:payItem.userId,type:"payment_initiated",message:"Paiement pour "+payItem.itemName,itemId:payItem.id,read:false,createdAt:serverTimestamp()});
    window.location.href=d.url;
  }catch(e){toast("Erreur:"+e.message);}
  btn.innerHTML='<i class="fa-brands fa-stripe text-2xl"></i> Payer maintenant';btn.disabled=false;
};
function checkPayReturn(){
  var p=new URLSearchParams(window.location.search);
  if(p.get("payment")!=="success") return;
  history.replaceState({},"","/");
  var iid=p.get("itemId"),sid=p.get("sellerId");
  setTimeout(async function(){
    if(!me) return;
    try{
      await addDoc(collection(db,"notifications"),{userId:me.uid,type:"payment_success",message:"Paiement valide ! Contactez le vendeur.",itemId:iid||"",read:false,createdAt:serverTimestamp()});
      if(sid) await addDoc(collection(db,"notifications"),{userId:sid,type:"sale",message:"Votre article vient d'etre achete !",itemId:iid||"",read:false,createdAt:serverTimestamp()});
      rateCtx={targetUserId:sid,role:"buyer",itemId:iid||""};
      setTimeout(function(){openRate("vendeur");},2000);
    }catch(e){}
  },1500);
}

// NOTIFS
function initNotifs(){
  if(!me) return;
  var q=query(collection(db,"notifications"),where("userId","==",me.uid));
  onSnapshot(q,function(snap){
    var list=[];
    snap.forEach(function(d){list.push(Object.assign({id:d.id},d.data()));});
    list.sort(function(a,b){return(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0);});
    var unread=list.filter(function(n){return !n.read;}).length;
    var b=document.getElementById("nbadge");
    b.classList.toggle("hidden",unread===0);
    if(unread) b.innerText=unread;
    var icons={payment_success:"ok",payment_initiated:"cb",sale:"vente",rating:"note"};
    var emojis={payment_success:"‚úÖ",payment_initiated:"üí≥",sale:"üéâ",rating:"‚≠ê"};
    document.getElementById("notif-list").innerHTML=list.length?list.map(function(n){
      var date=n.createdAt?new Date(n.createdAt.seconds*1000).toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):"";
      return '<div onclick="markRead(\''+n.id+'\')" style="background:#1e293b;border:1px solid rgba(148,163,184,.10);border-radius:16px;padding:14px;margin-bottom:8px;cursor:pointer;opacity:'+(n.read?".5":"1")+'"><div style="display:flex;gap:10px;align-items:flex-start"><span style="font-size:18px">'+(emojis[n.type]||"bell")+'</span><div style="flex:1"><p style="font-size:13px;font-weight:700;margin-bottom:3px">'+n.message+'</p><p style="font-size:10px;color:#94a3b8">'+date+"</p></div>"+(n.read?"":'<span style="width:7px;height:7px;background:#0ea5e9;border-radius:99px;margin-top:3px;flex-shrink:0;display:block"></span>')+"</div></div>";
    }).join(""):'<p style="text-align:center;color:#94a3b8;font-size:11px;font-weight:700;text-transform:uppercase;padding:48px 0">Aucune notification</p>';
  });
}
window.markRead=async function(id){await updateDoc(doc(db,"notifications",id),{read:true});};

// NOTATION
window.openRate=function(role){
  curStar=0;
  document.querySelectorAll(".star").forEach(function(s){s.style.color="#3f3f46";s.style.transform="scale(1)";});
  document.getElementById("rate-comment").value="";
  document.getElementById("rate-sub").innerText=role==="buyer"?"Comment s'est comporte l'acheteur ?":"Comment etait le vendeur ?";
  var m=document.getElementById("rate-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeRate=function(){
  var m=document.getElementById("rate-modal");
  m.classList.add("hidden");m.classList.remove("flex");
};
window.setStar=function(v){
  curStar=v;
  document.querySelectorAll(".star").forEach(function(s){
    var sv=parseInt(s.dataset.v);
    s.style.color=sv<=v?"#facc15":"#3f3f46";
    s.style.transform=sv<=v?"scale(1.15)":"scale(1)";
  });
};
window.submitRate=async function(){
  if(!curStar){toast("Choisissez une note");return;}
  if(!rateCtx) return;
  try{
    await addDoc(collection(db,"ratings"),{targetUserId:rateCtx.targetUserId,fromUserId:me.uid,itemId:rateCtx.itemId,rating:curStar,comment:document.getElementById("rate-comment").value,createdAt:serverTimestamp()});
    await updUserRating(rateCtx.targetUserId);
    await addDoc(collection(db,"notifications"),{userId:rateCtx.targetUserId,type:"rating",message:"Vous avez recu une note de "+curStar+"etoiles",read:false,createdAt:serverTimestamp()});
    closeRate();toast("Note envoyee !",true);
  }catch(e){toast("Erreur:"+e.message);}
};
async function updUserRating(uid){
  try{
    var s=await getDocs(query(collection(db,"ratings"),where("targetUserId","==",uid)));
    var r=[];s.forEach(function(d){r.push(d.data().rating);});
    if(!r.length) return;
    var avg=(r.reduce(function(a,b){return a+b;},0)/r.length).toFixed(1);
    await updateDoc(doc(db,"users",uid),{rating:parseFloat(avg),ratingCount:r.length});
  }catch(e){}
}
async function loadSellerRating(uid){
  try{
    var d=await getDoc(doc(db,"users",uid));
    var el=document.getElementById("det-rating");
    if(d.exists()&&d.data().rating){
      var r=d.data().rating,n=d.data().ratingCount||0;
      var stars="";
      for(var k=1;k<=5;k++) stars+=k<=Math.round(r)?"‚òÖ":"‚òÜ";
      el.innerText=stars+" "+r+"/5 ("+n+" avis)";
    }else{el.innerText="Nouveau vendeur";}
  }catch(e){}
}
async function loadMyRating(){
  if(!me) return;
  try{
    var d=await getDoc(doc(db,"users",me.uid));
    if(d.exists()&&d.data().rating) document.getElementById("profile-rating").innerText="‚òÖ"+d.data().rating;
  }catch(e){}
}

// EDIT / DELETE
window.openEdit=function(id){
  var i=items.find(function(x){return x.id===id;});if(!i)return;
  editingId=id;
  document.getElementById("edit-title").value=i.itemName||"";
  document.getElementById("edit-price").value=i.price||0;
  document.getElementById("edit-desc").value=i.description||"";
  document.getElementById("edit-cond").value=i.condition||"Bon etat";
  document.getElementById("edit-cat").value=i.category||"Divers";
  var m=document.getElementById("edit-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeEdit=function(){
  var m=document.getElementById("edit-modal");
  m.classList.add("hidden");m.classList.remove("flex");
  editingId=null;
};
window.saveEdit=async function(){
  if(!editingId) return;
  var btn=document.getElementById("edit-save");btn.innerText="Sauvegarde...";btn.disabled=true;
  try{
    await updateDoc(doc(db,"scans",editingId),{
      itemName:document.getElementById("edit-title").value,
      price:parseFloat(document.getElementById("edit-price").value)||0,
      description:document.getElementById("edit-desc").value,
      condition:document.getElementById("edit-cond").value,
      category:document.getElementById("edit-cat").value
    });
    closeEdit();
  }catch(e){toast("Erreur:"+e.message);}
  btn.innerText="Sauvegarder";btn.disabled=false;
};
window.confirmDel=function(id){
  deletingId=id;closeEdit();
  var m=document.getElementById("del-modal");
  m.classList.remove("hidden");m.classList.add("flex");
};
window.closeDel=function(){
  var m=document.getElementById("del-modal");
  m.classList.add("hidden");m.classList.remove("flex");
  deletingId=null;
};
window.doDelete=async function(){
  if(!deletingId) return;
  try{await deleteDoc(doc(db,"scans",deletingId));closeDel();}
  catch(e){toast("Erreur:"+e.message);}
};

// CARTE
var clusterGroup=null,userMarker=null,activeRadius=5;

function initMap(){
  if(map) return;
  var lat=userLat||46.2276,lng=userLng||2.2137,zoom=userLat?13:6;
  map=L.map("map-el",{zoomControl:false}).setView([lat,lng],zoom);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:"CartoDB",maxZoom:19}).addTo(map);
  clusterGroup=L.markerClusterGroup({
    maxClusterRadius:50,
    iconCreateFunction:function(cluster){
      return L.divIcon({
        className:"",
        html:'<div style="background:#0ea5e9;color:#000;font-size:12px;font-weight:900;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5)">'+cluster.getChildCount()+"</div>",
        iconSize:[36,36],iconAnchor:[18,18]
      });
    }
  });
  map.addLayer(clusterGroup);
  if(userLat) addUserMarker();
}

function addUserMarker(){
  if(userMarker) userMarker.remove();
  userMarker=L.circleMarker([userLat,userLng],{radius:10,fillColor:"#22d3ee",color:"#fff",weight:3,fillOpacity:1}).addTo(map);
  // Cercle de rayon
  if(activeRadius>0) drawRadiusCircle();
}

var radiusCircle=null;
function drawRadiusCircle(){
  if(radiusCircle) radiusCircle.remove();
  if(!userLat||activeRadius===0) return;
  radiusCircle=L.circle([userLat,userLng],{
    radius:activeRadius*1000,
    color:"#22d3ee",fillColor:"#22d3ee",fillOpacity:0.04,weight:1.5,dashArray:"6,6"
  }).addTo(map);
}

function getDistanceKm(lat1,lng1,lat2,lng2){
  var R=6371;
  var dLat=(lat2-lat1)*Math.PI/180;
  var dLng=(lng2-lng1)*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function geocodeCity(city){
  try{
    var r=await fetch("https://nominatim.openstreetmap.org/search?q="+encodeURIComponent(city+",France")+"&format=json&limit=1");
    var d=await r.json();
    if(!d.length) return null;
    return{lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};
  }catch(e){return null;}
}

function renderMapMarkers(){
  if(!map||!clusterGroup) return;
  clusterGroup.clearLayers();
  mapMarkers=[];

  var withCoords=items.filter(function(i){return i.lat&&i.lng;});
  var withCityOnly=items.filter(function(i){return i.city&&i.city.trim()&&!i.lat;});

  // Annonces avec coordonnees GPS directes
  withCoords.forEach(function(item){
    addItemMarker(item,item.lat,item.lng);
  });

  // Annonces avec ville seulement - geocoder
  withCityOnly.forEach(async function(item){
    var coords=await geocodeCity(item.city);
    if(!coords) return;
    addItemMarker(item,coords.lat,coords.lng);
  });
}

function addItemMarker(item,lat,lng){
  // Filtre par rayon
  if(activeRadius>0&&userLat){
    var dist=getDistanceKm(userLat,userLng,lat,lng);
    if(dist>activeRadius) return;
  }
  var icon=L.divIcon({
    className:"",
    html:'<div class="yb-marker"><div class="yb-pin"><div class="yb-dot"></div><div class="yb-stem"></div></div><div class="yb-price">'+(item.price||0)+"e</div></div>",
    iconSize:[40,44],
    iconAnchor:[20,26]
  });
  var marker=L.marker([lat,lng],{icon:icon});
  marker.on("click",function(){
    document.getElementById("map-pop-img").src=item.imageUrl||"";
    document.getElementById("map-pop-name").innerText=item.itemName||"";
    document.getElementById("map-pop-price").innerText=(item.price||0)+"euro";
    document.getElementById("map-pop-city-txt").innerText=item.city||"";
    document.getElementById("map-pop-btn").onclick=function(){openDetail(item.id);};
    var p=document.getElementById("map-popup");
    p.classList.remove("hidden");p.style.display="flex";
  });
  clusterGroup.addLayer(marker);
  mapMarkers.push(marker);
  // Mettre a jour le compteur
  var count=clusterGroup.getLayers().length;
  document.getElementById("map-count-txt").innerText=count+(count>1?" annonces":" annonce");
}

window.setRadius=function(km){
  activeRadius=km;
  ["r5","r20","r50","r0"].forEach(function(id){
    var el=document.getElementById(id);
    if(el){el.style.background="#0f172a";el.style.color="#94a3b8";el.style.border="1px solid rgba(148,163,184,.15)";}
  });
  var activeBtn=document.getElementById("r"+km);
  if(activeBtn){activeBtn.style.background="#22d3ee";activeBtn.style.color="#000";activeBtn.style.border="none";}
  drawRadiusCircle();
  renderMapMarkers();
  if(map&&userLat&&km>0) map.setView([userLat,userLng],km<=5?13:km<=20?11:10);
};

function askGeo(){
  if(!navigator.geolocation){toast("Geolocalisation non supportee");return;}
  navigator.geolocation.getCurrentPosition(
    function(pos){
      userLat=pos.coords.latitude;userLng=pos.coords.longitude;
      if(map){
        map.setView([userLat,userLng],13);
        addUserMarker();
        renderMapMarkers();
      }
      toast("Position obtenue !",true);
    },
    function(){toast("Position refusee - affichage de toute la France");}
  );
}
window.centerMap=function(){
  if(map&&userLat) map.setView([userLat,userLng],13);
  else askGeo();
};

// Sauvegarder lat/lng lors de la publication
async function geocodeAndSave(city){
  if(!city) return null;
  return await geocodeCity(city);
}
</script>
</body>
</html>
