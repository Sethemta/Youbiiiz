<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Youbiiiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; color: white; overflow: hidden; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .brand-logo { display: inline-flex; align-items: baseline; font-weight: 800; line-height: 1; user-select: none; }
        .i-wrapper { display: inline-flex; align-items: flex-end; gap: 4px; margin: 0 4px; height: 100%; }
        .i-stem { width: 12px; height: 38px; background: #22d3ee; border-radius: 2px; }
        .i-dot { width: 12px; height: 12px; background: #22d3ee; border-radius: 2px; position: absolute; bottom: 48px; box-shadow: 0 0 20px rgba(34, 211, 238, 0.5); }
        .i-char { position: relative; display: flex; flex-direction: column; align-items: center; }
        header .i-stem { width: 5px; height: 16px; }
        header .i-dot { width: 5px; height: 5px; bottom: 20px; box-shadow: none; }
        header .i-wrapper { gap: 2px; margin: 0 2px; }
        @keyframes subtle-dribble {
            0%, 100% { transform: translateY(0); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(var(--bounce)); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .i-char:nth-child(1) .i-dot { --bounce: -10px; animation: subtle-dribble 0.9s infinite; }
        .i-char:nth-child(2) .i-dot { --bounce: -15px; animation: subtle-dribble 1.3s infinite 0.2s; }
        .i-char:nth-child(3) .i-dot { --bounce: -12px; animation: subtle-dribble 1.1s infinite 0.5s; }
        .glass-card { background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 30px rgba(0,0,0,0.1); }
        .nav-blur { background: rgba(5,5,5,0.9); backdrop-filter: saturate(180%) blur(20px); border-top: 1px solid rgba(255,255,255,0.05); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .scan-line-anim { animation: scanMove 2s linear infinite; }
        @keyframes scanMove { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #debug-console { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 10px 20px; border-radius: 99px; font-size: 12px; font-weight: bold; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; text-align: center; }
        .filter-btn { padding: 6px 14px; border-radius: 99px; font-size: 10px; font-weight: 700; border: 1px solid rgba(255,255,255,0.1); color: #71717a; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .filter-btn.active { background: #22d3ee; color: black; border-color: #22d3ee; }
        .msg-bubble-me { background: #22d3ee; color: black; border-radius: 18px 18px 4px 18px; }
        .msg-bubble-them { background: #18181b; color: white; border-radius: 18px 18px 18px 4px; border: 1px solid rgba(255,255,255,0.08); }
        @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
    </style>
</head>
<body class="bg-[#050505]">

<div id="debug-console"></div>

<!-- SPLASH -->
<div id="splash" class="fixed inset-0 z-[200] bg-[#050505] flex flex-col items-center justify-center transition-all duration-500">
    <div class="brand-logo text-7xl flex items-baseline">
        <span>YOUB</span>
        <span class="i-wrapper">
            <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
            <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
            <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
        </span>
        <span>Z</span>
    </div>
    <div class="mt-12 w-32 h-1 bg-zinc-900 rounded-full overflow-hidden">
        <div class="h-full bg-cyan-500 animate-[loading_2s_ease-in-out_infinite]" style="width:50%"></div>
    </div>
    <p class="mt-4 text-[10px] text-zinc-600 font-bold uppercase tracking-widest">Connexion...</p>
</div>

<!-- APP -->
<div id="app" class="hidden opacity-0 transition-opacity duration-700 h-screen flex flex-col">

    <header class="h-20 px-6 flex items-center justify-between nav-blur z-50 shrink-0">
        <div class="brand-logo text-2xl cursor-pointer" onclick="switchView('home')">
            <span>YOUB</span>
            <span class="i-wrapper">
                <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
                <div class="i-char"><div class="i-dot"></div><div class="i-stem"></div></div>
            </span>
            <span>Z</span>
        </div>
        <div class="flex items-center gap-3">
            <div id="user-badge" class="text-[10px] font-mono text-zinc-500">...</div>
            <button onclick="switchView('notifications')" class="relative w-10 h-10 rounded-full bg-zinc-900 border border-white/10 flex items-center justify-center">
                <i class="fa-solid fa-bell text-sm text-zinc-400"></i>
                <span id="notif-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-[9px] font-black text-white flex items-center justify-center">0</span>
            </button>
            <div onclick="switchView('profile')" class="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center border border-white/10 cursor-pointer">
                <i class="fa-solid fa-user text-sm text-white"></i>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-32 relative">

        <!-- HOME -->
        <div id="view-home" class="px-6 pt-6 max-w-lg mx-auto">
            <div class="glass-card rounded-[2.5rem] p-8 relative overflow-hidden mb-6 text-center cursor-pointer active:scale-95 transition-transform" onclick="startScan()">
                <div class="relative z-10 flex flex-col items-center gap-4">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center shadow-[0_0_30px_rgba(34,211,238,0.4)] border-[4px] border-[#050505]">
                        <i class="fa-solid fa-camera text-3xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-extrabold tracking-tighter text-white">SCANNER UN OBJET</h1>
                        <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mt-1">IA active ‚Ä¢ Instantan√©</p>
                    </div>
                </div>
            </div>

            <!-- FILTRES -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-4">
                <button class="filter-btn active" onclick="filterFeed('all', this)">Tout</button>
                <button class="filter-btn" onclick="filterFeed('High-Tech', this)">High-Tech</button>
                <button class="filter-btn" onclick="filterFeed('Jeux vid√©o', this)">Jeux vid√©o</button>
                <button class="filter-btn" onclick="filterFeed('Informatique', this)">Informatique</button>
                <button class="filter-btn" onclick="filterFeed('Mode', this)">Mode</button>
                <button class="filter-btn" onclick="filterFeed('Maison', this)">Maison</button>
                <button class="filter-btn" onclick="filterFeed('Sport', this)">Sport</button>
            </div>

            <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-2">
                <h2 class="text-lg font-bold tracking-tight">Derniers Drops</h2>
                <div class="text-[10px] text-green-500 font-bold uppercase flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Live Sync
                </div>
            </div>

            <div id="feed" class="grid grid-cols-1 gap-4 pb-10">
                <div class="py-10 text-center text-zinc-700"><i class="fa-solid fa-circle-notch animate-spin text-2xl"></i></div>
            </div>
        </div>

        <!-- NOTIFICATIONS -->
        <div id="view-notifications" class="px-6 pt-6 max-w-lg mx-auto hidden">
            <h2 class="font-extrabold text-xl mb-6">Notifications</h2>
            <div id="notif-list" class="flex flex-col gap-3 pb-32">
                <div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Aucune notification</div>
            </div>
        </div>

        <!-- SEARCH -->
        <div id="view-search" class="px-6 pt-6 max-w-lg mx-auto hidden">
            <div class="relative mb-6">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                <input id="search-input" type="text" placeholder="Rechercher un objet..." oninput="searchItems(this.value)"
                    class="w-full bg-zinc-900 border border-white/10 rounded-2xl pl-12 pr-4 py-4 text-white placeholder-zinc-600 outline-none focus:border-cyan-500 transition-colors text-sm font-medium">
            </div>
            <div id="search-results" class="grid grid-cols-1 gap-4 pb-10">
                <div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Tapez pour rechercher</div>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="view-profile" class="px-6 pt-6 max-w-lg mx-auto hidden">
            <div class="glass-card rounded-[2.5rem] p-6 mb-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center border-2 border-white/10 shrink-0">
                        <i class="fa-solid fa-user text-2xl text-white"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="font-extrabold text-lg text-white">Mon Profil</h2>
                        <p id="profile-uid" class="text-[10px] text-zinc-500 font-mono">...</p>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span class="text-[10px] text-green-500 font-bold">Actif</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-black/50 rounded-2xl p-3 text-center border border-white/5">
                        <p id="profile-count" class="text-2xl font-black text-cyan-400">0</p>
                        <p class="text-[9px] text-zinc-500 uppercase font-bold mt-1">Annonces</p>
                    </div>
                    <div class="bg-black/50 rounded-2xl p-3 text-center border border-white/5">
                        <p id="profile-total" class="text-2xl font-black text-white">0‚Ç¨</p>
                        <p class="text-[9px] text-zinc-500 uppercase font-bold mt-1">Valeur totale</p>
                    </div>
                    <div class="bg-black/50 rounded-2xl p-3 text-center border border-white/5">
                        <p class="text-2xl font-black text-yellow-400">&#9733; 5.0</p>
                        <p class="text-[9px] text-zinc-500 uppercase font-bold mt-1">Note</p>
                    </div>
                </div>
            </div>
            <h3 class="font-bold text-sm text-zinc-400 uppercase tracking-widest mb-3">Mes annonces</h3>
            <div id="my-listings" class="grid grid-cols-1 gap-4 pb-32">
                <div class="py-8 text-center text-zinc-600 text-xs font-bold uppercase">Aucune annonce</div>
            </div>
        </div>

    </main>

    <!-- NAV -->
    <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-md h-20 glass-card rounded-full flex items-center justify-around px-8 shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-[100]">
        <button onclick="switchView('home')" id="nav-home" class="text-2xl text-cyan-400"><i class="fa-solid fa-house"></i></button>
        <button onclick="startScan()" class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-full flex items-center justify-center text-white shadow-[0_0_25px_rgba(34,211,238,0.5)] -mt-8 border-[6px] border-[#050505] active:scale-90 transition-transform">
            <i class="fa-solid fa-plus text-2xl"></i>
        </button>
        <button onclick="switchView('search')" id="nav-search" class="text-2xl text-zinc-600"><i class="fa-solid fa-magnifying-glass"></i></button>
    </nav>
</div>

<!-- SCAN OVERLAY -->
<div id="scan-overlay" class="fixed inset-0 z-[300] bg-black hidden flex-col p-6">
    <div class="flex justify-between items-center mb-6">
        <span class="text-xs font-bold tracking-[0.3em] text-cyan-500">SCANNER IA</span>
        <button onclick="stopScan()" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="flex-1 relative bg-zinc-900 rounded-[3rem] overflow-hidden border border-white/10 shadow-2xl flex flex-col justify-center items-center">
        <img id="scan-preview" class="absolute inset-0 w-full h-full object-cover hidden z-10">
        <div id="scan-line" class="hidden absolute w-full h-[3px] bg-cyan-400 shadow-[0_0_20px_#22d3ee] top-0 left-0 z-20 scan-line-anim"></div>
        <div id="scan-placeholder" class="text-center">
            <i class="fa-solid fa-camera text-4xl text-zinc-700 mb-4"></i>
            <p class="text-[10px] font-bold uppercase tracking-widest text-zinc-500">Alignez l'objet</p>
        </div>
        <div id="uploading-msg" class="hidden absolute inset-0 bg-black/90 z-30 flex flex-col items-center justify-center">
            <i class="fa-solid fa-circle-notch animate-spin text-cyan-500 text-4xl mb-4"></i>
            <span class="text-cyan-500 text-xs font-bold animate-pulse text-center tracking-widest">ANALYSE EN COURS...</span>
        </div>
    </div>
    <div id="ai-hud" class="hidden w-full mt-6 bg-zinc-900/50 p-6 rounded-[2rem] border border-white/10 modal-enter overflow-y-auto max-h-[55vh] no-scrollbar">
        <div class="flex justify-between items-center mb-4">
            <span class="text-xs text-zinc-400 font-mono uppercase">Analyse termin√©e</span>
            <span class="text-xs text-green-400 font-bold"><i class="fa-solid fa-check-circle"></i> Succ√®s</span>
        </div>
        <input id="ai-item-name" class="w-full bg-transparent text-xl font-extrabold text-white mb-3 border-b border-white/10 focus:border-cyan-500 outline-none pb-2" value="...">
        
        <!-- Marque & Mod√®le -->
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="bg-black p-3 rounded-xl border border-white/10">
                <p class="text-[9px] text-zinc-500 uppercase font-bold">Marque</p>
                <p id="ai-brand" class="text-sm font-black text-cyan-400">...</p>
            </div>
            <div class="bg-black p-3 rounded-xl border border-white/10">
                <p class="text-[9px] text-zinc-500 uppercase font-bold">Mod√®le</p>
                <p id="ai-model" class="text-sm font-black text-white truncate">...</p>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="bg-black p-3 rounded-xl border border-white/10">
                <p class="text-[9px] text-zinc-500 uppercase font-bold">Prix</p>
                <p id="ai-price" class="text-lg font-black text-cyan-400">...</p>
            </div>
            <div class="bg-black p-3 rounded-xl border border-white/10">
                <p class="text-[9px] text-zinc-500 uppercase font-bold">Cat√©gorie</p>
                <p id="ai-category" class="text-xs font-black text-white">...</p>
            </div>
            <div class="bg-black p-3 rounded-xl border border-white/10">
                <p class="text-[9px] text-zinc-500 uppercase font-bold">√âtat</p>
                <p id="ai-condition" class="text-xs font-black text-green-400">...</p>
            </div>
        </div>

        <div class="bg-black/50 p-3 rounded-xl border border-white/5 mb-3">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-1">Description</p>
            <textarea id="ai-desc" class="w-full bg-transparent text-xs text-zinc-300 outline-none h-14 resize-none" readonly></textarea>
        </div>

        <!-- LIVRAISON -->
        <div class="bg-black/50 p-3 rounded-xl border border-white/5 mb-4">
            <p class="text-[9px] text-zinc-500 uppercase font-bold mb-2">Mode de livraison</p>
            <div class="flex flex-col gap-2">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="ship-hand" class="w-4 h-4 accent-cyan-500" onchange="updateShipping()">
                    <div class="flex-1">
                        <span class="text-xs font-bold text-white">ü§ù Remise en main propre</span>
                        <span class="text-[10px] text-zinc-500 ml-2">Gratuit</span>
                    </div>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="ship-relay" class="w-4 h-4 accent-cyan-500" onchange="updateShipping()">
                    <div class="flex-1">
                        <span class="text-xs font-bold text-white">üì¶ Mondial Relay</span>
                        <input type="number" id="ship-relay-price" placeholder="Prix ‚Ç¨" class="ml-2 w-16 bg-zinc-800 border border-white/10 rounded-lg px-2 py-0.5 text-xs text-white outline-none focus:border-cyan-500" value="5">
                    </div>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="ship-colissimo" class="w-4 h-4 accent-cyan-500" onchange="updateShipping()">
                    <div class="flex-1">
                        <span class="text-xs font-bold text-white">üöö Colissimo</span>
                        <input type="number" id="ship-colissimo-price" placeholder="Prix ‚Ç¨" class="ml-2 w-16 bg-zinc-800 border border-white/10 rounded-lg px-2 py-0.5 text-xs text-white outline-none focus:border-cyan-500" value="8">
                    </div>
                </label>
            </div>
        </div>

        <button id="validate-btn" class="w-full bg-cyan-500 text-black font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">VALIDER & PUBLIER</button>
    </div>
    <canvas id="capture-canvas" class="hidden"></canvas>
    <div class="h-24 flex items-center justify-center shrink-0" style="position:relative; z-index:50;">
        <input type="file" id="camera-input" class="hidden" accept="image/*" onchange="handleImageFile(event)">
        <button id="capture-btn" onclick="capturePhoto()" class="w-20 h-20 bg-white rounded-full border-[6px] border-black ring-2 ring-white active:scale-90 transition-all shadow-2xl"></button>
    </div>
</div>
<video id="camera-video" class="hidden" style="position:fixed; top:120px; left:0; right:0; width:100%; height:calc(100% - 220px); object-fit:cover; z-index:310;" autoplay playsinline muted></video>

<!-- DETAIL ANNONCE -->
<div id="detail-modal" class="fixed inset-0 z-[400] bg-[#050505] hidden flex-col slide-in">
    <div class="h-14 flex items-center px-4 nav-blur shrink-0">
        <button onclick="closeDetail()" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center mr-4"><i class="fa-solid fa-arrow-left text-white"></i></button>
        <span class="font-bold text-sm">D√©tail de l'annonce</span>
    </div>
    <div class="flex-1 overflow-y-auto no-scrollbar">
        <div id="detail-img-wrap" class="w-full h-80 bg-zinc-900 relative overflow-hidden">
            <img id="detail-img" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
            <div class="absolute bottom-4 left-4 right-4 flex items-end justify-between">
                <p id="detail-price" class="text-cyan-400 font-black text-4xl drop-shadow-lg"></p>
                <span id="detail-condition" class="bg-black/70 backdrop-blur text-white text-[10px] font-bold px-3 py-1.5 rounded-full border border-white/10"></span>
            </div>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <h2 id="detail-title" class="font-extrabold text-2xl text-white leading-tight mb-2"></h2>
                <span id="detail-category" class="text-[10px] text-zinc-500 font-bold uppercase bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 inline-block"></span>
            </div>
            <!-- Marque & Mod√®le -->
            <p id="detail-brand" class="text-xs text-zinc-500 font-mono mb-3"></p>

            <div class="glass-card rounded-2xl p-5 mb-4">
                <p class="text-[9px] text-zinc-500 uppercase font-bold mb-3 tracking-widest">Description</p>
                <p id="detail-desc" class="text-sm text-zinc-300 leading-loose"></p>
            </div>

            <!-- Livraison -->
            <div class="glass-card rounded-2xl p-4 mb-4">
                <p class="text-[9px] text-zinc-500 uppercase font-bold mb-3">Livraison propos√©e</p>
                <div id="detail-shipping" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="glass-card rounded-2xl p-4 mb-6">
                <p class="text-[9px] text-zinc-500 uppercase font-bold mb-3">Vendeur</p>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center">
                        <i class="fa-solid fa-user text-sm text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p id="detail-seller" class="font-bold text-sm text-white"></p>
                        <p id="detail-seller-rating" class="text-[10px] text-yellow-400">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Nouveau vendeur</p>
                    </div>
                </div>
            </div>
            <button id="contact-btn" onclick="" class="w-full bg-zinc-900 border border-white/10 text-white font-bold py-4 rounded-xl mb-3 flex items-center justify-center gap-2 active:scale-95 transition-transform">
                <i class="fa-solid fa-message"></i> Contacter le vendeur
            </button>
            <button id="buy-btn" onclick="" class="w-full bg-cyan-500 text-black font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(34,211,238,0.3)] active:scale-95 transition-transform">
                <i class="fa-brands fa-apple-pay text-xl"></i> Acheter maintenant
            </button>
        </div>
    </div>
</div>

<!-- MESSAGERIE -->
<div id="chat-modal" class="fixed inset-0 z-[500] bg-[#050505] hidden flex-col">
    <div class="h-14 flex items-center px-4 nav-blur shrink-0">
        <button onclick="closeChat()" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center mr-3"><i class="fa-solid fa-arrow-left text-white"></i></button>
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center">
                <i class="fa-solid fa-user text-xs text-white"></i>
            </div>
            <div>
                <p id="chat-seller-name" class="font-bold text-sm text-white"></p>
                <p class="text-[10px] text-green-400">En ligne</p>
            </div>
        </div>
    </div>
    <div class="px-4 py-2 bg-zinc-900/50 border-b border-white/5 flex gap-3 items-center shrink-0">
        <img id="chat-item-img" class="w-10 h-10 rounded-xl object-cover border border-white/10">
        <div>
            <p id="chat-item-name" class="text-xs font-bold text-white truncate max-w-[200px]"></p>
            <p id="chat-item-price" class="text-xs text-cyan-400 font-bold"></p>
        </div>
    </div>
    <div id="chat-messages" class="flex-1 overflow-y-auto no-scrollbar p-4 flex flex-col gap-3">
        <div class="text-center py-4">
            <span class="text-[10px] text-zinc-600 font-bold uppercase bg-zinc-900 px-3 py-1 rounded-full">D√©but de la conversation</span>
        </div>
    </div>
    <div class="p-4 nav-blur shrink-0">
        <div class="flex gap-3 items-center">
            <input id="chat-input" type="text" placeholder="Votre message..." 
                class="flex-1 bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-white placeholder-zinc-600 outline-none focus:border-cyan-500 text-sm"
                onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="w-12 h-12 bg-cyan-500 rounded-2xl flex items-center justify-center active:scale-90 transition-transform">
                <i class="fa-solid fa-paper-plane text-black"></i>
            </button>
        </div>
        <!-- Messages rapides -->
        <div class="flex gap-2 mt-2 overflow-x-auto no-scrollbar">
            <button onclick="quickMsg('Est-ce encore disponible ?')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Disponible ?</button>
            <button onclick="quickMsg('Quel est le dernier prix ?')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Dernier prix ?</button>
            <button onclick="quickMsg('Possible de livrer ?')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Livraison ?</button>
            <button onclick="quickMsg('Je suis int√©ress√©(e) !')" class="text-[10px] text-zinc-400 bg-zinc-900 px-3 py-1.5 rounded-full border border-white/5 whitespace-nowrap">Int√©ress√© !</button>
        </div>
    </div>
</div>


<!-- EDIT ANNONCE MODAL -->
<div id="edit-modal" class="fixed inset-0 z-[700] bg-black/95 backdrop-blur-sm hidden items-end justify-center p-4">
    <div class="bg-[#0f0f0f] w-full max-w-md rounded-[2.5rem] border border-white/10 modal-enter shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b border-white/5">
            <h3 class="font-extrabold text-lg">Modifier l'annonce</h3>
            <button onclick="closeEdit()" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center"><i class="fa-solid fa-xmark text-white"></i></button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[75vh] no-scrollbar">
            <div class="mb-4">
                <label class="text-[10px] text-zinc-500 uppercase font-bold mb-1 block">Titre</label>
                <input id="edit-title" class="w-full bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-white outline-none focus:border-cyan-500 text-sm font-bold">
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="text-[10px] text-zinc-500 uppercase font-bold mb-1 block">Prix (‚Ç¨)</label>
                    <input id="edit-price" type="number" class="w-full bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-cyan-400 font-black outline-none focus:border-cyan-500 text-lg">
                </div>
                <div>
                    <label class="text-[10px] text-zinc-500 uppercase font-bold mb-1 block">√âtat</label>
                    <select id="edit-condition" class="w-full bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-white outline-none focus:border-cyan-500 text-sm">
                        <option>Neuf</option>
                        <option>Tr√®s bon √©tat</option>
                        <option>Bon √©tat</option>
                        <option>√âtat correct</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="text-[10px] text-zinc-500 uppercase font-bold mb-1 block">Cat√©gorie</label>
                <select id="edit-category" class="w-full bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-white outline-none focus:border-cyan-500 text-sm">
                    <option>High-Tech</option>
                    <option>Jeux vid√©o</option>
                    <option>Informatique</option>
                    <option>Mode</option>
                    <option>Maison</option>
                    <option>Sport</option>
                    <option>Divers</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="text-[10px] text-zinc-500 uppercase font-bold mb-1 block">Description</label>
                <textarea id="edit-desc" class="w-full bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-white outline-none focus:border-cyan-500 text-sm resize-none h-24"></textarea>
            </div>
            <button id="edit-save-btn" onclick="saveEdit()" class="w-full bg-cyan-500 text-black font-bold py-4 rounded-2xl mb-3 active:scale-95 transition-transform">
                <i class="fa-solid fa-check mr-2"></i>Sauvegarder
            </button>
            <button onclick="confirmDelete()" class="w-full bg-red-500/10 border border-red-500/30 text-red-400 font-bold py-4 rounded-2xl active:scale-95 transition-transform">
                <i class="fa-solid fa-trash mr-2"></i>Supprimer l'annonce
            </button>
        </div>
    </div>
</div>

<!-- CONFIRM DELETE -->
<div id="confirm-delete-modal" class="fixed inset-0 z-[800] bg-black/95 backdrop-blur-sm hidden items-center justify-center p-6">
    <div class="bg-[#0f0f0f] w-full max-w-sm p-6 rounded-[2rem] border border-red-500/20 modal-enter text-center">
        <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid fa-trash text-red-400 text-2xl"></i>
        </div>
        <h3 class="font-extrabold text-lg mb-2">Supprimer ?</h3>
        <p class="text-zinc-500 text-sm mb-6">Cette annonce sera d√©finitivement supprim√©e.</p>
        <div class="flex gap-3">
            <button onclick="closeConfirmDelete()" class="flex-1 bg-zinc-900 text-white font-bold py-3 rounded-2xl border border-white/10">Annuler</button>
            <button onclick="deleteItem()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-2xl">Supprimer</button>
        </div>
    </div>
</div>

<!-- PAIEMENT MODAL -->
<div id="payment-modal" class="fixed inset-0 z-[600] bg-black/95 backdrop-blur-sm hidden items-end sm:items-center justify-center p-4">
    <div class="bg-[#0f0f0f] w-full max-w-md p-6 rounded-[2.5rem] border border-white/10 modal-enter shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-500"><i class="fa-solid fa-shield-halved"></i></div>
                <span class="font-bold text-sm">Paiement S√©curis√© ¬∑ Stripe</span>
            </div>
            <button onclick="closePayment()" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex gap-4 mb-6">
            <div id="pay-img" class="w-20 h-20 rounded-2xl bg-zinc-800 bg-cover bg-center border border-white/10 shrink-0"></div>
            <div class="flex-1">
                <h4 id="pay-title" class="font-bold text-base leading-tight mb-1">...</h4>
                <p id="pay-price" class="text-cyan-500 font-extrabold text-2xl">0‚Ç¨</p>
                <p id="pay-shipping-info" class="text-xs text-zinc-500 mt-1"></p>
            </div>
        </div>
        <!-- Choix livraison -->
        <div id="pay-shipping-options" class="mb-6 hidden">
            <p class="text-[10px] text-zinc-500 uppercase font-bold mb-2">Mode de livraison</p>
            <div id="pay-shipping-list" class="flex flex-col gap-2"></div>
        </div>
        <div class="bg-zinc-900 rounded-2xl p-4 mb-6 border border-white/5">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-zinc-400">Article</span>
                <span id="pay-subtotal" class="font-bold text-white">0‚Ç¨</span>
            </div>
            <div class="flex justify-between text-sm mb-3">
                <span class="text-zinc-400">Livraison</span>
                <span id="pay-ship-cost" class="font-bold text-white">‚Äî</span>
            </div>
            <div class="flex justify-between border-t border-white/5 pt-3">
                <span class="font-bold text-white">Total</span>
                <span id="pay-total" class="font-extrabold text-cyan-400 text-lg">0‚Ç¨</span>
            </div>
        </div>
        <button id="stripe-pay-btn" onclick="processStripePayment()" class="w-full bg-[#635bff] text-white font-bold py-4 rounded-2xl flex justify-center items-center gap-3 shadow-[0_0_20px_rgba(99,91,255,0.4)] active:scale-95 transition-transform mb-3">
            <i class="fa-brands fa-stripe text-2xl"></i> Payer avec Stripe
        </button>
        <p class="text-center text-[10px] text-zinc-600">üîí Paiement crypt√© ¬∑ Remboursement si probl√®me</p>
    </div>
</div>

<!-- NOTATION MODAL -->
<div id="rating-modal" class="fixed inset-0 z-[900] bg-black/95 backdrop-blur-sm hidden items-center justify-center p-6">
    <div class="bg-[#0f0f0f] w-full max-w-sm p-6 rounded-[2.5rem] border border-white/10 modal-enter text-center">
        <div class="w-16 h-16 rounded-full bg-yellow-500/10 flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid fa-star text-yellow-400 text-2xl"></i>
        </div>
        <h3 class="font-extrabold text-lg mb-1">Laisser une note</h3>
        <p id="rating-subtitle" class="text-zinc-500 text-xs mb-6">Comment s'est pass√©e cette transaction ?</p>
        <div class="flex justify-center gap-3 mb-6" id="star-rating">
            <button onclick="setRating(1)" class="star-btn text-4xl text-zinc-700 transition-all" data-val="1">‚òÖ</button>
            <button onclick="setRating(2)" class="star-btn text-4xl text-zinc-700 transition-all" data-val="2">‚òÖ</button>
            <button onclick="setRating(3)" class="star-btn text-4xl text-zinc-700 transition-all" data-val="3">‚òÖ</button>
            <button onclick="setRating(4)" class="star-btn text-4xl text-zinc-700 transition-all" data-val="4">‚òÖ</button>
            <button onclick="setRating(5)" class="star-btn text-4xl text-zinc-700 transition-all" data-val="5">‚òÖ</button>
        </div>
        <textarea id="rating-comment" placeholder="Commentaire (optionnel)..." class="w-full bg-zinc-900 border border-white/10 rounded-2xl px-4 py-3 text-white text-sm outline-none focus:border-cyan-500 resize-none h-20 mb-4"></textarea>
        <button onclick="submitRating()" class="w-full bg-yellow-500 text-black font-bold py-4 rounded-2xl active:scale-95 transition-transform">
            Envoyer ma note
        </button>
        <button onclick="closeRating()" class="w-full text-zinc-600 text-sm mt-3">Passer</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, query, where, orderBy, getDocs, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOSIhWwrlkhNfk8Y3-tl9IebJW0YBA7d4",
        authDomain: "youbiiiz-app.firebaseapp.com",
        projectId: "youbiiiz-app",
        storageBucket: "youbiiiz-app.firebasestorage.app",
        messagingSenderId: "664733497216",
        appId: "1:664733497216:web:ae19fbadf0fa509f59b365"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let currentScanData = null;
    let allItems = [];
    let currentItem = null;
    let chatMessages = [];

    // Catch ALL JS errors and show them
    window.onerror = function(msg, src, line, col, err) {
        const debug = document.getElementById('debug-console');
        debug.style.display = 'block';
        debug.innerText = 'JS ERROR: ' + msg + ' (line ' + line + ')';
    };

    function logError(msg) {
        console.error(msg);
        const debug = document.getElementById('debug-console');
        debug.style.display = 'block';
        debug.innerText = msg;
        setTimeout(() => debug.style.display = 'none', 8000);
    }

    // AUTH
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('user-badge').innerText = `ID: ${user.uid.substring(0,4)}`;
            document.getElementById('profile-uid').innerText = `UID: ${user.uid.substring(0,12)}...`;
            startApp();
        } else {
            signInAnonymously(auth).catch(e => logError("Auth Error: " + e.message));
        }
    });

    function startApp() {
        setTimeout(() => {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            setTimeout(() => document.getElementById('app').style.opacity = '1', 100);
            initFeed();
            initNotifications();
            checkPaymentReturn();
        }, 1000);
    }

    // FEED
    function initFeed() {
        const feedCol = collection(db, 'scans');
        onSnapshot(feedCol, (snapshot) => {
            allItems = [];
            snapshot.forEach(d => allItems.push({id: d.id, ...d.data()}));
            allItems.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            renderFeed(allItems);
            updateProfileListings();
        }, (error) => logError("Feed Error: " + error.message));
    }

    function renderFeed(items) {
        const container = document.getElementById('feed');
        if (items.length === 0) {
            container.innerHTML = `<div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Aucune annonce</div>`;
            return;
        }
        container.innerHTML = items.map(item => itemCard(item)).join('');
    }

    function itemCard(item) {
        const desc = item.description ? item.description.substring(0, 80) + (item.description.length > 80 ? '...' : '') : '';
        return `
        <div class="glass-card rounded-[2rem] overflow-hidden fade-in cursor-pointer active:scale-[0.98] transition-transform" onclick="openDetail('${item.id}')">
            <div class="w-full h-52 bg-zinc-900 overflow-hidden relative">
                <img src="${item.imageUrl || ''}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\'w-full h-full flex items-center justify-center text-zinc-700\'><i class=\'fa-solid fa-image text-4xl\'></i></div>'">
                <div class="absolute top-3 right-3 flex gap-2">
                    ${item.condition ? `<span class="bg-black/70 backdrop-blur text-white text-[10px] font-bold px-3 py-1 rounded-full border border-white/10">${item.condition}</span>` : ''}
                </div>
                <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-black/80 to-transparent"></div>
                <p class="absolute bottom-3 left-4 text-cyan-400 font-black text-2xl">${item.price || 0}‚Ç¨</p>
            </div>
            <div class="p-4">
                <div class="flex items-start justify-between gap-2 mb-2">
                    <h4 class="font-bold text-base text-white leading-tight">${item.itemName || 'Objet'}</h4>
                    <span class="text-[9px] text-zinc-500 font-bold uppercase bg-zinc-900 px-2 py-1 rounded-lg border border-white/5 shrink-0">${item.category || 'Divers'}</span>
                </div>
                ${desc ? `<p class="text-xs text-zinc-500 leading-relaxed">${desc}</p>` : ''}
            </div>
        </div>`;
    }

    // FILTRES
    window.filterFeed = (cat, btn) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (cat === 'all') {
            renderFeed(allItems);
        } else {
            const filtered = allItems.filter(i => (i.category || '').toLowerCase().includes(cat.toLowerCase()));
            renderFeed(filtered);
        }
    };

    // RECHERCHE
    window.searchItems = (query) => {
        const container = document.getElementById('search-results');
        if (!query.trim()) {
            container.innerHTML = `<div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Tapez pour rechercher</div>`;
            return;
        }
        const results = allItems.filter(i =>
            (i.itemName || '').toLowerCase().includes(query.toLowerCase()) ||
            (i.category || '').toLowerCase().includes(query.toLowerCase()) ||
            (i.description || '').toLowerCase().includes(query.toLowerCase())
        );
        if (results.length === 0) {
            container.innerHTML = `<div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Aucun r√©sultat</div>`;
        } else {
            container.innerHTML = results.map(item => itemCard(item)).join('');
        }
    };

    // PROFIL
    function updateProfileListings() {
        if (!currentUser) return;
        const myItems = allItems.filter(i => i.userId === currentUser.uid);
        document.getElementById('profile-count').innerText = myItems.length;
        const total = myItems.reduce((sum, i) => sum + (parseFloat(i.price) || 0), 0);
        document.getElementById('profile-total').innerText = total + '‚Ç¨';
        const container = document.getElementById('my-listings');
        if (myItems.length === 0) {
            container.innerHTML = '<div class="py-8 text-center text-zinc-600 text-xs font-bold uppercase">Aucune annonce</div>';
        } else {
            container.innerHTML = myItems.map(item => myItemCard(item)).join('');
        }
    }

    function myItemCard(item) {
        return `
        <div class="glass-card rounded-[2rem] overflow-hidden fade-in">
            <div class="w-full h-44 bg-zinc-900 overflow-hidden relative">
                <img src="${item.imageUrl || ''}" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-black/80 to-transparent"></div>
                <p class="absolute bottom-3 left-4 text-cyan-400 font-black text-xl">${item.price || 0}‚Ç¨</p>
                <span class="absolute top-3 right-3 bg-black/70 backdrop-blur text-white text-[10px] font-bold px-3 py-1 rounded-full border border-white/10">${item.condition || ''}</span>
            </div>
            <div class="p-4">
                <h4 class="font-bold text-base text-white mb-1">${item.itemName || 'Objet'}</h4>
                <span class="text-[9px] text-zinc-500 font-bold uppercase bg-zinc-900 px-2 py-1 rounded-lg border border-white/5">${item.category || 'Divers'}</span>
                <div class="flex gap-2 mt-4">
                    <button onclick="openEdit('${item.id}')" class="flex-1 bg-zinc-900 border border-white/10 text-white font-bold py-3 rounded-xl text-xs flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        <i class="fa-solid fa-pen"></i> Modifier
                    </button>
                    <button onclick="confirmDelete('${item.id}')" class="flex-1 bg-red-500/10 border border-red-500/20 text-red-400 font-bold py-3 rounded-xl text-xs flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        <i class="fa-solid fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>`;
    }

        let editingItemId = null;
    let deletingItemId = null;

    window.openEdit = (itemId) => {
        const item = allItems.find(i => i.id === itemId);
        if (!item) return;
        editingItemId = itemId;
        document.getElementById('edit-title').value = item.itemName || '';
        document.getElementById('edit-price').value = item.price || 0;
        document.getElementById('edit-desc').value = item.description || '';
        document.getElementById('edit-condition').value = item.condition || 'Bon √©tat';
        document.getElementById('edit-category').value = item.category || 'Divers';
        document.getElementById('edit-modal').classList.remove('hidden');
        document.getElementById('edit-modal').classList.add('flex');
    };

    window.closeEdit = () => {
        document.getElementById('edit-modal').classList.add('hidden');
        document.getElementById('edit-modal').classList.remove('flex');
        editingItemId = null;
    };

    window.saveEdit = async () => {
        if (!editingItemId) return;
        const btn = document.getElementById('edit-save-btn');
        btn.innerText = 'Sauvegarde...';
        btn.disabled = true;
        try {
            await updateDoc(doc(db, 'scans', editingItemId), {
                itemName: document.getElementById('edit-title').value,
                price: parseFloat(document.getElementById('edit-price').value) || 0,
                description: document.getElementById('edit-desc').value,
                condition: document.getElementById('edit-condition').value,
                category: document.getElementById('edit-category').value,
            });
            window.closeEdit();
        } catch (err) {
            logError('Erreur modification: ' + err.message);
        }
        btn.innerText = 'Sauvegarder';
        btn.disabled = false;
    };

    window.confirmDelete = (itemId) => {
        deletingItemId = itemId;
        window.closeEdit();
        document.getElementById('confirm-delete-modal').classList.remove('hidden');
        document.getElementById('confirm-delete-modal').classList.add('flex');
    };

    window.closeConfirmDelete = () => {
        document.getElementById('confirm-delete-modal').classList.add('hidden');
        document.getElementById('confirm-delete-modal').classList.remove('flex');
        deletingItemId = null;
    };

    window.deleteItem = async () => {
        if (!deletingItemId) return;
        try {
            await deleteDoc(doc(db, 'scans', deletingItemId));
            window.closeConfirmDelete();
        } catch (err) {
            logError('Erreur suppression: ' + err.message);
        }
    };

    // DETAIL ANNONCE
    window.openDetail = (itemId) => {
        const item = allItems.find(i => i.id === itemId);
        if (!item) return;
        currentItem = item;
        document.getElementById('detail-img').src = item.imageUrl || '';
        document.getElementById('detail-title').innerText = item.itemName || 'Objet';
        document.getElementById('detail-price').innerText = (item.price || 0) + '‚Ç¨';
        document.getElementById('detail-category').innerText = item.category || 'Divers';
        document.getElementById('detail-img').style.height = '320px';
        document.getElementById('detail-condition').innerText = item.condition || 'Bon √©tat';
        document.getElementById('detail-desc').innerText = item.description || 'Aucune description.';
        document.getElementById('detail-seller').innerText = 'Vendeur #' + (item.userId || '').substring(0, 6);
        const brandEl = document.getElementById('detail-brand');
        if (brandEl) brandEl.innerText = [item.brand, item.model].filter(Boolean).join(' ‚Äî ') || '';
        const shipEl = document.getElementById('detail-shipping');
        if (shipEl) {
            if (item.shipping && item.shipping.length > 0) {
                shipEl.innerHTML = item.shipping.map(s =>
                    '<span class="bg-zinc-900 border border-white/5 rounded-xl px-3 py-1.5 text-xs font-bold text-white">' + s.method + ' <span class="text-cyan-400">' + (s.price === 0 ? 'Gratuit' : s.price + '‚Ç¨') + '</span></span>'
                ).join('');
            } else {
                shipEl.innerHTML = '<span class="text-xs text-zinc-500">Non renseign√©</span>';
            }
        }
        document.getElementById('contact-btn').onclick = () => openChat(item);
        document.getElementById('buy-btn').onclick = () => openPaymentFromItem(item);
        loadSellerRating(item.userId);
        const modal = document.getElementById('detail-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };

    window.closeDetail = () => {
        const modal = document.getElementById('detail-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    };

    // CHAT
    window.openChat = (item) => {
        currentItem = item;
        chatMessages = [];
        document.getElementById('chat-seller-name').innerText = 'Vendeur #' + (item.userId || '').substring(0, 6);
        document.getElementById('chat-item-name').innerText = item.itemName || 'Objet';
        document.getElementById('chat-item-price').innerText = (item.price || 0) + '‚Ç¨';
        document.getElementById('chat-item-img').src = item.imageUrl || '';
        document.getElementById('chat-messages').innerHTML = `
            <div class="text-center py-4">
                <span class="text-[10px] text-zinc-600 font-bold uppercase bg-zinc-900 px-3 py-1 rounded-full">D√©but de la conversation</span>
            </div>`;
        const modal = document.getElementById('chat-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.classList.add('flex-col');
        closeDetail();
    };

    window.closeChat = () => {
        document.getElementById('chat-modal').classList.add('hidden');
        document.getElementById('chat-modal').classList.remove('flex');
    };

    window.sendMessage = () => {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;
        appendMessage(text, true);
        input.value = '';
        // Simulation r√©ponse vendeur
        setTimeout(() => {
            const responses = [
                "Bonjour ! Oui l'objet est toujours disponible üòä",
                "Je peux faire un petit geste sur le prix si vous √™tes s√©rieux.",
                "Vous pouvez venir le voir sur place si vous voulez.",
                "Livraison possible en Mondial Relay, comptez 5‚Ç¨.",
                "L'objet est en parfait √©tat, aucun d√©faut."
            ];
            const r = responses[Math.floor(Math.random() * responses.length)];
            appendMessage(r, false);
        }, 1200);
    };

    window.quickMsg = (msg) => {
        document.getElementById('chat-input').value = msg;
        sendMessage();
    };

    function appendMessage(text, isMe) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
        div.innerHTML = `<div class="max-w-[75%] px-4 py-2.5 text-sm font-medium ${isMe ? 'msg-bubble-me' : 'msg-bubble-them'}">${text}</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // ‚îÄ‚îÄ‚îÄ STRIPE PAIEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STRIPE_PK = "pk_test_51Smby57Xwq5gHJ3CzwOMHsCkP52aG36Ybwl14pIAJAWMZKdkbTackJnSKfLR467QLPoHOU0LEfGAihlMARQ0eUt7000rv2wZAu";
    let paymentItem = null;
    let selectedShipping = null;

    window.openPaymentFromItem = (item) => {
        paymentItem = item;
        selectedShipping = null;
        document.getElementById('pay-img').style.backgroundImage = `url(${item.imageUrl})`;
        document.getElementById('pay-title').innerText = item.itemName;
        document.getElementById('pay-subtotal').innerText = item.price + '‚Ç¨';
        document.getElementById('pay-price').innerText = item.price + '‚Ç¨';
        document.getElementById('pay-ship-cost').innerText = '‚Äî';
        document.getElementById('pay-total').innerText = item.price + '‚Ç¨';

        // Shipping options
        const shipList = document.getElementById('pay-shipping-list');
        const shipOpts = document.getElementById('pay-shipping-options');
        if (item.shipping && item.shipping.length > 0) {
            shipOpts.classList.remove('hidden');
            shipList.innerHTML = item.shipping.map((s, i) => `
                <label class="flex items-center gap-3 bg-zinc-900 rounded-2xl p-3 border border-white/5 cursor-pointer">
                    <input type="radio" name="shipping" value="${i}" onchange="selectShipping(${i})" class="accent-cyan-500">
                    <span class="text-sm font-bold text-white flex-1">${s.method}</span>
                    <span class="text-cyan-400 font-bold">${s.price === 0 ? 'Gratuit' : s.price + '‚Ç¨'}</span>
                </label>`).join('');
        } else {
            shipOpts.classList.add('hidden');
        }
        document.getElementById('payment-modal').classList.remove('hidden');
        document.getElementById('payment-modal').classList.add('flex');
        closeDetail();
    };

    window.selectShipping = (idx) => {
        if (!paymentItem || !paymentItem.shipping) return;
        selectedShipping = paymentItem.shipping[idx];
        const shipCost = selectedShipping.price;
        const total = (parseFloat(paymentItem.price) || 0) + shipCost;
        document.getElementById('pay-ship-cost').innerText = shipCost === 0 ? 'Gratuit' : shipCost + '‚Ç¨';
        document.getElementById('pay-total').innerText = total + '‚Ç¨';
    };

    window.closePayment = () => {
        document.getElementById('payment-modal').classList.add('hidden');
        document.getElementById('payment-modal').classList.remove('flex');
    };

    window.processStripePayment = async () => {
        if (!paymentItem || !currentUser) return;
        if (paymentItem.shipping && paymentItem.shipping.length > 0 && !selectedShipping) {
            logError("Veuillez choisir un mode de livraison");
            return;
        }
        const btn = document.getElementById('stripe-pay-btn');
        btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i> Redirection...';
        btn.disabled = true;
        try {
            const shipCost = selectedShipping ? selectedShipping.price : 0;
            const total = (parseFloat(paymentItem.price) || 0) + shipCost;
            const resp = await fetch('https://createpayment-xjtnixfrra-uc.a.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: total,
                    itemName: paymentItem.itemName,
                    itemId: paymentItem.id,
                    buyerId: currentUser.uid,
                    sellerId: paymentItem.userId,
                })
            });
            const data = await resp.json();
            if (data.error) { logError("Erreur paiement: " + data.error); return; }
            // Notify seller
            await addDoc(collection(db, 'notifications'), {
                userId: paymentItem.userId,
                type: 'payment_initiated',
                message: `Paiement en cours pour "${paymentItem.itemName}"`,
                itemId: paymentItem.id,
                read: false,
                createdAt: serverTimestamp()
            });
            window.location.href = data.url;
        } catch (err) {
            logError("Erreur: " + err.message);
        }
        btn.innerHTML = '<i class="fa-brands fa-stripe text-2xl"></i> Payer avec Stripe';
        btn.disabled = false;
    };

    // Check payment return - called after auth ready
    function checkPaymentReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            const itemId = urlParams.get('itemId');
            const sellerId = urlParams.get('sellerId');
            history.replaceState({}, '', '/');
            setTimeout(async () => {
                if (currentUser) {
                    try {
                        await addDoc(collection(db, 'notifications'), {
                            userId: currentUser.uid,
                            type: 'payment_success',
                            message: 'Paiement valid√© ! Contactez le vendeur pour la livraison.',
                            itemId: itemId || '',
                            read: false,
                            createdAt: serverTimestamp()
                        });
                        if (sellerId) {
                            await addDoc(collection(db, 'notifications'), {
                                userId: sellerId,
                                type: 'sale',
                                message: "Votre article vient d'√™tre achet√© !",
                                itemId: itemId || '',
                                read: false,
                                createdAt: serverTimestamp()
                            });
                        }
                        ratingContext = { targetUserId: sellerId, role: 'buyer', itemId: itemId || '' };
                        setTimeout(() => openRating('vendeur'), 2000);
                    } catch(e) { console.error(e); }
                }
            }, 1500);
        }
    }

    // ‚îÄ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initNotifications() {
        if (!currentUser) return;
        const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid), orderBy('createdAt', 'desc'));
        onSnapshot(q, (snapshot) => {
            const notifs = [];
            snapshot.forEach(d => notifs.push({ id: d.id, ...d.data() }));
            const unread = notifs.filter(n => !n.read).length;
            const badge = document.getElementById('notif-badge');
            if (unread > 0) {
                badge.classList.remove('hidden');
                badge.innerText = unread;
            } else {
                badge.classList.add('hidden');
            }
            renderNotifications(notifs);
        });
    }

    function renderNotifications(notifs) {
        const container = document.getElementById('notif-list');
        if (notifs.length === 0) {
            container.innerHTML = '<div class="py-12 text-center text-zinc-600 text-xs font-bold uppercase">Aucune notification</div>';
            return;
        }
        const icons = { payment_success: '‚úÖ', payment_initiated: 'üí≥', sale: 'üéâ', rating: '‚≠ê' };
        container.innerHTML = notifs.map(n => `
            <div onclick="markRead('${n.id}')" class="glass-card rounded-2xl p-4 cursor-pointer ${n.read ? 'opacity-50' : ''} fade-in">
                <div class="flex gap-3 items-start">
                    <span class="text-2xl">${icons[n.type] || 'üîî'}</span>
                    <div class="flex-1">
                        <p class="text-sm font-bold text-white">${n.message}</p>
                        <p class="text-[10px] text-zinc-500 mt-1">${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleDateString('fr-FR', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : 'Maintenant'}</p>
                    </div>
                    ${!n.read ? '<span class="w-2 h-2 bg-cyan-400 rounded-full mt-1 shrink-0"></span>' : ''}
                </div>
            </div>`).join('');
    }

    window.markRead = async (notifId) => {
        await updateDoc(doc(db, 'notifications', notifId), { read: true });
    };

    // ‚îÄ‚îÄ‚îÄ NOTATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentRating = 0;
    let ratingContext = null;

    window.openRating = (role) => {
        currentRating = 0;
        document.querySelectorAll('.star-btn').forEach(s => s.style.color = '#3f3f46');
        document.getElementById('rating-comment').value = '';
        document.getElementById('rating-subtitle').innerText = role === 'buyer'
            ? "Comment s'est comport√© l'acheteur ?"
            : "Comment √©tait le vendeur ?";
        document.getElementById('rating-modal').classList.remove('hidden');
        document.getElementById('rating-modal').classList.add('flex');
    };

    window.closeRating = () => {
        document.getElementById('rating-modal').classList.add('hidden');
        document.getElementById('rating-modal').classList.remove('flex');
    };

    window.setRating = (val) => {
        currentRating = val;
        document.querySelectorAll('.star-btn').forEach(s => {
            s.style.color = parseInt(s.dataset.val) <= val ? '#facc15' : '#3f3f46';
            s.style.transform = parseInt(s.dataset.val) <= val ? 'scale(1.2)' : 'scale(1)';
        });
    };

    window.submitRating = async () => {
        if (currentRating === 0) { logError("Choisissez une note !"); return; }
        if (!ratingContext) return;
        try {
            const comment = document.getElementById('rating-comment').value;
            await addDoc(collection(db, 'ratings'), {
                targetUserId: ratingContext.targetUserId,
                fromUserId: currentUser.uid,
                itemId: ratingContext.itemId,
                rating: currentRating,
                comment,
                createdAt: serverTimestamp()
            });
            // Update user average rating
            await updateUserRating(ratingContext.targetUserId);
            // Notify rated user
            await addDoc(collection(db, 'notifications'), {
                userId: ratingContext.targetUserId,
                type: 'rating',
                message: `Vous avez re√ßu une note de ${currentRating}‚òÖ !`,
                read: false,
                createdAt: serverTimestamp()
            });
            closeRating();
            logError("‚≠ê Note envoy√©e !");
        } catch (err) {
            logError("Erreur notation: " + err.message);
        }
    };

    async function updateUserRating(userId) {
        try {
            const q = query(collection(db, 'ratings'), where('targetUserId', '==', userId));
            const snap = await getDocs(q);
            const ratings = [];
            snap.forEach(d => ratings.push(d.data().rating));
            if (ratings.length === 0) return;
            const avg = (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1);
            await updateDoc(doc(db, 'users', userId), { rating: parseFloat(avg), ratingCount: ratings.length });
        } catch (e) {}
    }

    async function loadSellerRating(userId) {
        try {
            const userDoc = await getDoc(doc(db, 'users', userId));
            const el = document.getElementById('detail-seller-rating');
            if (userDoc.exists() && userDoc.data().rating) {
                const r = userDoc.data().rating;
                const count = userDoc.data().ratingCount || 0;
                const stars = '‚òÖ'.repeat(Math.round(r)) + '‚òÜ'.repeat(5 - Math.round(r));
                el.innerText = `${stars} ${r}/5 (${count} avis)`;
            } else {
                el.innerText = '‚Äî Nouveau vendeur';
            }
        } catch (e) {}
    }

    // NAVIGATION
    window.switchView = (v) => {
        document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('view-' + v)?.classList.remove('hidden');
        document.getElementById('nav-home').className = 'text-2xl ' + (v === 'home' ? 'text-cyan-400' : 'text-zinc-600');
        document.getElementById('nav-search').className = 'text-2xl ' + (v === 'search' ? 'text-cyan-400' : 'text-zinc-600');
        // Mark notifications read when opening
        if (v === 'notifications' && currentUser) {
            const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid), where('read', '==', false));
            getDocs(q).then(snap => snap.forEach(d => updateDoc(doc(db, 'notifications', d.id), { read: true })));
        }
    };

    // CAMERA
    let cameraStream = null;

    window.startScan = async () => {
        document.getElementById('scan-overlay').classList.remove('hidden');
        document.getElementById('scan-overlay').classList.add('flex');
        await startCamera();
    };

    async function startCamera() {
        const video = document.getElementById('camera-video');
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: false
            });
            video.srcObject = cameraStream;
            video.classList.remove('hidden');
            document.getElementById('scan-placeholder').classList.add('hidden');
        } catch (err) {
            document.getElementById('camera-input').click();
        }
    }

    function stopCamera() {
        if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
        const video = document.getElementById('camera-video');
        video.srcObject = null;
        video.classList.add('hidden');
    }

    window.capturePhoto = () => {
        const video = document.getElementById('camera-video');
        if (cameraStream && !video.classList.contains('hidden')) {
            const canvas = document.getElementById('capture-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            stopCamera();
            // Capture en qualit√© maximale depuis la cam√©ra
            processCapture(canvas.toDataURL('image/jpeg', 1.0));
        } else {
            document.getElementById('camera-input').click();
        }
    };

    window.handleImageFile = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => processCapture(evt.target.result);
        reader.readAsDataURL(file);
    };

    function processCapture(imgBase64) {
        document.getElementById('scan-placeholder').classList.add('hidden');
        document.getElementById('capture-btn').classList.add('hidden');
        document.getElementById('uploading-msg').classList.remove('hidden');
        document.getElementById('scan-line').classList.remove('hidden');
        // Recadrage + haute qualit√© avant analyse
        optimizeImage(imgBase64, 1200, 1200, 0.92).then(optimized => {
            document.getElementById('scan-preview').src = optimized;
            document.getElementById('scan-preview').classList.remove('hidden');
            analyzeWithGemini(optimized);
        });
    }

    function optimizeImage(base64, maxW, maxH, quality) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const srcW = img.width, srcH = img.height;
                // Sortie toujours en 1:1 carr√© 1000x1000
                const OUT = 1000;
                const canvas = document.createElement('canvas');
                canvas.width = OUT;
                canvas.height = OUT;
                const ctx = canvas.getContext('2d');

                // Fond sombre
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, 0, OUT, OUT);

                // Recadrage carr√© centr√© : prend le max carr√© possible depuis le centre
                const cropSize = Math.min(srcW, srcH);
                const sx = Math.round((srcW - cropSize) / 2);
                // Pour les photos d'objet, l√©g√®rement au-dessus du centre vertical
                const sy = Math.round((srcH - cropSize) * 0.45);

                ctx.drawImage(img, sx, sy, cropSize, cropSize, 0, 0, OUT, OUT);

                // L√©g√®re am√©lioration contraste
                ctx.globalCompositeOperation = 'source-atop';
                ctx.globalAlpha = 0;
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;

                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = base64;
        });
    }

    async function analyzeWithGemini(imgBase64) {
        try {
            const mimeType = imgBase64.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
            const response = await fetch('https://analyzeimage-xjtnixfrra-uc.a.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageBase64: imgBase64.split(',')[1],
                    mimeType
                })
            });
            const data = await response.json();
            if (data.error) { logError("Erreur IA: " + data.error); resetScanUI(); return; }
            updateScanUI(data, imgBase64);
        } catch (err) {
            logError("Erreur analyse IA: " + err.message);
            resetScanUI();
        }
    }

    function resetScanUI() {
        document.getElementById('uploading-msg').classList.add('hidden');
        document.getElementById('scan-line').classList.add('hidden');
        document.getElementById('capture-btn').classList.remove('hidden');
    }

    function updateScanUI(result, img) {
        document.getElementById('uploading-msg').classList.add('hidden');
        document.getElementById('scan-line').classList.add('hidden');
        document.getElementById('ai-item-name').value = result.title;
        document.getElementById('ai-price').innerText = result.price + '‚Ç¨';
        document.getElementById('ai-category').innerText = result.category;
        document.getElementById('ai-desc').value = result.description || '';
        document.getElementById('ai-condition').innerText = result.condition || 'Bon √©tat';
        if(document.getElementById('ai-brand')) document.getElementById('ai-brand').innerText = result.brand || '‚Äî';
        if(document.getElementById('ai-model')) document.getElementById('ai-model').innerText = result.model || '‚Äî';
        currentScanData = { itemName: result.title, price: result.price, category: result.category, condition: result.condition || 'Bon √©tat', description: result.description || '', brand: result.brand || '', model: result.model || '', imageUrl: img, shipping: [] };
        document.getElementById('ai-hud').classList.remove('hidden');
    }

    window.updateShipping = () => {
        const options = [];
        if (document.getElementById('ship-hand')?.checked) options.push({ method: 'Remise en main propre', price: 0 });
        if (document.getElementById('ship-relay')?.checked) options.push({ method: 'Mondial Relay', price: parseFloat(document.getElementById('ship-relay-price').value) || 5 });
        if (document.getElementById('ship-colissimo')?.checked) options.push({ method: 'Colissimo', price: parseFloat(document.getElementById('ship-colissimo-price').value) || 8 });
        if (currentScanData) currentScanData.shipping = options;
    };

    document.getElementById('validate-btn').addEventListener('click', async () => {
        if (!currentScanData || !currentUser) return;
        window.updateShipping();
        const btn = document.getElementById('validate-btn');
        btn.innerText = 'Publication...';
        btn.disabled = true;
        try {
            await addDoc(collection(db, 'scans'), {
                userId: currentUser.uid,
                itemName: document.getElementById('ai-item-name').value,
                price: currentScanData.price,
                category: currentScanData.category,
                condition: currentScanData.condition,
                description: currentScanData.description,
                brand: currentScanData.brand || '',
                model: currentScanData.model || '',
                shipping: currentScanData.shipping || [],
                imageUrl: currentScanData.imageUrl,
                createdAt: serverTimestamp()
            });
            window.stopScan();
            window.switchView('home');
        } catch (err) {
            logError("Publish Error: " + err.message);
            btn.innerText = 'VALIDER & PUBLIER';
            btn.disabled = false;
        }
    });

    window.stopScan = () => {
        stopCamera();
        document.getElementById('scan-overlay').classList.add('hidden');
        document.getElementById('scan-overlay').classList.remove('flex');
        document.getElementById('scan-preview').classList.add('hidden');
        document.getElementById('scan-placeholder').classList.remove('hidden');
        document.getElementById('ai-hud').classList.add('hidden');
        document.getElementById('uploading-msg').classList.add('hidden');
        document.getElementById('scan-line').classList.add('hidden');
        document.getElementById('capture-btn').classList.remove('hidden');
        const btn = document.getElementById('validate-btn');
        btn.innerText = 'VALIDER & PUBLIER';
        btn.disabled = false;
        document.getElementById('camera-input').value = '';
        currentScanData = null;
    };
</script>
</body>
</html>
